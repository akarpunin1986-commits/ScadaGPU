<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>SCADA GPU v5.0</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23080c14'/%3E%3Cpath d='M17 4L8 18h6l-3 10 10-14h-6l3-10z' fill='%2300e09a' filter='url(%23g)'/%3E%3Cdefs%3E%3Cfilter id='g'%3E%3CfeDropShadow dx='0' dy='0' stdDeviation='1.5' flood-color='%2300e09a' flood-opacity='.6'/%3E%3C/filter%3E%3C/defs%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="/libs/chart.umd.min.js"></script>
<script src="/libs/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="/libs/hammer.min.js"></script>
<script src="/libs/chartjs-plugin-zoom.min.js"></script>
<style>
:root{
--bg:#06090f;--bg2:#0a0f1a;--bg3:#0f1525;--bg4:#152035;--bg5:#1a2840;
--bd:#1a2640;--bd2:#2a4068;--bdh:#3a5888;
--t:#e8edf5;--t2:#94a3b8;--t3:#5a6a80;--t4:#384860;
--g:#00e09a;--gd:rgba(0,224,154,.08);--gb:rgba(0,224,154,.15);
--y:#ffb020;--yd:rgba(255,176,32,.08);
--r:#ff4060;--rd:rgba(255,64,96,.08);
--b:#4090ff;--bb:rgba(64,144,255,.1);
--p:#a070ff;--pd:rgba(160,112,255,.08);
--m:'JetBrains Mono',monospace;--u:'Outfit',sans-serif;
--rs:8px;--rad:12px;
--ov:rgba(255,255,255,.02);--ov2:rgba(255,255,255,.04);--ov3:rgba(255,255,255,.08);
--btn-text:#080c14
}
[data-theme="light"]{
--bg:#eef1f6;--bg2:#ffffff;--bg3:#ffffff;--bg4:#e2e6ed;--bg5:#d5dae4;
--bd:#c4cbd8;--bd2:#a0aabb;--bdh:#7a8599;
--t:#111827;--t2:#374151;--t3:#556270;--t4:#8494a7;
--g:#059669;--gd:rgba(5,150,105,.1);--gb:rgba(5,150,105,.18);
--y:#b45309;--yd:rgba(180,83,9,.08);
--r:#dc2626;--rd:rgba(220,38,38,.08);
--b:#1d4ed8;--bb:rgba(29,78,216,.08);
--p:#6d28d9;--pd:rgba(109,40,217,.08);
--ov:rgba(0,0,0,.03);--ov2:rgba(0,0,0,.05);--ov3:rgba(0,0,0,.08);
--btn-text:#ffffff
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--t);font-family:var(--u);height:100vh;overflow:hidden}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
.app{display:flex;height:100vh}
.sb{width:220px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0}
.sb-hd{padding:16px 14px 12px;border-bottom:1px solid var(--bd)}
.logo{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.logo svg{color:var(--g);filter:drop-shadow(0 0 6px rgba(0,224,154,.4))}.logo b{font-size:14px;letter-spacing:1px;font-weight:700}.logo span{font-size:10px;color:var(--t3);font-family:var(--m);margin-left:auto}
.sb-btn{display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--bg3);color:var(--t2);cursor:pointer;font-size:12px;font-family:var(--u);width:100%;text-align:left;transition:all .15s;margin-bottom:4px}
.sb-btn:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}
.sb-btn.primary{background:var(--g);color:var(--btn-text);border-color:var(--g);font-weight:600}.sb-btn.primary:hover{background:#00c888}
.sb-sites{flex:1;overflow-y:auto;padding:8px}
.si{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:var(--rs);cursor:pointer;margin-bottom:2px;border:1px solid transparent;transition:all .15s}
.si:hover{background:var(--bg4)}.si.on{background:var(--gd);border-color:rgba(0,224,154,.25)}
.si-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.si-name{font-size:13px;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.si-acts{display:none;gap:2px}.si:hover .si-acts{display:flex}
.si-btn{background:none;border:none;cursor:pointer;font-size:11px;padding:2px 5px;border-radius:4px;color:var(--t3);transition:all .15s}.si-btn:hover{color:var(--t)}.si-btn.del:hover{color:var(--r)}
.mn{flex:1;overflow-y:auto;padding:12px 20px}
.dh{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:6px}
.dt{display:flex;align-items:center;gap:12px}.dt h1{font-size:18px;font-weight:600}
.ld{width:10px;height:10px;border-radius:50%;background:var(--g);box-shadow:0 0 10px var(--g);animation:pulse 2s ease-in-out infinite}@keyframes pulse{50%{opacity:.4}}
.da{display:flex;gap:6px;align-items:center}
.da button{padding:7px 14px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--bg3);color:var(--t2);cursor:pointer;font-size:12px;font-family:var(--u);display:flex;align-items:center;gap:6px;white-space:nowrap;transition:all .15s}
.da button:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.da .demo-on{background:var(--gd);border-color:var(--g);color:var(--g)}
.ck{font-size:12px;color:var(--t3);font-family:var(--m)}
.ss{display:grid;grid-template-columns:repeat(6,1fr);gap:5px;margin-bottom:8px}
.sc{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);padding:7px 10px;transition:border-color .2s}.sc:hover{border-color:var(--bd2)}
.sl2{font-size:9px;color:var(--t3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.8px;font-weight:500}
.sv{font-family:var(--m);font-size:20px;font-weight:700}.su{font-size:11px;color:var(--t3);margin-left:2px;font-weight:400}
.bdg{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;font-family:var(--m)}
.bdg-ok{background:var(--gd);color:var(--g);border:1px solid rgba(0,224,154,.2)}.bdg-w{background:var(--yd);color:var(--y);border:1px solid rgba(255,176,32,.2);cursor:pointer}.bdg-a{background:var(--rd);color:var(--r);border:1px solid rgba(255,64,96,.2);cursor:pointer;animation:bk 1.5s infinite}.bdg-off{background:var(--bg3);color:var(--t3);border:1px solid var(--bd)}.bdg-run{background:var(--gd);color:var(--g);border:1px solid rgba(0,224,154,.2)}
.gg{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}.sr2{display:flex;justify-content:center;margin-bottom:10px}.sr2 .cc{max-width:640px;width:100%}
.cc{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);overflow:hidden;transition:all .25s}.cc:hover{border-color:var(--bd2)}
.cc.s-run{border-left:3px solid var(--g)}.cc.s-stb{border-left:3px solid var(--t4)}.cc.s-wrn{border-left:3px solid var(--y)}.cc.s-alm{border-left:3px solid var(--r)}
.ch{padding:8px 12px 6px;cursor:pointer;transition:background .15s}.ch:hover{background:var(--ov)}
.cr1{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}.cid{display:flex;align-items:center;gap:8px}
.cdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:all .3s}
.cd-g{background:var(--g);box-shadow:0 0 8px var(--g)}.cd-x{background:var(--t4)}.cd-r{background:var(--r);box-shadow:0 0 8px var(--r);animation:bk 1s infinite}.cd-y{background:var(--y);box-shadow:0 0 8px var(--y)}
@keyframes bk{50%{opacity:.15}}
.cn{font-size:13px;font-weight:600}.csb{font-size:10px;color:var(--t3);font-family:var(--m);margin-top:1px}
.kr{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}.kr5{grid-template-columns:repeat(5,1fr)}
.kp{text-align:center;padding:4px 2px;background:var(--ov);border-radius:var(--rs)}.kl{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px;font-weight:500}
.kv{font-family:var(--m);font-size:14px;font-weight:600}.ku{font-size:8px;color:var(--t3)}
.vg{color:var(--g)}.vn{color:var(--t)}.vm{color:var(--t4)}.vw{color:var(--y)}.va{color:var(--r)}.vb{color:var(--b)}.vp{color:var(--p)}
/* Quick Controls - ALWAYS VISIBLE on card */
.qc{display:flex;gap:3px;margin-top:3px;padding-top:3px;border-top:1px solid var(--ov2)}
.qb{flex:1;display:flex;align-items:center;justify-content:center;gap:2px;padding:4px 2px;border-radius:6px;border:1px solid var(--bd);background:var(--ov);color:var(--t3);cursor:pointer;font-family:var(--u);font-size:9px;font-weight:500;transition:all .15s;white-space:nowrap}
.qb:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.qb:active{transform:scale(.96)}
.qb.q-start:hover{border-color:var(--g);color:var(--g);background:var(--gd)}
.qb.q-stop:hover{border-color:var(--r);color:var(--r);background:var(--rd)}
.qb.q-auto:hover{border-color:var(--b);color:var(--b);background:var(--bb)}
.qb.q-manual:hover{border-color:var(--y);color:var(--y);background:var(--yd)}
.qb.q-danger{border-color:rgba(255,64,96,.3);color:var(--r);background:var(--rd)}.qb.q-danger:hover{background:rgba(255,64,96,.2);border-color:var(--r)}
.qb.q-start.on{border-color:var(--g);color:var(--g);background:var(--gd);font-weight:700;box-shadow:0 0 6px rgba(0,224,154,.15)}
.qb.q-stop.on{border-color:var(--r);color:var(--r);background:var(--rd);font-weight:700;box-shadow:0 0 6px rgba(255,64,96,.15)}
.qb.q-auto.on{border-color:var(--b);color:var(--b);background:var(--bb);font-weight:700;box-shadow:0 0 6px rgba(29,78,216,.15)}
.qb.q-manual.on{border-color:var(--y);color:var(--y);background:var(--yd);font-weight:700;box-shadow:0 0 6px rgba(255,176,32,.15)}
.cmd-st{margin-top:6px;padding:5px 10px;border-radius:6px;font-size:10px;font-family:var(--m);background:var(--gd);color:var(--g);display:none;text-align:center}.cmd-st.sh{display:block}
.to-block{margin-top:3px;padding:4px 7px;background:var(--ov);border:1px solid var(--bd);border-radius:var(--rs);cursor:pointer;transition:all .2s}.to-block:hover{border-color:var(--bd2)}
.to-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}.to-name{font-size:10px;font-weight:600;font-family:var(--m)}.to-g{color:var(--g)}.to-y{color:var(--y)}.to-r{color:var(--r)}.to-remain{font-size:9px;font-family:var(--m);color:var(--t3)}
.to-bar{height:3px;background:var(--bg);border-radius:2px;overflow:hidden;margin-bottom:2px}.to-fill{height:100%;border-radius:2px;transition:width .5s}
.to-tasks{font-size:10px;color:var(--t3);line-height:1.4;max-height:0;overflow:hidden;transition:max-height .3s}.to-block.exp .to-tasks{max-height:140px}.to-hint{font-size:9px;color:var(--t4);text-align:right}
.mds{display:flex;gap:2px;margin-top:3px}.mdt{font-size:8px;font-family:var(--m);font-weight:600;padding:2px 6px;border-radius:3px;border:1px solid var(--bd);color:var(--t4);transition:all .2s}.mdt.on{border-color:var(--g);color:var(--g);background:var(--gd)}
/* Power Limit block */
.pl-block{margin-top:3px;padding:5px 8px;background:rgba(160,112,255,.04);border:1px solid rgba(160,112,255,.15);border-radius:var(--rs);transition:all .2s}
.pl-block:hover{border-color:rgba(160,112,255,.3)}
.pl-hdr{font-size:9px;font-weight:600;color:var(--p);margin-bottom:4px;letter-spacing:.3px}
.pl-rows{display:flex;flex-direction:column;gap:3px}
.pl-row{display:flex;align-items:center;gap:6px;font-size:10px;font-family:var(--m);color:var(--t2)}
.pl-lbl{width:12px;flex-shrink:0;font-weight:600;color:var(--t3)}
.pl-bar{flex:1;height:4px;background:var(--bg);border-radius:2px;overflow:hidden}
.pl-fill{height:100%;border-radius:2px;transition:width .5s,background .3s;background:var(--g)}
.pl-fill.pl-q{background:var(--b)}
.pl-fill.pl-warn{background:var(--y)}.pl-fill.pl-crit{background:var(--r)}
.pl-val{font-size:9px;color:var(--t2);width:90px;text-align:right;flex-shrink:0;white-space:nowrap}
.pl-btn{margin-top:4px;width:100%;padding:3px;border-radius:4px;border:1px solid rgba(160,112,255,.2);background:rgba(160,112,255,.06);color:var(--p);cursor:pointer;font-family:var(--u);font-size:9px;font-weight:500;transition:all .15s}
.pl-btn:hover{background:rgba(160,112,255,.15);border-color:rgba(160,112,255,.4)}
.pl-block.disabled{opacity:.4;pointer-events:none}.pl-block.disabled .pl-btn{cursor:default}
.sum-popup{position:fixed;z-index:9999;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.5);padding:10px 14px;min-width:220px;max-width:340px;animation:fadeIn .15s}
.sum-pop-hdr{font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--bd)}
.sum-pop-row{font-size:12px;color:var(--t);padding:4px 0;line-height:1.4}
.cv{display:flex;justify-content:center;padding:3px;color:var(--t4);transition:transform .3s}.cc.op .cv{transform:rotate(180deg)}
.ce{max-height:0;overflow:hidden;transition:max-height .4s ease}.cc.op .ce{max-height:2500px}.ei{padding:0 10px 8px}
.tbs{display:flex;gap:0;border-bottom:1px solid var(--bd);margin-bottom:8px;overflow-x:auto}
.tb{padding:7px 12px;font-size:12px;font-weight:500;color:var(--t3);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;font-family:var(--u);white-space:nowrap;flex-shrink:0;transition:all .15s}.tb:hover{color:var(--t)}.tb.on{color:var(--g);border-bottom-color:var(--g)}
.tp{display:none}.tp.on{display:block}
.mg{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.mg4{grid-template-columns:repeat(4,1fr)}.mg2{grid-template-columns:repeat(2,1fr)}
.mc{background:var(--ov);border:1px solid var(--bd);border-radius:8px;padding:10px}.ml{font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;font-weight:500}.mv{font-family:var(--m);font-size:17px;font-weight:600}.ms2{font-size:10px;color:var(--t3);font-family:var(--m);margin-top:2px}.mu{font-size:11px;color:var(--t3);margin-left:2px}
.pt{width:100%;font-size:12px;font-family:var(--m);border-collapse:collapse;margin-top:10px}.pt th{text-align:left;font-weight:500;color:var(--t3);padding:7px 8px;border-bottom:1px solid var(--bd);font-size:10px;text-transform:uppercase}.pt td{padding:7px 8px;border-bottom:1px solid var(--ov)}.pt .ph{color:var(--t3)}
.cg{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.cb2{display:flex;flex-direction:column;align-items:center;gap:5px;padding:12px 4px;border-radius:8px;border:1px solid var(--bd);background:var(--ov);color:var(--t3);cursor:pointer;font-family:var(--u);font-size:10px;transition:all .15s;font-weight:500}
.cb2:active{transform:scale(.95)}.cb2:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.cb2.cgo:hover{border-color:var(--g);color:var(--g);background:var(--gd)}.cb2.cst:hover{border-color:var(--r);color:var(--r);background:var(--rd)}.ci2{font-size:18px}
.ai{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:var(--rs);margin-bottom:4px;font-size:12px;font-family:var(--m)}.ai.aw{background:var(--yd);border:1px solid rgba(255,176,32,.2)}.ai.aa{background:var(--rd);border:1px solid rgba(255,64,96,.2)}
.cf{display:flex;align-items:center;justify-content:space-between;padding:3px 10px;border-top:1px solid var(--bd);font-size:9px;font-family:var(--m);color:var(--t4)}.li{display:flex;align-items:center;gap:5px}.lo{width:6px;height:6px;border-radius:50%}.lo-g{background:var(--g);animation:pulse 1.5s ease-in-out infinite}.lo-r{background:var(--r)}
.pflow{margin:0 0 6px;padding:2px 8px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad)}
.pflow svg{width:100%;height:auto}
.pline{stroke:var(--t4);stroke-width:2.5;fill:none;transition:stroke .3s}
.pline.on{stroke:var(--g);filter:drop-shadow(0 0 4px rgba(0,224,154,.5));stroke-dasharray:8 4;animation:flowA .8s linear infinite}
.pline.mon{stroke:var(--b);filter:drop-shadow(0 0 4px rgba(64,144,255,.4));stroke-dasharray:8 4;animation:flowA .8s linear infinite}
.pline.bus{stroke-width:4}
@keyframes flowA{to{stroke-dashoffset:-12}}
@keyframes flowR{to{stroke-dashoffset:12}}
.pline.onR{stroke:var(--g);filter:drop-shadow(0 0 4px rgba(0,224,154,.5));stroke-dasharray:8 4;animation:flowR .8s linear infinite}
.pline.monR{stroke:var(--b);filter:drop-shadow(0 0 4px rgba(64,144,255,.4));stroke-dasharray:8 4;animation:flowR .8s linear infinite}
.bk-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--ov);border:1px solid var(--bd);border-radius:6px;margin-bottom:4px;font-size:11px;font-family:var(--m)}
.bk-item:hover{border-color:var(--bd2)}
.bk-acts{display:flex;gap:4px}
.bk-btn{padding:3px 8px;border-radius:4px;border:1px solid var(--bd);background:var(--bg3);color:var(--t3);cursor:pointer;font-size:10px;font-family:var(--u);transition:all .15s}
.bk-btn:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}
.bk-btn.del:hover{color:var(--r);border-color:rgba(255,64,96,.3)}
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(6px)}.mbg.sh{display:flex}
.mod{background:var(--bg2);border:1px solid var(--bd);border-radius:14px;width:100%;max-width:520px;max-height:85vh;overflow-y:auto;box-shadow:0 2px 20px rgba(0,0,0,.4)}
.mhd{padding:16px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}.mhd h3{font-size:15px;font-weight:600}
.mx{background:none;border:none;color:var(--t3);cursor:pointer;font-size:20px;padding:4px 8px;border-radius:6px;transition:all .15s}.mx:hover{background:var(--bg4);color:var(--t)}
.mbd{padding:18px}
.fg{margin-bottom:14px}.fl{font-size:12px;color:var(--t2);margin-bottom:5px;display:block;font-weight:500}.req{color:var(--r)}
.fi{width:100%;padding:9px 12px;background:var(--bg);border:1px solid var(--bd);border-radius:var(--rs);color:var(--t);font-size:13px;font-family:var(--u);outline:none;transition:all .15s}.fi:focus{border-color:var(--g);box-shadow:0 0 0 3px rgba(0,224,154,.1)}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.bp{padding:10px;background:var(--g);color:var(--btn-text);border:none;border-radius:var(--rs);font-weight:600;cursor:pointer;font-family:var(--u);font-size:13px;width:100%;transition:all .15s}.bp:hover{background:#00c888}
.bs2{padding:8px 14px;background:var(--bg3);border:1px solid var(--bd);color:var(--t2);border-radius:var(--rs);cursor:pointer;font-family:var(--u);font-size:12px;transition:all .15s}.bs2:hover{background:var(--bg4);color:var(--t)}
.bdn{background:var(--rd);color:var(--r);border:1px solid rgba(255,64,96,.3);border-radius:var(--rs);cursor:pointer;font-family:var(--u);font-weight:600;font-size:13px;padding:10px;transition:all .15s}.bdn:hover{background:rgba(255,64,96,.15)}
.bpp{padding:8px 12px;background:var(--pd);border:1px solid rgba(160,112,255,.3);color:var(--p);border-radius:var(--rs);cursor:pointer;font-family:var(--u);font-size:12px;font-weight:600;width:100%;transition:all .15s}.bpp:hover{background:rgba(160,112,255,.15)}
.cfs{border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:12px;transition:border-color .2s}.cfs:hover{border-color:var(--bd2)}
.cft{font-size:12px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.cft .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.cft .dot-g{background:var(--g)}.cft .dot-p{background:var(--p)}
.conn-test{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:4px;font-size:10px;font-family:var(--m);margin-left:auto;cursor:pointer;background:var(--bg4);border:1px solid var(--bd);color:var(--t3);transition:all .15s}.conn-test:hover{color:var(--t);border-color:var(--bd2)}
.spr-cg{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px}
.spr-b{padding:10px 4px;border-radius:8px;border:1px solid var(--bd);background:var(--ov);color:var(--t3);cursor:pointer;font-family:var(--u);font-size:10px;text-align:center;transition:all .15s;font-weight:500}.spr-b:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.spr-b:active{transform:scale(.96)}.spr-b .si2{font-size:16px;display:block;margin-bottom:3px}
.spr-b.act-g{background:var(--gd);border-color:rgba(0,224,154,.4);color:var(--g);font-weight:600;box-shadow:0 0 8px rgba(0,224,154,.15)}
.spr-b.act-r{background:var(--rd);border-color:rgba(255,64,96,.4);color:var(--r);font-weight:600;box-shadow:0 0 8px rgba(255,64,96,.15)}
.spr-b.act-b{background:var(--bb);border-color:rgba(64,144,255,.4);color:var(--b);font-weight:600;box-shadow:0 0 8px rgba(64,144,255,.15)}
.spr-b.act-y{background:var(--yd);border-color:rgba(255,176,32,.4);color:var(--y);font-weight:600;box-shadow:0 0 8px rgba(255,176,32,.15)}
.preset-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px}
.preset-btn{padding:10px 6px;border-radius:8px;border:1px solid var(--bd);background:var(--ov);color:var(--t2);cursor:pointer;font-family:var(--u);font-size:11px;text-align:center;transition:all .15s}
.preset-btn:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.preset-btn:active{transform:scale(.96)}
.preset-btn .preset-name{font-weight:600;margin-bottom:2px}.preset-btn .preset-desc{font-size:9px;color:var(--t3);font-family:var(--m)}.preset-btn.active{border-color:var(--p);background:var(--pd);color:var(--p)}
.slider-group{padding:10px 12px;background:var(--ov);border:1px solid var(--bd);border-radius:8px;margin-bottom:8px}
.slider-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}.slider-row:last-child{margin-bottom:0}
.slider-label{font-size:11px;font-family:var(--m);color:var(--t3);width:20px;flex-shrink:0}.slider-val{font-size:12px;font-family:var(--m);color:var(--t);width:44px;text-align:right;flex-shrink:0;font-weight:600}
input[type=range]{flex:1;-webkit-appearance:none;height:4px;background:var(--bd);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--p);border-radius:50%;cursor:pointer;box-shadow:0 0 6px rgba(160,112,255,.4)}
.ev{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);padding:14px 16px}.ev-t{font-size:11px;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.8px;font-weight:500}
.er{font-size:11px;font-family:var(--m);padding:4px 0;color:var(--t2);display:flex;gap:8px}.et{color:var(--t4);flex-shrink:0}
.to-iv{padding:12px;background:var(--bg4);border:1px solid var(--bd);border-radius:8px;margin-bottom:8px}.to-iv-bar{height:3px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:6px}.to-iv-fill{height:100%;border-radius:2px}
.chk-item{display:flex;align-items:flex-start;gap:8px;padding:7px 8px;border-radius:var(--rs);cursor:pointer;font-size:12px;transition:background .15s}.chk-item:hover{background:var(--bg4)}.chk-item.crit{background:rgba(255,64,96,.03)}.chk-item input{margin-top:2px;accent-color:var(--g)}
.ta{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--bd);border-radius:var(--rs);color:var(--t2);font-size:11px;font-family:var(--u);resize:vertical;min-height:60px;outline:none}.ta:focus{border-color:var(--g)}
.empty-dash{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;color:var(--t3);text-align:center}
.set-tabs{display:flex;gap:0;margin-bottom:16px;border-bottom:1px solid var(--bd)}
.set-tab{padding:10px 16px;font-size:12px;font-weight:500;color:var(--t3);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;font-family:var(--u);transition:all .15s}.set-tab:hover{color:var(--t)}.set-tab.on{color:var(--g);border-bottom-color:var(--g)}
.set-panel{display:none}.set-panel.on{display:block}
.ov-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px}
.ov-panel{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);padding:10px;overflow:hidden}
.ov-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.ov-hdr .ov-lbl{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600}
.ov-hdr .ov-sub{font-size:10px;color:var(--t3);font-family:var(--m)}
.ov-hdr .ov-bdg{font-size:9px;padding:2px 8px;border-radius:4px;font-weight:600;font-family:var(--m)}
.ov-pq{display:flex;gap:12px;margin-bottom:8px}
.ov-pq span{font-family:var(--m);font-size:14px;font-weight:600}
.ov-pq small{font-size:10px;color:var(--t3);margin-right:3px}
.ov-bus{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);padding:10px;margin-bottom:10px}
.ov-bus-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;text-align:center}
.ov-bus-grid .ov-bv{font-family:var(--m);font-size:15px;font-weight:600;color:var(--y)}
.ov-bus-grid .ov-bl{font-size:9px;color:var(--t3)}
.ov-sw{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;padding:8px 12px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad)}
.ov-sw-item{text-align:center;font-size:11px}
.ov-sw-item .ov-sw-lbl{font-size:9px;color:var(--t3);margin-bottom:2px}
.ov-sw-line{flex:1;height:3px;background:var(--bd);border-radius:2px;position:relative;overflow:hidden}
.ov-sw-line.on{background:var(--g)}
.ov-sw-line.on::after{content:'';position:absolute;top:0;left:-30%;width:30%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);animation:swglow 1.5s linear infinite}
@keyframes swglow{0%{left:-30%}100%{left:100%}}
.ov-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.ov-st{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);padding:8px;text-align:center}
.ov-st .ov-stv{font-family:var(--m);font-size:15px;font-weight:600}
.ov-st .ov-stl{font-size:9px;color:var(--t3);margin-top:2px}
.ind-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.ind-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--t2)}
.ind-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.arc-ctl{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;flex-wrap:wrap}
.arc-devs{display:flex;gap:4px}
.arc-dev{padding:6px 14px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--bg3);color:var(--t2);cursor:pointer;font-size:12px;font-family:var(--u);transition:all .15s}
.arc-dev:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}
.arc-dev.on{background:var(--gd);border-color:rgba(0,224,154,.25);color:var(--g);font-weight:600}
.arc-time{display:flex;align-items:center;gap:4px}
.arc-tb{padding:5px 10px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--bg3);color:var(--t3);cursor:pointer;font-size:11px;font-family:var(--m);transition:all .15s}
.arc-tb:hover{background:var(--bg4);color:var(--t)}.arc-tb.on{background:var(--gd);border-color:rgba(0,224,154,.25);color:var(--g)}
.zoom-lbl{font-size:11px;font-family:var(--m);color:var(--g);padding:3px 8px;border-radius:4px;background:var(--gd);border:1px solid rgba(0,224,154,.2);white-space:nowrap;opacity:0;transition:opacity .3s;margin-left:6px;display:inline-block;vertical-align:middle;pointer-events:none}.zoom-lbl.vis{opacity:1}
.arc-dt{width:155px;padding:5px 8px!important;font-size:10px!important;font-family:var(--m)!important}
.dp-wrap{position:relative;display:inline-block}
.dp-btn{padding:5px 10px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--bg3);color:var(--t3);cursor:pointer;font-size:11px;font-family:var(--m);transition:all .15s;white-space:nowrap;min-width:130px;text-align:center}
.dp-btn:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.dp-btn.has-val{color:var(--g);border-color:rgba(0,224,154,.25);background:var(--gd)}
.dp-drop{position:absolute;top:calc(100% + 4px);right:0;z-index:999;background:var(--bg2);border:1px solid var(--bd2);border-radius:var(--rad);padding:10px;box-shadow:0 8px 24px rgba(0,0,0,.5);display:none;width:260px}
.dp-drop.open{display:block}
.dp-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.dp-hdr span{font-size:12px;font-weight:600;color:var(--t);font-family:var(--u)}
.dp-nav{background:none;border:1px solid var(--bd);border-radius:6px;color:var(--t2);cursor:pointer;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .15s}
.dp-nav:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}
.dp-wk{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px}
.dp-wk span{text-align:center;font-size:9px;color:var(--t4);font-family:var(--m);padding:2px 0}
.dp-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.dp-d{text-align:center;padding:5px 2px;font-size:11px;font-family:var(--m);color:var(--t2);cursor:pointer;border-radius:6px;border:1px solid transparent;transition:all .12s}
.dp-d:hover{background:var(--bg4);color:var(--t);border-color:var(--bd)}.dp-d.sel{background:var(--gd);color:var(--g);border-color:rgba(0,224,154,.3);font-weight:600}
.dp-d.other{color:var(--t4)}.dp-d.today{border-color:var(--bd2)}
.dp-time{display:flex;align-items:center;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--bd)}
.dp-time input{width:44px;padding:4px 6px;background:var(--bg);border:1px solid var(--bd);border-radius:6px;color:var(--t);font-size:11px;font-family:var(--m);text-align:center;outline:none}
.dp-time input:focus{border-color:var(--g)}
.dp-time label{font-size:10px;color:var(--t3)}
.dp-apply{width:100%;margin-top:8px;padding:6px;border-radius:var(--rs);border:none;background:var(--g);color:var(--btn-text);font-size:11px;font-weight:600;font-family:var(--u);cursor:pointer;transition:background .15s}
.dp-apply:hover{background:#00c888}
.arc-chart-wrap{position:relative;height:480px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);padding:14px 14px 10px;margin-bottom:8px}
.arc-desc{padding:10px 12px;margin-bottom:6px;font-size:12px;line-height:1.6;color:var(--t2);background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);border-left:3px solid #4090ff}
.arc-desc b{color:var(--t);font-weight:600}
.arc-stats{padding:8px 10px;font-size:11px;color:var(--t2);font-family:var(--m)}
.arc-fstats{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-bottom:8px}
.arc-fs{padding:10px 12px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);border-left:3px solid var(--g)}
.arc-fs-name{font-size:11px;font-weight:600;color:var(--t);margin-bottom:6px;font-family:var(--u);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.arc-fs-row{display:flex;justify-content:space-between;font-size:10px;font-family:var(--m);padding:1px 0}
.arc-fs-lbl{color:var(--t3)}.arc-fs-val{color:var(--t);font-weight:500}
.arc-flt{display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.arc-pag{padding:4px 0}
.arc-stat-card{padding:12px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad)}
.sb-ft{padding:8px;border-top:1px solid var(--bd)}
.sb-global{padding:8px;border-top:1px solid var(--bd)}
.sb-global .sb-btn{margin-bottom:2px}
.sb-tree{margin-bottom:2px}
.sb-tree .si{display:flex;align-items:center;gap:6px}
.si-arrow{font-size:9px;width:14px;text-align:center;color:var(--t3);flex-shrink:0}
.sb-sub{padding-left:28px;padding-bottom:4px}
.sb-sub-btn{display:block;width:100%;text-align:left;padding:5px 10px;font-size:11px;color:var(--t3);background:none;border:none;cursor:pointer;border-radius:4px;transition:background .15s}
.sb-sub-btn:hover{background:var(--ov);color:var(--t)}
.sb-sub-btn.on{color:var(--g);font-weight:600}
.b24-task:hover{border-color:var(--b)!important;box-shadow:0 0 0 1px rgba(64,144,255,.2)}
.b24-eq:hover{border-color:var(--g)!important;box-shadow:0 0 0 1px rgba(0,224,154,.2)}
#b24StatOpen:hover,#b24StatClosed:hover,#b24StatMaint:hover,#b24StatAlarm:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.15);transition:all .15s}
[data-theme="light"] ::-webkit-scrollbar-thumb{background:#a0aabb}
[data-theme="light"] .mbg{background:rgba(0,0,0,.35)}
[data-theme="light"] .ov-sw-line.on::after{background:linear-gradient(90deg,transparent,rgba(0,0,0,.15),transparent)}
[data-theme="light"] .cc{box-shadow:0 1px 4px rgba(0,0,0,.08)}
[data-theme="light"] .sc{box-shadow:0 1px 3px rgba(0,0,0,.06)}
[data-theme="light"] .mod{box-shadow:0 8px 30px rgba(0,0,0,.18)}
[data-theme="light"] .sb{background:#f8f9fc;border-right-color:#d0d5dd}
[data-theme="light"] .sb-btn{background:#ffffff;border-color:#c4cbd8;color:#374151}
[data-theme="light"] .sb-btn:hover{background:#e2e6ed;color:#111827;border-color:#a0aabb}
[data-theme="light"] .si.on{background:rgba(5,150,105,.1);border-color:rgba(5,150,105,.3)}
[data-theme="light"] .bdg-ok{background:rgba(5,150,105,.12);color:#047857;border-color:rgba(5,150,105,.25)}
[data-theme="light"] .bdg-w{background:rgba(180,83,9,.1);color:#92400e;border-color:rgba(180,83,9,.25)}
[data-theme="light"] .bdg-a{background:rgba(220,38,38,.1);color:#b91c1c;border-color:rgba(220,38,38,.25)}
[data-theme="light"] .bdg-run{background:rgba(5,150,105,.12);color:#047857;border-color:rgba(5,150,105,.25)}
[data-theme="light"] .cd-g{background:#059669;box-shadow:0 0 6px rgba(5,150,105,.5)}
[data-theme="light"] .cd-r{background:#dc2626;box-shadow:0 0 6px rgba(220,38,38,.5)}
[data-theme="light"] .cd-y{background:#b45309;box-shadow:0 0 6px rgba(180,83,9,.5)}
[data-theme="light"] .ld{background:#059669;box-shadow:0 0 8px rgba(5,150,105,.5)}
[data-theme="light"] .vg{color:#047857}
[data-theme="light"] .vw{color:#92400e}
[data-theme="light"] .va{color:#b91c1c}
[data-theme="light"] .vb{color:#1d4ed8}
[data-theme="light"] .vp{color:#6d28d9}
[data-theme="light"] .sv{color:#111827}
[data-theme="light"] .kv{color:#1f2937}
[data-theme="light"] .pflow{background:#ffffff;border-color:#c4cbd8}
[data-theme="light"] .fi{background:#ffffff;border-color:#c4cbd8;color:#111827}
[data-theme="light"] .fi:focus{border-color:#059669;box-shadow:0 0 0 3px rgba(5,150,105,.15)}
[data-theme="light"] .arc-dev.on{background:rgba(5,150,105,.12);border-color:rgba(5,150,105,.35);color:#047857}
[data-theme="light"] .arc-tb.on{background:rgba(5,150,105,.12);border-color:rgba(5,150,105,.35);color:#047857}
[data-theme="light"] .tb.on{color:#047857;border-bottom-color:#059669}
[data-theme="light"] .arc-chart-wrap{background:#ffffff;border-color:#c4cbd8}
[data-theme="light"] .ov-panel{background:#ffffff}
[data-theme="light"] .ov-bus{background:#ffffff}
[data-theme="light"] .ov-st{background:#ffffff}
[data-theme="light"] .ov-sw{background:#ffffff}
[data-theme="light"] .mc{background:#ffffff;border-color:#c4cbd8}
[data-theme="light"] .ai.aw{background:rgba(180,83,9,.08);border-color:rgba(180,83,9,.2)}
[data-theme="light"] .ai.aa{background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.2)}
[data-theme="light"] .sum-popup{background:#ffffff;border-color:#c4cbd8;box-shadow:0 8px 24px rgba(0,0,0,.15)}
[data-theme="light"] .dp-drop{background:#ffffff;border-color:#a0aabb;box-shadow:0 8px 24px rgba(0,0,0,.15)}
[data-theme="light"] .arc-fs{background:#ffffff}
[data-theme="light"] .arc-stat-card{background:#ffffff}
[data-theme="light"] .ev{background:#ffffff}
[data-theme="light"] .logo svg{color:#059669;filter:drop-shadow(0 0 4px rgba(5,150,105,.3))}
[data-theme="light"] .qb{background:#ffffff;border-color:#c4cbd8;color:#556270}
[data-theme="light"] .qb:hover{background:#e2e6ed;color:#111827;border-color:#a0aabb}
[data-theme="light"] .mdt.on{border-color:#059669;color:#047857;background:rgba(5,150,105,.1)}
[data-theme="light"] .spr-b{background:#ffffff;border-color:#c4cbd8;color:#556270}
[data-theme="light"] .spr-b:hover{background:#e2e6ed;color:#111827;border-color:#a0aabb}
[data-theme="light"] .spr-b.act-g{background:rgba(5,150,105,.1);border-color:rgba(5,150,105,.35);color:#047857}
[data-theme="light"] .spr-b.act-r{background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.3);color:#b91c1c}
[data-theme="light"] .spr-b.act-b{background:rgba(29,78,216,.08);border-color:rgba(29,78,216,.3);color:#1d4ed8}
[data-theme="light"] .spr-b.act-y{background:rgba(180,83,9,.08);border-color:rgba(180,83,9,.3);color:#92400e}
[data-theme="light"] .bk-item{background:#ffffff;border-color:#c4cbd8}
[data-theme="light"] .cb2{background:#ffffff;border-color:#c4cbd8;color:#556270}
[data-theme="light"] .cb2:hover{background:#e2e6ed;color:#111827}
[data-theme="light"] .preset-btn{background:#ffffff;border-color:#c4cbd8;color:#374151}
[data-theme="light"] .preset-btn:hover{background:#e2e6ed;color:#111827}
[data-theme="light"] .slider-group{background:#ffffff;border-color:#c4cbd8}
[data-theme="light"] input[type=range]{background:#c4cbd8}
[data-theme="light"] input[type=range]::-webkit-slider-thumb{background:#6d28d9}
[data-theme="light"] .to-block{background:#ffffff;border-color:#c4cbd8}
[data-theme="light"] .pl-block{background:rgba(109,40,217,.04);border-color:rgba(109,40,217,.18)}
[data-theme="light"] .kp{background:rgba(0,0,0,.03)}
[data-theme="light"] .cmd-st{background:rgba(5,150,105,.1);color:#047857}
/* ===== Sanek Chat Panel ===== */
#sanekBtn{position:fixed;bottom:20px;right:20px;z-index:999;width:96px;height:96px;border-radius:50%;background:transparent;border:none;cursor:pointer;transition:all .3s cubic-bezier(.34,1.56,.64,1);padding:0;overflow:hidden}
#sanekBtn:hover{transform:scale(1.1)}
#sanekBtn canvas{width:100%;height:100%;pointer-events:none}
#sanekPanel{position:fixed;top:0;right:-420px;width:420px;height:100vh;background:#0c1021;border-left:1.5px solid #232d4a;z-index:998;transition:right .35s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;font-family:'Nunito',system-ui,sans-serif}
#sanekPanel.open{right:0}
.sn-hd{padding:14px 18px;border-bottom:1px solid #232d4a;display:flex;align-items:center;gap:14px;background:#141a2e}
.sn-hd canvas{width:128px;height:128px;flex-shrink:0;border-radius:50%;overflow:hidden}
.sn-hd-info h3{font-size:16px;font-weight:800;color:#e8ecf4;margin:0}
.sn-hd-status{font-size:11px;color:#4ade80;display:flex;align-items:center;gap:5px;position:relative}
.sn-health-tip{position:absolute;top:100%;left:0;right:0;margin-top:6px;padding:10px 14px;background:#1c1030;border:1.5px solid #ff6b81;border-radius:12px;font-size:11.5px;line-height:1.5;color:#fca5a5;z-index:10;animation:snBubbleIn .3s ease;box-shadow:0 4px 20px rgba(255,107,129,.15);white-space:normal}
.sn-health-tip::before{content:'';position:absolute;top:-6px;left:16px;width:10px;height:10px;background:#1c1030;border-left:1.5px solid #ff6b81;border-top:1.5px solid #ff6b81;transform:rotate(45deg)}
.sn-health-tip b{color:#ff6b81;font-weight:700}
.sn-health-tip .sn-tip-close{position:absolute;top:6px;right:8px;background:none;border:none;color:#6b7a9e;cursor:pointer;font-size:14px;padding:0 4px}
[data-theme="light"] .sn-health-tip{background:#fff0f0;border-color:#ef4444;color:#991b1b;box-shadow:0 4px 20px rgba(239,68,68,.12)}
[data-theme="light"] .sn-health-tip::before{background:#fff0f0;border-color:#ef4444}
[data-theme="light"] .sn-health-tip b{color:#dc2626}
.sn-hd-dot{width:6px;height:6px;background:#4ade80;border-radius:50%;animation:snPulse 2s ease-in-out infinite}
@keyframes snPulse{0%,100%{opacity:1}50%{opacity:.3}}
.sn-msgs{flex:1;overflow-y:auto;padding:16px 18px;display:flex;flex-direction:column;gap:12px;background:#0c1021}
.sn-msg{max-width:86%;padding:11px 16px;border-radius:18px;font-size:13.5px;line-height:1.55;word-wrap:break-word;white-space:pre-wrap;animation:snBubbleIn .4s cubic-bezier(.34,1.56,.64,1) both}
@keyframes snBubbleIn{from{opacity:0;transform:translateY(10px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.sn-msg.user{align-self:flex-end;background:linear-gradient(135deg,rgba(93,228,255,.12),rgba(167,139,250,.08));border:1px solid rgba(93,228,255,.15);color:#7eeaff;border-bottom-right-radius:6px}
.sn-msg.assistant{align-self:flex-start;background:#1a2240;border:1px solid #232d4a;color:#e8ecf4;border-bottom-left-radius:6px}
.sn-msg.assistant .sn-bname{font-size:11px;font-weight:800;color:#5de4ff;margin-bottom:3px}
.sn-action{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:10px;font-size:10px;font-weight:700;background:rgba(74,222,128,.12);color:#4ade80;margin-top:4px;border:1px solid rgba(74,222,128,.15)}
.sn-pending{background:rgba(255,190,74,.08);border:1px solid rgba(255,190,74,.2);border-radius:14px;padding:12px;margin-top:6px}
.sn-pending-btns{display:flex;gap:8px;margin-top:10px}
.sn-pending-btns button{padding:8px 20px;border-radius:12px;border:none;cursor:pointer;font-size:12px;font-weight:700;transition:transform .2s}
.sn-pending-btns button:hover{transform:scale(1.05)}
.sn-pending-btns .sn-yes{background:linear-gradient(135deg,#5de4ff,#4ade80);color:#0c1021}
.sn-pending-btns .sn-no{background:rgba(255,107,129,.15);color:#ff6b81;border:1px solid rgba(255,107,129,.25)}
.sn-input-row{padding:12px 18px;border-top:1px solid #232d4a;display:flex;gap:10px;align-items:center;background:#141a2e}
.sn-input-row input{flex:1;padding:10px 16px;border:1px solid #232d4a;border-radius:14px;background:#0c1021;color:#e8ecf4;font-size:13px;font-family:inherit;outline:none;transition:border-color .3s}
.sn-input-row input:focus{border-color:#5de4ff}
.sn-input-row input::placeholder{color:#6b7a9e}
.sn-send-btn{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;background:linear-gradient(135deg,#5de4ff,#4ade80);display:flex;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s;flex-shrink:0}
.sn-send-btn:hover{transform:scale(1.12);box-shadow:0 0 20px rgba(74,222,128,.3)}
.sn-send-btn:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:none}
.sn-send-btn svg{width:18px;height:18px;fill:#0c1021}
.sn-msg.error{align-self:flex-start;background:rgba(255,107,129,.06);border:1px solid rgba(255,107,129,.18);color:#ff8fa3;border-bottom-left-radius:6px}
.sn-msg.error .sn-bname{color:#ff6b81}
[data-theme="light"] .sn-msg.error{background:rgba(220,38,38,.05);border-color:rgba(220,38,38,.15);color:#dc2626}
[data-theme="light"] .sn-msg.error .sn-bname{color:#dc2626}
.sn-typing{align-self:flex-start;padding:12px 16px;border-radius:18px;background:#1a2240;border:1px solid #232d4a;border-bottom-left-radius:6px}
.sn-typing span{display:inline-block;width:8px;height:8px;border-radius:50%;background:#5de4ff;margin:0 2px;animation:snDotBounce 1.2s ease-in-out infinite}
.sn-typing span:nth-child(2){animation-delay:.15s}
.sn-typing span:nth-child(3){animation-delay:.3s}
@keyframes snDotBounce{0%,80%,100%{transform:translateY(0);opacity:.4}40%{transform:translateY(-8px);opacity:1}}
.sn-welcome{text-align:center;padding:40px 24px 24px;color:#6b7a9e}
.sn-welcome-line{width:40px;height:3px;border-radius:2px;background:linear-gradient(90deg,#5de4ff,#4ade80);margin:0 auto 18px;opacity:.5}
.sn-welcome h3{color:#e8ecf4;margin:0 0 8px;font-size:17px;font-weight:800}
.sn-welcome p{font-size:12.5px;margin:0 0 24px;line-height:1.7;color:#6b7a9e}
.sn-hints{display:flex;flex-direction:column;gap:8px}
.sn-hint{padding:10px 14px;border:1.5px solid #232d4a;border-radius:14px;background:#141a2e;color:#6b7a9e;font-size:12px;cursor:pointer;text-align:left;transition:all .25s cubic-bezier(.34,1.56,.64,1)}
.sn-hint:hover{border-color:rgba(93,228,255,.3);color:#e8ecf4;background:#1a2240;transform:translateY(-2px);box-shadow:0 4px 16px rgba(93,228,255,.06)}
[data-theme="light"] #sanekBtn{background:transparent}
[data-theme="light"] #sanekPanel{background:#f8fafc;border-color:#d1d5db}
[data-theme="light"] .sn-hd{background:#fff;border-color:#e2e8f0}
[data-theme="light"] .sn-msgs{background:#f1f5f9}
[data-theme="light"] .sn-msg.user{background:linear-gradient(135deg,rgba(109,40,217,.1),rgba(79,70,229,.06));border-color:rgba(109,40,217,.15);color:#6d28d9}
[data-theme="light"] .sn-msg.assistant{background:#fff;border-color:#e2e8f0;color:#1e293b}
[data-theme="light"] .sn-msg.assistant .sn-bname{color:#6d28d9}
[data-theme="light"] .sn-input-row{background:#fff;border-color:#e2e8f0}
[data-theme="light"] .sn-input-row input{background:#f1f5f9;border-color:#e2e8f0;color:#1e293b}
[data-theme="light"] .sn-input-row input:focus{border-color:#6d28d9}
[data-theme="light"] .sn-hint{background:#fff;border-color:#e2e8f0;color:#64748b}
[data-theme="light"] .sn-hint:hover{border-color:rgba(109,40,217,.3);color:#1e293b;background:#f5f3ff}
[data-theme="light"] .sn-action{background:rgba(109,40,217,.08);color:#6d28d9;border-color:rgba(109,40,217,.12)}
[data-theme="light"] .sn-hd-info h3{color:#1e293b}
[data-theme="light"] .sn-welcome h3{color:#1e293b}
[data-theme="light"] .sn-welcome p{color:#64748b}
[data-theme="light"] .sn-welcome-line{background:linear-gradient(90deg,#6d28d9,#4f46e5)}
/* --- Sanek: History dropdown + Counter --- */
.sn-hd-top{display:flex;align-items:center;gap:8px;position:relative}
.sn-hist-btn{background:none;border:1.5px solid #232d4a;border-radius:10px;padding:5px 10px;color:#6b7a9e;cursor:pointer;font-size:11px;transition:all .2s;display:flex;align-items:center;gap:4px}
.sn-hist-btn:hover{border-color:rgba(93,228,255,.3);color:#e8ecf4}
.sn-hist-btn.active{border-color:#5de4ff;color:#5de4ff}
.sn-counter{font-size:10px;color:#6b7a9e;font-family:'Space Mono',monospace;padding:2px 7px;border-radius:8px;background:rgba(93,228,255,.06);border:1px solid rgba(93,228,255,.1);white-space:nowrap;display:none}
.sn-counter.vis{display:inline-block}
.sn-counter.warn{color:#ffbe4a;border-color:rgba(255,190,74,.2);background:rgba(255,190,74,.06)}
.sn-counter.crit{color:#ff6b81;border-color:rgba(255,107,129,.2);background:rgba(255,107,129,.06)}
.sn-hist{max-height:0;overflow:hidden;background:#141a2e;border-bottom:1px solid transparent;transition:max-height .3s ease,border-color .3s}
.sn-hist.open{max-height:55vh;overflow-y:auto;border-color:#232d4a}
.sn-hist-hd{padding:10px 14px;border-bottom:1px solid #232d4a;display:flex;align-items:center;justify-content:space-between}
.sn-hist-hd span{font-size:12px;font-weight:700;color:#e8ecf4}
.sn-hist-hd button{background:none;border:none;color:#6b7a9e;cursor:pointer;font-size:11px}
.sn-hist-hd button:hover{color:#5de4ff}
.sn-hist-list{padding:6px}
.sn-hist-item{padding:10px 12px;border-radius:10px;cursor:pointer;transition:background .2s;display:flex;align-items:center;gap:10px}
.sn-hist-item:hover{background:rgba(93,228,255,.06)}
.sn-hist-item.active{background:rgba(93,228,255,.1);border:1px solid rgba(93,228,255,.15)}
.sn-hist-item .sn-hi-icon{width:28px;height:28px;border-radius:8px;background:rgba(93,228,255,.08);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.sn-hist-item .sn-hi-body{flex:1;min-width:0}
.sn-hist-item .sn-hi-title{font-size:12px;color:#e8ecf4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600}
.sn-hist-item .sn-hi-meta{font-size:10px;color:#6b7a9e;margin-top:2px;display:flex;gap:8px}
.sn-hi-del{background:none;border:none;cursor:pointer;font-size:12px;padding:4px 6px;border-radius:6px;opacity:0;transition:opacity .2s,background .2s;flex-shrink:0}
.sn-hist-item:hover .sn-hi-del{opacity:.6}
.sn-hi-del:hover{opacity:1!important;background:rgba(255,107,129,.12)}
.sn-hist-empty{padding:24px;text-align:center;color:#6b7a9e;font-size:12px}
.sn-ctx-badge{font-size:9px;padding:2px 6px;border-radius:6px;background:rgba(93,228,255,.08);color:#5de4ff;border:1px solid rgba(93,228,255,.1);white-space:nowrap;display:inline-block;margin-left:6px}
[data-theme="light"] .sn-hist-btn{border-color:#d1d5db;color:#64748b}
[data-theme="light"] .sn-hist-btn:hover{border-color:rgba(109,40,217,.3);color:#1e293b}
[data-theme="light"] .sn-hist-btn.active{border-color:#6d28d9;color:#6d28d9}
[data-theme="light"] .sn-counter{color:#64748b;background:rgba(109,40,217,.04);border-color:rgba(109,40,217,.1)}
[data-theme="light"] .sn-hist{background:#fff;border-color:#e2e8f0}
[data-theme="light"] .sn-hist-hd{border-color:#e2e8f0}
[data-theme="light"] .sn-hist-hd span{color:#1e293b}
[data-theme="light"] .sn-hist-item:hover{background:rgba(109,40,217,.04)}
[data-theme="light"] .sn-hist-item.active{background:rgba(109,40,217,.06);border-color:rgba(109,40,217,.12)}
[data-theme="light"] .sn-hist-item .sn-hi-title{color:#1e293b}
[data-theme="light"] .sn-hist-item .sn-hi-meta{color:#64748b}
[data-theme="light"] .sn-ctx-badge{background:rgba(109,40,217,.04);color:#6d28d9;border-color:rgba(109,40,217,.1)}
[data-theme="light"] .sn-send-btn{background:linear-gradient(135deg,#6d28d9,#4f46e5)}
[data-theme="light"] .sn-send-btn:hover{box-shadow:0 0 20px rgba(109,40,217,.3)}
[data-theme="light"] .sn-send-btn svg{fill:#fff}
[data-theme="light"] .sn-pending-btns .sn-yes{background:linear-gradient(135deg,#6d28d9,#4f46e5);color:#fff}
[data-theme="light"] .sn-typing span{background:#6d28d9}
[data-theme="light"] .sn-hist-hd button:hover{color:#6d28d9}
[data-theme="light"] .sn-hist-item .sn-hi-icon{background:rgba(109,40,217,.08)}
</style></head><body>
<div class="app">
<div class="sb"><div class="sb-hd">
<div class="logo"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg><b>SCADA</b><span>v5</span></div>
<button class="sb-btn primary" onclick="openAddSite()">+ –û–±—ä–µ–∫—Ç</button>
</div><div class="sb-sites" id="sbSites"></div><div class="sb-global">
<button class="sb-btn" onclick="showB24Dashboard()">üîó –ë–∏—Ç—Ä–∏–∫—Å24</button>
<button class="sb-btn" onclick="initAIModal();showM('aiconf')">ü§ñ AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä</button>
</div><div class="sb-ft"><button class="sb-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</button></div></div>
<div class="mn" id="mainArea"></div></div>
<!-- MODALS -->
<!-- AI Provider Config -->
<div class="mbg" id="m-aiconf"><div class="mod" style="max-width:540px"><div class="mhd"><h3>ü§ñ AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã</h3><button class="mx" onclick="hideM('aiconf')">‚úï</button></div><div class="mbd">
<div style="font-size:12px;color:var(--t2);margin-bottom:12px">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤. –ú–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî –æ–¥–∏–Ω –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–º.</div>
<div id="aiProviderCards" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px"></div>
<div id="aiKeySection" style="display:none">
<div class="fg"><label class="fl" id="aiKeyLabel">API Key</label><div style="display:flex;gap:6px"><input class="fi" id="aiKeyInput" type="password" placeholder="sk-..." style="flex:1"><button class="bs2" style="padding:8px 12px;font-size:11px;flex-shrink:0" onclick="toggleAIKeyVis()">üëÅ</button></div></div>
<div class="fg"><label class="fl">–ú–æ–¥–µ–ª—å</label><select class="fi" id="aiModelSelect" style="padding:8px 10px"></select></div>
<div style="display:flex;gap:8px;margin-bottom:10px"><button class="bp" style="flex:1" onclick="saveAIConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="bs2" style="padding:10px" onclick="testAIProvider()">üîå –¢–µ—Å—Ç</button><button class="bs2" id="aiActivateBtn" style="padding:10px;font-size:11px" onclick="activateAIProvider()">‚òÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button></div>
<div id="aiTestResult" style="margin-top:4px"></div>
</div>
<div id="aiStatus" style="padding:8px 10px;background:var(--ov);border:1px solid var(--bd);border-radius:6px;margin-top:8px;font-size:10px;color:var(--t3);line-height:1.5"></div>
</div></div></div>
<div class="mbg" id="m-site"><div class="mod" style="max-width:440px"><div class="mhd"><h3 id="smT">–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç</h3><button class="mx" onclick="hideM('site')">‚úï</button></div><div class="mbd">
<div class="fg"><label class="fl">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="req">*</span></label><input class="fi" id="fN" placeholder="–ú–ö–ó"></div>
<div class="fg"><label class="fl">–ö–æ–¥ (–ª–∞—Ç–∏–Ω–∏—Ü–∞) <span class="req">*</span></label><input class="fi" id="fC" placeholder="mkz"></div>
<div class="fg"><label class="fl">–û–ø–∏—Å–∞–Ω–∏–µ</label><input class="fi" id="fD" placeholder="–ö–∏—Ä–ø–∏—á–Ω—ã–π –∑–∞–≤–æ–¥"></div>
<div class="fg"><label class="fl">üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¢–û</label><select class="fi" id="fResp" style="padding:8px 10px"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option></select><div style="font-size:9px;color:var(--t4);margin-top:3px">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –ë–∏—Ç—Ä–∏–∫—Å24 ‚Üí –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div></div>
<div id="smA"></div></div></div></div>
<div class="mbg" id="m-del"><div class="mod" style="max-width:380px"><div class="mhd"><h3>–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?</h3><button class="mx" onclick="hideM('del')">‚úï</button></div><div class="mbd"><p style="font-size:13px;color:var(--t2);margin-bottom:16px">–£–¥–∞–ª–∏—Ç—å <b id="delN"></b> –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?</p><div style="display:flex;gap:8px"><button class="bdn" style="flex:1" onclick="doDel()">–£–¥–∞–ª–∏—Ç—å</button><button class="bs2" style="flex:1;padding:10px" onclick="hideM('del')">–û—Ç–º–µ–Ω–∞</button></div></div></div></div>
<div class="mbg" id="m-settings"><div class="mod" style="max-width:560px"><div class="mhd"><h3 id="setTitle">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button class="mx" onclick="hideM('settings')">‚úï</button></div><div class="mbd" id="setBody"></div></div></div>
<div class="mbg" id="m-cmd"><div class="mod" style="max-width:400px"><div class="mhd"><h3 id="cmdT">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3><button class="mx" onclick="hideM('cmd')">‚úï</button></div><div class="mbd">
<div style="padding:12px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:8px;margin-bottom:12px"><div style="font-size:12px;color:var(--y);font-weight:600;margin-bottom:4px">‚ö† –í–Ω–∏–º–∞–Ω–∏–µ</div><p id="cmdTxt" style="font-size:13px;color:var(--t2)"></p></div>
<div id="cmdInfo" style="padding:8px 10px;background:var(--ov);border:1px solid var(--bd);border-radius:6px;font-size:10px;color:var(--t3);font-family:var(--m);margin-bottom:14px"></div>
<div style="display:flex;gap:8px"><button class="bp" style="flex:1" id="cmdOk">‚ö° –í—ã–ø–æ–ª–Ω–∏—Ç—å</button><button class="bs2" style="flex:1;padding:10px" onclick="hideM('cmd')">–û—Ç–º–µ–Ω–∞</button></div></div></div></div>
<div class="mbg" id="m-to"><div class="mod"><div class="mhd"><h3 id="toT">–¢–û</h3><button class="mx" onclick="hideM('to')">‚úï</button></div><div class="mbd" id="toBody"></div></div></div>
<div class="mbg" id="m-tpl"><div class="mod"><div class="mhd"><h3 id="tplT">–†–µ–≥–ª–∞–º–µ–Ω—Ç—ã</h3><button class="mx" onclick="hideM('tpl')">‚úï</button></div><div class="mbd" id="tplBody"></div></div></div>
<div class="mbg" id="m-bitrix"><div class="mod" style="max-width:560px"><div class="mhd"><h3>üîó –ë–∏—Ç—Ä–∏–∫—Å24 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</h3><button class="mx" onclick="hideM('bitrix')">‚úï</button></div><div class="mbd">
<div class="set-tabs"><button class="set-tab on" onclick="bxTab(this,0)">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button><button class="set-tab" onclick="bxTab(this,1)">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button><button class="set-tab" onclick="bxTab(this,2)">–ò–º–ø–æ—Ä—Ç –¢–û</button><button class="set-tab" onclick="bxTab(this,3)">–ê–≤—Ç–æ–∑–∞–¥–∞—á–∏</button></div>
<div class="set-panel on" id="bxp0">
<div class="fg"><label class="fl">Webhook URL <span class="req">*</span></label><input class="fi" id="bxUrl" placeholder="https://your.bitrix24.ru/rest/1/abc123xyz/" value=""></div>
<div style="padding:8px 10px;background:var(--ov);border:1px solid var(--bd);border-radius:6px;margin-bottom:10px;font-size:10px;color:var(--t3);line-height:1.5">
<b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å:</b> –ë–∏—Ç—Ä–∏–∫—Å24 ‚Üí –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º ‚Üí –î—Ä—É–≥–æ–µ ‚Üí –í—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫ ‚Üí –°–æ–∑–¥–∞—Ç—å.<br>
<b>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞:</b><br>
‚Ä¢ <b style="color:var(--g)">task</b> ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ/—á—Ç–µ–Ω–∏–µ –∑–∞–¥–∞—á (tasks.task.add, task.checklistitem.add)<br>
‚Ä¢ <b style="color:var(--g)">user</b> ‚Äî —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (user.get)<br>
‚Ä¢ <b style="color:var(--y)">disk</b> ‚Äî —Ñ–∞–π–ª—ã –î–∏—Å–∫–∞ (disk.folder.getchildren, disk.file.get) ‚Äî –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¢–û<br>
‚Ä¢ <b style="color:var(--t3)">crm</b> ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∑–∞–¥–∞—á –∫ CRM (UF_CRM_TASK)<br>
<b>–§–æ—Ä–º–∞—Ç URL:</b> https://–≤–∞—à-–¥–æ–º–µ–Ω.bitrix24.ru/rest/USER_ID/SECRET/<br>
<b>USER_ID</b> ‚Äî –æ—Ç –∏–º–µ–Ω–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∑–∞–¥–∞—á–∏ (CREATED_BY)
</div>
<div style="display:flex;gap:8px"><button class="bp" style="flex:1" onclick="saveBxConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="bs2" style="padding:10px" onclick="testBxConnection()">üîå –¢–µ—Å—Ç</button></div>
<div id="bxConnResult" style="margin-top:8px"></div>
</div>
<div class="set-panel" id="bxp1">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-size:12px;color:var(--t2)">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24</span><button class="bs2" style="padding:6px 12px;font-size:11px" onclick="loadBxUsers()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button></div>
<div id="bxUserList" style="max-height:300px;overflow-y:auto"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div></div>
<div style="padding:8px 10px;background:var(--ov);border:1px solid var(--bd);border-radius:6px;margin-top:10px;font-size:10px;color:var(--t3);line-height:1.5">–°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö (RESPONSIBLE_ID) –∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π (AUDITORS) –≤ –∑–∞–¥–∞—á–∞—Ö –¢–û.<br><b>API:</b> user.get ‚Üí –ø–æ–ª—è: ID, NAME, LAST_NAME, WORK_POSITION, UF_DEPARTMENT</div>
</div>
<div class="set-panel" id="bxp2">
<div style="font-size:12px;color:var(--t2);margin-bottom:10px">–ò–º–ø–æ—Ä—Ç —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞ –¢–û –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24 –î–∏—Å–∫</div>
<div class="fg"><label class="fl">ID –ø–∞–ø–∫–∏ –Ω–∞ –î–∏—Å–∫–µ –ë24</label><input class="fi" id="bxFolderId" placeholder="12345" type="number"></div>
<div style="display:flex;gap:8px;margin-bottom:10px"><button class="bp" style="flex:1" onclick="scanBxFolder()">üìÇ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ø–∫—É</button></div>
<div id="bxFileList" style="margin-bottom:10px"></div>
<div style="padding:10px;background:rgba(160,112,255,.04);border:1px solid rgba(160,112,255,.15);border-radius:8px;font-size:10px;color:var(--t2);line-height:1.5">
<b style="color:var(--p)">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b><br>
1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç –¢–û (PDF/DOCX) –Ω–∞ –î–∏—Å–∫ –ë–∏—Ç—Ä–∏–∫—Å24<br>
2. –£–∫–∞–∂–∏—Ç–µ ID –ø–∞–ø–∫–∏ ‚Üí SCADA —Å–∫–∞–Ω–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã<br>
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª ‚Üí AI-–∞–≥–µ–Ω—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç<br>
4. –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ —á–µ–∫–ª–∏—Å—Ç—ã –¢–û<br>
<b>API:</b> disk.folder.getchildren ‚Üí disk.file.get ‚Üí AI parse
</div>
</div>
<div class="set-panel" id="bxp3">
<div style="font-size:12px;color:var(--t2);margin-bottom:10px">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –¢–û</div>
<div class="fg"><label class="fl">–ì—Ä—É–ø–ø–∞/–ø—Ä–æ–µ–∫—Ç –≤ –ë24 (GROUP_ID)</label><input class="fi" id="bxGroupId" placeholder="42" type="number"></div>
<div class="fg"><label class="fl">–®–∞–±–ª–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏ (TITLE)</label><input class="fi" id="bxTaskTitle" placeholder="{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}" value="{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}"></div>
<div style="display:flex;gap:8px"><div class="fg" style="flex:1"><label class="fl">–°—Ä–æ–∫ (–¥–Ω–µ–π –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è)</label><input class="fi" id="bxDeadlineDays" placeholder="3" value="3" type="number"></div><div class="fg" style="flex:1"><label class="fl">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (PRIORITY)</label><select class="fi" id="bxPriority" style="padding:8px 10px"><option value="0">–ù–∏–∑–∫–∏–π (0)</option><option value="1" selected>–°—Ä–µ–¥–Ω–∏–π (1)</option><option value="2">–í—ã—Å–æ–∫–∏–π (2)</option></select></div></div>
<div class="fg"><label class="fl">üë§ –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (AUDITORS)</label><select class="fi" id="bxAuditor" style="padding:8px 10px"><option value="">‚Äî –Ω–µ—Ç ‚Äî</option></select></div>
<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;padding:8px 10px;background:var(--ov);border:1px solid var(--bd);border-radius:6px">
<div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bxAutoCreate" style="accent-color:var(--g)"><label for="bxAutoCreate" style="font-size:12px;color:var(--t2)">–ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –¢–û</label></div>
<div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bxAddChecklist" style="accent-color:var(--g)" checked><label for="bxAddChecklist" style="font-size:12px;color:var(--t2)">–î–æ–±–∞–≤–∏—Ç—å —á–µ–∫–ª–∏—Å—Ç —Ä–∞–±–æ—Ç (task.checklistitem.add)</label></div>
<div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bxDescBBCode" style="accent-color:var(--g)" checked><label for="bxDescBBCode" style="font-size:12px;color:var(--t2)">–û–ø–∏—Å–∞–Ω–∏–µ –≤ BBCode (DESCRIPTION_IN_BBCODE=Y)</label></div>
</div>
<button class="bp" onclick="saveBxConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
<div style="padding:10px;background:var(--ov);border:1px solid var(--bd);border-radius:8px;margin-top:10px;font-size:10px;color:var(--t3);line-height:1.6">
<b style="color:var(--t2)">–ü–æ–ª—è –∑–∞–¥–∞—á–∏ tasks.task.add:</b><br>
‚Ä¢ TITLE ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —à–∞–±–ª–æ–Ω—É<br>
‚Ä¢ DESCRIPTION ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ —Å —Ä–∞–±–æ—Ç–∞–º–∏ –¢–û (BBCode)<br>
‚Ä¢ RESPONSIBLE_ID ‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–±—ä–µ–∫—Ç–∞)<br>
‚Ä¢ CREATED_BY ‚Äî –ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫ (USER_ID –∏–∑ webhook URL)<br>
‚Ä¢ AUDITORS ‚Äî –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ (–º–∞—Å—Å–∏–≤ ID)<br>
‚Ä¢ GROUP_ID ‚Äî –ø—Ä–æ–µ–∫—Ç/–≥—Ä—É–ø–ø–∞<br>
‚Ä¢ DEADLINE ‚Äî —Å—Ä–æ–∫ –≤ ISO-8601: 2025-01-15T19:00:00+03:00<br>
‚Ä¢ PRIORITY ‚Äî 0/1/2 (–Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π)<br>
‚Ä¢ ALLOW_CHANGE_DEADLINE ‚Äî N (–∑–∞–ø—Ä–µ—Ç —Å–¥–≤–∏–≥–∞ —Å—Ä–æ–∫–∞)<br>
<b style="color:var(--t2);margin-top:4px;display:block">–ß–µ–∫–ª–∏—Å—Ç task.checklistitem.add:</b><br>
‚Ä¢ –í—ã–∑–æ–≤: [TASK_ID, {TITLE: "—Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç—ã"}] –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–∞–±–æ—Ç—ã<br>
‚Ä¢ [!] –∫—Ä–∏—Ç–∏—á–Ω—ã–µ ‚Üí {TITLE: "‚ö† —Ä–∞–±–æ—Ç–∞", IS_IMPORTANT: "Y"}<br>
<b style="color:var(--t2);margin-top:4px;display:block">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞:</b><br>
{TO_NAME}, {SITE_NAME}, {GEN_NAME}, {HOURS}, {RESPONSIBLE}<br>
<b style="color:var(--y);margin-top:4px;display:block">–ò—Å—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å):</b><br>
–ë24 ‚Üí SCADA: –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–¥–∞—á–∏ ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –¢–û.<br>
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –ë24 ‚Üí –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º ‚Üí –ò—Å—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫ ‚Üí –°–æ–±—ã—Ç–∏–µ: ONTASKCOMPLETE
</div>
</div>
</div></div></div>

<script>
const $=id=>document.getElementById(id);
let S,cur,editId=null,delId=null,evts=[];try{S=JSON.parse(localStorage.getItem('s5s'))||{}}catch(e){S={}}cur=localStorage.getItem('s5c')||null;
let demo=false,demoIv=null,dStep=0;

// ===================== THEME TOGGLE =====================
(function(){const saved=localStorage.getItem('s5theme');if(saved)document.documentElement.setAttribute('data-theme',saved)})();
function toggleTheme(){
const html=document.documentElement;
const isLight=html.getAttribute('data-theme')==='light';
const next=isLight?'dark':'light';
html.setAttribute('data-theme',next);
localStorage.setItem('s5theme',next);
updateThemeBtn();
updateChartTheme();
if(typeof _snUpdateThemeColors==='function')_snUpdateThemeColors();
}
function updateThemeBtn(){
const btn=$('themeBtn');if(!btn)return;
const isLight=document.documentElement.getAttribute('data-theme')==='light';
btn.textContent=isLight?'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞':'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
}
function getChartColors(){
const isLight=document.documentElement.getAttribute('data-theme')==='light';
return{
grid:isLight?'rgba(0,0,0,.1)':'rgba(40,60,100,.35)',
border:isLight?'rgba(0,0,0,.15)':'rgba(40,60,100,.5)',
tick:isLight?'#4a5568':'#7a8ca0'
};
}
function updateChartTheme(){
const c=getChartColors();
if(typeof arcChart!=='undefined'&&arcChart){
arcChart.options.scales.x.grid.color=c.grid;
arcChart.options.scales.x.border.color=c.border;
arcChart.options.scales.x.ticks.color=c.tick;
arcChart.options.scales.y.grid.color=c.grid;
arcChart.options.scales.y.border.color=c.border;
arcChart.options.scales.y.ticks.color=c.tick;
arcChart.update('none');
}
if(typeof pwChart!=='undefined'&&pwChart){
pwChart.options.scales.x.grid.color=c.grid;
pwChart.options.scales.x.border.color=c.border;
pwChart.options.scales.x.ticks.color=c.tick;
pwChart.options.scales.y.grid.color=c.grid;
pwChart.options.scales.y.border.color=c.border;
pwChart.options.scales.y.ticks.color=c.tick;
pwChart.update('none');
}
}
setTimeout(updateThemeBtn,0);

// ===================== API / WS INTEGRATION LAYER =====================
const API_BASE = (window.location.port === '8011' || window.location.port === '80' || window.location.port === '')
    ? '' // nginx proxy ‚Äî same origin (ports 80, 8011, or default)
    : 'http://' + window.location.hostname + ':8010';
const WS_BASE = API_BASE
    ? API_BASE.replace(/^http/, 'ws')
    : 'ws://' + window.location.host;

const api = {
    async get(path) {
        const r = await fetch(API_BASE + path);
        if (!r.ok) throw new Error(`GET ${path}: ${r.status}`);
        return r.json();
    },
    async post(path, body) {
        const r = await fetch(API_BASE + path, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(`POST ${path}: ${r.status}`);
        return r.json();
    },
    async patch(path, body) {
        const r = await fetch(API_BASE + path, {
            method: 'PATCH', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(`PATCH ${path}: ${r.status}`);
        return r.json();
    },
    async put(path, body) {
        const r = await fetch(API_BASE + path, {
            method: 'PUT', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(`PUT ${path}: ${r.status}`);
        return r.json();
    },
    async del(path) {
        const r = await fetch(API_BASE + path, {method: 'DELETE'});
        if (!r.ok) throw new Error(`DELETE ${path}: ${r.status}`);
    },
};

// Maps device_id ‚Üí {siteKey, slot, deviceType}
let deviceSlotIndex = {};
// Cache latest WS metrics per device
let latestMetrics = {};
// Maps siteKey ‚Üí apiSiteId
let siteApiIds = {};
// Whether backend API is available
let apiAvailable = false;
let ws = null, wsReconnectTimer = null;
const WS_RECONNECT_DELAY = 3000;

async function loadFromAPI() {
    try {
        const apiSites = await api.get('/api/sites');
        S = {};
        deviceSlotIndex = {};
        siteApiIds = {};
        for (const s of apiSites) {
            const key = (s.code || ('site_' + s.id)).toLowerCase();
            siteApiIds[key] = s.id;
            S[key] = {
                _apiId: s.id,
                name: s.name,
                code: s.code,
                desc: s.description || '',
                responsible: '',
                g1: {}, g2: {}, spr: {},
            };
        }
        // Load devices for each site
        for (const s of apiSites) {
            const key = (s.code || ('site_' + s.id)).toLowerCase();
            try {
                const devices = await api.get('/api/devices?site_id=' + s.id);
                const gens = devices.filter(d => d.device_type === 'generator').sort((a, b) => a.id - b.id);
                const ats = devices.filter(d => d.device_type === 'ats');

                if (gens[0]) {
                    S[key].g1 = {
                        _deviceId: gens[0].id,
                        ip: gens[0].ip_address,
                        port: gens[0].port,
                        slaveId: gens[0].slave_id,
                        runHours: 0,
                    };
                    deviceSlotIndex[gens[0].id] = {siteKey: key, slot: 'g1'};
                }
                if (gens[1]) {
                    S[key].g2 = {
                        _deviceId: gens[1].id,
                        ip: gens[1].ip_address,
                        port: gens[1].port,
                        slaveId: gens[1].slave_id,
                        runHours: 0,
                    };
                    deviceSlotIndex[gens[1].id] = {siteKey: key, slot: 'g2'};
                }
                if (ats[0]) {
                    S[key].spr = {
                        _deviceId: ats[0].id,
                        ip: ats[0].ip_address,
                        port: ats[0].port,
                        slaveId: ats[0].slave_id,
                    };
                    deviceSlotIndex[ats[0].id] = {siteKey: key, slot: 'spr'};
                }
            } catch (e) {
                console.warn('Failed to load devices for site', s.id, e);
            }
        }
        if (!cur || !S[cur]) cur = Object.keys(S)[0] || null;
        apiAvailable = true;
        sv();
        ae('üåê –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ API');
        return true;
    } catch (e) {
        console.warn('API unavailable, using localStorage', e);
        return false;
    }
}

function connectWebSocket() {
    if (ws) { try { ws.close(); } catch(e){} }
    const url = WS_BASE + '/ws/metrics';
    try {
        ws = new WebSocket(url);
    } catch (e) {
        console.warn('WS connect error:', e);
        scheduleWsReconnect();
        return;
    }
    ws.onopen = () => {
        ae('üîå WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω');
        console.log('WS connected:', url);
    };
    ws.onclose = () => {
        console.log('WS closed');
        scheduleWsReconnect();
    };
    ws.onerror = (e) => {
        console.warn('WS error:', e);
    };
    ws.onmessage = (ev) => {
        try {
            const msg = JSON.parse(ev.data);
            if (msg.type === 'snapshot' && Array.isArray(msg.data)) {
                for (const m of msg.data) handleMetricsUpdate(m);
            } else if (msg.type === 'maintenance_alert') {
                // Maintenance alert from backend ‚Äî ignore for now (v5 handles TO locally)
            } else if (msg.device_id !== undefined) {
                handleMetricsUpdate(msg);
            }
        } catch(e) {}
    };
}

function scheduleWsReconnect() {
    if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
    wsReconnectTimer = setTimeout(connectWebSocket, WS_RECONNECT_DELAY);
}

function handleMetricsUpdate(m) {
    if (!m || !m.device_id) return;
    latestMetrics[m.device_id] = m;

    const info = deviceSlotIndex[m.device_id];
    if (!info) return;
    const {siteKey, slot} = info;

    // Only update if this site is currently displayed
    if (siteKey !== cur) return;

    if (slot === 'g1' || slot === 'g2') {
        // Update runHours in S from WS data
        if (m.run_hours != null && S[siteKey]?.[slot]) {
            S[siteKey][slot].runHours = m.run_hours + (m.run_minutes ? m.run_minutes / 60 : 0);
        }
        // Determine status
        let status = 'standby';
        if (m.online === false) status = 'alarm'; // CONN_LOST ‚Äî no connection to controller
        else if (m.alarm_common || m.alarm_shutdown) status = 'alarm';
        else if (m.alarm_warning) status = 'warning';
        else if (m.gen_status === 9 || m.gen_status_text === 'running') status = 'running';
        else if (m.gen_status >= 1 && m.gen_status <= 8) status = 'running'; // starting sequence
        else if (m.gen_status >= 10 && m.gen_status <= 14) status = 'standby'; // stopping sequence

        const rh = S[siteKey]?.[slot]?.runHours || 0;
        const basePower = m.power_total != null ? m.power_total : 0;

        applyGen(slot, status, rh, basePower, m.online !== false);
        // applyGenDetailed not needed ‚Äî applyGen now uses latestMetrics directly

        // Update summary cards
        updateSummary();
        // Update flow SVG
        updateFlowFromMetrics();
    }
    else if (slot === 'spr') {
        const gOn = (m.genset_status === 9);
        const mN = (m.mains_status === 0); // 0 = normal
        const bC = (m.busbar_switch === 3); // 3 = closed
        const mC = (m.mains_switch === 3);  // 3 = closed

        applySpr(gOn, mN, bC, mC, m.online !== false);
        if(m.online !== false) applySprDetailed(m);

        updateSummary();
        updateFlowFromMetrics();
    }
}

function applyGenDetailed(sl, m) {
    if (!m) return;
    const on = m.gen_status === 9 || (m.gen_status >= 1 && m.gen_status <= 8);
    const eT = $(sl + 'e');
    if (eT && on) {
        const p = m.power_total != null ? m.power_total : 0;
        const q = m.reactive_total != null ? m.reactive_total : 0;
        const pf = m.pf_avg != null ? m.pf_avg : 0;
        const uab = m.gen_uab != null ? m.gen_uab : 0;
        const ubc = m.gen_ubc != null ? m.gen_ubc : 0;
        const uca = m.gen_uca != null ? m.gen_uca : 0;
        const ia = m.current_a != null ? m.current_a : 0;
        const ib = m.current_b != null ? m.current_b : 0;
        const ic = m.current_c != null ? m.current_c : 0;
        const freq = m.gen_freq != null ? m.gen_freq : 0;
        const rh = S[cur]?.[sl]?.runHours || 0;
        const load = m.load_pct != null ? m.load_pct : 0;
        const ekwh = m.energy_kwh != null ? m.energy_kwh : 0;
        const starts = m.start_count != null ? m.start_count : 0;
        const pa = m.power_a != null ? m.power_a : 0;
        const pb = m.power_b != null ? m.power_b : 0;
        const pc = m.power_c != null ? m.power_c : 0;

        eT.innerHTML = `<div class="mg"><div class="mc"><div class="ml">P</div><div class="mv vg">${p.toFixed(1)}<span class="mu">–∫–í—Ç</span></div></div><div class="mc"><div class="ml">Q</div><div class="mv vn">${q.toFixed(1)}<span class="mu">–∫–≤–∞—Ä</span></div></div><div class="mc"><div class="ml">Cos œÜ</div><div class="mv vn">${pf.toFixed(3)}</div></div></div><table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U</th><th>I</th><th>P</th></tr></thead><tbody><tr><td class="ph">A-B</td><td>${uab.toFixed(0)}</td><td>${ia.toFixed(1)}</td><td>${pa.toFixed(1)}</td></tr><tr><td class="ph">B-C</td><td>${ubc.toFixed(0)}</td><td>${ib.toFixed(1)}</td><td>${pb.toFixed(1)}</td></tr><tr><td class="ph">C-A</td><td>${uca.toFixed(0)}</td><td>${ic.toFixed(1)}</td><td>${pc.toFixed(1)}</td></tr></tbody></table><div class="mg mg4" style="margin-top:10px"><div class="mc"><div class="ml">–ù–∞–≥—Ä—É–∑–∫–∞</div><div class="mv vn">${load}%</div></div><div class="mc"><div class="ml">–≠–Ω–µ—Ä–≥–∏—è</div><div class="mv vn">${ekwh}<span class="mu">–∫–í—Ç¬∑—á</span></div></div><div class="mc"><div class="ml">–ú–æ—Ç–æ—á–∞—Å—ã</div><div class="mv vn">${rh.toFixed(0)}<span class="mu">—á</span></div></div><div class="mc"><div class="ml">–ü—É—Å–∫–æ–≤</div><div class="mv vn">${starts}</div></div></div>`;
    }
    const mT = $(sl + 'm');
    if (mT && on) {
        const ct = m.coolant_temp != null ? m.coolant_temp : '‚Äî';
        const op = m.oil_pressure != null ? m.oil_pressure : '‚Äî';
        const rpm = m.engine_speed != null ? m.engine_speed : '‚Äî';
        const oilT = m.oil_temp != null ? m.oil_temp : '‚Äî';
        const fuel = m.fuel_level != null ? m.fuel_level : '‚Äî';
        const fc = m.fuel_consumption != null ? m.fuel_consumption : '‚Äî';
        const turbo = m.turbo_pressure != null ? m.turbo_pressure : '‚Äî';
        const batt = m.battery_volt != null ? m.battery_volt : '‚Äî';
        const ctC = (typeof ct === 'number' && ct > 95) ? 'va' : (typeof ct === 'number' && ct > 88) ? 'vw' : 'vn';
        const opC = (typeof op === 'number' && op < 300) ? 'va' : 'vn';
        const fuelC = (typeof fuel === 'number' && fuel < 50) ? 'vw' : 'vn';
        mT.innerHTML = `<div class="mg"><div class="mc"><div class="ml">–û–±–æ—Ä–æ—Ç—ã</div><div class="mv vn">${rpm}</div></div><div class="mc"><div class="ml">–¢–µ–º–ø.–û–ñ</div><div class="mv ${ctC}">${ct}¬∞C</div></div><div class="mc"><div class="ml">–î–∞–≤–ª.–º–∞—Å–ª–∞</div><div class="mv ${opC}">${op} –∫–ü–∞</div></div><div class="mc"><div class="ml">–¢–µ–º–ø.–º–∞—Å–ª–∞</div><div class="mv vn">${oilT}¬∞C</div></div><div class="mc"><div class="ml">–¢–æ–ø–ª–∏–≤–æ</div><div class="mv ${fuelC}">${fuel}%</div></div><div class="mc"><div class="ml">–†–∞—Å—Ö–æ–¥</div><div class="mv vn">${fc} –ª/—á</div></div><div class="mc"><div class="ml">–¢—É—Ä–±–æ</div><div class="mv vn">${turbo} –∫–ü–∞</div></div><div class="mc"><div class="ml">–ë–∞—Ç–∞—Ä–µ—è</div><div class="mv vn">${typeof batt === 'number' ? batt.toFixed(1) : batt}–í</div></div></div>`;
    }
}

const GENSET_ST_TEXT={0:'–û–∂–∏–¥–∞–Ω–∏–µ',1:'–ü—Ä–æ–≥—Ä–µ–≤',2:'–ü–æ–¥–∞—á–∞ —Ç–æ–ø–ª–∏–≤–∞',3:'–°—Ç–∞—Ä—Ç–µ—Ä',4:'–ü–∞—É–∑–∞ —Å—Ç–∞—Ä—Ç–µ—Ä–∞',5:'–ü—Ä–æ–±–Ω—ã–π –ø—É—Å–∫',6:'–•–æ–ª–æ—Å—Ç–æ–π —Ö–æ–¥',7:'–ü—Ä–æ–≥—Ä–µ–≤ –í–°',8:'–û–∂–∏–¥. –Ω–∞–≥—Ä—É–∑–∫–∏',9:'–†–∞–±–æ—Ç–∞',10:'–û—Ö–ª–∞–∂–¥. –í–°',11:'–•–æ–ª–æ—Å—Ç–æ–π —Å—Ç–æ–ø',12:'–ê–≤–∞—Ä–∏–π–Ω—ã–π —Å—Ç–æ–ø',13:'–û–∂–∏–¥. –æ—Å—Ç–∞–Ω–æ–≤–∫–∏',14:'–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∞'};
const SW_ST_TEXT={0:'–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è',1:'–ó–∞–¥–µ—Ä–∂. –≤–∫–ª.',2:'–û–∂–∏–¥. –∑–∞–º—ã–∫–∞–Ω–∏—è',3:'–ó–∞–º–∫–Ω—É—Ç',4:'–°–±—Ä–æ—Å –Ω–∞–≥—Ä—É–∑–∫–∏',5:'–ó–∞–¥–µ—Ä–∂. –æ—Ç–∫–ª.',6:'–û–∂–∏–¥. —Ä–∞–∑–º—ã–∫–∞–Ω–∏—è',7:'–†–∞–∑–æ–º–∫–Ω—É—Ç'};
const MAINS_ST_TEXT={0:'–°–µ—Ç—å –Ω–æ—Ä–º–∞',1:'–ù–æ—Ä–º–∞ (–∑–∞–¥–µ—Ä–∂–∫–∞)',2:'–ê–≤–∞—Ä–∏—è',3:'–ê–≤–∞—Ä–∏—è (–∑–∞–¥–µ—Ä–∂–∫–∞)'};
const MAINS_ST_RU={0:'–ù–û–†–ú–ê',1:'–ù–û–†–ú–ê (–∑–∞–¥–µ—Ä–∂–∫–∞)',2:'–ê–í–ê–†–ò–Ø',3:'–ê–í–ê–†–ò–Ø (–∑–∞–¥–µ—Ä–∂–∫–∞)'};
function _v(v,d){return v!=null?v:d}
function _f1(v){return v!=null?v.toFixed(1):'‚Äî'}
function _f2(v){return v!=null?v.toFixed(2):'‚Äî'}

function applySprDetailed(m) {
    if (!m) return;
    const mN = (m.mains_status === 0);
    const bC = (m.busbar_switch === 3);
    const mC = (m.mains_switch === 3);
    const gOn = (m.genset_status === 9);
    // Get G1 & G2 data for overview
    const g1id = getDeviceIdForSlot('g1');
    const g2id = getDeviceIdForSlot('g2');
    const g1 = g1id ? latestMetrics[g1id] : null;
    const g2 = g2id ? latestMetrics[g2id] : null;
    const g1on = g1 && g1.online !== false;
    const g2on = g2 && g2.online !== false;

    // === –û–ë–ó–û–† TAB ===
    const sprov=$('sprov');
    if(sprov){
    // -- Helper: build gen panel HTML for a generator --
    function _genPanel(gx, gxon, label, gxid) {
        let st, stT, stC;
        if (!gxon) {
            st = -1; stT = '–ù–µ—Ç —Å–≤—è–∑–∏'; stC = 'background:rgba(255,64,96,.12);color:var(--r)';
        } else {
            st = gx.gen_status != null ? gx.gen_status : (m.genset_status != null ? m.genset_status : -1);
            stT = GENSET_ST_TEXT[st] || '‚Äî';
            stC = st === 9 ? 'background:rgba(0,224,154,.15);color:#00e09a' : 'background:var(--bg);color:var(--t3)';
        }
        let body;
        if (gxon) {
            const P=_f1(gx.power_total), Q=_f1(gx.reactive_total);
            const Uab=Math.round(_v(gx.gen_uab,0)), Ubc=Math.round(_v(gx.gen_ubc,0)), Uca=Math.round(_v(gx.gen_uca,0));
            const Ia=_f1(gx.current_a), Ib=_f1(gx.current_b), Ic=_f1(gx.current_c);
            const F=_f2(gx.gen_freq);
            body = `<div class="ov-pq"><span style="color:var(--g)"><small>P:</small>${P} –∫–í—Ç</span><span style="color:var(--t3)"><small>Q:</small>${Q} –∫–≤–∞—Ä</span></div>
<table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U –ª–∏–Ω, –í</th><th>I, –ê</th></tr></thead><tbody>
<tr><td class="ph">A</td><td>${Uab}</td><td>${Ia}</td></tr>
<tr><td class="ph">B</td><td>${Ubc}</td><td>${Ib}</td></tr>
<tr><td class="ph">C</td><td>${Uca}</td><td>${Ic}</td></tr></tbody></table>
<div style="text-align:center;margin-top:6px;font-family:var(--m)"><span style="color:var(--g);font-size:13px;font-weight:600">f: ${F} –ì—Ü</span></div>`;
        } else {
            body = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px 10px;color:var(--t4)">
<div style="font-size:22px;margin-bottom:6px;opacity:.4">‚ö°</div>
<div style="font-size:11px;font-weight:500;color:var(--t3)">${label} –æ—Ñ–ª–∞–π–Ω</div>
<div style="font-size:10px">–ù–µ—Ç —Å–≤—è–∑–∏ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º</div></div>`;
        }
        const dotC = gxon ? 'var(--g)' : 'var(--r)';
        return `<div class="ov-panel"><div class="ov-hdr"><div class="ov-lbl"><span style="color:${dotC}">‚óè</span> ${label}</div><span class="ov-bdg" style="${stC}">${stT}</span></div>${body}</div>`;
    }
    const g1Html = g1id ? _genPanel(g1, g1on, '–ì1', g1id) : '';
    const g2Html = g2id ? _genPanel(g2, g2on, '–ì2', g2id) : '';
    // -- Mains panel --
    const mStR=MAINS_ST_RU[m.mains_status]||'‚Äî';
    const mStC=mN?'background:rgba(0,188,212,.15);color:#00bcd4':'background:rgba(255,64,96,.15);color:#ff4060';
    const mP=_f1(m.mains_total_p);
    const mQ=_f1(m.mains_total_q);
    const mUab=_v(m.mains_uab,'‚Äî');const mUbc=_v(m.mains_ubc,'‚Äî');const mUca=_v(m.mains_uca,'‚Äî');
    const mUa=_v(m.mains_ua,'‚Äî');const mUb=_v(m.mains_ub,'‚Äî');const mUc=_v(m.mains_uc,'‚Äî');
    const mIa=_f1(m.mains_ia);const mIb=_f1(m.mains_ib);const mIc=_f1(m.mains_ic);
    const mF=_f2(m.mains_freq);
    // -- Busbar --
    const bp=_v(m.busbar_p,0);const bq=_v(m.busbar_q,0);const bi=_v(m.busbar_current,0);
    const bU=_v(m.busbar_uab,0);const bF=_v(m.busbar_freq,0);
    // -- Running --
    const rh=_v(m.running_hours_a,_v(m.maint_hours,0));
    const rst=_v(m.start_times_a,0);
    const kwh=_v(m.accum_kwh,0);
    const batV=_f1(m.battery_volt);
    const maintH=_v(m.maint_hours,0);
    // -- Switches --
    const bSwC=bC?'var(--g)':'var(--r)';const mSwC=mC?'var(--g)':'var(--r)';
    const bSwT=bC?'–ó–ê–ú–ö–ù–£–¢':'–†–ê–ó–û–ú–ö–ù';const mSwT=mC?'–ó–ê–ú–ö–ù–£–¢':'–†–ê–ó–û–ú–ö–ù';
    const lineOn=bC||mC;
    // Grid: if 2 gens + mains = 3 columns, if 1 gen + mains = 2 columns
    const genCount = (g1id?1:0)+(g2id?1:0);
    const gridCols = genCount + 1; // +1 for mains
    sprov.innerHTML=`<div class="ov-grid" style="grid-template-columns:repeat(${gridCols},1fr)">
${g1Html}${g2Html}
<div class="ov-panel"><div class="ov-hdr"><div class="ov-lbl"><span style="color:var(--b)">‚óè</span> –°–µ—Ç—å</div><span class="ov-bdg" style="${mStC}">${mStR}</span></div>
<div class="ov-pq"><span style="color:var(--b)"><small>P:</small>${mP} –∫–í—Ç</span><span style="color:var(--t3)"><small>Q:</small>${mQ} –∫–≤–∞—Ä</span></div>
<table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U –ª–∏–Ω, –í</th><th>U —Ñ–∞–∑, –í</th><th>I, –ê</th></tr></thead><tbody>
<tr><td class="ph">A</td><td>${mUab}</td><td>${mUa}</td><td>${mIa}</td></tr>
<tr><td class="ph">B</td><td>${mUbc}</td><td>${mUb}</td><td>${mIb}</td></tr>
<tr><td class="ph">C</td><td>${mUca}</td><td>${mUc}</td><td>${mIc}</td></tr></tbody></table>
<div style="text-align:center;margin-top:6px;font-family:var(--m)"><span style="color:var(--b);font-size:13px;font-weight:600">f: ${mF} –ì—Ü</span></div></div></div>
<div class="ov-bus"><div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="color:var(--y)">‚óè</span><span style="font-size:12px;font-weight:600">–®–ò–ù–ê</span><span style="margin-left:auto;font-size:10px;color:var(--t3)">‚Üí –ù–∞–≥—Ä—É–∑–∫–∞</span></div>
<div class="ov-bus-grid"><div><div class="ov-bv">${(typeof bp==='number'?bp:0).toFixed(1)}</div><div class="ov-bl">P, –∫–í—Ç</div></div><div><div class="ov-bv">${(typeof bq==='number'?bq:0).toFixed(1)}</div><div class="ov-bl">Q, –∫–≤–∞—Ä</div></div><div><div class="ov-bv">${(typeof bi==='number'?bi:0).toFixed(0)}</div><div class="ov-bl">I, –ê</div></div><div><div class="ov-bv">${bU}</div><div class="ov-bl">U, –í</div></div><div><div class="ov-bv">${(typeof bF==='number'?bF:0).toFixed(2)}</div><div class="ov-bl">f, –ì—Ü</div></div></div></div>
<div class="ov-sw"><div class="ov-sw-item"><div class="ov-sw-lbl">–ê–≤—Ç. —à–∏–Ω—ã</div><div style="font-family:var(--m);font-size:11px;font-weight:600;color:${bSwC}">${bSwT}</div></div>
<div class="ov-sw-line${lineOn?' on':''}"></div>
<div style="font-size:10px;font-weight:600;color:var(--y)">–®–ò–ù–ê</div>
<div class="ov-sw-line${lineOn?' on':''}"></div>
<div class="ov-sw-item"><div class="ov-sw-lbl">–ê–≤—Ç. —Å–µ—Ç–∏</div><div style="font-family:var(--m);font-size:11px;font-weight:600;color:${mSwC}">${mSwT}</div></div></div>
<div class="ov-stats"><div class="ov-st"><div class="ov-stv" style="color:var(--g)">${(typeof kwh==='number'?kwh:0).toLocaleString('ru-RU')}</div><div class="ov-stl">–∫–í—Ç¬∑—á</div></div>
<div class="ov-st"><div class="ov-stv" style="color:var(--t)">${rh} —á</div><div class="ov-stl">–ù–∞—Ä–∞–±–æ—Ç–∫–∞ ¬∑ –ü—É—Å–∫–æ–≤: ${rst}</div></div>
<div class="ov-st"><div class="ov-stv" style="color:var(--y)">${maintH} —á</div><div class="ov-stl">–¢–û –æ—Å—Ç–∞–ª–æ—Å—å</div></div>
<div class="ov-st"><div class="ov-stv" style="color:var(--g)">${batV} –í</div><div class="ov-stl">–ë–∞—Ç–∞—Ä–µ—è</div></div></div>`;
    }

    // === –®–ò–ù–ê TAB (sprb) - unchanged ===
    const sprb = $('sprb');
    if (sprb) {
        const bp2=_v(m.busbar_p,0);const bq2=_v(m.busbar_q,0);const bi2=_v(m.busbar_current,0);
        sprb.innerHTML=`<div class="mg"><div class="mc"><div class="ml">P —à–∏–Ω—ã</div><div class="mv vg">${(typeof bp2==='number'?bp2:0).toFixed(1)}<span class="mu">–∫–í—Ç</span></div></div><div class="mc"><div class="ml">Q</div><div class="mv vn">${(typeof bq2==='number'?bq2:0).toFixed(1)}<span class="mu">–∫–≤–∞—Ä</span></div></div><div class="mc"><div class="ml">I</div><div class="mv vn">${(typeof bi2==='number'?bi2:0).toFixed(0)}<span class="mu">–ê</span></div></div></div><table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U –ª–∏–Ω</th><th>U —Ñ–∞–∑</th></tr></thead><tbody><tr><td class="ph">A-B</td><td>${_v(m.busbar_uab,0)}</td><td>${_v(m.busbar_ua,0)}</td></tr><tr><td class="ph">B-C</td><td>${_v(m.busbar_ubc,0)}</td><td>${_v(m.busbar_ub,0)}</td></tr><tr><td class="ph">C-A</td><td>${_v(m.busbar_uca,0)}</td><td>${_v(m.busbar_uc,0)}</td></tr></tbody></table>`;
    }

    // === –°–ï–¢–¨ TAB (sprm) - enhanced with per-phase table ===
    const sprm = $('sprm');
    if (sprm) {
        const mStR2=MAINS_ST_RU[m.mains_status]||'‚Äî';
        const stCls=mN?'vg':'va';
        const mPt=_f1(m.mains_total_p);const mQt=_f1(m.mains_total_q);const mPf=m.mains_pf_avg!=null?m.mains_pf_avg.toFixed(2):'‚Äî';
        sprm.innerHTML=`<div class="mg"><div class="mc"><div class="ml">P —Å–µ—Ç–∏</div><div class="mv vb">${mPt}<span class="mu">–∫–í—Ç</span></div></div><div class="mc"><div class="ml">Q —Å–µ—Ç–∏</div><div class="mv vn">${mQt}<span class="mu">–∫–≤–∞—Ä</span></div></div><div class="mc"><div class="ml">cos œÜ</div><div class="mv vn">${mPf}</div></div></div>
<table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U –ª–∏–Ω, –í</th><th>U —Ñ–∞–∑, –í</th><th>I, –ê</th><th>P, –∫–í—Ç</th><th>cos œÜ</th></tr></thead><tbody>
<tr><td class="ph">A</td><td>${_v(m.mains_uab,'‚Äî')}</td><td>${_v(m.mains_ua,'‚Äî')}</td><td>${_f1(m.mains_ia)}</td><td>${_f1(m.mains_p_a)}</td><td>${m.mains_pf_a!=null?m.mains_pf_a.toFixed(2):'‚Äî'}</td></tr>
<tr><td class="ph">B</td><td>${_v(m.mains_ubc,'‚Äî')}</td><td>${_v(m.mains_ub,'‚Äî')}</td><td>${_f1(m.mains_ib)}</td><td>${_f1(m.mains_p_b)}</td><td>${m.mains_pf_b!=null?m.mains_pf_b.toFixed(2):'‚Äî'}</td></tr>
<tr><td class="ph">C</td><td>${_v(m.mains_uca,'‚Äî')}</td><td>${_v(m.mains_uc,'‚Äî')}</td><td>${_f1(m.mains_ic)}</td><td>${_f1(m.mains_p_c)}</td><td>${m.mains_pf_c!=null?m.mains_pf_c.toFixed(2):'‚Äî'}</td></tr></tbody></table>
<div style="text-align:center;margin-top:6px;font-family:var(--m)"><span style="color:var(--b);font-size:13px;font-weight:600">f: ${_f2(m.mains_freq)} –ì—Ü</span> <span style="margin-left:12px;font-size:11px;color:var(--t3)">–°—Ç–∞—Ç—É—Å:</span> <span class="mv ${stCls}" style="font-size:11px">${mStR2}</span></div>`;
    }

    // === –ö–û–ú–ú–£–¢–ê–¶–ò–Ø TAB (sprs) - enhanced ===
    const sprs = $('sprs');
    if (sprs) {
        const bSwV=m.busbar_switch!=null?m.busbar_switch:-1;
        const mSwV=m.mains_switch!=null?m.mains_switch:-1;
        const bSwT2=SW_ST_TEXT[bSwV]||'‚Äî';
        const mSwT2=SW_ST_TEXT[mSwV]||'‚Äî';
        const bSwC2=bSwV===3?'var(--g)':bSwV===7?'var(--r)':'var(--y)';
        const mSwC2=mSwV===3?'var(--g)':mSwV===7?'var(--r)':'var(--y)';
        const gStV=m.genset_status!=null?m.genset_status:-1;
        const gStT2=GENSET_ST_TEXT[gStV]||'‚Äî';
        const gStC2=gStV===9?'var(--g)':gStV===0?'var(--t3)':'var(--y)';
        const mStV=m.mains_status!=null?m.mains_status:-1;
        const mStT2=MAINS_ST_TEXT[mStV]||'‚Äî';
        const mStC2=mStV===0?'var(--g)':mStV===2||mStV===3?'var(--r)':'var(--y)';
        const ind=m.indicators!=null?m.indicators:0;
        const lineOn2=bC||mC;
        sprs.innerHTML=`<div class="ov-sw" style="margin-bottom:12px"><div class="ov-sw-item"><div class="ov-sw-lbl">–ê–≤—Ç. —à–∏–Ω—ã</div><div style="font-family:var(--m);font-size:11px;font-weight:600;color:${bSwC2}">${bSwT2}</div></div>
<div class="ov-sw-line${lineOn2?' on':''}"></div><div style="font-size:10px;font-weight:600;color:var(--y)">–®–ò–ù–ê</div><div class="ov-sw-line${lineOn2?' on':''}"></div>
<div class="ov-sw-item"><div class="ov-sw-lbl">–ê–≤—Ç. —Å–µ—Ç–∏</div><div style="font-family:var(--m);font-size:11px;font-weight:600;color:${mSwC2}">${mSwT2}</div></div></div>
<div class="mg mg2"><div class="mc"><div class="ml">–°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</div><div class="mv" style="color:${gStC2}">${gStT2}</div></div><div class="mc"><div class="ml">–°—Ç–∞—Ç—É—Å —Å–µ—Ç–∏</div><div class="mv" style="color:${mStC2}">${mStT2}</div></div></div>
<div class="ind-grid">
<div class="ind-item"><div class="ind-dot" style="background:${ind&1?'var(--g)':'var(--t4)'}"></div>–°–µ—Ç—å –Ω–æ—Ä–º–∞</div>
<div class="ind-item"><div class="ind-dot" style="background:${ind&2?'var(--g)':'var(--t4)'}"></div>–°–µ—Ç—å –∑–∞–º–∫–Ω.</div>
<div class="ind-item"><div class="ind-dot" style="background:${ind&4?'var(--g)':'var(--t4)'}"></div>–®–∏–Ω–∞ –Ω–æ—Ä–º–∞</div>
<div class="ind-item"><div class="ind-dot" style="background:${ind&8?'var(--g)':'var(--t4)'}"></div>–®–∏–Ω–∞ –∑–∞–º–∫–Ω.</div>
<div class="ind-item"><div class="ind-dot" style="background:${ind&16?'var(--r)':'var(--t4)'}"></div>–ê–≤–∞—Ä–∏—è</div>
<div class="ind-item"><div class="ind-dot" style="background:${ind&32?'var(--g)':'var(--t4)'}"></div>–†–∞–±–æ—Ç–∞</div></div>`;
    }

    // === UPDATE CONTROL TAB BUTTONS ===
    updateSprControlMode(m);
}

let _summaryIssues = []; // shared for popup
function updateSummary() {
    const s = S[cur];
    if (!s) return;

    // Collect powers and issues from latestMetrics
    let totalP = 0, genP = 0, mainsU = null, hasAlarm = false, hasWarning = false, running = 0;
    let allOffline = true, deviceCount = 0, anyOffline = false, onlineCount = 0;
    const issues = [];

    const slotNames = {g1: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1', g2: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2', spr: '–®–ü–†'};

    for (const [devId, m] of Object.entries(latestMetrics)) {
        const info = deviceSlotIndex[devId];
        if (!info || info.siteKey !== cur) continue;
        deviceCount++;
        const devName = slotNames[info.slot] || ('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ' + devId);

        if (m.online === false) {
            anyOffline = true;
            issues.push({severity: 'error', text: devName + ' ‚Äî –Ω–µ—Ç —Å–≤—è–∑–∏'});
        } else {
            allOffline = false;
            onlineCount++;
        }

        if (info.slot === 'g1' || info.slot === 'g2') {
            const p = m.power_total || 0;
            if (m.online !== false && m.gen_status === 9) { genP += p; running++; }
            if (m.online !== false && (m.alarm_common || m.alarm_shutdown)) {
                hasAlarm = true;
                issues.push({severity: 'error', text: devName + ' ‚Äî –∞–≤–∞—Ä–∏—è'});
            }
            if (m.online !== false && m.alarm_warning) {
                hasWarning = true;
                issues.push({severity: 'warn', text: devName + ' ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ'});
            }
        }
        if (info.slot === 'spr') {
            if (m.online !== false) {
                totalP = m.busbar_p || 0;
                mainsU = m.mains_uab;
                if (m.alarm_common) {
                    hasAlarm = true;
                    issues.push({severity: 'error', text: devName + ' ‚Äî –∞–≤–∞—Ä–∏—è'});
                }
                // Mains lost
                if (m.mains_status != null && m.mains_status !== 0) {
                    issues.push({severity: 'warn', text: '–°–µ—Ç—å ‚Äî –∞–≤–∞—Ä–∏–π–Ω–∞—è'});
                }
            }
        }
    }
    if (!totalP) totalP = genP;
    _summaryIssues = issues;

    const el = n => document.getElementById(n);
    if (el('sP')) el('sP').innerHTML = allOffline ? '‚Äî<span class="su">–∫–í—Ç</span>' : `${totalP.toFixed(1)}<span class="su">–∫–í—Ç</span>`;
    if (el('sPg')) el('sPg').innerHTML = allOffline ? '‚Äî<span class="su">–∫–í—Ç</span>' : `${genP.toFixed(1)}<span class="su">–∫–í—Ç</span>`;
    if (el('sU')) el('sU').innerHTML = mainsU != null ? `${mainsU.toFixed(0)}<span class="su">–í</span>` : '‚Äî<span class="su">–í</span>';
    if (el('sG')) el('sG').innerHTML = `${onlineCount}<span class="su">/${deviceCount}</span>`;
    if (el('sSt')) {
        const hasIssues = issues.length > 0;
        const clk = hasIssues ? ' onclick="showSummaryIssues(event)" style="cursor:pointer"' : '';
        if (deviceCount > 0 && allOffline) {
            el('sSt').innerHTML = `<span class="bdg bdg-a"${clk}>‚óè –ù–µ—Ç —Å–≤—è–∑–∏ (${issues.length})</span>`;
        } else if (hasAlarm || anyOffline) {
            const lbl = hasAlarm ? '–ê–≤–∞—Ä–∏—è' : '–û—à–∏–±–∫–∞';
            el('sSt').innerHTML = `<span class="bdg bdg-a"${clk}>‚óè ${lbl} (${issues.length})</span>`;
        } else if (hasWarning) {
            el('sSt').innerHTML = `<span class="bdg bdg-w"${clk}>‚óè –ü—Ä–µ–¥—É–ø—Ä. (${issues.length})</span>`;
        } else if (running > 0 || totalP > 0) {
            el('sSt').innerHTML = '<span class="bdg bdg-ok">‚óè –ù–æ—Ä–º–∞</span>';
        } else {
            el('sSt').innerHTML = '<span class="bdg bdg-off">‚óè –°—Ç–æ–ø</span>';
        }
    }
}

function showSummaryIssues(e) {
    e.stopPropagation();
    // Remove existing popup
    let pop = document.getElementById('summaryPopup');
    if (pop) { pop.remove(); return; }
    if (!_summaryIssues.length) return;
    pop = document.createElement('div');
    pop.id = 'summaryPopup';
    pop.className = 'sum-popup';
    let html = '<div class="sum-pop-hdr">–ü—Ä–æ–±–ª–µ–º—ã –æ–±—ä–µ–∫—Ç–∞</div>';
    for (const iss of _summaryIssues) {
        const ic = iss.severity === 'error' ? 'üî¥' : 'üü°';
        html += `<div class="sum-pop-row">${ic} ${iss.text}</div>`;
    }
    pop.innerHTML = html;
    // Position near the badge
    const rect = e.target.getBoundingClientRect();
    pop.style.top = (rect.bottom + 8) + 'px';
    pop.style.left = Math.max(8, rect.left - 60) + 'px';
    document.body.appendChild(pop);
    // Close on click outside
    setTimeout(() => {
        document.addEventListener('click', function _closePop() {
            const p = document.getElementById('summaryPopup');
            if (p) p.remove();
            document.removeEventListener('click', _closePop);
        }, {once: true});
    }, 50);
}

function updateFlowFromMetrics() {
    const pf = $('pflow');
    if (!pf || !cur || !S[cur]) return;

    let g1on = false, g2on = false, mN = false, bC = false, mC = false, p1 = 0, p2 = 0, mP = 0, busP = 0;
    // g1st/g2st: 0=–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, 1=–æ—Ñ–ª–∞–π–Ω, 2=–æ–Ω–ª–∞–π–Ω
    const g1id = getDeviceIdForSlot('g1'), g2id = getDeviceIdForSlot('g2');
    let g1st = g1id ? 1 : 0, g2st = g2id ? 1 : 0;

    for (const [devId, m] of Object.entries(latestMetrics)) {
        const info = deviceSlotIndex[devId];
        if (!info || info.siteKey !== cur) continue;
        if (info.slot === 'g1') { g1on = m.gen_status === 9; p1 = m.power_total || 0; if(m.online !== false) g1st = 2; }
        if (info.slot === 'g2') { g2on = m.gen_status === 9; p2 = m.power_total || 0; if(m.online !== false) g2st = 2; }
        if (info.slot === 'spr') {
            mN = (m.mains_status === 0);
            bC = (m.busbar_switch === 3);
            mC = (m.mains_switch === 3);
            mP = m.mains_total_p || 0;
            busP = m.busbar_p || 0;
        }
    }

    pf.innerHTML = flowSvg(g1on, g2on, mN, bC, mC, p1, p2, mP, busP, g1st, g2st);
}

function getDeviceIdForSlot(slot) {
    if (!cur || !S[cur]) return null;
    return S[cur][slot]?._deviceId || null;
}

// ===================== END API / WS LAYER =====================
const DEF_TPL={name:'–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π',intervals:[
{id:'to1',name:'–¢–û-1',hours:250,tasks:[{id:1,text:'–ó–∞–º–µ–Ω–∞ –º–æ—Ç–æ—Ä–Ω–æ–≥–æ –º–∞—Å–ª–∞',c:1},{id:2,text:'–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª—è–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞',c:1},{id:3,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –û–ñ',c:1},{id:4,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ç—è–∂–µ–Ω–∏—è —Ä–µ–º–Ω–µ–π',c:0},{id:5,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞',c:0},{id:6,text:'–û—Å–º–æ—Ç—Ä –Ω–∞ —É—Ç–µ—á–∫–∏',c:0},{id:7,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π –ø—Ä–∏–±–æ—Ä–æ–≤',c:0}]},
{id:'to2',name:'–¢–û-2',hours:500,tasks:[{id:1,text:'–ó–∞–º–µ–Ω–∞ –º–æ—Ç–æ—Ä–Ω–æ–≥–æ –º–∞—Å–ª–∞',c:1},{id:2,text:'–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª—è–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞',c:1},{id:3,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –û–ñ',c:1},{id:4,text:'–ó–∞–º–µ–Ω–∞ –≤–æ–∑–¥—É—à–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞',c:1},{id:5,text:'–ó–∞–º–µ–Ω–∞ —Ç–æ–ø–ª–∏–≤–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞',c:1},{id:6,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä—Å—É–Ω–æ–∫',c:0},{id:7,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è –º–∞—Å–ª–∞',c:0},{id:8,text:'–°–ª–∏–≤ –æ—Ç—Å—Ç–æ—è –∏–∑ –±–∞–∫–∞',c:0}]},
{id:'to3',name:'–¢–û-3',hours:1000,tasks:[{id:1,text:'–ó–∞–º–µ–Ω–∞ –º–æ—Ç–æ—Ä–Ω–æ–≥–æ –º–∞—Å–ª–∞',c:1},{id:2,text:'–ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤',c:1},{id:3,text:'–ó–∞–º–µ–Ω–∞ –û–ñ –ø–æ–ª–Ω–æ—Å—Ç—å—é',c:1},{id:4,text:'–ü—Ä–æ–º—ã–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è',c:1},{id:5,text:'–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –∫–ª–∞–ø–∞–Ω–Ω—ã—Ö –∑–∞–∑–æ—Ä–æ–≤',c:1},{id:6,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏',c:1},{id:7,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—É—Ä–±–æ–∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞',c:0},{id:8,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —Å—Ç–∞—Ä—Ç–µ—Ä–∞',c:0},{id:9,text:'–û—á–∏—Å—Ç–∫–∞ —Ä–∞–¥–∏–∞—Ç–æ—Ä–∞',c:0}]},
{id:'to4',name:'–¢–û-4',hours:2000,tasks:[{id:1,text:'–í—Å–µ —Ä–∞–±–æ—Ç—ã –¢–û-3',c:1},{id:2,text:'–ó–∞–º–µ–Ω–∞ —Ä–µ–º–Ω—è –ì–†–ú',c:1},{id:3,text:'–ó–∞–º–µ–Ω–∞ –≤–æ–¥—è–Ω–æ–≥–æ –Ω–∞—Å–æ—Å–∞',c:1},{id:4,text:'–ó–∞–º–µ–Ω–∞ –ø—Ä–∏–≤–æ–¥–Ω—ã—Ö —Ä–µ–º–Ω–µ–π',c:1},{id:5,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–æ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è',c:0},{id:6,text:'–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≠–ë–£',c:0},{id:7,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤',c:0},{id:8,text:'–ü–æ–ª–Ω—ã–π –æ—Å–º–æ—Ç—Ä',c:1}]}
]};
function getTpl(){try{const raw=localStorage.getItem('s5tpl');return raw?JSON.parse(raw):JSON.parse(JSON.stringify(DEF_TPL))}catch(e){return JSON.parse(JSON.stringify(DEF_TPL))}}
function saveTpl(t){localStorage.setItem('s5tpl',JSON.stringify(t))}
function getTOData(site,dev){try{return JSON.parse(localStorage.getItem('s5to_'+site+'_'+dev))||{hoursAtLastTO:0,lastTOId:null,history:[]}}catch(e){return{hoursAtLastTO:0,lastTOId:null,history:[]}}}
function saveTOData(site,dev,d){localStorage.setItem('s5to_'+site+'_'+dev,JSON.stringify(d))}
function getNextTO(rh,site,dev){
const tpl=getTpl(),td=getTOData(site||'',dev||''),lastH=td.hoursAtLastTO||0;
// –ï—Å–ª–∏ –º–æ—Ç–æ—á–∞—Å—ã 0 –∏ –Ω–∏—á–µ–≥–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –ø–µ—Ä–≤–æ–µ –¢–û
if(rh<=0&&lastH<=0)return{name:tpl.intervals[0]?.name||'–¢–û-1',hours:tpl.intervals[0]?.hours||250,remain:tpl.intervals[0]?.hours||250,pct:0,tasks:tpl.intervals[0]?.tasks||[],since:0,dueAt:tpl.intervals[0]?.hours||250,unknown:false};
// –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∞ –º–æ—Ç–æ—á–∞—Å—ã —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
if(!td.lastTOId&&rh>0)return{name:'–¢–û-?',hours:0,remain:0,pct:0,tasks:[],since:rh,dueAt:0,unknown:true};
const sorted=[...tpl.intervals].sort((a,b)=>a.hours-b.hours);
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¢–û –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ (–∫–∞–∫–æ–π —Å–∞–º—ã–π —Å—Ç–∞—Ä—à–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–µ–ª–∏—Ç —Ç–æ—á–∫—É)
function toTypeAtPoint(pt){for(let i=sorted.length-1;i>=0;i--){if(pt>0&&pt%sorted[i].hours===0)return sorted[i]}return sorted[0]}
// –ë–ª–∏–∂–∞–π—à–∞—è —Å–ª–µ–¥—É—é—â–∞—è —Ç–æ—á–∫–∞ –¢–û (–ª—é–±–æ–≥–æ —Ç–∏–ø–∞) > lastH
const minH=sorted[0]?.hours||250;
// –°—á–∏—Ç–∞–µ–º –æ—Ç lastH ‚Äî –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ –ø–æ—Å–ª–µ lastH
let nextPoint=minH>0?Math.ceil(Math.max(lastH+1,1)/minH)*minH:250;
// –ï—Å–ª–∏ nextPoint —É–∂–µ –ø–æ–∑–∞–¥–∏ rh ‚Äî –ø—Ä–æ—Å—Ä–æ—á–∫–∞
if(nextPoint<rh){
// –ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ ‚Äî –Ω–∞–π–¥—ë–º —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –Ω–µ–ø—Ä–æ–π–¥–µ–Ω–Ω—É—é
const overdueIv=toTypeAtPoint(nextPoint);
const overdueH=rh-nextPoint;
return{...overdueIv,remain:-overdueH,pct:100,since:rh-lastH,_prevP:nextPoint,dueAt:nextPoint,unknown:false}
}
const nextIv=toTypeAtPoint(nextPoint);
const remain=nextPoint-rh;
const totalSpan=nextPoint-lastH;
const progress=totalSpan>0?Math.min(100,Math.max(0,Math.round((rh-lastH)/totalSpan*100))):0;
return{...nextIv,remain,pct:progress,since:rh-lastH,_nextP:nextPoint,dueAt:nextPoint,unknown:false}
}
function sv(){localStorage.setItem('s5s',JSON.stringify(S));localStorage.setItem('s5c',cur||'')}
function esc(s){const d=document.createElement('div');d.textContent=s==null?'':String(s);return d.innerHTML}
function ae(m){evts.unshift({t:now(),m});if(evts.length>40)evts.pop()}
function showM(n){$('m-'+n).classList.add('sh')}function hideM(n){$('m-'+n).classList.remove('sh')}
document.querySelectorAll('.mbg').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('sh')}));
function R(a,b){return+(a+Math.random()*(b-a)).toFixed(1)}function RI(a,b){return Math.floor(a+Math.random()*(b-a))}
function now(){return new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}
let curView='monitoring';
function renderSB(){const k=Object.keys(S);$('sbSites').innerHTML=k.length?k.map(id=>{const s=S[id],active=id===cur;return`<div class="sb-tree${active?' open':''}"><div class="si${active?' on':''}" onclick="sel('${id}')"><span class="si-arrow">${active?'‚ñº':'‚ñ∂'}</span><span class="si-name">${esc(s.name)}</span><div class="si-acts"><button class="si-btn" onclick="event.stopPropagation();openEdit('${id}')">‚úè</button><button class="si-btn del" onclick="event.stopPropagation();openDel('${id}')">‚úï</button></div></div>${active?`<div class="sb-sub"><button class="sb-sub-btn${curView==='monitoring'?' on':''}" onclick="event.stopPropagation();curView='monitoring';renderDash();renderSB()">‚ö° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button><button class="sb-sub-btn${curView==='alarms'?' on':''}" onclick="event.stopPropagation();curView='alarms';showAlarms();renderSB()">üö® –ê–≤–∞—Ä–∏–∏</button><button class="sb-sub-btn${curView==='archive'?' on':''}" onclick="event.stopPropagation();curView='archive';showArchive('${id}');renderSB()">üìä –ê—Ä—Ö–∏–≤</button><button class="sb-sub-btn${curView==='to'?' on':''}" onclick="event.stopPropagation();curView='to';openTOTemplates();renderSB()">üìã –¢–û</button></div>`:''}</div>`}).join(''):'<div style="padding:20px;text-align:center;font-size:11px;color:var(--t4)">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´+ –û–±—ä–µ–∫—Ç¬ª</div>'}
function sel(id){archiveMode=false;curView='monitoring';cur=id;sv();renderSB();renderDash();if(_snOpen)_snUpdateCtxBadge()}
function openAddSite(){editId=null;$('smT').textContent='–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç';$('fN').value='';$('fC').value='';$('fC').disabled=false;$('fD').value='';populateRespSelect('');$('smA').innerHTML='<button class="bp" onclick="saveSite()">–°–æ–∑–¥–∞—Ç—å</button>';showM('site')}
function openEdit(id){editId=id;const s=S[id];$('smT').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: '+s.name;$('fN').value=s.name;$('fC').value=id;$('fC').disabled=true;$('fD').value=s.desc||'';populateRespSelect(s.responsible||'');$('smA').innerHTML=`<div style="display:flex;gap:8px"><button class="bp" style="flex:1" onclick="saveSite()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="bdn" style="flex:0;padding:10px 16px" onclick="hideM('site');openDel('${id}')">üóë</button></div>`;showM('site')}
async function saveSite(){const n=$('fN').value.trim(),c=$('fC').value.trim().toLowerCase().replace(/[^a-z0-9_-]/g,''),d=$('fD').value.trim(),resp=$('fResp').value;if(!n||!c){ae('‚ö† –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥');return}if(!editId&&S[c]){ae('‚ö† –û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ¬´'+c+'¬ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');return}if(editId){S[editId].name=n;S[editId].desc=d;S[editId].responsible=resp;ae('‚úè '+n);
// API: update site
if(apiAvailable&&siteApiIds[editId]){try{await api.patch('/api/sites/'+siteApiIds[editId],{name:n,description:d})}catch(e){console.warn('API update site error:',e)}}
}else{S[c]={name:n,desc:d,responsible:resp,g1:{},g2:{},spr:{}};cur=c;ae('‚úÖ '+n+' —Å–æ–∑–¥–∞–Ω');
// API: create site
if(apiAvailable){try{const s=await api.post('/api/sites',{name:n,code:c,network:'modbus',description:d});siteApiIds[c]=s.id;S[c]._apiId=s.id}catch(e){console.warn('API create site error:',e)}}
}$('fC').disabled=false;sv();hideM('site');renderSB();renderDash()}
function populateRespSelect(selectedId){populateRespSelectById('fResp',selectedId)}
function populateRespSelectById(selId,selectedId){const sel=$(selId);if(!sel)return;const users=getBxUsers();sel.innerHTML='<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>';for(var i=0;i<users.length;i++){var u=users[i];sel.innerHTML+='<option value="'+u.id+'"'+(u.id===selectedId?' selected':'')+'>'+esc(u.name)+(u.dept?' ('+esc(u.dept)+')':'')+'</option>'}if(!users.length)sel.innerHTML+='<option disabled>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –ë24 –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</option>'}
function openDel(id){delId=id;$('delN').textContent=S[id]?.name||id;showM('del')}
async function doDel(){if(!delId)return;const dName=S[delId]?.name||delId;
// API: delete site (cascade deletes devices)
if(apiAvailable&&siteApiIds[delId]){try{await api.del('/api/sites/'+siteApiIds[delId]);delete siteApiIds[delId]}catch(e){console.warn('API delete site error:',e)}}
delete S[delId];if(cur===delId)cur=Object.keys(S)[0]||null;
localStorage.removeItem('s5to_'+delId+'_g1');localStorage.removeItem('s5to_'+delId+'_g2');
localStorage.removeItem('s5alm_'+delId+'_g1');localStorage.removeItem('s5alm_'+delId+'_g2');localStorage.removeItem('s5alm_'+delId+'_spr');
localStorage.removeItem('s5_spr_backups_'+delId);
ae('üóë '+dName+' —É–¥–∞–ª—ë–Ω');sv();hideM('del');renderSB();renderDash();delId=null}
// === TABBED SETTINGS ===
function openSet(){if(!cur||!S[cur])return;const s=S[cur];
$('setTitle').textContent='‚öô '+s.name+' ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
$('setBody').innerHTML=`<div class="set-tabs"><button class="set-tab on" onclick="setTab(this,0)">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1</button><button class="set-tab" onclick="setTab(this,1)">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2</button><button class="set-tab" onclick="setTab(this,2)">–®–ü–†</button><button class="set-tab" onclick="setTab(this,3)">–û–±—ä–µ–∫—Ç</button></div>
<div class="set-panel on" id="sp0"><div class="cfs"><div class="cft"><span class="dot dot-g"></span>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1 ‚Äî HGM9520N<span class="conn-test" onclick="testConn('g1')">üîå –¢–µ—Å—Ç</span></div>
<div class="fr2"><div class="fg"><label class="fl">IP-–∞–¥—Ä–µ—Å <span class="req">*</span></label><input class="fi" id="cg1i" value="${esc(s.g1?.ip||'')}" placeholder="192.168.97.10"></div><div class="fg"><label class="fl">–ü–æ—Ä—Ç Modbus TCP</label><input class="fi" id="cg1p" value="${s.g1?.port||502}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">Slave ID</label><input class="fi" id="cg1s" value="${s.g1?.slaveId||1}" type="number"></div><div class="fg"><label class="fl">–ú–æ—Ç–æ—á–∞—Å—ã</label><input class="fi" id="cg1h" value="${s.g1?.runHours||0}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û</label><select class="fi" id="cg1lt"><option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>${getTpl().intervals.map(iv=>`<option value="${iv.id}"${(getTOData(cur,'g1').lastTOId===iv.id)?' selected':''}>${iv.name}</option>`).join('')}</select></div><div class="fg"><label class="fl">–ü—Ä–∏ –º–æ—Ç–æ—á–∞—Å–∞—Ö</label><input class="fi" id="cg1lth" value="${getTOData(cur,'g1').hoursAtLastTO||0}" type="number" placeholder="0"></div></div>
<button class="bp" style="margin-top:8px;width:100%;background:var(--bg4);border:1px solid var(--bd);color:var(--t2);font-size:12px;padding:8px 0" onclick="testConn('g1')">üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º</button><div id="g1test"></div></div></div>
<div class="set-panel" id="sp1"><div class="cfs"><div class="cft"><span class="dot dot-g"></span>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2 ‚Äî HGM9520N<span class="conn-test" onclick="testConn('g2')">üîå –¢–µ—Å—Ç</span></div>
<div class="fr2"><div class="fg"><label class="fl">IP-–∞–¥—Ä–µ—Å <span class="req">*</span></label><input class="fi" id="cg2i" value="${esc(s.g2?.ip||'')}" placeholder="192.168.97.11"></div><div class="fg"><label class="fl">–ü–æ—Ä—Ç Modbus TCP</label><input class="fi" id="cg2p" value="${s.g2?.port||502}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">Slave ID</label><input class="fi" id="cg2s" value="${s.g2?.slaveId||1}" type="number"></div><div class="fg"><label class="fl">–ú–æ—Ç–æ—á–∞—Å—ã</label><input class="fi" id="cg2h" value="${s.g2?.runHours||0}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û</label><select class="fi" id="cg2lt"><option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>${getTpl().intervals.map(iv=>`<option value="${iv.id}"${(getTOData(cur,'g2').lastTOId===iv.id)?' selected':''}>${iv.name}</option>`).join('')}</select></div><div class="fg"><label class="fl">–ü—Ä–∏ –º–æ—Ç–æ—á–∞—Å–∞—Ö</label><input class="fi" id="cg2lth" value="${getTOData(cur,'g2').hoursAtLastTO||0}" type="number" placeholder="0"></div></div>
<button class="bp" style="margin-top:8px;width:100%;background:var(--bg4);border:1px solid var(--bd);color:var(--t2);font-size:12px;padding:8px 0" onclick="testConn('g2')">üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º</button><div id="g2test"></div></div></div>
<div class="set-panel" id="sp2"><div class="cfs"><div class="cft"><span class="dot dot-p"></span>–®–ü–† ‚Äî HGM9560 (RS-485‚ÜíEthernet)<span class="conn-test" onclick="testConn('spr')">üîå –¢–µ—Å—Ç</span></div>
<div class="fr2"><div class="fg"><label class="fl">IP –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞ <span class="req">*</span></label><input class="fi" id="csi" value="${esc(s.spr?.ip||'')}" placeholder="10.11.0.2"></div><div class="fg"><label class="fl">–ü–æ—Ä—Ç</label><input class="fi" id="csp" value="${s.spr?.port||26}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">Slave ID</label><input class="fi" id="css" value="${s.spr?.slaveId||1}" type="number"></div><div class="fg"><label class="fl">–ü—Ä–æ—Ç–æ–∫–æ–ª</label><div style="padding:9px 12px;background:var(--bg);border:1px solid var(--bd);border-radius:var(--rs);font-size:13px;color:var(--t3)">RTU 9600/8N2</div></div></div><button class="bp" style="margin-top:8px;width:100%;background:var(--bg4);border:1px solid var(--bd);color:var(--t2);font-size:12px;padding:8px 0" onclick="testConn('spr')">üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º</button><div id="sprtest"></div></div></div>
<div class="set-panel" id="sp3"><div class="cfs"><div class="cft"><span class="dot dot-g"></span>–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div class="fg"><label class="fl">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="fi" id="csn" value="${esc(s.name)}"></div>
<div class="fg"><label class="fl">–û–ø–∏—Å–∞–Ω–∏–µ</label><input class="fi" id="csd" value="${esc(s.desc||'')}"></div>
<div class="fg"><label class="fl">–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ (–º—Å)</label><input class="fi" id="csi2" value="${s.pollInterval||2000}" type="number"></div>
<div class="fg"><label class="fl">üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¢–û</label><select class="fi" id="csResp" style="padding:8px 10px"></select></div></div></div>
<button class="bp" style="margin-top:4px" onclick="saveSet()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;showM('settings');populateRespSelectById('csResp',s.responsible||'')}
function setTab(btn,idx){btn.closest('.mbd').querySelectorAll('.set-tab').forEach(b=>b.classList.remove('on'));btn.closest('.mbd').querySelectorAll('.set-panel').forEach(p=>p.classList.remove('on'));btn.classList.add('on');$('sp'+idx)?.classList.add('on')}
async function testConn(dev){const el=$(dev+'test');el.innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y);font-family:var(--m);margin-top:6px">‚è≥ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>';
const s=S[cur];if(!s)return;
let ip='',port=502,slaveId=1,proto='tcp';
if(dev==='g1'){ip=$('cg1i')?.value||s.g1?.ip||'';port=+($('cg1p')?.value)||502;slaveId=+($('cg1s')?.value)||1;proto='tcp'}
else if(dev==='g2'){ip=$('cg2i')?.value||s.g2?.ip||'';port=+($('cg2p')?.value)||502;slaveId=+($('cg2s')?.value)||1;proto='tcp'}
else if(dev==='spr'){ip=$('csi')?.value||s.spr?.ip||'';port=+($('csp')?.value)||26;slaveId=+($('css')?.value)||1;proto='rtu_over_tcp'}
if(!ip){el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r);font-family:var(--m);margin-top:6px">–£–∫–∞–∂–∏—Ç–µ IP-–∞–¥—Ä–µ—Å</div>';return}
try{const r=await api.post('/api/devices/test-connection',{ip_address:ip,port:port,slave_id:slaveId,protocol:proto});
if(r.success){el.innerHTML=`<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m);margin-top:6px">‚úÖ ${r.message}</div>`}
else{el.innerHTML=`<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r);font-family:var(--m);margin-top:6px">‚ùå ${r.message}</div>`}
}catch(e){el.innerHTML=`<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r);font-family:var(--m);margin-top:6px">‚ùå ${e.message}</div>`}}
async function saveSet(){const s=S[cur];s.g1={...s.g1,ip:$('cg1i').value.trim(),port:+$('cg1p').value||502,slaveId:+$('cg1s').value||1,runHours:+$('cg1h').value||0};s.g2={...s.g2,ip:$('cg2i').value.trim(),port:+$('cg2p').value||502,slaveId:+$('cg2s').value||1,runHours:+$('cg2h').value||0};s.spr={...s.spr,ip:$('csi').value.trim(),port:+$('csp').value||26,slaveId:+$('css').value||1};s.name=$('csn')?.value.trim()||s.name;s.desc=$('csd')?.value.trim()||'';s.responsible=$('csResp')?.value||s.responsible||'';s.pollInterval=+$('csi2')?.value||2000;
// Save last TO data for G1/G2
for(const sl of['g1','g2']){const ltSel=$('c'+sl+'lt'),lthInp=$('c'+sl+'lth');if(ltSel){const td=getTOData(cur,sl);const newId=ltSel.value||null;const newH=+(lthInp?.value)||0;if(newId!==td.lastTOId||newH!==td.hoursAtLastTO){td.lastTOId=newId;td.hoursAtLastTO=newH;saveTOData(cur,sl,td)}}}
sv();
// API: sync devices
if(apiAvailable&&siteApiIds[cur]){const siteId=siteApiIds[cur];try{
// Update site name/desc
await api.patch('/api/sites/'+siteId,{name:s.name,description:s.desc});
// Sync each device slot
for(const [slot,dtype,proto] of [['g1','generator','tcp'],['g2','generator','tcp'],['spr','ats','rtu_over_tcp']]){
const d=s[slot];if(!d?.ip)continue;
if(d._deviceId){await api.patch('/api/devices/'+d._deviceId,{ip_address:d.ip,port:d.port,slave_id:d.slaveId||1,name:slot==='spr'?'–®–ü–†':('–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä '+(slot==='g1'?'1':'2'))})}
else{const created=await api.post('/api/devices',{site_id:siteId,name:slot==='spr'?'–®–ü–†':('–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä '+(slot==='g1'?'1':'2')),device_type:dtype,ip_address:d.ip,port:d.port,slave_id:d.slaveId||1,protocol:proto});
d._deviceId=created.id;deviceSlotIndex[created.id]={siteKey:cur,slot}}
}}catch(e){console.warn('API sync devices error:',e)}}
ae('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');hideM('settings');renderSB();renderDash()}
function cmdConfirm(target,cmd,label,info){$('cmdT').textContent='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: '+label;$('cmdTxt').innerHTML=`–ö–æ–º–∞–Ω–¥–∞ <b>${label}</b> ‚Üí <b>${target}</b>`;$('cmdInfo').textContent=info||'Modbus FC05';$('cmdOk').onclick=async()=>{hideM('cmd');
const cs=$('cs-'+target.replace(/[\s\/]/g,''));
// Resolve device_id and command params
let deviceId=null,fc=5,addr=0,val=1;
if(target.includes('–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1'))deviceId=getDeviceIdForSlot('g1');
else if(target.includes('–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2'))deviceId=getDeviceIdForSlot('g2');
else if(target==='–®–ü–†')deviceId=getDeviceIdForSlot('spr');
// Parse FC and address from info string
const fcMatch=info?.match(/FC0?(\d)/);if(fcMatch)fc=parseInt(fcMatch[1]);
const addrMatch=info?.match(/0x([0-9A-Fa-f]+)/);if(addrMatch)addr=parseInt(addrMatch[1],16);
const regMatch=info?.match(/reg\s+(\d+)/);if(regMatch)addr=parseInt(regMatch[1]);
// For FC06, parse value from cmd or info
if(fc===6){
const valMatch=info?.match(/‚Üê\s*(\d+)/);if(valMatch)val=parseInt(valMatch[1]);
else if(cmd.includes('LoadMode=')){val=parseInt(cmd.split('=')[1])||0}
else if(cmd==='SetPQ'){
// Send P and Q as separate commands
const pv=+($('sprPslider')?.value||500),qv=+($('sprQslider')?.value||500);
if(apiAvailable&&deviceId){try{
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4352,value:pv});
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4354,value:qv});
if(cs){cs.textContent='‚úÖ P/Q –∑–∞–ø–∏—Å–∞–Ω—ã';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}
ae(`‚ö° FC06 P=${pv/10}% Q=${qv/10}% ‚Üí ${target}`);return}catch(e){ae(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`);if(cs){cs.textContent='‚ùå –û—à–∏–±–∫–∞';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}return}}}
}
if(cmd.startsWith('Preset:')){
// Preset: send 3 commands (LoadMode, P, Q)
const P={island:{m:0,p:1000,q:500},genres:{m:0,p:800,q:500},peak:{m:1,p:300,q:500},parallel:{m:2,p:500,q:500},export:{m:0,p:800,q:300},mains:{m:1,p:0,q:0},test:{m:0,p:200,q:200}};
const pn=cmd.split(':')[1],pr=P[pn];
if(apiAvailable&&deviceId&&pr){try{
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4351,value:pr.m});
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4352,value:pr.p});
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4354,value:pr.q});
if(cs){cs.textContent='‚úÖ –ü—Ä–µ—Å–µ—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}
ae(`‚ö° –ü—Ä–µ—Å–µ—Ç ${pn} ‚Üí ${target}`);return}catch(e){ae(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`)}}
}
// Standard FC05 or FC06 command
if(apiAvailable&&deviceId){try{
const resp=await api.post('/api/commands',{device_id:deviceId,function_code:fc,address:addr,value:fc===5?1:val});
ae(`‚ö° ${cmd} ‚Üí ${target}`);if(cs){cs.textContent='‚úÖ '+label+' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}
}catch(e){ae(`‚ùå ${cmd} ‚Üí ${target}: ${e.message}`);if(cs){cs.textContent='‚ùå –û—à–∏–±–∫–∞';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}}}
else{ae(`‚ö° ${cmd} ‚Üí ${target}`);if(cs){cs.textContent='‚úÖ '+label+' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}}
};showM('cmd')}
// TO
function openTO(dev){if(!cur)return;const s=S[cur],c=dev==='g1'?s.g1:s.g2,rh=c?.runHours||0;const tpl=getTpl(),td=getTOData(cur,dev);
const to=getNextTO(rh,cur,dev);
const lastName=td.lastTOId?tpl.intervals.find(iv=>iv.id===td.lastTOId)?.name||td.lastTOId:'–Ω–µ —É–∫–∞–∑–∞–Ω–æ';
const lastH=td.hoursAtLastTO||0;
const isOverdue=to.remain<0;
const col=isOverdue?'var(--r)':to.remain<=20?'var(--y)':'var(--g)';
const bgd=isOverdue?'var(--rd)':'var(--bg4)';
const brd=isOverdue?'rgba(255,64,96,.2)':'transparent';
// –í—Å–µ —Ç–æ—á–∫–∏ –¢–û –≤ —Ü–∏–∫–ª–µ
const sorted=[...tpl.intervals].sort((a,b)=>a.hours-b.hours);
const minH=sorted[0]?.hours||250;
const maxH=sorted[sorted.length-1]?.hours||2000;
let schedule=[];
for(let h=minH;h<=maxH;h+=minH){let best=sorted[0];for(let i=sorted.length-1;i>=0;i--){if(h%sorted[i].hours===0){best=sorted[i];break}}
schedule.push({name:best.name,hours:h})}
let histH=td.history?.length?td.history.slice(0,8).map(h=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--bd);font-size:11px"><span>${h.type} ¬∑ ${h.hours}—á ${h.done?'<span style="color:var(--g)">‚úì'+h.done+'/'+h.total+'</span>':''}</span><span style="color:var(--t4)">${h.date}</span></div>`).join(''):'<div style="color:var(--t4);font-size:11px;padding:10px;text-align:center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
$('toT').textContent=(dev==='g1'?'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1':'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2')+' ‚Äî –¢–û';
$('toBody').innerHTML=`<div style="text-align:center;padding:18px;background:var(--bg4);border-radius:10px;margin-bottom:14px"><div style="font-size:11px;color:var(--t3)">–ú–æ—Ç–æ—á–∞—Å—ã</div><div style="font-size:30px;font-weight:700;font-family:var(--m)">${rh} <span style="font-size:14px;color:var(--t3)">—á</span></div><div style="font-size:10px;color:var(--t4)">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û: ${lastName}${lastH?' –ø—Ä–∏ '+lastH+'—á':''}</div></div>
${to.unknown?`<div style="padding:14px;background:var(--yd);border:1px solid rgba(255,186,0,.2);border-radius:8px;margin-bottom:10px;text-align:center"><div style="font-size:13px;color:var(--y);font-weight:600;margin-bottom:6px">‚ö† –£–∫–∞–∂–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û</div><div style="font-size:11px;color:var(--t3);margin-bottom:10px">–ß—Ç–æ–±—ã —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ –¢–û, –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–∞–∫–æ–µ –¢–û –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –º–æ—Ç–æ—á–∞—Å–∞—Ö.</div><button class="bp" style="padding:8px 24px" onclick="hideM('to');openSet()">‚öô –û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button></div>`:`${isOverdue?`<div style="padding:10px 12px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:8px;margin-bottom:10px"><div style="font-size:12px;color:var(--r);font-weight:600">‚ö† ${to.name} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(to.remain)}—á</div><div style="font-size:10px;color:var(--t3);margin-top:2px">–ë—ã–ª–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∏ ${to.dueAt||'?'}—á ¬∑ –¢–µ–∫—É—â–∏–µ: ${rh}—á</div></div>`:''}
<div style="padding:10px 12px;background:${bgd};border:1px solid ${brd};border-radius:8px;margin-bottom:10px">
<div style="display:flex;justify-content:space-between;margin-bottom:6px"><b style="font-size:12px;color:${col}">${isOverdue?'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+to.name:'–°–ª–µ–¥—É—é—â–µ–µ: '+to.name}</b><span style="font-size:11px;color:${col};font-family:var(--m)">${isOverdue?'‚Äî':to.remain+'—á –æ—Å—Ç.'}</span></div>
<div class="to-iv-bar"><div class="to-iv-fill" style="width:${to.pct}%;background:${col}"></div></div>
<div style="font-size:10px;color:var(--t3);margin-top:4px">${to.tasks?.slice(0,5).map(t=>'‚Ä¢ '+(t.c?'<b>':'')+t.text+(t.c?'</b>':'')).join('<br>')||''}</div>
</div>`}
<div style="font-size:11px;color:var(--t3);margin-bottom:6px">–¶–∏–∫–ª –¢–û (–∫–∞–∂–¥—ã–µ ${maxH}—á)</div>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">${schedule.map(s=>`<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:var(--bg4);color:var(--t3);font-family:var(--m)">${s.name} ${s.hours}—á</span>`).join('')}</div>
<div style="padding:12px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:10px"><div style="font-size:12px;color:var(--g);font-weight:600;margin-bottom:8px">–ü—Ä–æ–≤–µ—Å—Ç–∏ –¢–û</div><div style="display:flex;gap:6px"><select class="fi" id="toSel" style="flex:1;padding:7px 8px">${tpl.intervals.map((iv,i)=>`<option value="${i}"${iv.id===to.id?' selected':''}>${iv.name} (${iv.hours}—á)</option>`).join('')}</select><button class="bp" style="width:auto;padding:8px 20px" onclick="openChecklist('${dev}')">–ù–∞—á–∞—Ç—å</button></div><button class="bs2" style="width:100%;margin-top:6px;padding:7px;font-size:11px;color:var(--b)" onclick="createBxTaskFromTO('${dev}')">üìã –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ –ë–∏—Ç—Ä–∏–∫—Å24</button></div>
<div style="font-size:11px;color:var(--t3);margin-top:14px;margin-bottom:6px">–ò—Å—Ç–æ—Ä–∏—è</div>${histH}`;showM('to')}
function openChecklist(dev){const tpl=getTpl(),idx=+$('toSel').value,iv=tpl.intervals[idx],rh=S[cur]?.[dev]?.runHours||0;$('toT').textContent=iv.name+' ‚Äî –ß–µ–∫–ª–∏—Å—Ç';
$('toBody').innerHTML=`<div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg4);border-radius:8px;font-size:12px;margin-bottom:12px"><span>–ú–æ—Ç–æ—á–∞—Å—ã:</span><b style="font-family:var(--m)">${rh} —á</b></div>
<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:11px;color:var(--t3)">–†–∞–±–æ—Ç—ã</span><button onclick="document.querySelectorAll('.chk-cb').forEach(c=>c.checked=true)" style="font-size:10px;color:var(--g);background:none;border:none;cursor:pointer">–í—Å–µ</button></div>
<div style="max-height:300px;overflow-y:auto">${iv.tasks.map((t,i)=>`<label class="chk-item ${t.c?'crit':''}"><input type="checkbox" class="chk-cb" id="chk${i}"><span>${t.text}${t.c?'<span style="color:var(--r);font-size:9px;margin-left:4px">–æ–±—è–∑–∞—Ç.</span>':''}</span></label>`).join('')}</div>
<div style="padding:8px;background:var(--yd);border-radius:6px;font-size:10px;color:var(--y);margin-top:8px">‚ö† –°—á—ë—Ç—á–∏–∫ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω</div>
<div style="display:flex;gap:8px;margin-top:12px"><button class="bp" style="flex:1" onclick="completeTO('${dev}',${idx})">‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button><button class="bs2" style="flex:1;padding:10px" onclick="openTO('${dev}')">–ù–∞–∑–∞–¥</button></div>`}
function completeTO(dev,idx){const tpl=getTpl(),iv=tpl.intervals[idx],rh=S[cur]?.[dev]?.runHours||0;const cbs=document.querySelectorAll('.chk-cb');let done=0;cbs.forEach(c=>{if(c.checked)done++});const td=getTOData(cur,dev);td.hoursAtLastTO=rh;td.lastTOId=iv.id;td.history=td.history||[];td.history.unshift({type:iv.name,hours:rh,done,total:cbs.length,date:new Date().toLocaleDateString('ru-RU')});saveTOData(cur,dev,td);ae(`‚úÖ ${iv.name} ${dev==='g1'?'G1':'G2'}: ${done}/${cbs.length}`);hideM('to');renderDash()}
async function openTOTemplates(){curView='to';stopB24Poll();const tpl=getTpl();const bxCfg=getBxConfig();const bxOk=!!bxCfg.url;
let aiOk=false;let aiProv='';let aiModel='';if(apiAvailable){try{const ah=await api.get('/api/ai/health');aiOk=ah&&ah.available;aiProv=ah?.provider||'';aiModel=ah?.model||''}catch(e){}}
var localAi=getAIConfig();var localProv=localAi.provider||'';var localHasKey=!!(localAi.keys&&localAi.keys[localProv]);
var provName=localProv?((AI_PROVIDERS[localProv]||{}).name||localProv):'';var provIcon=localProv?((AI_PROVIDERS[localProv]||{}).icon||'ü§ñ'):'ü§ñ';
$('tplT').textContent='üìã –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã –¢–û';$('tplBody').innerHTML=`
<div style="padding:10px;background:${bxOk?'rgba(0,224,154,.04)':'rgba(255,176,32,.04)'};border:1px solid ${bxOk?'rgba(0,224,154,.15)':'rgba(255,176,32,.15)'};border-radius:8px;margin-bottom:12px">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
<span style="font-size:12px;font-weight:600;color:${bxOk?'var(--g)':'var(--y)'}">${bxOk?'üîó –ë–∏—Ç—Ä–∏–∫—Å24 –ø–æ–¥–∫–ª—é—á—ë–Ω':'‚ö† –ë–∏—Ç—Ä–∏–∫—Å24 –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω'}</span>
<button class="bs2" style="padding:4px 10px;font-size:10px" onclick="hideM('tpl');initBxModal();showM('bitrix')">${bxOk?'‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏':'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å'}</button>
</div>
<div style="font-size:10px;color:var(--t3);line-height:1.5">
${bxOk&&(aiOk||localHasKey)?`<b style="color:var(--p)">${provIcon} AI-–∏–º–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (${aiProv?provName+' ¬∑ '+aiModel:provName})</b> ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–∞–Ω—É–∞–ª –î–ì–£ –Ω–∞ –î–∏—Å–∫ –ë24, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ò–º–ø–æ—Ä—Ç –∏–∑ –º–∞–Ω—É–∞–ª–∞¬ª.<br>–ò–ò-–∞–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á—ë—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¢–û, —á–µ–∫–ª–∏—Å—Ç—ã —Ä–∞–±–æ—Ç –∏ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å.`:bxOk&&!aiOk?`<b style="color:var(--y)">‚ö† AI-–∞–≥–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</b> ‚Äî <a href="#" onclick="event.preventDefault();hideM('tpl');initAIModal();showM('aiconf')" style="color:var(--p);text-decoration:underline">–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</a> (OpenAI, Claude, Gemini, Grok).`:'–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ë–∏—Ç—Ä–∏–∫—Å24 –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ –¢–û –∏–∑ –º–∞–Ω—É–∞–ª–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ò–ò-–∞–≥–µ–Ω—Ç.'}
</div>
${bxOk?`<div style="display:flex;gap:6px;margin-top:8px"><button class="bpp" style="flex:1;padding:7px 10px;font-size:11px" onclick="hideM('tpl');initBxModal();showM('bitrix');setTimeout(()=>bxTab(document.querySelectorAll('.set-tab')[2],2),100)">ü§ñ –ò–º–ø–æ—Ä—Ç –∏–∑ –º–∞–Ω—É–∞–ª–∞</button></div>`:''}
</div>
<div style="font-size:11px;color:var(--t3);margin-bottom:6px;font-weight:500">–¢–µ–∫—É—â–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (${tpl.intervals.length})</div>
<div style="margin-bottom:10px">${tpl.intervals.map((iv,i)=>`<div class="to-iv" style="display:flex;align-items:center;gap:8px"><div style="flex:1"><div style="display:flex;justify-content:space-between"><b>${iv.name}</b><span style="font-size:11px;color:var(--t3);font-family:var(--m)">${iv.hours}—á ¬∑ ${iv.tasks.length} —Ä–∞–±–æ—Ç</span></div></div><button class="bk-btn del" onclick="delTOInterval(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button></div>`).join('')}</div>
<div style="display:flex;gap:8px;margin-bottom:8px"><button class="bp" style="flex:1" onclick="editTemplates()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="bs2" style="flex:0;padding:10px 16px" onclick="addTOInterval()">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
<button class="bs2" style="width:100%" onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º?')){localStorage.removeItem('s5tpl');openTOTemplates()}">–°–±—Ä–æ—Å–∏—Ç—å</button>`;showM('tpl')}
function addTOInterval(){const tpl=getTpl();const num=tpl.intervals.length+1;tpl.intervals.push({id:'to_'+Date.now(),name:'–¢–û-'+num,hours:num*500,tasks:[{id:1,text:'–û—Å–º–æ—Ç—Ä',c:0}]});saveTpl(tpl);ae('+ –¢–û-'+num+' –¥–æ–±–∞–≤–ª–µ–Ω');editTemplates()}
function delTOInterval(idx){const tpl=getTpl();if(tpl.intervals.length<=1)return;const name=tpl.intervals[idx].name;if(!confirm('–£–¥–∞–ª–∏—Ç—å '+name+'?'))return;tpl.intervals.splice(idx,1);saveTpl(tpl);ae('üóë '+name+' —É–¥–∞–ª—ë–Ω');openTOTemplates()}
function editTemplates(){const tpl=getTpl();$('tplT').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';$('tplBody').innerHTML=tpl.intervals.map((iv,i)=>`<div class="cfs"><div class="cft"><span class="dot dot-g"></span><input class="fi" style="width:80px;padding:4px 6px;font-size:12px;font-weight:600" id="tin${i}" value="${iv.name}"><span class="conn-test del" onclick="delTOInterval(${i})">‚úï –£–¥–∞–ª–∏—Ç—å</span></div><div class="fg"><label class="fl">–ò–Ω—Ç–µ—Ä–≤–∞–ª (—á)</label><input class="fi" id="tih${i}" value="${iv.hours}" type="number"></div><div class="fg"><label class="fl">–†–∞–±–æ—Ç—ã ([!] = –∫—Ä–∏—Ç–∏—á–Ω–∞—è)</label><textarea class="ta" id="tit${i}" rows="4">${iv.tasks.map(t=>(t.c?'[!] ':'')+t.text).join('\n')}</textarea></div></div>`).join('')+`<div style="display:flex;gap:8px;margin-top:4px"><button class="bp" style="flex:1" onclick="saveTemplates()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="bs2" style="padding:10px" onclick="addTOInterval()">+ –î–æ–±–∞–≤–∏—Ç—å</button><button class="bs2" style="flex:1;padding:10px" onclick="openTOTemplates()">–ù–∞–∑–∞–¥</button></div>`}
function saveTemplates(){const tpl=getTpl();tpl.intervals.forEach((iv,i)=>{iv.name=$('tin'+i)?.value||iv.name;iv.hours=parseInt($('tih'+i).value)||iv.hours;const lines=$('tit'+i).value.split('\n').filter(l=>l.trim());if(lines.length===0)lines.push('–û—Å–º–æ—Ç—Ä');iv.tasks=lines.map((l,j)=>{const c=l.startsWith('[!]');return{id:j+1,text:l.replace('[!] ','').replace('[!]','').trim(),c:c?1:0}})});saveTpl(tpl);ae('‚úÖ –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');openTOTemplates()}
// === POWER FLOW SVG ===
// –°–∏–ª–æ–≤–∞—è —Ü–µ–ø—å: –ì1,–ì2 ‚Üí –∞–≤—Ç.—à–∏–Ω—ã ‚Üí –®–ò–ù–ê ‚Üê –∞–≤—Ç.—Å–µ—Ç–∏ ‚Üê –°–ï–¢–¨
// –ù–∞–≥—Ä—É–∑–∫–∞ –≤–∏—Å–∏—Ç –Ω–∞ —à–∏–Ω–µ.
// –¢—Ä–∏ —Ç–æ—á–∫–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è:
//   busP  = busbar_p    ‚Äî –¢–¢ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–Ω–æ–º –≤–≤–æ–¥–µ (‚âà P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞)
//   mP    = mains_total_p ‚Äî –¢–¢ –Ω–∞ —Å–µ—Ç–µ–≤–æ–º –≤–≤–æ–¥–µ (P —Å–µ—Ç–∏)
//   loadP = busP + mP   ‚Äî —Å—É–º–º–∞—Ä–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –Ω–∞ –Ω–∞–≥—Ä—É–∑–∫–µ (—Ä–∞—Å—á—ë—Ç–Ω–∞—è)
// –ö–æ–≥–¥–∞ –æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∞ –∑–∞–º–∫–Ω—É—Ç—ã (–ø–∞—Ä–∞–ª–ª–µ–ª—å): P –Ω–∞–≥—Ä—É–∑–∫–∏ = P —à–∏–Ω—ã + P —Å–µ—Ç–∏
// –ö–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç.—à–∏–Ω—ã –∑–∞–º–∫–Ω—É—Ç (–æ—Å—Ç—Ä–æ–≤–Ω–æ–π): P –Ω–∞–≥—Ä—É–∑–∫–∏ = P —à–∏–Ω—ã
// –ö–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç.—Å–µ—Ç–∏ –∑–∞–º–∫–Ω—É—Ç (—Ç–æ–ª—å–∫–æ —Å–µ—Ç—å): P –Ω–∞–≥—Ä—É–∑–∫–∏ = P —Å–µ—Ç–∏
function flowSvg(g1on,g2on,mN,bC,mC,p1,p2,mP,busP,g1st,g2st){
p1=p1||0;p2=p2||0;mP=mP||0;busP=busP||0;
g1st=g1st||0;g2st=g2st||0; // 0=–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, 1=–æ—Ñ–ª–∞–π–Ω, 2=–æ–Ω–ª–∞–π–Ω
const gAct=(g1on||g2on)&&bC,mAct=mN&&mC,busAct=gAct||mAct;
const g1act=g1on&&bC,g2act=g2on&&bC;
const genTotal=p1+p2;
// P –Ω–∞–≥—Ä—É–∑–∫–∏ = —Å—É–º–º–∞ –≤–≤–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–º–∫–Ω—É—Ç—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã
const loadP=(bC?busP:0)+(mC?mP:0);
// Line thickness proportional to power (2-5px range)
const g1w=g1act?Math.max(2,Math.min(5,p1/100)):2.5;
const g2w=g2act?Math.max(2,Math.min(5,p2/100)):2.5;
const mw=mAct?Math.max(2,Math.min(5,mP/100)):2.5;
// Power label formatting
const _pw=v=>Math.abs(v)>=1000?(v/1000).toFixed(1)+' –ú–í—Ç':v.toFixed(1)+' –∫–í—Ç';
// Generator circle colors: 0=grey(–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω), 1=red(–æ—Ñ–ª–∞–π–Ω), 2=green(–æ–Ω–ª–∞–π–Ω)
function _gc(st,on){
    if(st===0)return{fill:'var(--ov)',stroke:'var(--t4)',txt:'var(--t4)',sub:'var(--t4)',lbl:'‚Äî'};
    if(st===1)return{fill:'rgba(255,64,96,.06)',stroke:'#ff4060',txt:'#ff4060',sub:'rgba(255,64,96,.5)',lbl:'–û–§–õ–ê–ô–ù'};
    return on
        ?{fill:'rgba(0,224,154,.1)',stroke:'var(--g)',txt:'var(--g)',sub:'rgba(0,224,154,.6)',lbl:null}
        :{fill:'rgba(0,224,154,.04)',stroke:'rgba(0,224,154,.5)',txt:'rgba(0,224,154,.7)',sub:'rgba(0,224,154,.4)',lbl:'–°–¢–û–ü'};
}
const c1=_gc(g1st,g1on),c2=_gc(g2st,g2on);
return`<svg viewBox="0 0 740 96" style="width:100%">
<!-- G1 (source, top-left) -->
<circle cx="46" cy="16" r="12" fill="${c1.fill}" stroke="${c1.stroke}" stroke-width="1.5"/>
<text x="46" y="14" fill="${c1.txt}" font-size="8" text-anchor="middle" font-family="var(--m)" font-weight="700">–ì1</text>
<text x="46" y="22" fill="${c1.sub}" font-size="5.5" text-anchor="middle" font-family="var(--m)">${c1.lbl||(p1>0?_pw(p1):'–†–ê–ë')}</text>
<!-- G1 ‚Üí Y-join -->
<line x1="58" y1="16" x2="100" y2="16" class="pline ${g1act?'on':''}" stroke-width="${g1w}"/>
<line x1="100" y1="16" x2="100" y2="38" class="pline ${g1act?'on':''}" stroke-width="${g1w}"/>
<!-- G2 (source, bottom-left) -->
<circle cx="46" cy="60" r="12" fill="${c2.fill}" stroke="${c2.stroke}" stroke-width="1.5"/>
<text x="46" y="58" fill="${c2.txt}" font-size="8" text-anchor="middle" font-family="var(--m)" font-weight="700">–ì2</text>
<text x="46" y="66" fill="${c2.sub}" font-size="5.5" text-anchor="middle" font-family="var(--m)">${c2.lbl||(p2>0?_pw(p2):'–†–ê–ë')}</text>
<!-- G2 ‚Üí Y-join -->
<line x1="58" y1="60" x2="100" y2="60" class="pline ${g2act?'on':''}" stroke-width="${g2w}"/>
<line x1="100" y1="60" x2="100" y2="38" class="pline ${g2act?'on':''}" stroke-width="${g2w}"/>
<!-- Y-join ‚Üí Busbar Switch -->
<line x1="100" y1="38" x2="150" y2="38" class="pline ${gAct?'on':''}"/>
<!-- GEN POWER LABEL: P —à–∏–Ω—ã (–¢–¢ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–Ω–æ–≥–æ –≤–≤–æ–¥–∞) ‚Äî –Ω–∞–¥ –ª–∏–Ω–∏–µ–π –∞–≤—Ç.—à–∏–Ω—ã‚Üí—à–∏–Ω–∞ -->
${bC&&busP>0?`<text x="270" y="34" fill="var(--g)" font-size="7.5" text-anchor="middle" font-family="var(--m)" font-weight="700" style="cursor:pointer" onclick="showPwChart('bus')">${_pw(busP)}</text>`:''}
<!-- Busbar Switch -->
<rect x="150" y="28" width="48" height="20" rx="4" fill="${bC?'rgba(0,224,154,.08)':'var(--ov)'}" stroke="${bC?'var(--g)':'var(--t4)'}" stroke-width="1.5"/>
<text x="174" y="41" fill="${bC?'var(--g)':'var(--t3)'}" font-size="6.5" text-anchor="middle" font-family="var(--m)" font-weight="600">${bC?'–ó–ê–ú–ö–ù':'–†–ê–ó–û–ú–ö'}</text>
<text x="174" y="23" fill="var(--t3)" font-size="5.5" text-anchor="middle" font-family="var(--m)">–ê–≤—Ç. —à–∏–Ω—ã</text>
<!-- Busbar Switch ‚Üí BUS LEFT -->
<line x1="198" y1="38" x2="340" y2="38" class="pline bus ${gAct?'on':(busAct?'on':'')}" stroke-width="4"/>
<!-- BUS CENTER LABEL -->
<rect x="340" y="29" width="64" height="18" rx="4" fill="var(--bg3)" stroke="${busAct?'var(--g)':'var(--t4)'}" stroke-width="1"/>
<text x="372" y="41" fill="${busAct?'var(--g)':'var(--t3)'}" font-size="8" text-anchor="middle" font-family="var(--m)" font-weight="700">–®–ò–ù–ê</text>
<text x="372" y="24" fill="var(--p)" font-size="5.5" text-anchor="middle" font-family="var(--m)" font-weight="600">–®–ü–†</text>
<!-- BUS RIGHT ‚Üí Mains Switch -->
<line x1="404" y1="38" x2="520" y2="38" class="pline bus ${mAct?'monR':(busAct?'on':'')}" stroke-width="4"/>
<!-- MAINS POWER LABEL: P —Å–µ—Ç–∏ (–¢–¢ —Å–µ—Ç–µ–≤–æ–≥–æ –≤–≤–æ–¥–∞) ‚Äî –Ω–∞–¥ –ª–∏–Ω–∏–µ–π —à–∏–Ω–∞‚Üí–∞–≤—Ç.—Å–µ—Ç–∏ -->
${mC&&mP>0?`<text x="462" y="34" fill="#4090ff" font-size="7.5" text-anchor="middle" font-family="var(--m)" font-weight="700" style="cursor:pointer" onclick="showPwChart('mains')">${_pw(mP)}</text>`:''}
<!-- Mains Switch -->
<rect x="520" y="28" width="48" height="20" rx="4" fill="${mC?'rgba(64,144,255,.1)':'var(--ov)'}" stroke="${mC?'#4090ff':'var(--t4)'}" stroke-width="1.5"/>
<text x="544" y="41" fill="${mC?'#4090ff':'var(--t3)'}" font-size="6.5" text-anchor="middle" font-family="var(--m)" font-weight="600">${mC?'–ó–ê–ú–ö–ù':'–†–ê–ó–û–ú–ö'}</text>
<text x="544" y="23" fill="var(--t3)" font-size="5.5" text-anchor="middle" font-family="var(--m)">–ê–≤—Ç. —Å–µ—Ç–∏</text>
<!-- Mains Switch ‚Üí MAINS -->
<line x1="568" y1="38" x2="630" y2="38" class="pline ${mAct?'monR':''}" stroke-width="${mw}"/>
<!-- MAINS (source, right) -->
<rect x="630" y="26" width="56" height="24" rx="5" fill="${mN?'rgba(64,144,255,.1)':'rgba(255,64,96,.06)'}" stroke="${mN?'#4090ff':'#ff4060'}" stroke-width="1.5"/>
<text x="658" y="42" fill="${mN?'#4090ff':'#ff4060'}" font-size="8.5" text-anchor="middle" font-family="var(--m)" font-weight="600">–°–ï–¢–¨</text>
<text x="658" y="20" fill="${mN?'rgba(64,144,255,.6)':'rgba(255,64,96,.5)'}" font-size="5.5" text-anchor="middle" font-family="var(--m)">${mN?'–ù–û–†–ú–ê':'–ê–í–ê–†–ò–Ø'}</text>
<!-- BUS ‚Üí LOAD -->
<line x1="372" y1="47" x2="372" y2="68" class="pline ${busAct?'on':''}"/>
<!-- LOAD POWER LABEL: P –Ω–∞–≥—Ä—É–∑–∫–∏ = P —à–∏–Ω—ã + P —Å–µ—Ç–∏ -->
${busAct&&loadP>0?`<text x="398" y="60" fill="var(--y)" font-size="7.5" text-anchor="start" font-family="var(--m)" font-weight="700" style="cursor:pointer" onclick="showPwChart('load')">${_pw(loadP)}</text>`:''}
<rect x="342" y="68" width="60" height="22" rx="5" fill="${busAct?'rgba(255,176,32,.06)':'var(--ov)'}" stroke="${busAct?'var(--y)':'var(--t4)'}" stroke-width="1.5"/>
<text x="372" y="82" fill="${busAct?'var(--y)':'var(--t3)'}" font-size="7.5" text-anchor="middle" font-family="var(--m)" font-weight="600">–ù–ê–ì–†–£–ó–ö–ê</text>
</svg>`}
// === RENDER ===
function renderDash(){stopB24Poll();curView='monitoring';const mn=$('mainArea');
if(!cur||!S[cur]){mn.innerHTML='<div class="empty-dash" style="height:100%"><div style="font-size:48px;margin-bottom:16px;opacity:.4">üè≠</div><p style="font-size:14px">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –∏–ª–∏ <span style="color:var(--g);cursor:pointer" onclick="openAddSite()">—Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</span></p></div>';return}
const s=S[cur],hg1=!!s.g1?.ip,hg2=!!s.g2?.ip,hs=!!s.spr?.ip,cfg=[hg1,hg2,hs].filter(Boolean).length;
mn.innerHTML=`<div class="dh"><div class="dt"><div class="ld"></div><h1>${esc(s.name)}${s.desc?' ‚Äî '+esc(s.desc):''}</h1></div><div style="display:flex;align-items:center;gap:16px"><div class="da"><button onclick="openSet()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button><button id="demoBtn" class="${demo?'demo-on':''}" onclick="togDemo()">${demo?'‚èπ –°—Ç–æ–ø':'‚ñ∂ –î–µ–º–æ'}</button></div><span class="ck" id="ck"></span></div></div>
<div class="ss"><div class="sc"><div class="sl2">P —à–∏–Ω—ã</div><div class="sv" style="color:var(--g)" id="sP">‚Äî<span class="su">–∫–í—Ç</span></div></div><div class="sc"><div class="sl2">P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤</div><div class="sv" style="color:var(--p)" id="sPg">‚Äî<span class="su">–∫–í—Ç</span></div></div><div class="sc"><div class="sl2">U —Å–µ—Ç–∏</div><div class="sv" id="sU">‚Äî<span class="su">–í</span></div></div><div class="sc"><div class="sl2">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div><div class="sv" id="sG">${cfg}<span class="su">/3</span></div></div><div class="sc"><div class="sl2">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div><div id="sSt"><span class="bdg bdg-off">${cfg?'–û–∂–∏–¥–∞–Ω–∏–µ':'‚Äî'}</span></div></div><div class="sc"><div class="sl2">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div><div class="sv" id="sResp" style="font-size:12px">‚Äî</div></div></div>
${cfg===0?'<div class="empty-dash" style="padding:40px"><div style="font-size:32px;margin-bottom:10px;opacity:.4">‚öô</div><p>–ù–∞–∂–º–∏—Ç–µ <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b></p></div>':`
<div class="gg">${genCard('g1','–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1',s.g1)}${genCard('g2','–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2',s.g2)}</div>
<div class="pflow" id="pflow">${flowSvg(false,false,false,false,false,0,0,0,0,hg1?1:0,hg2?1:0)}</div>
${hs?sprCard(s.spr):''}
`}<div class="ev"><div class="ev-t">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</div><div id="evL">${evts.length?evts.slice(0,10).map(e=>`<div class="er"><span class="et">${e.t}</span>${esc(e.m)}</div>`).join(''):'<div style="color:var(--t4);font-size:11px">‚Äî</div>'}</div></div>`;uCk();if(demo)demoTick()}
function genCard(sl,nm,c){
if(!c?.ip)return`<div class="cc s-stb"><div style="padding:24px;text-align:center;color:var(--t3);font-size:12px">${nm} ‚Äî –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω<br><span style="color:var(--g);cursor:pointer" onclick="openSet()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å ‚Üí</span></div></div>`;
const rh=c.runHours||0,to=getNextTO(rh,cur,sl),tc=to.remain<0?'to-r':to.pct>85?'to-r':to.pct>65?'to-y':'to-g',bc=to.remain<0?'var(--r)':to.pct>85?'var(--r)':to.pct>65?'var(--y)':'var(--g)';
return`<div class="cc s-stb" id="c${sl}"><div class="ch" onclick="tog('c${sl}')">
<div class="cr1"><div class="cid"><div class="cdot cd-x"></div><div><div class="cn">${nm}</div><div class="csb">HGM9520N ¬∑ ${esc(c.ip)}:${c.port||502} <span id="${sl}-rh" style="color:var(--t);font-weight:600;margin-left:6px">‚è± ${rh} —á</span></div></div></div><span class="bdg bdg-off" onclick="event.stopPropagation();openAlarms('c${sl}','${sl}a')" title="–ù–∞–∂–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–≤–∞—Ä–∏–π">–û–ñ–ò–î–ê–ù–ò–ï</span></div>
<div class="kr"><div class="kp"><div class="kl">P</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">U</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">I</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">f</div><div class="kv vm">‚Äî</div></div></div>
<div class="to-block" id="${sl}-to" onclick="event.stopPropagation();${to.unknown?'openSet()':'this.classList.toggle(&quot;exp&quot;)'}"><div class="to-head"><span class="to-name ${to.unknown?'to-y':tc}">${to.unknown?'‚ö† –£–∫–∞–∂–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û':to.name+' ‚Üí '+to.dueAt+'—á'}</span><span class="to-remain">${to.unknown?'<span style=&quot;color:var(--y);cursor:pointer&quot;>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí</span>':(to.remain>0?to.remain+'—á –æ—Å—Ç.':(to.remain<0?'–ø—Ä–æ—Å—Ä–æ—á. '+Math.abs(to.remain)+'—á':'—Å–µ–π—á–∞—Å'))+' ¬∑ '+rh+'—á'}</span></div>${to.unknown?'':`<div class="to-bar"><div class="to-fill" style="width:${to.pct}%;background:${bc}"></div></div><div class="to-tasks">${to.tasks?.slice(0,5).map(t=>'‚Ä¢ '+(t.c?'<b>':'')+t.text+(t.c?'</b>':'')).join('<br>')||''}</div><div class="to-hint">‚ñº —Ä–∞–±–æ—Ç—ã ¬∑ <span style="color:var(--g);cursor:pointer" onclick="event.stopPropagation();openTO('${sl}')">–¢–û</span></div>`}</div>
<div class="mds"><span class="mdt">AUTO</span><span class="mdt">MAN</span><span class="mdt">TEST</span><span class="mdt">STOP</span></div>
<div class="pl-block" id="${sl}-pl" style="display:none">
<div class="pl-hdr">‚ö° –û–≥—Ä. –º–æ—â–Ω–æ—Å—Ç–∏</div>
<div class="pl-rows">
<div class="pl-row"><span class="pl-lbl">P</span><div class="pl-bar"><div class="pl-fill" id="${sl}-pl-pf"></div></div><span class="pl-val" id="${sl}-pl-pv">‚Äî</span></div>
<div class="pl-row"><span class="pl-lbl">Q</span><div class="pl-bar"><div class="pl-fill pl-q" id="${sl}-pl-qf"></div></div><span class="pl-val" id="${sl}-pl-qv">‚Äî</span></div>
</div>
<button class="pl-btn" onclick="event.stopPropagation();openPowerLimitModal('${sl}')">‚öô –ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
</div></div>
<!-- QUICK CONTROLS always visible -->
<div style="padding:0 10px 5px"><div class="qc">
<button class="qb q-start" onclick="event.stopPropagation();cmdConfirm('${nm}','Start','‚ñ∂ –ü—É—Å–∫','FC05 coil 0x0000: Remote Start')">‚ñ∂ –ü—É—Å–∫</button>
<button class="qb q-stop" onclick="event.stopPropagation();cmdConfirm('${nm}','Stop','‚èπ –°—Ç–æ–ø','FC05 coil 0x0001: Remote Stop')">‚èπ –°—Ç–æ–ø</button>
<button class="qb q-auto" onclick="event.stopPropagation();cmdConfirm('${nm}','Auto','üÖ∞ –ê–≤—Ç–æ','FC05 coil 0x0003: Remote Auto')">üÖ∞ –ê–≤—Ç–æ</button>
<button class="qb q-manual" onclick="event.stopPropagation();cmdConfirm('${nm}','Manual','üîß –†—É—á–Ω–æ–π','FC05 coil 0x0004: Remote Manual')">üîß –†—É—á.</button>
</div><div class="cmd-st" id="cs-${nm.replace(/[\s\/]/g,'')}"></div></div>
<div class="cv" onclick="tog('c${sl}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
<div class="ce"><div class="ei">
<div class="tbs"><button class="tb on" onclick="stab(this,'${sl}e')">–≠–ª–µ–∫—Ç—Ä–∏–∫–∞</button><button class="tb" onclick="stab(this,'${sl}m')">–î–≤–∏–≥–∞—Ç–µ–ª—å</button><button class="tb" onclick="stab(this,'${sl}a')">–ê–≤–∞—Ä–∏–∏</button><button class="tb" onclick="stab(this,'${sl}c')">–í—Å–µ –∫–æ–º–∞–Ω–¥—ã</button></div>
<div class="tp on" id="${sl}e"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div></div>
<div class="tp" id="${sl}m"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="${sl}a">
<div style="display:flex;gap:4px;margin-bottom:8px"><button class="spr-b" style="flex:1;font-weight:600;color:var(--r)" id="${sl}a-act-btn" onclick="showAlarmSub('${sl}','act')">üî¥ –ê–∫—Ç–∏–≤–Ω—ã–µ</button><button class="spr-b" style="flex:1" id="${sl}a-arc-btn" onclick="showAlarmSub('${sl}','arc')">üìã –ê—Ä—Ö–∏–≤</button><button class="spr-b" onclick="clearAlarmArchive('${sl}')">üóë</button></div>
<div id="${sl}a-act"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–ù–µ—Ç –∞–≤–∞—Ä–∏–π ‚úì</div></div>
<div id="${sl}a-arc" style="display:none"><div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div></div>
</div>
<div class="tp" id="${sl}c"><div style="font-size:11px;color:var(--t3);margin-bottom:8px">–í—Å–µ –∫–æ–º–∞–Ω–¥—ã HGM9520N (FC05)</div>
<div class="cg">
<button class="cb2 cgo" onclick="event.stopPropagation();cmdConfirm('${nm}','Start','‚ñ∂ –ü—É—Å–∫','FC05 0x0000')"><span class="ci2">‚ñ∂</span>–ü—É—Å–∫</button>
<button class="cb2 cst" onclick="event.stopPropagation();cmdConfirm('${nm}','Stop','‚èπ –°—Ç–æ–ø','FC05 0x0001')"><span class="ci2">‚èπ</span>–°—Ç–æ–ø</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','Auto','üÖ∞ –ê–≤—Ç–æ','FC05 0x0003')"><span class="ci2">üÖ∞</span>–ê–≤—Ç–æ</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','Manual','üîß –†—É—á–Ω–æ–π','FC05 0x0004')"><span class="ci2">üîß</span>–†—É—á–Ω–æ–π</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','GenClose','‚ö° –í–ö–õ –≥–µ–Ω.','FC05 0x0006: Remote Gen Close')"><span class="ci2">‚ö°</span>–í–ö–õ –≥–µ–Ω.</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','GenOpen','‚ö° –û–¢–ö–õ –≥–µ–Ω.','FC05 0x0007: Remote Gen Open')"><span class="ci2">‚ö°</span>–û–¢–ö–õ –≥–µ–Ω.</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','MainsClose','üîå –ê–≤—Ç.—Å–µ—Ç–∏','FC05 0x0005: Mains Close/Open')"><span class="ci2">üîå</span>–ê–≤—Ç.—Å–µ—Ç–∏</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','Mute','üîá –¢–∏—à–∏–Ω–∞','FC05 addr 0x000C (12): Remote Mute Key')"><span class="ci2">üîá</span>–¢–∏—à–∏–Ω–∞</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','Reset','üîÑ –°–±—Ä–æ—Å','FC05 addr 0x0011 (17): Remote Alarm Reset')"><span class="ci2">üîÑ</span>–°–±—Ä–æ—Å</button>
</div><div style="margin-top:8px"><button class="cb2 q-danger" style="width:100%;flex-direction:row;justify-content:center;gap:8px;padding:10px" onclick="event.stopPropagation();cmdConfirm('${nm}','FastStop','üõë –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å—Ç–æ–ø','FC05 addr 0x000F (15): Remote Diesel Engine Fast Stop')"><span>üõë</span>–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å—Ç–æ–ø</button></div>
</div></div></div>
<div class="cf"><div class="li"><span class="lo lo-r"></span><span>–æ–∂–∏–¥–∞–Ω–∏–µ</span></div><span>tcp:${c.port||502} ¬∑ id:${c.slaveId||1}</span></div></div>`}
function sprCard(c){return`<div class="sr2"><div class="cc s-stb" id="cspr"><div class="ch" onclick="tog('cspr')">
<div class="cr1"><div class="cid"><div class="cdot cd-x"></div><div><div class="cn" style="color:var(--p)">–®–ü–†</div><div class="csb">HGM9560 ¬∑ ${esc(c.ip)}:${c.port||26} ¬∑ RTU</div></div></div><span class="bdg bdg-off" onclick="event.stopPropagation();openAlarms('cspr','spra')" title="–ù–∞–∂–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–≤–∞—Ä–∏–π">–û–ñ–ò–î–ê–ù–ò–ï</span></div>
<div class="kr kr5"><div class="kp"><div class="kl">P —à–∏–Ω—ã</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">U</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">f</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">–°–µ—Ç—å</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">–†–µ–∂–∏–º</div><div class="kv vm">‚Äî</div></div></div></div>
<!-- SPR QUICK CONTROLS -->
<div style="padding:0 10px 5px"><div class="qc">
<button class="qb q-start" onclick="event.stopPropagation();cmdConfirm('–®–ü–†','Start','‚ñ∂ –ü—É—Å–∫','FC05 0x0000')">‚ñ∂ –ü—É—Å–∫</button>
<button class="qb q-stop" onclick="event.stopPropagation();cmdConfirm('–®–ü–†','Stop','‚èπ –°—Ç–æ–ø','FC05 0x0001')">‚èπ –°—Ç–æ–ø</button>
<button class="qb q-auto" onclick="event.stopPropagation();cmdConfirm('–®–ü–†','Auto','üÖ∞ –ê–≤—Ç–æ','FC05 0x0003')">üÖ∞ –ê–≤—Ç–æ</button>
<button class="qb q-manual" onclick="event.stopPropagation();cmdConfirm('–®–ü–†','Manual','üîß –†—É—á–Ω–æ–π','FC05 0x0004')">üîß –†—É—á.</button>
</div><div class="cmd-st" id="cs-–®–ü–†"></div></div>
<div class="cv" onclick="tog('cspr')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
<div class="ce"><div class="ei">
<div class="tbs"><button class="tb on" onclick="stab(this,'sprov')">–û–±–∑–æ—Ä</button><button class="tb" onclick="stab(this,'sprb')">–®–∏–Ω–∞</button><button class="tb" onclick="stab(this,'sprm')">–°–µ—Ç—å</button><button class="tb" onclick="stab(this,'sprs')">–ö–æ–º–º—É—Ç–∞—Ü–∏—è</button><button class="tb" onclick="stab(this,'spra')">–ê–≤–∞—Ä–∏–∏</button><button class="tb" onclick="stab(this,'sprc');onSprControlTabOpen()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button><button class="tb" onclick="stab(this,'sprp')">–ü—Ä–µ—Å–µ—Ç—ã</button></div>
<div class="tp on" id="sprov"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="sprb"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="sprm"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="sprs"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="spra">
<div style="display:flex;gap:4px;margin-bottom:8px"><button class="spr-b" style="flex:1;font-weight:600;color:var(--r)" id="spra-act-btn" onclick="showAlarmSub('spr','act')">üî¥ –ê–∫—Ç–∏–≤–Ω—ã–µ</button><button class="spr-b" style="flex:1" id="spra-arc-btn" onclick="showAlarmSub('spr','arc')">üìã –ê—Ä—Ö–∏–≤</button><button class="spr-b" onclick="clearAlarmArchive('spr')">üóë</button></div>
<div id="spra-act"><div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –®–ü–†...</div></div>
<div id="spra-arc" style="display:none"><div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div></div>
</div>
<div class="tp" id="sprc">
<div id="sprCfgBanner" style="padding:8px 10px;background:var(--bg3);border:1px solid var(--bd);border-radius:6px;margin-bottom:10px;font-size:11px;color:var(--t3);font-family:var(--m);text-align:center">–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç —Å—á–∏—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
<div style="font-size:11px;color:var(--t3);margin-bottom:8px">–ö–æ–º–∞–Ω–¥—ã HGM9560 (FC05)</div>
<div class="spr-cg">
<button class="spr-b" id="sprCmdStart" onclick="cmdConfirm('–®–ü–†','Start','‚ñ∂ –ü—É—Å–∫','FC05 0x0000')"><span class="si2">‚ñ∂</span>–ü—É—Å–∫</button>
<button class="spr-b" id="sprCmdStop" onclick="cmdConfirm('–®–ü–†','Stop','‚èπ –°—Ç–æ–ø','FC05 0x0001')"><span class="si2">‚èπ</span>–°—Ç–æ–ø</button>
<button class="spr-b" id="sprCmdAuto" onclick="cmdConfirm('–®–ü–†','Auto','üÖ∞ –ê–≤—Ç–æ','FC05 0x0003')"><span class="si2">üÖ∞</span>–ê–≤—Ç–æ</button>
<button class="spr-b" id="sprCmdManual" onclick="cmdConfirm('–®–ü–†','Manual','üîß –†—É—á–Ω.','FC05 0x0004')"><span class="si2">üîß</span>–†—É—á–Ω.</button>
</div><div class="spr-cg">
<button class="spr-b" id="sprCmdMains" onclick="cmdConfirm('–®–ü–†','MainsSwitch','üîå –ê–≤—Ç.—Å–µ—Ç–∏','FC05 0x0005: Mains Close/Open')"><span class="si2">üîå</span>–ê–≤—Ç.—Å–µ—Ç–∏</button>
<button class="spr-b" id="sprCmdBusbar" onclick="cmdConfirm('–®–ü–†','BusbarSwitch','‚ö° –ê–≤—Ç.—à–∏–Ω—ã','FC05 0x0006: Busbar Close/Open')"><span class="si2">‚ö°</span>–ê–≤—Ç.—à–∏–Ω—ã</button>
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','Mute','üîá –¢–∏—à–∏–Ω–∞','FC05 0x000C: Mute')"><span class="si2">üîá</span>–¢–∏—à–∏–Ω–∞</button>
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','Confirm','‚úì –ü–æ–¥—Ç–≤.','FC05 0x000B: Confirm')"><span class="si2">‚úì</span>–ü–æ–¥—Ç–≤.</button>
</div>
<div style="font-size:11px;color:var(--t3);margin-top:12px;margin-bottom:6px">–†–µ–∂–∏–º –Ω–∞–≥—Ä—É–∑–∫–∏ (FC06 reg 4351) <span id="sprLmCurrent" style="font-size:10px;color:var(--t4)"></span></div>
<div style="padding:8px 10px;background:var(--ov);border:1px solid var(--bd);border-radius:6px;margin-bottom:8px;font-size:10px;color:var(--t2);line-height:1.5;font-family:var(--m)">
<b style="color:var(--g)">Gen Control (0)</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —É–ø—Ä–∞–≤–ª—è—é—Ç –º–æ—â–Ω–æ—Å—Ç—å—é. P% –∑–∞–¥–∞—ë—Ç, —Å–∫–æ–ª—å–∫–æ –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞ –≤—ã–¥–∞—ë—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –°–µ—Ç—å –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫.<br>
<b style="color:var(--b)">Mains Control (1)</b> ‚Äî —Å–µ—Ç—å –æ—Å–Ω–æ–≤–Ω–∞—è. P% –∑–∞–¥–∞—ë—Ç –ø–æ—Ä–æ–≥ ¬´—Å—Ä–µ–∑–∞–Ω–∏—è –ø–∏–∫–æ–≤¬ª (peak clipping). –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –≤–∫–ª—é—á–∞—é—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ç–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —ç—Ç–æ—Ç %.<br>
<b style="color:var(--p)">Load Reception (2)</b> ‚Äî –ø—Ä–∏—ë–º –Ω–∞–≥—Ä—É–∑–∫–∏. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –ø–ª–∞–≤–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –Ω–∞ —Å–µ–±—è –Ω–∞–≥—Ä—É–∑–∫—É –æ—Ç —Å–µ—Ç–∏.
</div>
<div style="display:flex;gap:6px;margin-bottom:10px">
<button class="spr-b" id="sprLm0" style="flex:1" onclick="setSprLoadMode(0)">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
<button class="spr-b" id="sprLm1" style="flex:1" onclick="setSprLoadMode(1)">–°–µ—Ç—å</button>
<button class="spr-b" id="sprLm2" style="flex:1" onclick="setSprLoadMode(2)">–ü—Ä–∏—ë–º –Ω–∞–≥—Ä.</button>
</div>
<div class="slider-group">
<div style="font-size:10px;color:var(--t3);margin-bottom:6px;line-height:1.4">P% –∏ Q% ‚Äî —É—Å—Ç–∞–≤–∫–∏ –¥–ª—è –®–ü–†. –í —Ä–µ–∂–∏–º–µ <b style="color:var(--g)">Gen Ctrl</b>: P% = –≤—ã—Ö–æ–¥–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞. –í —Ä–µ–∂–∏–º–µ <b style="color:var(--b)">Mains Ctrl</b>: P% = –ø–æ—Ä–æ–≥ –ø–∏–∫-—à–µ–π–≤–∏–Ω–≥–∞ —Å–µ—Ç–∏.</div>
<div class="slider-row"><span class="slider-label">P%</span><input type="range" id="sprPslider" min="0" max="1000" value="500" oninput="sprCfgDirty=true;$('sprPval').textContent=((+this.value)/10).toFixed(1)+'%'"><span class="slider-val" id="sprPval">50.0%</span></div>
<div class="slider-row"><span class="slider-label">Q%</span><input type="range" id="sprQslider" min="0" max="1000" value="500" oninput="sprCfgDirty=true;$('sprQval').textContent=((+this.value)/10).toFixed(1)+'%'"><span class="slider-val" id="sprQval">50.0%</span></div>
<button class="bp" id="sprSaveBtn" style="margin-top:6px;padding:7px;font-size:11px" onclick="saveSprConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä</button>
<div style="font-size:9px;color:var(--t4);margin-top:4px">FC06: LoadMode ‚Üí reg 4351, P% ‚Üí reg 4352, Q% ‚Üí reg 4354. –ó–Ω–∞—á–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.</div></div>
<div style="font-size:11px;color:var(--t3);margin-top:14px;margin-bottom:6px">–ë—ç–∫–∞–ø / –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
<div style="display:flex;gap:6px;margin-bottom:8px">
<button class="spr-b" style="flex:1" onclick="readSprConfig()"><span class="si2">üîÑ</span>–ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å</button>
<button class="spr-b" style="flex:1" onclick="backupSprConfig()"><span class="si2">üíæ</span>–ë—ç–∫–∞–ø</button>
<button class="spr-b" style="flex:1" onclick="openRestoreBackup()"><span class="si2">üìÇ</span>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
</div>
<div id="sprConfigStatus"></div>
<div id="sprBackupList"></div>
</div>
<!-- PRESETS TAB -->
<div class="tp" id="sprp">
<div style="font-size:11px;color:var(--t3);margin-bottom:10px">–ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã —Ä–µ–∂–∏–º–æ–≤ –®–ü–† (HGM9560)</div>
<div style="padding:10px;background:rgba(160,112,255,.04);border:1px solid rgba(160,112,255,.15);border-radius:8px;margin-bottom:12px;font-size:11px;color:var(--t2);line-height:1.5">
<b style="color:var(--p)">–ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–µ—Å–µ—Ç—ã?</b><br>
–ü—Ä–µ—Å–µ—Ç ‚Äî —ç—Ç–æ –≥–æ—Ç–æ–≤–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –∏–∑ —Ç—Ä—ë—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: <b>—Ä–µ–∂–∏–º –Ω–∞–≥—Ä—É–∑–∫–∏</b> (LoadMode), <b>% –∞–∫—Ç–∏–≤–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏</b> (P) –∏ <b>% —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏</b> (Q), –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –®–ü–† —á–µ—Ä–µ–∑ FC06.<br>
–í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ‚Äî –æ–¥–∏–Ω –∫–ª–∏–∫.
</div>
<div class="preset-grid">
<button class="preset-btn" onclick="applyPreset(this,'island')"><div class="preset-name">üèù –û—Å—Ç—Ä–æ–≤–Ω–æ–π</div><div class="preset-desc">Gen Ctrl ¬∑ P100% Q50%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'genres')"><div class="preset-name">üîã –ì–µ–Ω+–†–µ–∑–µ—Ä–≤</div><div class="preset-desc">Gen Ctrl ¬∑ P80% Q50%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'peak')"><div class="preset-name">‚ö° –ü–∏–∫-—à–µ–π–≤–∏–Ω–≥</div><div class="preset-desc">Mains Ctrl ¬∑ P30% Q50%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'parallel')"><div class="preset-name">üîÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å</div><div class="preset-desc">Load Rec ¬∑ P50% Q50%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'export')"><div class="preset-name">üì§ –≠–∫—Å–ø–æ—Ä—Ç</div><div class="preset-desc">Gen Ctrl ¬∑ P80% Q30%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'mains')"><div class="preset-name">üîå –¢–æ–ª—å–∫–æ —Å–µ—Ç—å</div><div class="preset-desc">Mains Ctrl ¬∑ P0% Q0%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'test')"><div class="preset-name">üîß –¢–µ—Å—Ç</div><div class="preset-desc">Gen Ctrl ¬∑ P20% Q20%</div></button>
</div>
<div id="presetExplain" style="padding:10px;background:var(--ov);border:1px solid var(--bd);border-radius:8px;margin-top:6px">
<div style="font-size:10px;color:var(--t3);margin-bottom:6px">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤:</div>
<div style="font-size:10px;color:var(--t2);line-height:1.6;font-family:var(--m)">
<b style="color:var(--g)">üèù –û—Å—Ç—Ä–æ–≤–Ω–æ–π</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫, —Å–µ—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∞. P=100%<br>
<b style="color:#00c8ff">üîã –ì–µ–Ω+–†–µ–∑–µ—Ä–≤</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π (80%), —Å–µ—Ç—å –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫. –ü—Ä–∏ –ø—Ä–æ–ø–∞–¥–∞–Ω–∏–∏ —Å–µ—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–∏—Ç–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏<br>
<b style="color:var(--y)">‚ö° –ü–∏–∫-—à–µ–π–≤–∏–Ω–≥</b> ‚Äî —Å–µ—Ç—å –æ—Å–Ω–æ–≤–Ω–∞—è, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —Å—Ä–µ–∑–∞—é—Ç –ø–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏. P=30%<br>
<b style="color:var(--p)">üîÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å</b> ‚Äî –ø—Ä–∏—ë–º –Ω–∞–≥—Ä—É–∑–∫–∏, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –∏ —Å–µ—Ç—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ<br>
<b style="color:var(--b)">üì§ –≠–∫—Å–ø–æ—Ä—Ç</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –≤—ã–¥–∞—é—Ç 80% –≤ —Å–µ—Ç—å (–æ–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞)<br>
<b style="color:var(--t)">üîå –¢–æ–ª—å–∫–æ —Å–µ—Ç—å</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã, –ø–∏—Ç–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ—Ç —Å–µ—Ç–∏<br>
<b style="color:var(--t3)">üîß –¢–µ—Å—Ç</b> ‚Äî 20% –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤
</div>
</div>
<div style="padding:10px;background:var(--ov);border:1px solid var(--bd);border-radius:8px;margin-top:8px"><div style="font-size:10px;color:var(--t3);margin-bottom:4px">–¢–µ–∫—É—â–∏–π:</div><div id="currentPreset" style="font-family:var(--m);font-size:12px;color:var(--t2)">–ù–µ –≤—ã–±—Ä–∞–Ω</div></div>
</div></div></div>
<div class="cf"><div class="li"><span class="lo lo-r"></span><span>–æ–∂–∏–¥–∞–Ω–∏–µ</span></div><span>rtu:9600/8N2 ¬∑ id:${c.slaveId||1}</span></div></div></div>`}
function applyPreset(btn,name){
const P={island:{m:0,p:1000,q:500,l:'üèù –û—Å—Ç—Ä–æ–≤–Ω–æ–π'},genres:{m:0,p:800,q:500,l:'üîã –ì–µ–Ω+–†–µ–∑–µ—Ä–≤ —Å–µ—Ç–∏'},peak:{m:1,p:300,q:500,l:'‚ö° –ü–∏–∫-—à–µ–π–≤–∏–Ω–≥'},parallel:{m:2,p:500,q:500,l:'üîÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å'},export:{m:0,p:800,q:300,l:'üì§ –≠–∫—Å–ø–æ—Ä—Ç'},mains:{m:1,p:0,q:0,l:'üîå –¢–æ–ª—å–∫–æ —Å–µ—Ç—å'},test:{m:0,p:200,q:200,l:'üîß –¢–µ—Å—Ç'}};
const pr=P[name];if(!pr)return;
// Apply preset to control tab UI
sprSelectedLoadMode=pr.m;sprCfgDirty=true;
applySprConfigToUI(pr.m, pr.p, pr.q);
const cp=$('currentPreset');if(cp)cp.innerHTML=`<b>${pr.l}</b> ¬∑ Mode=${pr.m} P=${(pr.p/10).toFixed(1)}% Q=${(pr.q/10).toFixed(1)}%`;
document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
ae(`üéõ –ü—Ä–µ—Å–µ—Ç: ${pr.l}`);
// Prompt to save to controller
if(confirm('–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–µ—Å–µ—Ç ¬´'+pr.l+'¬ª –∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä?\n\nLoadMode='+pr.m+' P='+(pr.p/10).toFixed(1)+'% Q='+(pr.q/10).toFixed(1)+'%')){saveSprConfig()}
else{const banner=$('sprCfgBanner');if(banner)banner.innerHTML='<span style="color:var(--y)">‚ö† –ü—Ä–µ—Å–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –ù–ï –∑–∞–ø–∏—Å–∞–Ω –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä. –ù–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.</span>'}}
function tog(id){$(id)?.classList.toggle('op')}
function openAlarms(cardId,alarmTabId){const card=$(cardId);if(!card)return;if(!card.classList.contains('op'))card.classList.add('op');const tabs=card.querySelectorAll('.tb');const panels=card.querySelectorAll('.tp');tabs.forEach(t=>t.classList.remove('on'));panels.forEach(p=>p.classList.remove('on'));tabs.forEach(t=>{if(t.textContent==='–ê–≤–∞—Ä–∏–∏')t.classList.add('on')});const ap=$(alarmTabId);if(ap)ap.classList.add('on');card.scrollIntoView({behavior:'smooth',block:'nearest'})}
function scrollToAlarm(){const cards=['cg1','cg2','cspr'];for(const id of cards){const c=$(id);if(c&&(c.classList.contains('s-wrn')||c.classList.contains('s-alm'))){const sl=id.replace('c','');const aTab=id==='cspr'?'spra':sl+'a';openAlarms(id,aTab);return}}}
function stab(btn,pid){const c=btn.closest('.cc');if(!c)return;c.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));c.querySelectorAll('.tp').forEach(p=>p.classList.remove('on'));btn.classList.add('on');$(pid)?.classList.add('on')}
function uCk(){const el=$('ck');if(el)el.textContent=now()}
setInterval(uCk,1000);
// === DEMO ===
function togDemo(){demo=!demo;
if(demo){if(cur&&S[cur]){const s=S[cur];if(!s.g1?.ip){s.g1={ip:'192.168.97.10',port:502,slaveId:1,runHours:1227};s.g2={ip:'192.168.97.11',port:502,slaveId:1,runHours:489};s.spr={ip:'10.11.0.2',port:26,slaveId:1};sv();renderDash()}}dStep=0;ae('‚ñ∂ –î–µ–º–æ');demoTick();demoIv=setInterval(demoTick,2500)}
else{clearInterval(demoIv);demoIv=null;
// Clean up demo power_limit data from latestMetrics
for(const did of Object.keys(latestMetrics)){const mx=latestMetrics[did];if(mx){delete mx.current_p_pct;delete mx.target_p_pct;delete mx.current_q_pct;delete mx.target_q_pct}}
ae('‚èπ –°—Ç–æ–ø');renderDash()}
const b=$('demoBtn');if(b){b.textContent=demo?'‚èπ –°—Ç–æ–ø':'‚ñ∂ –î–µ–º–æ';b.classList.toggle('demo-on',demo)}}
// Demo scenario: [g1state, g2state, mainsNormal, busbarClosed, mainsClosed, g1power, g2power]
// Shows realistic ATS: mains fail ‚Üí generators start ‚Üí parallel ‚Üí mains return ‚Üí transfer back
const SC=[
['standby','standby',true,false,true, 0,0],       // 1: –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —Å–µ—Ç—å –ø–∏—Ç–∞–µ—Ç, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —Å—Ç–æ—è—Ç
['standby','standby',true,false,true, 0,0],       // 2: –Ω–æ—Ä–º–∞–ª—å–Ω–æ
['standby','standby',false,false,true, 0,0],      // 3: –ê–í–ê–†–ò–Ø –°–ï–¢–ò! mains fail
['running','standby',false,false,false, 180,0],   // 4: G1 –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, G2 –µ—â—ë —Å—Ç–æ–∏—Ç
['running','running',false,false,false, 280,200],  // 5: –æ–±–∞ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å, –Ω–∞–±–∏—Ä–∞—é—Ç –æ–±–æ—Ä–æ—Ç—ã
['running','running',false,true,false, 320,240],   // 6: –∞–≤—Ç.—à–∏–Ω—ã –∑–∞–º–∫–Ω—É—Ç, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
['running','running',false,true,false, 340,220],   // 7: —Ä–∞–±–æ—Ç–∞—é—Ç, G1 –±–æ–ª—å—à–µ –º–æ—â–Ω–æ—Å—Ç–∏ —á–µ–º G2
['warning','running',false,true,false, 350,260],   // 8: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ G1 (—Ç–µ–º–ø.–û–ñ)
['running','running',false,true,false, 300,280],   // 9: G1 —Å–Ω–∏–∑–∏–ª –Ω–∞–≥—Ä—É–∑–∫—É, G2 –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç
['running','running',true,true,false, 280,260],    // 10: —Å–µ—Ç—å –≤–µ—Ä–Ω—É–ª–∞—Å—å! –Ω–æ –µ—â—ë –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞—Ö
['running','running',true,true,true, 200,180],     // 11: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Å–µ—Ç—å—é, –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
['standby','standby',true,false,true, 0,0]         // 12: –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –≤–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ —Å–µ—Ç—å
];
const ST={running:{dot:'cd-g',bdg:'bdg-run',txt:'–†–ê–ë–û–¢–ê',cls:'s-run'},warning:{dot:'cd-y',bdg:'bdg-w',txt:'–ü–†–ï–î–£–ü–†.',cls:'s-wrn'},alarm:{dot:'cd-r',bdg:'bdg-a',txt:'–ê–í–ê–†–ò–Ø',cls:'s-alm'},standby:{dot:'cd-x',bdg:'bdg-off',txt:'–°–¢–û–ü',cls:'s-stb'}};
function demoTick(){if(!cur||!S[cur])return;dStep++;const sc=SC[(dStep-1)%SC.length],s1=sc[0],s2=sc[1],mN=sc[2],bC=sc[3],mC=sc[4],p1base=sc[5],p2base=sc[6];
const on1=s1!=='standby',on2=s2!=='standby';
// Inject ONLY power_limit fields for demo (do NOT touch online/power_total/modes ‚Äî that breaks real WS data)
const _g1id=getDeviceIdForSlot('g1'),_g2id=getDeviceIdForSlot('g2');
if(_g1id){if(!latestMetrics[_g1id])latestMetrics[_g1id]={};latestMetrics[_g1id].current_p_pct=on1?75+R(-2,2):null;latestMetrics[_g1id].target_p_pct=on1?75:null;latestMetrics[_g1id].current_q_pct=on1?50+R(-1.5,1.5):null;latestMetrics[_g1id].target_q_pct=on1?50:null}
if(_g2id){if(!latestMetrics[_g2id])latestMetrics[_g2id]={};latestMetrics[_g2id].current_p_pct=on2?80+R(-3,3):null;latestMetrics[_g2id].target_p_pct=on2?80:null;latestMetrics[_g2id].current_q_pct=on2?45+R(-2,2):null;latestMetrics[_g2id].target_q_pct=on2?45:null}
// Pass actual power values to applyGen for display
applyGen('g1',s1,S[cur].g1?.runHours||1227,p1base,true);applyGen('g2',s2,S[cur].g2?.runHours||489,p2base,true);applySpr(on1||on2,mN,bC,mC,true);
const p1=on1?p1base+R(-10,10):0,p2=on2?p2base+R(-10,10):0,mP=mN&&mC?R(100,200):0;const busP2=p1+p2+(mN&&mC?mP:0);const el=n=>document.getElementById(n);
const pf=$('pflow');if(pf)pf.innerHTML=flowSvg(on1,on2,mN,bC,mC,p1,p2,mP,busP2,2,2);
if(el('sP'))el('sP').innerHTML=`${(p1+p2+mP).toFixed(1)}<span class="su">–∫–í—Ç</span>`;
if(el('sPg'))el('sPg').innerHTML=`${(p1+p2).toFixed(1)}<span class="su">–∫–í—Ç</span>`;
if(el('sU')){if(mN)el('sU').innerHTML=`${RI(398,406)}<span class="su">–í</span>`;else el('sU').innerHTML='<span style="color:var(--r)">–ê–í–ê–†</span>'}
if(el('sG'))el('sG').innerHTML=`${(on1?1:0)+(on2?1:0)}<span class="su">/2</span>`;
const w=s1==='alarm'||s2==='alarm'?'a':s1==='warning'||s2==='warning'?'w':(!mN&&!on1&&!on2)?'a':'ok';
if(el('sSt'))el('sSt').innerHTML=w==='a'?'<span class="bdg bdg-a" onclick="scrollToAlarm()" style="cursor:pointer">‚óè –ê–≤–∞—Ä–∏—è</span>':w==='w'?'<span class="bdg bdg-w" onclick="scrollToAlarm()" style="cursor:pointer">‚óè –ü—Ä–µ–¥—É–ø—Ä.</span>':'<span class="bdg bdg-ok">‚óè –ù–æ—Ä–º–∞</span>';
if(el('sResp')){var rid=S[cur]?.responsible||'';var users=getBxUsers();var rn='‚Äî';for(var ui=0;ui<users.length;ui++){if(users[ui].id===rid)rn=users[ui].name}el('sResp').textContent=rn}
if(el('evL'))el('evL').innerHTML=evts.slice(0,10).map(e=>`<div class="er"><span class="et">${e.t}</span>${esc(e.m)}</div>`).join('')}
function applyGen(sl,status,rh,basePower,isOnline){const card=$('c'+sl);if(!card)return;const st=ST[status],on=status!=='standby',isO=card.classList.contains('op');
card.className='cc '+st.cls+(isO?' op':'');card.querySelector('.cdot').className='cdot '+st.dot;
const bdg=card.querySelector('.bdg');bdg.className='bdg '+st.bdg;bdg.textContent=st.txt;
// Use real WS metrics if available, else random (demo)
const devId=getDeviceIdForSlot(sl),mx=devId?latestMetrics[devId]:null;
const p=mx?.power_total!=null?mx.power_total:(basePower?basePower+R(-8,8):R(220,340));
const u=mx?.gen_uab!=null?mx.gen_uab:R(398,406);
const I=mx?.current_a!=null?(mx.current_a+mx.current_b+mx.current_c):(basePower?Math.round(basePower*2.5+R(-20,20)):RI(1100,1350));
const f=mx?.gen_freq!=null?mx.gen_freq:R(49.96,50.04);
const kvs=card.querySelectorAll('.kv');
if(on&&isOnline){kvs[0].className='kv vg';kvs[0].innerHTML=p.toFixed(1)+'<span class="ku">–∫–í—Ç</span>';kvs[1].className='kv vn';kvs[1].innerHTML=u.toFixed(0)+'<span class="ku">–í</span>';kvs[2].className='kv vn';kvs[2].innerHTML=Math.round(I)+'<span class="ku">–ê</span>';kvs[3].className='kv vn';kvs[3].innerHTML=f.toFixed(2)+'<span class="ku">–ì—Ü</span>'}else kvs.forEach(k=>{k.className='kv vm';k.textContent='‚Äî'});
const modes=card.querySelectorAll('.mdt');modes.forEach(m=>m.classList.remove('on'));
if(mx){if(mx.mode_auto)modes[0]?.classList.add('on');if(mx.mode_manual)modes[1]?.classList.add('on');if(mx.mode_test)modes[2]?.classList.add('on');if(mx.mode_stop)modes[3]?.classList.add('on')}else{if(on)modes[0]?.classList.add('on');else modes[3]?.classList.add('on')}
if(typeof updateQuickButtons==='function')updateQuickButtons('c'+sl,mx);
// Power Limit block
const plb=$(sl+'-pl');if(plb){const hasPL=mx&&(mx.current_p_pct!=null||mx.target_p_pct!=null);if(hasPL&&isOnline){plb.style.display='';plb.classList.remove('disabled');const cpP=mx.current_p_pct??0,tpP=mx.target_p_pct,cpQ=mx.current_q_pct??0,tpQ=mx.target_q_pct;const pfEl=$(sl+'-pl-pf'),qfEl=$(sl+'-pl-qf'),pvEl=$(sl+'-pl-pv'),qvEl=$(sl+'-pl-qv');if(pfEl){pfEl.style.width=Math.min(cpP,100)+'%';pfEl.className='pl-fill'+(cpP>80?' pl-crit':cpP>50?' pl-warn':'')}if(qfEl){qfEl.style.width=Math.min(Math.abs(cpQ),100)+'%';qfEl.className='pl-fill pl-q'+(Math.abs(cpQ)>80?' pl-crit':Math.abs(cpQ)>50?' pl-warn':'')}if(pvEl)pvEl.textContent=cpP.toFixed(1)+'%'+(tpP!=null?' ‚Üí '+tpP.toFixed(1)+'%':'');if(qvEl)qvEl.textContent=cpQ.toFixed(1)+'%'+(tpQ!=null?' ‚Üí '+tpQ.toFixed(1)+'%':'')}else if(hasPL&&!isOnline){plb.style.display='';plb.classList.add('disabled')}else{plb.style.display='none'}}
// Update run hours display in header
const rhEl=$(sl+'-rh');if(rhEl){if(!isOnline){rhEl.textContent='‚è± ‚Äî —á';rhEl.style.opacity='0.4'}else{const rhVal=mx?.run_hours!=null?mx.run_hours:rh;rhEl.textContent='‚è± '+(typeof rhVal==='number'?rhVal.toFixed(0):rhVal)+' —á';rhEl.style.opacity=''}}
const tob=$(sl+'-to');if(tob){if(!isOnline){tob.querySelector('.to-head').innerHTML=`<span class="to-name" style="color:var(--t3)">‚ö† –ù–µ—Ç —Å–≤—è–∑–∏ ‚Äî –º–æ—Ç–æ—á–∞—Å—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</span>`;const bar=tob.querySelector('.to-bar');if(bar)bar.style.display='none';const tasks=tob.querySelector('.to-tasks');if(tasks)tasks.style.display='none';const hint=tob.querySelector('.to-hint');if(hint)hint.style.display='none'}else{const to=getNextTO(rh,cur,sl);if(to.unknown){tob.querySelector('.to-head').innerHTML=`<span class="to-name to-y">‚ö† –£–∫–∞–∂–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û</span><span class="to-remain" style="color:var(--y);cursor:pointer" onclick="event.stopPropagation();openSet()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí</span>`;tob.onclick=function(e){e.stopPropagation();openSet()};const bar=tob.querySelector('.to-bar');if(bar)bar.style.display='none';const tasks=tob.querySelector('.to-tasks');if(tasks)tasks.style.display='none';const hint=tob.querySelector('.to-hint');if(hint)hint.style.display='none'}else{const tc2=to.remain<0?'to-r':to.pct>85?'to-r':to.pct>65?'to-y':'to-g';const bc2=to.remain<0?'var(--r)':to.pct>85?'var(--r)':to.pct>65?'var(--y)':'var(--g)';tob.querySelector('.to-head').innerHTML=`<span class="to-name ${tc2}">${to.name} ‚Üí ${to.dueAt}—á</span><span class="to-remain">${to.remain>0?to.remain+'—á –æ—Å—Ç.':(to.remain<0?'–ø—Ä–æ—Å—Ä–æ—á. '+Math.abs(to.remain)+'—á':'—Å–µ–π—á–∞—Å')} ¬∑ ${rh}—á</span>`;const fill=tob.querySelector('.to-fill');if(fill){fill.parentElement.style.display='';fill.style.cssText=`width:${to.pct}%;background:${bc2}`}}}}
// online/offline indicator: isOnline=true means WS data arrives, separate from gen running
const connOk=isOnline!==undefined?isOnline:(mx?.online===true);
card.querySelector('.lo').className='lo '+(connOk?'lo-g':'lo-r');card.querySelector('.li span:last-child').textContent=connOk?(on?'live':'standby'):'offline';
// Detailed tabs ‚Äî use real WS data if available
const ct=mx?.coolant_temp!=null?mx.coolant_temp:(status==='warning'?RI(93,99):(status==='alarm'?RI(100,108):RI(75,88)));
const op=mx?.oil_pressure!=null?mx.oil_pressure:(status==='alarm'?RI(150,250):RI(350,450));
const eT=$(sl+'e');if(eT&&on&&isOnline){const pp=mx?.power_total!=null?mx.power_total:(basePower||p);
const q=mx?.reactive_total!=null?mx.reactive_total:R(30,55);
const pf=mx?.pf_avg!=null?mx.pf_avg:R(.97,.999);
const uab=mx?.gen_uab!=null?mx.gen_uab:u;
const ubc=mx?.gen_ubc!=null?mx.gen_ubc:R(397,403);
const uca=mx?.gen_uca!=null?mx.gen_uca:R(399,405);
const ia=mx?.current_a!=null?mx.current_a:Math.round(I/3+R(-15,15));
const ib=mx?.current_b!=null?mx.current_b:Math.round(I/3+R(-15,15));
const ic=mx?.current_c!=null?mx.current_c:Math.round(I/3+R(-15,15));
const pa=mx?.power_a!=null?mx.power_a:(pp/3+R(-5,5));
const pb=mx?.power_b!=null?mx.power_b:(pp/3+R(-5,5));
const pc=mx?.power_c!=null?mx.power_c:(pp/3+R(-5,5));
const ld=mx?.load_pct!=null?mx.load_pct:Math.round(pp/5);
const ekwh=mx?.energy_kwh!=null?mx.energy_kwh:RI(400,500);
const starts=mx?.start_count!=null?mx.start_count:RI(300,400);
eT.innerHTML=`<div class="mg"><div class="mc"><div class="ml">P</div><div class="mv vg">${pp.toFixed?pp.toFixed(1):pp}<span class="mu">–∫–í—Ç</span></div></div><div class="mc"><div class="ml">Q</div><div class="mv vn">${typeof q==='number'?q.toFixed(1):q}<span class="mu">–∫–≤–∞—Ä</span></div></div><div class="mc"><div class="ml">Cos œÜ</div><div class="mv vn">${typeof pf==='number'?pf.toFixed(3):pf}</div></div></div><table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U</th><th>I</th><th>P</th></tr></thead><tbody><tr><td class="ph">A-B</td><td>${typeof uab==='number'?uab.toFixed(0):uab}</td><td>${typeof ia==='number'?ia.toFixed(1):ia}</td><td>${typeof pa==='number'?pa.toFixed(1):pa}</td></tr><tr><td class="ph">B-C</td><td>${typeof ubc==='number'?ubc.toFixed(0):ubc}</td><td>${typeof ib==='number'?ib.toFixed(1):ib}</td><td>${typeof pb==='number'?pb.toFixed(1):pb}</td></tr><tr><td class="ph">C-A</td><td>${typeof uca==='number'?uca.toFixed(0):uca}</td><td>${typeof ic==='number'?ic.toFixed(1):ic}</td><td>${typeof pc==='number'?pc.toFixed(1):pc}</td></tr></tbody></table><div class="mg mg4" style="margin-top:10px"><div class="mc"><div class="ml">–ù–∞–≥—Ä—É–∑–∫–∞</div><div class="mv vn">${ld}%</div></div><div class="mc"><div class="ml">–≠–Ω–µ—Ä–≥–∏—è</div><div class="mv vn">${ekwh}<span class="mu">–∫–í—Ç¬∑—á</span></div></div><div class="mc"><div class="ml">–ú–æ—Ç–æ—á–∞—Å—ã</div><div class="mv vn">${typeof rh==='number'?rh.toFixed(0):rh}<span class="mu">—á</span></div></div><div class="mc"><div class="ml">–ü—É—Å–∫–æ–≤</div><div class="mv vn">${starts}</div></div></div>`}
else if(eT&&(!on||!isOnline))eT.innerHTML=`<div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">${connOk?'–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω':'–ù–µ—Ç —Å–≤—è–∑–∏'}</div>`;
const mT=$(sl+'m');if(mT&&on&&isOnline){
const rpm=mx?.engine_speed!=null?mx.engine_speed:1500;
const oilT=mx?.oil_temp!=null?mx.oil_temp:RI(70,85);
const fuel=mx?.fuel_level!=null?mx.fuel_level:RI(30,90);
const fc=mx?.fuel_consumption!=null?mx.fuel_consumption:R(30,45);
const turbo=mx?.turbo_pressure!=null?mx.turbo_pressure:RI(160,200);
const batt=mx?.battery_volt!=null?mx.battery_volt:R(27,28.5);
const ctC=(typeof ct==='number'&&ct>95)?'va':(typeof ct==='number'&&ct>88)?'vw':'vn';
const opC=(typeof op==='number'&&op<300)?'va':'vn';
const fuelC=(typeof fuel==='number'&&fuel<50)?'vw':'vn';
mT.innerHTML=`<div class="mg"><div class="mc"><div class="ml">–û–±–æ—Ä–æ—Ç—ã</div><div class="mv vn">${rpm}</div></div><div class="mc"><div class="ml">–¢–µ–º–ø.–û–ñ</div><div class="mv ${ctC}">${ct}¬∞C</div></div><div class="mc"><div class="ml">–î–∞–≤–ª.–º–∞—Å–ª–∞</div><div class="mv ${opC}">${op} –∫–ü–∞</div></div><div class="mc"><div class="ml">–¢–µ–º–ø.–º–∞—Å–ª–∞</div><div class="mv vn">${oilT}¬∞C</div></div><div class="mc"><div class="ml">–¢–æ–ø–ª–∏–≤–æ</div><div class="mv ${fuelC}">${fuel}%</div></div><div class="mc"><div class="ml">–†–∞—Å—Ö–æ–¥</div><div class="mv vn">${typeof fc==='number'?fc.toFixed(1):fc} –ª/—á</div></div><div class="mc"><div class="ml">–¢—É—Ä–±–æ</div><div class="mv vn">${turbo} –∫–ü–∞</div></div><div class="mc"><div class="ml">–ë–∞—Ç–∞—Ä–µ—è</div><div class="mv vn">${typeof batt==='number'?batt.toFixed(1):batt}–í</div></div></div>`}
else if(mT&&(!on||!isOnline))mT.innerHTML=`<div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">${connOk?'‚Äî':'–ù–µ—Ç —Å–≤—è–∑–∏'}</div>`;
const aT=$(sl+'a-act');if(aT){let ah='';
if(!connOk) ah+=`<div class="ai aa">üî¥ <b style="color:var(--r)">CONN_LOST</b> –ù–µ—Ç —Å–≤—è–∑–∏ —Å HGM9520N<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(mx?.alarm_common) ah+=`<div class="ai aa"${ah?' style="margin-top:2px"':''}>üî¥ <b style="color:var(--r)">COMMON</b> –û–±—â–∞—è –∞–≤–∞—Ä–∏—è<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(mx?.alarm_shutdown) ah+=`<div class="ai aa" style="margin-top:2px">üî¥ <b style="color:var(--r)">SHUTDOWN</b> –ê–≤–∞—Ä–∏–π–Ω—ã–π –æ—Å—Ç–∞–Ω–æ–≤<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(mx?.alarm_warning) ah+=`<div class="ai aw" style="margin-top:2px">‚ö† <b style="color:var(--y)">WARNING</b> –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(mx?.alarm_block) ah+=`<div class="ai aa" style="margin-top:2px">üî¥ <b style="color:var(--r)">BLOCK</b> –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
aT.innerHTML=ah||'<div style="color:var(--g);font-size:12px;text-align:center;padding:15px">‚úì –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤–∞—Ä–∏–π</div>'}}
function applySpr(gOn,mN,bC,mC,isOnline){const card=$('cspr');if(!card)return;const isO=card.classList.contains('op'),active=gOn||mN;
// Status: alarm (mains abnormal), running (active), standby (online but idle), offline
let cls='s-stb',dot='cd-x',bcls='bdg-off',btxt='–°–¢–û–ü';
if(!isOnline){cls='s-alm';dot='cd-r';bcls='bdg-a';btxt='–ê–í–ê–†–ò–Ø'}
else if(!mN&&!active){cls='s-alm';dot='cd-r';bcls='bdg-a';btxt='–ê–í–ê–†–ò–Ø'}
else if(active){cls='s-run';dot='cd-g';bcls='bdg-run';btxt='–†–ê–ë–û–¢–ê'}
else{cls='s-run';dot='cd-g';bcls='bdg-ok';btxt='–ù–û–†–ú–ê'}
card.className='cc '+cls+(isO?' op':'');card.querySelector('.cdot').className='cdot '+dot;
const bdg=card.querySelector('.bdg');bdg.className='bdg '+bcls;bdg.textContent=btxt;
const kvs=card.querySelectorAll('.kv'),bp=R(400,520),bu=RI(398,405),bf=R(49.98,50.04);
if(isOnline){
const m3=latestMetrics[getDeviceIdForSlot('spr')];
const rBp=m3?.busbar_p!=null?m3.busbar_p:0;
const rBu=m3?.busbar_uab!=null?m3.busbar_uab:0;
const rBf=m3?.busbar_freq!=null?m3.busbar_freq:0;
kvs[0].className='kv '+(rBp>0?'vg':'vn');kvs[0].innerHTML=(rBp||0).toFixed(1)+'<span class="ku">–∫–í—Ç</span>';
kvs[1].className='kv vn';kvs[1].innerHTML=(rBu||0)+'<span class="ku">–í</span>';
kvs[2].className='kv vn';kvs[2].innerHTML=(rBf||0).toFixed(2)+'<span class="ku">–ì—Ü</span>';
kvs[3].className=mN?'kv vg':'kv va';kvs[3].textContent=mN?'–ù–û–†–ú':'–ê–í–ê–†';
const mode=gOn&&!mC?'–ì–ï–ù':mC&&!gOn?'–°–ï–¢–¨':gOn&&mC?'–ü–ê–†–ê–õ':'‚Äî';
kvs[4].className='kv '+(gOn&&mC?'vp':gOn?'vg':mN?'vb':'vm');kvs[4].textContent=mN&&!gOn?'–°–ï–¢–¨':mode;
}else kvs.forEach(k=>{k.className='kv vm';k.textContent='‚Äî'});
card.querySelector('.lo').className='lo '+(isOnline?'lo-g':'lo-r');card.querySelector('.li span:last-child').textContent=isOnline?'live':'offline';
// Tabs (–û–±–∑–æ—Ä/–®–∏–Ω–∞/–°–µ—Ç—å/–ö–æ–º–º—É—Ç–∞—Ü–∏—è) are rendered by applySprDetailed() via WS updates
if(isOnline){const m3=latestMetrics[getDeviceIdForSlot('spr')];if(m3)applySprDetailed(m3)}
const sprAct=$('spra-act');if(sprAct){const sprMx=latestMetrics[getDeviceIdForSlot('spr')];let sah='';
if(!isOnline) sah+=`<div class="ai aa">üî¥ <b style="color:var(--r)">CONN_LOST</b> –ù–µ—Ç —Å–≤—è–∑–∏ —Å HGM9560<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(isOnline&&!mN) sah+=`<div class="ai aa"${sah?' style="margin-top:2px"':''}>üî¥ <b style="color:var(--r)">M001</b> –ê–≤–∞—Ä–∏—è —Å–µ—Ç–∏<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(sprMx?.alarm_common) sah+=`<div class="ai aa" style="margin-top:2px">üî¥ <b style="color:var(--r)">COMMON</b> –û–±—â–∞—è –∞–≤–∞—Ä–∏—è<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(sprMx?.alarm_shutdown) sah+=`<div class="ai aa" style="margin-top:2px">üî¥ <b style="color:var(--r)">SHUTDOWN</b> –ê–≤–∞—Ä–∏–π–Ω—ã–π –æ—Å—Ç–∞–Ω–æ–≤<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(sprMx?.alarm_warning) sah+=`<div class="ai aw" style="margin-top:2px">‚ö† <b style="color:var(--y)">WARNING</b> –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
if(sprMx?.alarm_trip_stop) sah+=`<div class="ai aa" style="margin-top:2px">üî¥ <b style="color:var(--r)">TRIP_STOP</b> –ê–≤–∞—Ä–∏–π–Ω—ã–π —Å—Ç–æ–ø<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;
sprAct.innerHTML=sah||'<div style="color:var(--g);font-size:12px;text-align:center;padding:15px">‚úì –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤–∞—Ä–∏–π</div>'}}
// === BITRIX24 INTEGRATION ===
function getBxConfig(){try{return JSON.parse(localStorage.getItem('s5bx'))||{}}catch(e){return{}}}
function saveBxCfg(c){localStorage.setItem('s5bx',JSON.stringify(c))}
function getBxUsers(){try{return JSON.parse(localStorage.getItem('s5bx_users'))||[]}catch(e){return[]}}
function saveBxUsers(u){localStorage.setItem('s5bx_users',JSON.stringify(u))}
async function getBxWebhookUrl(){
  const cfg=getBxConfig();
  if(cfg.url)return cfg.url;
  if(apiAvailable){try{const s=await api.get('/api/bitrix24/status');if(s.webhook_url){cfg.url=s.webhook_url;saveBxCfg(cfg);return s.webhook_url}}catch(e){}}
  return '';
}
async function initBxModal(){
  let cfg=getBxConfig();
  if(apiAvailable){
    try{const r=await api.get('/api/bitrix24/config');if(r.group_id)cfg.groupId=String(r.group_id);if(r.task_title_template)cfg.taskTitle=r.task_title_template;if(r.deadline_days)cfg.deadlineDays=r.deadline_days;if(r.priority)cfg.priority=String(r.priority);if(r.auto_create!==undefined)cfg.autoCreate=r.auto_create;if(r.add_checklist!==undefined)cfg.addChecklist=r.add_checklist;if(r.auditor_id)cfg.auditor=String(r.auditor_id)}catch(e){}
    try{const s=await api.get('/api/bitrix24/status');if(s.webhook_url)cfg.url=s.webhook_url}catch(e){}
    saveBxCfg(cfg);
  }
  if($('bxUrl'))$('bxUrl').value=cfg.url||'';
  if($('bxFolderId'))$('bxFolderId').value=cfg.folderId||'';
  if($('bxGroupId'))$('bxGroupId').value=cfg.groupId||'46';
  if($('bxTaskTitle'))$('bxTaskTitle').value=cfg.taskTitle||'{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}';
  if($('bxDeadlineDays'))$('bxDeadlineDays').value=cfg.deadlineDays||3;
  if($('bxPriority'))$('bxPriority').value=cfg.priority||'1';
  if($('bxAutoCreate'))$('bxAutoCreate').checked=cfg.autoCreate||false;
  if($('bxAddChecklist'))$('bxAddChecklist').checked=cfg.addChecklist!==false;
  if($('bxDescBBCode'))$('bxDescBBCode').checked=cfg.descBBCode!==false;
  const aud=$('bxAuditor');
  if(aud){const users=getBxUsers();aud.innerHTML='<option value="">‚Äî –Ω–µ—Ç ‚Äî</option>'+users.map(u=>`<option value="${u.id||u.ID}"${String(u.id||u.ID)===String(cfg.auditor)?' selected':''}>${u.name||(u.LAST_NAME||'')+' '+(u.NAME||'')}</option>`).join('')}
}
function bxTab(btn,idx){btn.closest('.mbd').querySelectorAll('.set-tab').forEach(b=>b.classList.remove('on'));btn.closest('.mbd').querySelectorAll('.set-panel').forEach(p=>p.classList.remove('on'));btn.classList.add('on');$('bxp'+idx)?.classList.add('on');if(idx===1){const ul=$('bxUserList');if(ul&&(!ul.innerHTML||ul.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∏—Ç–µ')||ul.innerHTML.includes('–¥–µ–º–æ')))loadBxUsers()}}
async function saveBxConfig(){const cfg=getBxConfig();cfg.url=($('bxUrl')?.value||'').trim();cfg.folderId=$('bxFolderId')?.value||'';cfg.groupId=$('bxGroupId')?.value||'';cfg.taskTitle=$('bxTaskTitle')?.value||'{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}';cfg.deadlineDays=+($('bxDeadlineDays')?.value)||3;cfg.priority=$('bxPriority')?.value||'1';cfg.auditor=$('bxAuditor')?.value||'';cfg.autoCreate=$('bxAutoCreate')?.checked||false;cfg.addChecklist=$('bxAddChecklist')?.checked!==false;cfg.descBBCode=$('bxDescBBCode')?.checked!==false;saveBxCfg(cfg);
if(apiAvailable){try{await api.put('/api/bitrix24/config',{group_id:+cfg.groupId||46,deadline_days:cfg.deadlineDays,priority:+cfg.priority,auto_create:cfg.autoCreate,add_checklist:cfg.addChecklist,auditor_id:+cfg.auditor||null,task_title_template:cfg.taskTitle})}catch(e){}}
ae('‚úÖ –ë–∏—Ç—Ä–∏–∫—Å24 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã')}
async function testBxConnection(){const el=$('bxConnResult');const url=($('bxUrl')?.value||'').trim();if(!url){el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">–£–∫–∞–∂–∏—Ç–µ Webhook URL</div>';return}
el.innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y);font-family:var(--m)">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>';
if(apiAvailable){try{const r=await api.post('/api/bitrix/test',{webhook_url:url});
if(r.success){el.innerHTML='<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m)">‚úÖ '+r.message+'</div>';ae('‚úÖ –ë24 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ OK')}
else{el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+r.message+'</div>'}
}catch(e){el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+e.message+'</div>'}}
else{setTimeout(function(){el.innerHTML='<div style="padding:6px 10px;background:var(--bb);border:1px solid rgba(64,144,255,.2);border-radius:6px;font-size:11px;color:var(--b);font-family:var(--m)">‚Ñπ Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. URL: '+esc(url.substring(0,40))+'...</div>'},800)}}
async function loadBxUsers(){const el=$('bxUserList');el.innerHTML='<div style="color:var(--y);font-size:12px;text-align:center;padding:15px">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ user.get...</div>';
const url=await getBxWebhookUrl();
if(apiAvailable&&url){try{const r=await api.post('/api/bitrix/users/sync',{webhook_url:url});
if(r.success&&r.users&&r.users.length>0){saveBxUsers(r.users);var h='';for(var i=0;i<r.users.length;i++){var u=r.users[i];h+='<div class="bk-item"><div><b style="color:var(--t)">'+esc(u.name)+'</b><br><span style="color:var(--t3);font-size:10px">'+esc(u.pos||'‚Äî')+' ¬∑ '+esc(u.dept||'‚Äî')+'</span></div><span style="font-size:10px;color:var(--t4);font-family:var(--m)">ID: '+u.id+'</span></div>'}
el.innerHTML=h+'<div style="padding:6px;text-align:center;font-size:10px;color:var(--t4)">'+r.users.length+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –ë24</div>';ae('üë• –ó–∞–≥—Ä—É–∂–µ–Ω–æ '+r.users.length+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');return}
}catch(e){console.warn('Bitrix users error:',e)}}
el.innerHTML='<div style="padding:10px;text-align:center;font-size:11px;color:var(--r)">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Webhook URL –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ¬ª.</div>'}
function formatSize(b){if(b<1024)return b+' –ë';if(b<1048576)return(b/1024).toFixed(0)+' –ö–ë';return(b/1048576).toFixed(1)+' –ú–ë'}
async function scanBxFolder(){var el=$('bxFileList');var fid=$('bxFolderId')?.value;if(!fid){el.innerHTML='<div style="padding:6px;background:var(--rd);border-radius:6px;font-size:11px;color:var(--r)">–£–∫–∞–∂–∏—Ç–µ ID –ø–∞–ø–∫–∏</div>';return}
el.innerHTML='<div style="padding:10px;color:var(--y);font-size:12px;text-align:center">‚è≥ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ disk.folder.getchildren...</div>';
var url=await getBxWebhookUrl();
if(apiAvailable&&url){try{var r=await api.post('/api/bitrix/folder/scan',{webhook_url:url,folder_id:parseInt(fid)});
if(r.success&&r.files&&r.files.length>0){var h='<div style="font-size:11px;color:var(--t3);margin-bottom:6px">–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: '+r.files.length+'</div>';
for(var i=0;i<r.files.length;i++){var f=r.files[i];var ext=(f.name||'').split('.').pop().toLowerCase();var canParse=(ext==='pdf'||ext==='docx');
h+='<div class="bk-item"><div><b style="color:var(--t)">'+esc(f.name)+'</b><br><span style="color:var(--t3);font-size:10px">'+ext.toUpperCase()+' ¬∑ '+formatSize(f.size||0)+' ¬∑ '+(f.updated||'')+'</span></div>';
if(canParse){h+='<button class="bk-btn" onclick="importBxFile('+f.id+',\''+esc(f.name).replace(/'/g,"\\'")+'\')" style="color:var(--p)">ü§ñ AI Import</button>'}
h+='</div>'}
el.innerHTML=h;ae('üìÇ –ù–∞–π–¥–µ–Ω–æ '+r.files.length+' —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ –ë24')}
else if(r.success){el.innerHTML='<div style="padding:10px;font-size:11px;color:var(--t3);text-align:center">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</div>'}
else{el.innerHTML='<div style="padding:6px;background:var(--rd);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+(r.message||'–û—à–∏–±–∫–∞')+'</div>'}}
catch(e){el.innerHTML='<div style="padding:6px;background:var(--rd);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+e.message+'</div>'}}
else{el.innerHTML='<div style="padding:10px;text-align:center;font-size:11px;color:var(--r)">‚ùå Webhook URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –£–∫–∞–∂–∏—Ç–µ URL –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ¬ª.</div>'}}
async function importBxFile(fileId,filename){var el=$('bxFileList');var bxUrl=await getBxWebhookUrl();
el.innerHTML+='<div id="aiProgress" style="padding:10px;background:var(--pd);border:1px solid rgba(160,112,255,.2);border-radius:8px;margin-top:8px"><div style="font-size:12px;color:var(--p);font-weight:600;margin-bottom:6px">ü§ñ AI-–∞–≥–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</div><div id="aiStep" style="font-size:11px;color:var(--t2)">‚è≥ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24...</div><div style="margin-top:6px;height:3px;background:rgba(160,112,255,.1);border-radius:2px;overflow:hidden"><div id="aiBar" style="width:10%;height:100%;background:var(--p);transition:width .5s"></div></div></div>';
ae('ü§ñ AI-–∏–º–ø–æ—Ä—Ç: '+(filename||'file#'+fileId));
var t1=setTimeout(function(){var b=$('aiBar'),s=$('aiStep');if(b)b.style.width='30%';if(s)s.textContent='‚è≥ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞...'},2000);
var aiCfgName=((AI_PROVIDERS[(getAIConfig().provider||'openai')])||{}).name||'AI';
var t2=setTimeout(function(){var b=$('aiBar'),s=$('aiStep');if(b)b.style.width='50%';if(s)s.textContent='‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ '+aiCfgName+' –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...'},5000);
var t3=setTimeout(function(){var b=$('aiBar'),s=$('aiStep');if(b)b.style.width='80%';if(s)s.textContent='‚è≥ –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¢–û –∏ —Ä–∞–±–æ—Ç...'},15000);
if(apiAvailable&&bxUrl){try{var r=await api.post('/api/ai/parse',{webhook_url:bxUrl,file_id:fileId,filename:filename||''});
clearTimeout(t1);clearTimeout(t2);clearTimeout(t3);
var bar=$('aiBar');if(bar)bar.style.width='100%';
if(r.success&&r.intervals&&r.intervals.length>0){window._aiParsedResult=r;
var prog=$('aiProgress');if(prog)prog.remove();
var h='<div id="aiResult" style="padding:10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:8px;margin-top:8px">';
h+='<div style="font-size:12px;color:var(--g);font-weight:600;margin-bottom:6px">‚úÖ AI-–∞–≥–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª –∞–Ω–∞–ª–∏–∑</div>';
h+='<div style="font-size:11px;color:var(--t2);margin-bottom:8px">'+esc(r.template_name)+' ‚Äî '+r.intervals.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤</div>';
for(var i=0;i<r.intervals.length;i++){var iv=r.intervals[i];h+='<div style="padding:5px 8px;background:var(--ov);border:1px solid var(--bd);border-radius:4px;margin-bottom:3px"><div style="display:flex;justify-content:space-between"><b style="font-size:11px">'+esc(iv.name)+'</b><span style="font-size:10px;color:var(--t3);font-family:var(--m)">'+iv.hours+'—á ¬∑ '+iv.tasks.length+' —Ä–∞–±–æ—Ç</span></div></div>'}
h+='<div style="display:flex;gap:8px;margin-top:10px"><button class="bp" style="flex:1" onclick="applyAIResult()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—É</button><button class="bs2" style="padding:10px" onclick="var e=document.getElementById(\'aiResult\');if(e)e.remove()">‚úï</button></div></div>';
el.innerHTML+=h;ae('‚úÖ AI: –Ω–∞–π–¥–µ–Ω–æ '+r.intervals.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¢–û')}
else{var step=$('aiStep');if(step){step.textContent='‚ùå '+(r.error||'–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ');step.style.color='var(--r)'}ae('‚ùå AI: '+(r.error||'–ø—É—Å—Ç–æ'))}}
catch(e){clearTimeout(t1);clearTimeout(t2);clearTimeout(t3);var step=$('aiStep');if(step){step.textContent='‚ùå –û—à–∏–±–∫–∞: '+e.message;step.style.color='var(--r)'}ae('‚ùå AI –æ—à–∏–±–∫–∞: '+e.message)}}
else{clearTimeout(t1);clearTimeout(t2);clearTimeout(t3);var step=$('aiStep');if(step){step.textContent='‚Ñπ Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî AI-–∏–º–ø–æ—Ä—Ç —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É';step.style.color='var(--b)'}}}
function applyAIResult(){var r=window._aiParsedResult;if(!r||!r.intervals){ae('‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö AI');return}
var tpl=getTpl();var newIvs=[];
for(var i=0;i<r.intervals.length;i++){var iv=r.intervals[i];var tasks=[];
for(var j=0;j<iv.tasks.length;j++){tasks.push({id:j+1,text:iv.tasks[j].text,c:iv.tasks[j].is_critical?1:0})}
newIvs.push({id:iv.code,name:iv.name,hours:iv.hours,tasks:tasks})}
if(confirm('–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–≥–ª–∞–º–µ–Ω—Ç ('+tpl.intervals.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤) –Ω–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ('+newIvs.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤)?')){
tpl.name=r.template_name||tpl.name;tpl.intervals=newIvs;saveTpl(tpl);
ae('‚úÖ –†–µ–≥–ª–∞–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –∏–∑ AI: '+newIvs.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤');hideM('bitrix');openTOTemplates()}}
function createBxTaskFromTO(dev){var tpl=getTpl();var idx=+($('toSel')?.value||0);var iv=tpl.intervals[idx];if(!iv){ae('‚ö† –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¢–û');return}createBxTask(dev,iv.name,iv.tasks)}
function createBxTask(dev,toName,tasks){var cfg=getBxConfig();var s=S[cur];if(!s)return;var users=getBxUsers();var respId=s.responsible||'';var respName='–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';for(var i=0;i<users.length;i++){if(users[i].id===respId)respName=users[i].name}
var genName=dev==='g1'?'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1':'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2';var title=cfg.taskTitle||'{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}';title=title.replace('{TO_NAME}',toName).replace('{SITE_NAME}',s.name).replace('{GEN_NAME}',genName).replace('{HOURS}',s[dev]?.runHours||0).replace('{RESPONSIBLE}',respName);
var dl=new Date();dl.setDate(dl.getDate()+(+cfg.deadlineDays||3));var dlStr=dl.toISOString().replace('Z','+03:00');
var desc='[B]–û–±—ä–µ–∫—Ç:[/B] '+s.name+'\n[B]–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä:[/B] '+genName+'\n[B]–ú–æ—Ç–æ—á–∞—Å—ã:[/B] '+(s[dev]?.runHours||0)+'\n[B]–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:[/B] '+respName+'\n\n[B]–†–∞–±–æ—Ç—ã –¢–û:[/B]\n';
for(var ti=0;ti<tasks.length;ti++){desc+=(ti+1)+'. '+tasks[ti].text+(tasks[ti].c?' [COLOR=red][!] –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û[/COLOR]':'')+'\n'}
var auditors=cfg.auditor?'['+cfg.auditor+']':'[]';
var payload=JSON.stringify({fields:{TITLE:title,DESCRIPTION:desc,DESCRIPTION_IN_BBCODE:"Y",RESPONSIBLE_ID:+respId||null,GROUP_ID:cfg.groupId?+cfg.groupId:null,DEADLINE:dlStr,PRIORITY:+(cfg.priority||1),AUDITORS:cfg.auditor?[+cfg.auditor]:[],ALLOW_CHANGE_DEADLINE:"N"}},null,2);
var chkPayload='// –î–ª—è –∫–∞–∂–¥–æ–π —Ä–∞–±–æ—Ç—ã:\ntask.checklistitem.add\n[TASK_ID, {"TITLE": "—Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç—ã"}]';
$('toBody').innerHTML+='<div style="padding:10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:8px;margin-top:10px"><div style="font-size:12px;color:var(--g);font-weight:600;margin-bottom:8px">üìã –ó–∞–¥–∞—á–∞ –¥–ª—è –ë–∏—Ç—Ä–∏–∫—Å24</div><div style="font-size:11px;color:var(--t2);line-height:1.5"><b>TITLE:</b> '+esc(title)+'<br><b>RESPONSIBLE_ID:</b> '+respId+' ('+esc(respName)+')<br><b>GROUP_ID:</b> '+(cfg.groupId||'‚Äî')+'<br><b>DEADLINE:</b> '+dlStr+'<br><b>PRIORITY:</b> '+(cfg.priority||1)+'<br><b>AUDITORS:</b> '+auditors+'<br><b>–ß–µ–∫–ª–∏—Å—Ç:</b> '+tasks.length+' –ø—É–Ω–∫—Ç–æ–≤'+(cfg.addChecklist!==false?' (task.checklistitem.add)':' (–æ—Ç–∫–ª—é—á—ë–Ω)')+'</div><details style="margin-top:8px"><summary style="cursor:pointer;font-size:10px;color:var(--t3)">–ü–æ–∫–∞–∑–∞—Ç—å JSON payload</summary><pre style="font-size:9px;color:var(--t3);background:var(--bg);padding:8px;border-radius:4px;margin-top:4px;overflow-x:auto;white-space:pre-wrap">POST {webhook}/tasks.task.add\n'+esc(payload)+'</pre></details><div style="margin-top:8px;font-size:9px;color:var(--t4)">–¢—Ä–µ–±—É–µ—Ç—Å—è backend –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. URL: '+esc((cfg.url||'https://...').substring(0,35))+'...</div></div>';ae('üìã –ë24 –∑–∞–¥–∞—á–∞: '+title)}
// initBxModal() defined above in BITRIX24 INTEGRATION section (async, loads from backend API)
// === AI PROVIDER CONFIG (Multi-provider, persistent DB storage) ===
const AI_PROVIDERS={
openai:{id:'openai',name:'OpenAI',color:'#10a37f',icon:'üü¢',models:['gpt-4o','gpt-4o-mini','gpt-4-turbo','o3-mini'],keyPrefix:'sk-',keyPlaceholder:'sk-proj-...'},
claude:{id:'claude',name:'Claude',color:'#d97706',icon:'üü†',models:['claude-sonnet-4-20250514','claude-3-5-haiku-20241022','claude-opus-4-20250514'],keyPrefix:'sk-ant-',keyPlaceholder:'sk-ant-api03-...'},
gemini:{id:'gemini',name:'Gemini',color:'#4285f4',icon:'üîµ',models:['gemini-2.5-pro','gemini-2.5-flash','gemini-2.0-flash'],keyPrefix:'AI',keyPlaceholder:'AIza...'},
grok:{id:'grok',name:'Grok',color:'#ef4444',icon:'üî¥',models:['grok-3','grok-3-mini','grok-2'],keyPrefix:'xai-',keyPlaceholder:'xai-...'}
};
var _aiDbData=null;var _aiEditPid=null;
function getAIConfig(){try{return JSON.parse(localStorage.getItem('s5ai'))||{}}catch(e){return{}}}
function saveAICfg(c){localStorage.setItem('s5ai',JSON.stringify(c))}
async function initAIModal(){
var cfg=getAIConfig();_aiDbData=null;
if(apiAvailable){try{_aiDbData=await api.get('/api/ai/providers')}catch(e){console.warn('AI providers fetch:',e)}}
var cards=$('aiProviderCards');if(!cards)return;var h='';
for(var k in AI_PROVIDERS){var p=AI_PROVIDERS[k];
var isActive=_aiDbData?(_aiDbData.active_provider===k):(cfg.provider===k);
var isCfg=false;
if(_aiDbData){var dp=_aiDbData.providers.find(function(x){return x.provider===k});isCfg=dp?dp.is_configured:false}
else{isCfg=!!(cfg.keys&&cfg.keys[k])}
h+='<div onclick="selectAIProvider(\''+k+'\')" style="padding:10px;border:2px solid '+(isActive?p.color:isCfg?'var(--g)':'var(--bd)')+';border-radius:var(--rad);cursor:pointer;background:'+(isActive?p.color+'15':'var(--ov)')+';transition:all .2s;text-align:center;position:relative" id="aip_'+k+'">';
h+='<div style="font-size:22px;margin-bottom:4px">'+p.icon+'</div>';
h+='<div style="font-size:13px;font-weight:600;color:'+(isActive?p.color:'var(--t)')+'">'+p.name+'</div>';
h+='<div style="font-size:9px;margin-top:2px;color:'+(isCfg?'var(--g)':'var(--t4)')+'">'+
(isCfg?'‚óè –ù–∞—Å—Ç—Ä–æ–µ–Ω':'‚óã –ù–µ—Ç –∫–ª—é—á–∞')+'</div>';
if(isActive)h+='<div style="font-size:8px;color:'+p.color+';font-weight:700;margin-top:2px">‚òÖ –ê–ö–¢–ò–í–ù–´–ô</div>';
h+='</div>'}
cards.innerHTML=h;
var showPid=_aiDbData?_aiDbData.active_provider:cfg.provider;
if(showPid){showAIKeySection(showPid)}else{$('aiKeySection').style.display='none'}
updateAIStatus()}
function selectAIProvider(pid){
for(var k in AI_PROVIDERS){var el=$('aip_'+k);if(!el)continue;var p=AI_PROVIDERS[k];
var isActive=_aiDbData?(_aiDbData.active_provider===k):false;
var isCfg=false;if(_aiDbData){var dp=_aiDbData.providers.find(function(x){return x.provider===k});isCfg=dp?dp.is_configured:false}
var editing=k===pid;
el.style.borderColor=editing?p.color:isActive?p.color:isCfg?'var(--g)':'var(--bd)';
el.style.background=editing?p.color+'15':'var(--ov)'}
showAIKeySection(pid)}
function showAIKeySection(pid){var p=AI_PROVIDERS[pid];if(!p)return;
_aiEditPid=pid;var cfg=getAIConfig();
$('aiKeySection').style.display='block';
$('aiKeyLabel').textContent=p.name+' API Key';$('aiKeyLabel').style.color=p.color;
$('aiKeyInput').placeholder=p.keyPlaceholder;$('aiKeyInput').type='password';
// Load key from localStorage (DB never returns full key)
$('aiKeyInput').value=cfg.keys?.[pid]||'';
var sel=$('aiModelSelect');sel.innerHTML='';
var savedModel=null;
if(_aiDbData){var dp=_aiDbData.providers.find(function(x){return x.provider===pid});if(dp&&dp.model)savedModel=dp.model}
if(!savedModel)savedModel=cfg.models?.[pid];
for(var i=0;i<p.models.length;i++){var o=document.createElement('option');o.value=p.models[i];o.textContent=p.models[i];sel.appendChild(o)}
if(savedModel)sel.value=savedModel;
$('aiTestResult').innerHTML='';
// Update activate button
var abtn=$('aiActivateBtn');if(abtn){
var isActive=_aiDbData?(_aiDbData.active_provider===pid):cfg.provider===pid;
abtn.textContent=isActive?'‚òÖ –ê–∫—Ç–∏–≤–Ω—ã–π':'‚òÜ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
abtn.style.background=isActive?'var(--gd)':'';abtn.style.color=isActive?'var(--g)':'';
abtn.style.borderColor=isActive?'rgba(0,224,154,.3)':'';
abtn.disabled=isActive}}
function toggleAIKeyVis(){var inp=$('aiKeyInput');inp.type=inp.type==='password'?'text':'password'}
async function saveAIConfig(){var pid=_aiEditPid;if(!pid){ae('‚ö† –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞');return}
var key=$('aiKeyInput').value.trim();var model=$('aiModelSelect').value;
if(!key){ae('‚ö† –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á');return}
// Save to localStorage
var cfg=getAIConfig();if(!cfg.keys)cfg.keys={};if(!cfg.models)cfg.models={};
cfg.keys[pid]=key;cfg.models[pid]=model;saveAICfg(cfg);
// Save to DB via backend
if(apiAvailable){try{var r=await api.post('/api/ai/provider/save',{provider:pid,api_key:key,model:model});
if(r.success){ae('üíæ '+AI_PROVIDERS[pid].name+' —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ë–î')}
else{ae('‚ö† '+r.message)}}catch(e){ae('‚ö† '+e.message);console.warn('AI save error:',e)}}
else{ae('‚úÖ '+AI_PROVIDERS[pid].name+' —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)')}
await initAIModal()}
async function activateAIProvider(){var pid=_aiEditPid;if(!pid)return;
if(!apiAvailable){ae('‚ö† Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');return}
try{var r=await api.post('/api/ai/provider/activate',{provider:pid});
if(r.success){ae('‚òÖ '+AI_PROVIDERS[pid].name+' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
var cfg=getAIConfig();cfg.provider=pid;saveAICfg(cfg);await initAIModal()}
else{ae('‚ö† '+r.message)}}catch(e){ae('‚ö† '+e.message)}}
async function testAIProvider(){var pid=_aiEditPid;if(!pid)return;
var key=$('aiKeyInput').value.trim();var model=$('aiModelSelect').value;
if(!key){$('aiTestResult').innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á</div>';return}
var el=$('aiTestResult');el.innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y);font-family:var(--m)">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ '+AI_PROVIDERS[pid].name+'...</div>';
if(apiAvailable){try{var r=await api.post('/api/ai/test',{provider:pid,api_key:key,model:model});
if(r.success){el.innerHTML='<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m)">‚úÖ '+r.message+'</div>';ae('‚úÖ '+AI_PROVIDERS[pid].name+' OK')}
else{el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+(r.error||'–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è')+'</div>'}}
catch(e){el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+e.message+'</div>'}}
else{setTimeout(function(){el.innerHTML='<div style="padding:6px 10px;background:var(--bb);border:1px solid rgba(64,144,255,.2);border-radius:6px;font-size:11px;color:var(--b);font-family:var(--m)">‚Ñπ Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Ç–µ—Å—Ç —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É</div>'},800)}}
function updateAIStatus(){var el=$('aiStatus');if(!el)return;
if(_aiDbData){
var cfgCount=_aiDbData.providers.filter(function(p){return p.is_configured}).length;
var ap=_aiDbData.active_provider;var apInfo=ap?AI_PROVIDERS[ap]:null;
el.innerHTML='<b>–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã:</b> '+cfgCount+'/4 –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ'+
(apInfo?' ¬∑ <b>–ê–∫—Ç–∏–≤–Ω—ã–π:</b> '+apInfo.icon+' <span style="color:'+apInfo.color+';font-weight:600">'+apInfo.name+'</span>':
' ¬∑ <span style="color:var(--y)">‚ö† –∞–∫—Ç–∏–≤–Ω—ã–π –Ω–µ –≤—ã–±—Ä–∞–Ω</span>');
// Show configured providers list
var cfgList=_aiDbData.providers.filter(function(p){return p.is_configured});
if(cfgList.length>0){var det='';cfgList.forEach(function(dp){var pi=AI_PROVIDERS[dp.provider];
det+='<br>'+pi.icon+' '+pi.name+': <span style="font-family:var(--m);font-size:9px">'+esc(dp.model)+'</span>'+(dp.is_active?' <span style="color:var(--g)">‚òÖ</span>':'')});
el.innerHTML+=det}}
else{var cfg=getAIConfig();
if(!cfg.provider){el.innerHTML='<b>–°—Ç–∞—Ç—É—Å:</b> –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω';return}
var p=AI_PROVIDERS[cfg.provider];var hasKey=cfg.keys?.[cfg.provider];var model=cfg.models?.[cfg.provider]||p.models[0];
el.innerHTML='<b>–°—Ç–∞—Ç—É—Å:</b> '+p.icon+' <span style="color:'+p.color+';font-weight:600">'+p.name+'</span>'+(hasKey?' ¬∑ <span style="color:var(--g)">üîë –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω</span>':' ¬∑ <span style="color:var(--y)">‚ö† –Ω–µ—Ç –∫–ª—é—á–∞</span>')+'<br><b>–ú–æ–¥–µ–ª—å:</b> <span style="font-family:var(--m)">'+model+'</span>'}}
// === ALARM SYSTEM ===
// HGM9520N alarms from protocol Table 27
const ALARM_CODES={
'E001':'–ê–≤–∞—Ä–∏–π–Ω—ã–π –æ—Å—Ç–∞–Ω–æ–≤','E002':'–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –æ–±–æ—Ä–æ—Ç–æ–≤','E003':'–°–Ω–∏–∂–µ–Ω–∏–µ –æ–±–æ—Ä–æ—Ç–æ–≤','E004':'–ü–æ—Ç–µ—Ä—è —Å–∏–≥–Ω–∞–ª–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏',
'E005':'–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞','E006':'–ü–æ–Ω–∏–∂–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞','E007':'–ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞','E008':'–ü–æ–Ω–∏–∂–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞',
'E009':'–ù–µ—É–¥–∞—á–Ω—ã–π –∑–∞–ø—É—Å–∫','E010':'–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø–æ —Ç–æ–∫—É','E011':'–î–∏—Å–±–∞–ª–∞–Ω—Å —Ç–æ–∫–æ–≤','E012':'–ó–∞–º—ã–∫–∞–Ω–∏–µ –Ω–∞ –∑–µ–º–ª—é',
'E013':'–û–±—Ä–∞—Ç–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å','E014':'–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø–æ –º–æ—â–Ω–æ—Å—Ç–∏','E015':'–ü–æ—Ç–µ—Ä—è –≤–æ–∑–±—É–∂–¥–µ–Ω–∏—è','E016':'–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –≠–ë–£',
'W001':'–ê–≤–∞—Ä–∏—è –≠–ë–£','W002':'–í—Ö–æ–¥ –≤—ã—Å–æ–∫–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã','W003':'–í—Ö–æ–¥ –Ω–∏–∑–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è –º–∞—Å–ª–∞','W004':'–û—à–∏–±–∫–∞ MSC ID',
'W005':'–û—à–∏–±–∫–∞ —à–∏–Ω—ã –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è','W006':'–û—à–∏–±–∫–∞ —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è —Ñ–∞–∑','W007':'–û–±—Ä—ã–≤ –¥–∞—Ç—á–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã',
'W008':'–í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è','W009':'–ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è','W010':'–û–±—Ä—ã–≤ –¥–∞—Ç—á–∏–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è –º–∞—Å–ª–∞',
'W011':'–í—ã—Å–æ–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å–ª–∞','W012':'–ù–∏–∑–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å–ª–∞','W013':'–ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞',
'W014':'–û—à–∏–±–∫–∞ –∑–∞—Ä—è–¥–∫–∏','W015':'–ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë','W016':'–ü–æ–Ω–∏–∂–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë',
'W017':'–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏','W018':'–†–µ–≥—É–ª—è—Ç–æ—Ä –æ–±–æ—Ä–æ—Ç–æ–≤ –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ','W019':'AVR –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ',
'W020':'–û—à–∏–±–∫–∞ –≤–∫–ª. –∞–≤—Ç–æ–º–∞—Ç–∞ —Å–µ—Ç–∏','W021':'–û—à–∏–±–∫–∞ –≤–∫–ª. –∞–≤—Ç–æ–º–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞','W022':'–¢—Ä–µ–±—É–µ—Ç—Å—è –¢–û',
'M001':'–ê–≤–∞—Ä–∏—è —Å–µ—Ç–∏'
};
function getAlarmArchive(site,dev){try{return JSON.parse(localStorage.getItem('s5alm_'+site+'_'+dev))||[]}catch(e){return[]}}
function saveAlarmArchive(site,dev,a){localStorage.setItem('s5alm_'+site+'_'+dev,JSON.stringify(a))}
function addAlarmToArchive(dev,code,msg,severity){if(!cur)return;const arc=getAlarmArchive(cur,dev);arc.unshift({code,msg,severity,time:new Date().toLocaleString('ru-RU'),ts:Date.now()});if(arc.length>100)arc.pop();saveAlarmArchive(cur,dev,arc)}
function showAlarmSub(sl,sub){const act=$(sl+'a-act'),arc=$(sl+'a-arc'),ab=$(sl+'a-act-btn'),bb=$(sl+'a-arc-btn');if(!act||!arc)return;if(sub==='act'){act.style.display='';arc.style.display='none';ab.style.fontWeight='600';ab.style.color='var(--r)';bb.style.fontWeight='';bb.style.color=''}else{act.style.display='none';arc.style.display='';bb.style.fontWeight='600';bb.style.color='var(--p)';ab.style.fontWeight='';ab.style.color='';renderAlarmArchive(sl)}}
function renderAlarmArchive(sl){const el=$(sl+'a-arc');if(!el||!cur)return;const arc=getAlarmArchive(cur,sl);if(!arc.length){el.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div>';return}
el.innerHTML='<div style="max-height:200px;overflow-y:auto">'+arc.map(function(a){var isA=a.severity==='alarm';var cls=isA?'aa':'aw';var ico=isA?'üî¥':'‚ö†';var col=isA?'var(--r)':'var(--y)';return'<div class="ai '+cls+'" style="margin-bottom:2px"><span style="font-size:10px">'+ico+'</span><b style="color:'+col+';font-size:10px;margin:0 4px">'+a.code+'</b><span style="font-size:11px;flex:1">'+a.msg+'</span><span style="color:var(--t4);font-size:9px;white-space:nowrap">'+a.time+'</span></div>'}).join('')+'</div>'}
function clearAlarmArchive(sl){if(!cur)return;if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤ –∞–≤–∞—Ä–∏–π?'))return;saveAlarmArchive(cur,sl,[]);renderAlarmArchive(sl);ae('üóë –ê—Ä—Ö–∏–≤ –∞–≤–∞—Ä–∏–π '+sl+' –æ—á–∏—â–µ–Ω')}
// === SPR CONFIG: READ ‚Üí CONFIGURE ‚Üí SAVE ===
let sprCurrentConfig = null; // {loadMode, pRaw, qRaw, readAt} ‚Äî last config read from controller
let sprSelectedLoadMode = null; // user-selected load mode (null = not changed)
let sprCfgDirty = false; // true when user changed sliders or load mode
let sprCfgReading = false;

function getSprBackups(){try{return JSON.parse(localStorage.getItem('s5_spr_backups_'+(cur||'')))||[]}catch(e){return[]}}
function saveSprBackups(list){localStorage.setItem('s5_spr_backups_'+(cur||''),JSON.stringify(list))}

// Called when "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" tab is opened
async function onSprControlTabOpen(){
    if(sprCfgReading)return;
    await readSprConfig();
}

// Read current config from controller via API
async function readSprConfig(){
    const banner=$('sprCfgBanner'),status=$('sprConfigStatus');
    const devId=getDeviceIdForSlot('spr');
    if(!devId||!apiAvailable){
        if(banner)banner.innerHTML='<span style="color:var(--y)">‚ö† –®–ü–† –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ API</span>';
        return;
    }
    sprCfgReading=true;
    if(banner)banner.innerHTML='<span style="color:var(--y)">‚è≥ –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞...</span>';
    if(status)status.innerHTML='';
    try{
        const ac=new AbortController();
        const tid=setTimeout(()=>ac.abort(),10000);
        let cfg;
        try{
            const r=await fetch(API_BASE+'/api/commands/spr-config/'+devId,{signal:ac.signal});
            clearTimeout(tid);
            if(!r.ok)throw new Error('HTTP '+r.status);
            cfg=await r.json();
        }catch(fe){
            clearTimeout(tid);
            if(fe.name==='AbortError')throw new Error('–¢–∞–π–º–∞—É—Ç 10—Å ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª');
            throw fe;
        }
        if(!cfg.success)throw new Error(cfg.message);
        sprCurrentConfig={loadMode:cfg.load_mode,pRaw:cfg.p_raw,qRaw:cfg.q_raw,readAt:Date.now()};
        sprSelectedLoadMode=cfg.load_mode;
        sprCfgDirty=false;
        // Populate UI from real controller values
        applySprConfigToUI(cfg.load_mode, cfg.p_raw, cfg.q_raw);
        if(banner)banner.innerHTML='<span style="color:var(--g)">‚úì –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—á–∏—Ç–∞–Ω–∞ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞</span>'+
            '<span style="color:var(--t4);font-size:10px;margin-left:8px">'+new Date().toLocaleTimeString('ru-RU')+'</span>';
        ae('üìñ –ö–æ–Ω—Ñ–∏–≥ –®–ü–† —Å—á–∏—Ç–∞–Ω: Mode='+cfg.load_mode+' P='+(cfg.p_raw/10).toFixed(1)+'% Q='+(cfg.q_raw/10).toFixed(1)+'%');
    }catch(e){
        console.error('SPR config read error:',e);
        if(banner)banner.innerHTML='<span style="color:var(--r)">‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: '+(e.message||e)+'</span>';
    }finally{sprCfgReading=false}
}

function applySprConfigToUI(loadMode, pRaw, qRaw){
    // LoadMode buttons
    highlightLoadMode(loadMode);
    // P/Q sliders
    const ps=$('sprPslider'),qs=$('sprQslider');
    if(ps){ps.value=pRaw;$('sprPval').textContent=(pRaw/10).toFixed(1)+'%'}
    if(qs){qs.value=qRaw;$('sprQval').textContent=(qRaw/10).toFixed(1)+'%'}
    // Current label
    const lbl=$('sprLmCurrent');
    if(lbl)lbl.textContent='(—Ç–µ–∫—É—â–∏–π: '+(loadMode===0?'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä':loadMode===1?'–°–µ—Ç—å':loadMode===2?'–ü—Ä–∏—ë–º –Ω–∞–≥—Ä—É–∑–∫–∏':'?')+')';
}

function highlightLoadMode(mode){
    const colors=['var(--g)','var(--b)','var(--p)'];
    const bgs=['var(--gd)','var(--bb)','var(--pd)'];
    ['sprLm0','sprLm1','sprLm2'].forEach((id,i)=>{
        const btn=$(id);if(!btn)return;
        if(i===mode){btn.style.background=bgs[i]||'var(--gd)';btn.style.color=colors[i]||'var(--g)';btn.style.borderColor=colors[i]||'var(--g)';btn.style.fontWeight='600'}
        else{btn.style.background='';btn.style.color='';btn.style.borderColor='';btn.style.fontWeight=''}
    });
}

function setSprLoadMode(mode){
    sprSelectedLoadMode=mode;
    sprCfgDirty=true;
    highlightLoadMode(mode);
}

// Update control tab buttons to reflect current controller mode (called from applySprDetailed)
function updateQuickButtons(cardId, mx){
    if(!mx)return;
    const card=$(cardId);if(!card)return;
    const isRunning=mx.genset_status===9;
    const qbs=card.querySelectorAll('.qb');
    qbs.forEach(b=>{
        b.classList.remove('on');
        if(b.classList.contains('q-start')&&isRunning)b.classList.add('on');
        else if(b.classList.contains('q-auto')&&mx.mode_auto)b.classList.add('on');
        else if(b.classList.contains('q-manual')&&mx.mode_manual)b.classList.add('on');
        else if(b.classList.contains('q-stop')&&mx.mode_stop)b.classList.add('on');
    });
}
function updateSprControlMode(mx){
    if(!mx)return;
    // --- Quick buttons (top row) ---
    updateQuickButtons('cspr',mx);
    // --- Command buttons: –ê–≤—Ç–æ / –†—É—á–Ω. / –°—Ç–æ–ø ---
    const cmdMap=[
        {id:'sprCmdAuto',flag:'mode_auto',cls:'act-g'},
        {id:'sprCmdManual',flag:'mode_manual',cls:'act-y'},
        {id:'sprCmdStop',flag:'mode_stop',cls:'act-r'},
        {id:'sprCmdStart',flag:null,cls:'act-g'}, // start = genset running (status 9)
    ];
    const isRunning = mx.genset_status===9;
    cmdMap.forEach(c=>{
        const btn=$(c.id);if(!btn)return;
        btn.classList.remove('act-g','act-r','act-b','act-y');
        let active=false;
        if(c.id==='sprCmdStart') active=isRunning;
        else if(c.flag) active=!!mx[c.flag];
        if(active) btn.classList.add(c.cls);
    });
    // --- Switch buttons: –ê–≤—Ç.—Å–µ—Ç–∏ / –ê–≤—Ç.—à–∏–Ω—ã ---
    const mSwBtn=$('sprCmdMains'), bSwBtn=$('sprCmdBusbar');
    if(mSwBtn){mSwBtn.classList.remove('act-g','act-r','act-b','act-y');if(mx.mains_switch===3)mSwBtn.classList.add('act-g');else if(mx.mains_switch===7)mSwBtn.classList.add('act-r')}
    if(bSwBtn){bSwBtn.classList.remove('act-g','act-r','act-b','act-y');if(mx.busbar_switch===3)bSwBtn.classList.add('act-g');else if(mx.busbar_switch===7)bSwBtn.classList.add('act-r')}
}

// Save current configuration to controller (LoadMode + P% + Q%)
async function saveSprConfig(){
    const devId=getDeviceIdForSlot('spr');
    if(!devId||!apiAvailable){ae('‚ö† –®–ü–† –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω');return}
    const lm=sprSelectedLoadMode!=null?sprSelectedLoadMode:(sprCurrentConfig?.loadMode??0);
    const pv=+($('sprPslider')?.value||500);
    const qv=+($('sprQslider')?.value||500);
    const desc='LoadMode='+lm+' P='+(pv/10).toFixed(1)+'% Q='+(qv/10).toFixed(1)+'%';
    // Confirm before writing
    if(!confirm('–ó–∞–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –®–ü–†?\n\n'+desc))return;
    const banner=$('sprCfgBanner');
    if(banner)banner.innerHTML='<span style="color:var(--y)">‚è≥ –ó–∞–ø–∏—Å—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (FC06 √ó 3 + verify)...</span>';
    try{
        // Atomic write: 3 config registers ‚Üí verify read-back
        const res=await api.post('/api/commands/spr-config/'+devId,{
            load_mode:lm, p_raw:pv, q_raw:qv
        });
        sprCfgDirty=false;
        if(res.verified){
            sprCurrentConfig={loadMode:lm,pRaw:pv,qRaw:qv,readAt:Date.now()};
            if(banner)banner.innerHTML='<span style="color:var(--g)">‚úì –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–∞–Ω–∞ –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞</span>'+
                '<span style="color:var(--t4);font-size:10px;margin-left:8px">'+new Date().toLocaleTimeString('ru-RU')+'</span>';
            ae('‚ö° –®–ü–† –∫–æ–Ω—Ñ–∏–≥ –∑–∞–ø–∏—Å–∞–Ω (verified): '+desc);
        }else{
            // Echo OK but verify-read returned old values
            if(banner)banner.innerHTML='<span style="color:var(--y)">‚ö† –ö–æ–º–∞–Ω–¥—ã FC06 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (echo OK), –Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–Ω–∏–∏ ‚Äî —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.</span>'+
                '<span style="display:block;font-size:10px;color:var(--t4);margin-top:2px">–ó–∞–ø–∏—Å—å reg 4351-4354 —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—à–∏–≤–∫—É HGM9560 ‚â• V1.1 (2023). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é –ø—Ä–æ—à–∏–≤–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞.</span>';
            ae('‚ö† –®–ü–† –∫–æ–Ω—Ñ–∏–≥: echo OK, verify mismatch (firmware V1.1+ needed?): '+desc);
        }
    }catch(e){
        console.error('SPR config write error:',e);
        const msg=(e.message||e).toString();
        if(banner)banner.innerHTML='<span style="color:var(--r)">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: '+msg+'</span>';
        ae('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∫–æ–Ω—Ñ–∏–≥–∞ –®–ü–†: '+msg);
    }
}

function backupSprConfig(){
    if(!sprCurrentConfig){ae('‚ö† –°–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞');readSprConfig();return}
    const backups=getSprBackups();
    const backup={id:'bk_'+Date.now(),date:new Date().toLocaleString('ru-RU'),site:cur,name:S[cur]?.name||'',
        loadMode:sprCurrentConfig.loadMode,pPercent:sprCurrentConfig.pRaw,qPercent:sprCurrentConfig.qRaw,
        readAt:sprCurrentConfig.readAt,note:''};
    backups.unshift(backup);if(backups.length>20)backups.pop();saveSprBackups(backups);
    ae('üíæ –ë—ç–∫–∞–ø –®–ü–† —Å–æ–∑–¥–∞–Ω (–∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞)');renderBackupList();
    const el=$('sprConfigStatus');if(el)el.innerHTML='<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m);margin-bottom:6px">‚úì –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω: '+backup.date+' (LoadMode='+backup.loadMode+' P='+(backup.pPercent/10).toFixed(1)+'% Q='+(backup.qPercent/10).toFixed(1)+'%)</div>';
}
function openRestoreBackup(){const backups=getSprBackups();if(!backups.length){const el=$('sprConfigStatus');if(el)el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r);font-family:var(--m);margin-bottom:6px">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤</div>';return}
renderBackupList()}
function renderBackupList(){const backups=getSprBackups();const el=$('sprBackupList');if(!el)return;
const lmNames={0:'GenCtrl',1:'MainsCtrl',2:'LoadRec'};
el.innerHTML='<div style="font-size:10px;color:var(--t3);margin:6px 0 4px">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –±—ç–∫–∞–ø—ã ('+backups.length+'):</div><div style="max-height:160px;overflow-y:auto">'+backups.map((b,i)=>`<div class="bk-item"><div><span style="color:var(--t)">${b.date}</span><br><span style="color:var(--t3);font-size:10px">${lmNames[b.loadMode]||'?'} P=${(b.pPercent/10).toFixed(1)}% Q=${(b.qPercent/10).toFixed(1)}%</span></div><div class="bk-acts"><button class="bk-btn" onclick="restoreBackup(${i})" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä">üìÇ</button><button class="bk-btn" onclick="downloadBackup(${i})" title="–°–∫–∞—á–∞—Ç—å JSON">‚¨á</button><button class="bk-btn del" onclick="deleteBackup(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button></div></div>`).join('')+'</div>'}
function restoreBackup(idx){const backups=getSprBackups();const b=backups[idx];if(!b)return;
// Apply backup values to UI
sprSelectedLoadMode=b.loadMode;sprCfgDirty=true;
applySprConfigToUI(b.loadMode, b.pPercent, b.qPercent);
// Prompt to save to controller
const desc='LoadMode='+b.loadMode+' P='+(b.pPercent/10).toFixed(1)+'% Q='+(b.qPercent/10).toFixed(1)+'%';
if(confirm('–ü—Ä–∏–º–µ–Ω–∏—Ç—å –±—ç–∫–∞–ø –æ—Ç '+b.date+' –∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä?\n\n'+desc)){saveSprConfig()}
else{ae('üìÇ –ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω –≤ UI (–Ω–µ –∑–∞–ø–∏—Å–∞–Ω –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä)')}}
function downloadBackup(idx){const backups=getSprBackups();const b=backups[idx];if(!b)return;
const json=JSON.stringify(b,null,2);const blob=new Blob([json],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='spr_backup_'+b.date.replace(/[\s:.,]/g,'_')+'.json';a.click();URL.revokeObjectURL(url);ae('‚¨á –ë—ç–∫–∞–ø —Å–∫–∞—á–∞–Ω')}
function deleteBackup(idx){const backups=getSprBackups();backups.splice(idx,1);saveSprBackups(backups);renderBackupList();ae('üóë –ë—ç–∫–∞–ø —É–¥–∞–ª—ë–Ω')}
// ===================== ARCHIVE PAGE =====================
let archiveMode=false;
let arcState={slot:'g1',hours:1,group:'power',almPage:0,almLimit:50};
let arcChart=null;
// === ARC_GROUPS: per-device-type chart configurations ===
const ARC_GROUPS_GEN={
power:{fields:'power_total,power_a,power_b,power_c',labels:{power_total:'–û–±—â–∞—è –º–æ—â–Ω–æ—Å—Ç—å (–∫–í—Ç)',power_a:'–ú–æ—â–Ω–æ—Å—Ç—å —Ñ–∞–∑—ã A (–∫–í—Ç)',power_b:'–ú–æ—â–Ω–æ—Å—Ç—å —Ñ–∞–∑—ã B (–∫–í—Ç)',power_c:'–ú–æ—â–Ω–æ—Å—Ç—å —Ñ–∞–∑—ã C (–∫–í—Ç)'},unit:'–∫–í—Ç',colors:['#00e09a','#4090ff','#ffb020','#a070ff'],
desc:'–ê–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞. ¬´–û–±—â–∞—è –º–æ—â–Ω–æ—Å—Ç—å¬ª ‚Äî —Å—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (P = Pa + Pb + Pc). –§–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è A, B, C –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ —Ñ–∞–∑–∞–º. –ü–µ—Ä–µ–∫–æ—Å –±–æ–ª–µ–µ 15% –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ ‚Äî –Ω–µ–Ω–æ—Ä–º–∞–ª—å–Ω–æ.'},
voltage:{fields:'gen_uab,gen_ubc,gen_uca,mains_uab',labels:{gen_uab:'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä UAB (–ª–∏–Ω–µ–π–Ω–æ–µ)',gen_ubc:'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä UBC (–ª–∏–Ω–µ–π–Ω–æ–µ)',gen_uca:'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä UCA (–ª–∏–Ω–µ–π–Ω–æ–µ)',mains_uab:'–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å–µ—Ç–∏ UAB'},unit:'–í',colors:['#00e09a','#4090ff','#ffb020','#ff4060'],
desc:'–õ–∏–Ω–µ–π–Ω—ã–µ (–º–µ–∂—Ñ–∞–∑–Ω—ã–µ) –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∏ –≤–≤–æ–¥–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è —Å–µ—Ç–∏. UAB ‚Äî –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ A –∏ B, UBC ‚Äî –º–µ–∂–¥—É B –∏ C, UCA ‚Äî –º–µ–∂–¥—É C –∏ A. –ù–æ—Ä–º–∞ 380-400–í. –ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è ‚Äî –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏ –Ω–∞ –≤–≤–æ–¥–µ.'},
engine:{fields:'coolant_temp,oil_pressure,battery_volt,fuel_level',labels:{coolant_temp:'–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ—Ö–ª. –∂–∏–¥–∫–æ—Å—Ç–∏ (¬∞C)',oil_pressure:'–î–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å–ª–∞ (–∫–ü–∞)',battery_volt:'–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë (–í)',fuel_level:'–£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞ (%)'},unit:'',colors:['#ff4060','#ffb020','#00e09a','#a070ff'],
desc:'–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –û–ñ: –Ω–æ—Ä–º–∞ 70-95¬∞C, –≤—ã—à–µ 100¬∞C ‚Äî –ø–µ—Ä–µ–≥—Ä–µ–≤. –î–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å–ª–∞: –Ω–æ—Ä–º–∞ 200-500 –∫–ü–∞, –ø–∞–¥–µ–Ω–∏–µ –Ω–∏–∂–µ 100 ‚Äî –∞–≤–∞—Ä–∏–π–Ω–æ–µ. –ê–ö–ë: –Ω–æ—Ä–º–∞ 24-28–í (24–í —Å–∏—Å—Ç–µ–º–∞). –¢–æ–ø–ª–∏–≤–æ: –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∫–∞.'},
current:{fields:'current_a,current_b,current_c,load_pct',labels:{current_a:'–¢–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Ñ–∞–∑–∞ A (–ê)',current_b:'–¢–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Ñ–∞–∑–∞ B (–ê)',current_c:'–¢–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Ñ–∞–∑–∞ C (–ê)',load_pct:'–ù–∞–≥—Ä—É–∑–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (%)'},unit:'–ê',colors:['#4090ff','#00e09a','#ffb020','#a070ff'],
desc:'–¢–æ–∫–∏ –Ω–∞ –≤—ã—Ö–æ–¥–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ —Ç—Ä—ë–º —Ñ–∞–∑–∞–º –∏ –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞. –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–∫–æ–≤ –ø–æ —Ñ–∞–∑–∞–º ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏. –ù–∞–≥—Ä—É–∑–∫–∞ –≤—ã—à–µ 80% –¥–ª–∏—Ç–µ–ª—å–Ω–æ ‚Äî –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –∏–∑–Ω–æ—Å.'}
};
const ARC_GROUPS_SPR={
balance:{fields:'busbar_p,mains_total_p',labels:{busbar_p:'P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–∫–í—Ç)',mains_total_p:'P —Å–µ—Ç–∏ (–∫–í—Ç)'},unit:'–∫–í—Ç',colors:['#00e09a','#4090ff'],
desc:'–ë–∞–ª–∞–Ω—Å –º–æ—â–Ω–æ—Å—Ç–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ. <b>P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤</b> ‚Äî –º–æ—â–Ω–æ—Å—Ç—å –æ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞ —à–∏–Ω–µ. <b>P —Å–µ—Ç–∏</b> ‚Äî –º–æ—â–Ω–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏. P –Ω–∞–≥—Ä—É–∑–∫–∏ = P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ + P —Å–µ—Ç–∏.',
_computed:[{label:'P –Ω–∞–≥—Ä—É–∑–∫–∏ (–∫–í—Ç)',color:'#ffb020',calc:row=>{const b=row.busbar_p!=null?Number(row.busbar_p):0;const m=row.mains_total_p!=null?Number(row.mains_total_p):0;return b+m}}]},
power:{fields:'mains_total_p,mains_p_a,mains_p_b,mains_p_c,busbar_p',labels:{mains_total_p:'Œ£ P —Å–µ—Ç–∏ (–∫–í—Ç)',mains_p_a:'P —Å–µ—Ç–∏ —Ñ.A (–∫–í—Ç)',mains_p_b:'P —Å–µ—Ç–∏ —Ñ.B (–∫–í—Ç)',mains_p_c:'P —Å–µ—Ç–∏ —Ñ.C (–∫–í—Ç)',busbar_p:'P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–∫–í—Ç)'},unit:'–∫–í—Ç',colors:['#00e09a','#4090ff','#ffb020','#a070ff','#ff4060'],
desc:'–ê–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –Ω–∞ –≤–≤–æ–¥–µ –æ—Ç –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏ –∏ –Ω–∞ –æ–±—â–µ–π —à–∏–Ω–µ. <b>Œ£ P —Å–µ—Ç–∏</b> = —Å—É–º–º–∞ —Ç—Ä—ë—Ö —Ñ–∞–∑ –≤–≤–æ–¥–∞. <b>P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤</b> ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π. –†–∞–∑–Ω–∏—Ü–∞ P —Å–µ—Ç–∏ ‚àí P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ = –ø–æ—Ç–µ—Ä–∏ –≤ –∫–æ–º–º—É—Ç–∞—Ü–∏–∏.'},
voltage:{fields:'mains_uab,mains_ubc,mains_uca,busbar_uab,busbar_ubc,busbar_uca',labels:{mains_uab:'–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å–µ—Ç–∏ UAB (–í)',mains_ubc:'–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å–µ—Ç–∏ UBC (–í)',mains_uca:'–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å–µ—Ç–∏ UCA (–í)',busbar_uab:'–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —à–∏–Ω—ã UAB (–í)',busbar_ubc:'–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —à–∏–Ω—ã UBC (–í)',busbar_uca:'–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —à–∏–Ω—ã UCA (–í)'},unit:'–í',colors:['#4090ff','#00e09a','#ffb020','#ff4060','#a070ff','#f472b6'],
desc:'–õ–∏–Ω–µ–π–Ω—ã–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –Ω–∞ –≤–≤–æ–¥–µ –æ—Ç –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏ –∏ –Ω–∞ –æ–±—â–µ–π —à–∏–Ω–µ (–ø–æ—Å–ª–µ –∫–æ–º–º—É—Ç–∞—Ü–∏–∏). –°–µ—Ç—å ‚Äî –≤—Ö–æ–¥—è—â–µ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –æ—Ç —ç–Ω–µ—Ä–≥–æ—Å–±—ã—Ç–∞. –®–∏–Ω–∞ ‚Äî –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, –ø–æ–¥–∞–≤–∞–µ–º–æ–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º. –ù–æ—Ä–º–∞ 380-400–í. –ü—Ä–æ—Å–∞–¥–∫–∞ —à–∏–Ω—ã –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–æ 5%.'},
current:{fields:'mains_ia,mains_ib,mains_ic,busbar_current',labels:{mains_ia:'–¢–æ–∫ –≤–≤–æ–¥–∞ —Å–µ—Ç–∏ —Ñ.A (–ê)',mains_ib:'–¢–æ–∫ –≤–≤–æ–¥–∞ —Å–µ—Ç–∏ —Ñ.B (–ê)',mains_ic:'–¢–æ–∫ –≤–≤–æ–¥–∞ —Å–µ—Ç–∏ —Ñ.C (–ê)',busbar_current:'Œ£ —Ç–æ–∫ —à–∏–Ω—ã (–ê)'},unit:'–ê',colors:['#4090ff','#00e09a','#ffb020','#ff4060'],
desc:'–¢–æ–∫–∏ –Ω–∞ <b>—Å–µ—Ç–µ–≤–æ–º –≤–≤–æ–¥–µ</b> –ø–æ —Ñ–∞–∑–∞–º A/B/C –∏ —Å—É–º–º–∞—Ä–Ω—ã–π —Ç–æ–∫ –Ω–∞ –æ–±—â–µ–π —à–∏–Ω–µ. –ü–æ—Ñ–∞–∑–Ω—ã–µ —Ç–æ–∫–∏ ‚Äî —ç—Ç–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä–æ–≤ —Ç–æ–∫–∞ –Ω–∞ –≤–≤–æ–¥–µ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏. <b>Œ£ —Ç–æ–∫ —à–∏–Ω—ã</b> ‚Äî —Å—É–º–º–∞—Ä–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ (–ø–æ—Ñ–∞–∑–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ HGM9560). –ü–µ—Ä–µ–∫–æ—Å —Ç–æ–∫–æ–≤ –≤–≤–æ–¥–∞ >15% ‚Äî –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞.'},
frequency:{fields:'mains_freq,busbar_freq',labels:{mains_freq:'–ß–∞—Å—Ç–æ—Ç–∞ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏ (–ì—Ü)',busbar_freq:'–ß–∞—Å—Ç–æ—Ç–∞ –Ω–∞ —à–∏–Ω–µ (–ì—Ü)'},unit:'–ì—Ü',colors:['#4090ff','#ff4060'],
desc:'–ß–∞—Å—Ç–æ—Ç–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π —Å–µ—Ç–∏ –Ω–∞ –≤–≤–æ–¥–µ –∏ –Ω–∞ –æ–±—â–µ–π —à–∏–Ω–µ. –ù–æ–º–∏–Ω–∞–ª 50.0 –ì—Ü. –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ¬±0.5 –ì—Ü ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ. –ü—Ä–æ–≤–∞–ª—ã —á–∞—Å—Ç–æ—Ç—ã —Å–µ—Ç–∏ –Ω–∏–∂–µ 49 –ì—Ü —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É —ç–Ω–µ—Ä–≥–æ—Å–∏—Å—Ç–µ–º—ã. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ –æ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —á–∞—Å—Ç–æ—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±–æ—Ä–æ—Ç–æ–≤ –¥–≤–∏–≥–∞—Ç–µ–ª—è.'}
};
// Tabs definition per device type: [{key, label}]
const ARC_TABS_GEN=[{key:'power',label:'‚ö° –ú–æ—â–Ω–æ—Å—Ç—å'},{key:'voltage',label:'üîå –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ'},{key:'engine',label:'üõ¢ –î–≤–∏–≥–∞—Ç–µ–ª—å'},{key:'current',label:'„Ä∞ –¢–æ–∫–∏'}];
const ARC_TABS_SPR=[{key:'balance',label:'‚öñ –ë–∞–ª–∞–Ω—Å'},{key:'power',label:'‚ö° –ú–æ—â–Ω–æ—Å—Ç—å'},{key:'voltage',label:'üîå –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ'},{key:'current',label:'„Ä∞ –¢–æ–∫–∏'},{key:'frequency',label:'üì∂ –ß–∞—Å—Ç–æ—Ç–∞'}];
function arcGetGroups(){return arcState.slot==='spr'?ARC_GROUPS_SPR:ARC_GROUPS_GEN}
function arcGetTabs(){return arcState.slot==='spr'?ARC_TABS_SPR:ARC_TABS_GEN}
const CHART_DEFAULTS={responsive:true,maintainAspectRatio:false,animation:{duration:400},
interaction:{mode:'index',intersect:false,axis:'x'},
plugins:{
  legend:{position:'top',align:'start',
    labels:{color:'#c8d4e6',font:{family:'Outfit',size:12,weight:'500'},padding:16,usePointStyle:true,pointStyle:'circle',pointStyleWidth:10,
      generateLabels:function(chart){
        const orig=Chart.defaults.plugins.legend.labels.generateLabels(chart);
        return orig.map(item=>{
          const ds=chart.data.datasets[item.datasetIndex];
          if(ds&&ds.data&&ds.data.length){
            const last=ds.data[ds.data.length-1];
            const val=last&&last.y!=null?last.y.toFixed(1):'‚Äî';
            item.text=ds.label+' ('+val+')';
          }
          return item;
        });
      }
    }
  },
  tooltip:{
    backgroundColor:'rgba(10,15,26,.95)',borderColor:'rgba(64,144,255,.3)',borderWidth:1,
    titleColor:'#e8edf5',bodyColor:'#c8d4e6',footerColor:'#5a6a80',
    titleFont:{family:'JetBrains Mono',size:12,weight:'600'},
    bodyFont:{family:'JetBrains Mono',size:11},
    footerFont:{family:'JetBrains Mono',size:9},
    padding:12,cornerRadius:8,displayColors:true,boxPadding:4,
    caretSize:6,caretPadding:8,
    callbacks:{
      label:function(ctx){return ' '+ctx.dataset.label.split(' (')[0]+': '+(ctx.parsed.y!=null?ctx.parsed.y.toFixed(2):'‚Äî')},
      footer:function(items){if(!items.length)return '';const d=items[0].parsed.x;return new Date(d).toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'})}
    }
  },
  crosshair:false,
  zoom:false
},
scales:(function(){const c=getChartColors();return{
  x:{type:'time',
    grid:{color:c.grid,lineWidth:1,drawTicks:true,tickLength:4},
    border:{color:c.border},
    ticks:{color:c.tick,font:{family:'JetBrains Mono',size:10},maxRotation:0,autoSkipPadding:20,
      callback:function(val,idx,ticks){
        var xScale=this.chart.scales.x;
        var rangeMs=(xScale.max||0)-(xScale.min||0);
        var d=new Date(val);
        var hh=String(d.getHours()).padStart(2,'0');
        var mm=String(d.getMinutes()).padStart(2,'0');
        var ss=String(d.getSeconds()).padStart(2,'0');
        if(rangeMs>86400000){
          // >1 day: show date + time
          var dd=String(d.getDate()).padStart(2,'0');
          var mo=String(d.getMonth()+1).padStart(2,'0');
          return dd+'.'+mo+' '+hh+':'+mm;
        }
        if(rangeMs<3600000) return hh+':'+mm+':'+ss;
        return hh+':'+mm;
      }
    },
    time:{tooltipFormat:'dd.MM.yyyy HH:mm:ss',displayFormats:{second:'HH:mm:ss',minute:'HH:mm',hour:'HH:mm',day:'dd.MM',week:'dd.MM',month:'MMM yyyy'}}
  },
  y:{
    grid:{color:c.grid,lineWidth:1},
    border:{color:c.border},
    ticks:{color:c.tick,font:{family:'JetBrains Mono',size:10},padding:8,
      callback:function(v){return v>=1000?(v/1000).toFixed(1)+'k':v>=100?Math.round(v):v.toFixed(1)}
    }
  }
}})()
};

function showArchive(siteKey){stopB24Poll();curView='archive';
const keys=Object.keys(S);if(!keys.length){ae('‚ö† –ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤');return}
const sk=siteKey||(cur&&S[cur]?cur:keys[0]);
arcState.siteKey=sk;archiveMode=true;
const s=S[sk],mn=$('mainArea');
// Site selector options
let siteOpts=keys.map(k=>`<option value="${k}"${k===sk?' selected':''}>${esc(S[k].name)}</option>`).join('');
// Device buttons for selected site
const firstSlot=s.g1?.ip?'g1':s.g2?.ip?'g2':s.spr?.ip?'spr':null;
let devBtns='';
if(s.g1?.ip)devBtns+=`<button class="arc-dev${firstSlot==='g1'?' on':''}" onclick="arcDev(this,'g1')">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1</button>`;
if(s.g2?.ip)devBtns+=`<button class="arc-dev${firstSlot==='g2'&&!s.g1?.ip?' on':''}" onclick="arcDev(this,'g2')">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2</button>`;
if(s.spr?.ip)devBtns+=`<button class="arc-dev${firstSlot==='spr'?' on':''}" onclick="arcDev(this,'spr')">–®–ü–†</button>`;
arcState.slot=firstSlot||'g1';arcState.hours=1;arcState.group='power';arcState.almPage=0;
mn.innerHTML=`
<div class="dh"><div class="dt"><h1>üìä –ê—Ä—Ö–∏–≤</h1>
<select class="fi" id="arcSiteSelect" style="margin-left:12px;width:auto;padding:6px 12px;font-size:13px;font-weight:500;background:var(--bg3);border-color:var(--bd2)" onchange="arcSwitchSite(this.value)">${siteOpts}</select></div>
<div class="da"><button onclick="archiveMode=false;renderDash()">‚Üê –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button></div></div>
<div class="arc-ctl">
<div class="arc-devs" id="arcDevsWrap">${devBtns}</div>
<div class="arc-time">
<button class="arc-tb on" onclick="arcRange(this,1)">1—á</button>
<button class="arc-tb" onclick="arcRange(this,6)">6—á</button>
<button class="arc-tb" onclick="arcRange(this,24)">24—á</button>
<button class="arc-tb" onclick="arcRange(this,168)">7–¥</button>
<button class="arc-tb" onclick="arcRange(this,720)">30–¥</button>
<span id="arcZoomLabel" class="zoom-lbl"></span>
<div class="dp-wrap"><button class="dp-btn" id="arcFromBtn" onclick="dpToggle('arcFrom')">üìÖ –û—Ç</button><div class="dp-drop" id="arcFromDrop"></div></div>
<span style="color:var(--t3);font-size:11px">‚Äî</span>
<div class="dp-wrap"><button class="dp-btn" id="arcToBtn" onclick="dpToggle('arcTo')">üìÖ –î–æ</button><div class="dp-drop" id="arcToDrop"></div></div>
</div></div>
<div class="tbs" id="arcMainTabs" style="margin-bottom:12px">
<button class="tb on" onclick="arcTab(this,'arcCharts')">üìà –ì—Ä–∞—Ñ–∏–∫–∏</button>
<button class="tb" onclick="arcTab(this,'arcAlarms')">üî¥ –ñ—É—Ä–Ω–∞–ª –∞–≤–∞—Ä–∏–π</button>
<button class="tb" onclick="arcTab(this,'arcDisk')">üíæ –•—Ä–∞–Ω–∏–ª–∏—â–µ</button></div>
<div id="arcCharts" style="display:block">
<div class="tbs" style="margin-bottom:8px" id="arcChartTabs"></div>
<div class="arc-chart-wrap"><canvas id="arcCanvas"></canvas></div>
<div id="arcFieldStats" class="arc-fstats"></div>
<div id="arcDesc" class="arc-desc"></div>
<div id="arcStats" class="arc-stats"></div></div>
<div id="arcAlarms" style="display:none">
<div class="arc-flt">
<select class="fi" id="arcSev" style="width:140px;padding:6px 8px;font-size:11px" onchange="arcLoadAlarms()">
<option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option><option value="error">üî¥ –û—à–∏–±–∫–∞</option><option value="warning">üü° –ü—Ä–µ–¥—É–ø—Ä.</option><option value="mains">üîµ –°–µ—Ç—å</option></select>
<label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--t2)"><input type="checkbox" id="arcActiveOnly" style="accent-color:var(--g)" onchange="arcLoadAlarms()"> –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</label>
<button class="sb-btn" style="padding:5px 10px;font-size:11px;width:auto" onclick="arcLoadAlarms()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button></div>
<div id="arcAlarmTable"></div>
<div class="arc-pag" id="arcPag"></div></div>
<div id="arcDisk" style="display:none"><div id="arcDiskInfo"></div></div>`;
arcRenderChartTabs();arcLoadChart();arcLoadAlarms();arcLoadDisk();
}

function arcDev(btn,slot){
btn.parentElement.querySelectorAll('.arc-dev').forEach(b=>b.classList.remove('on'));
btn.classList.add('on');arcState.slot=slot;arcState.almPage=0;arcRenderChartTabs();arcLoadChart();arcLoadAlarms();
}
function arcSwitchSite(siteKey){
if(!S[siteKey])return;arcState.siteKey=siteKey;
const s=S[siteKey];
const firstSlot=s.g1?.ip?'g1':s.g2?.ip?'g2':s.spr?.ip?'spr':null;
let devBtns='';
if(s.g1?.ip)devBtns+=`<button class="arc-dev${firstSlot==='g1'?' on':''}" onclick="arcDev(this,'g1')">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1</button>`;
if(s.g2?.ip)devBtns+=`<button class="arc-dev${firstSlot==='g2'&&!s.g1?.ip?' on':''}" onclick="arcDev(this,'g2')">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2</button>`;
if(s.spr?.ip)devBtns+=`<button class="arc-dev${firstSlot==='spr'?' on':''}" onclick="arcDev(this,'spr')">–®–ü–†</button>`;
const wrap=$('arcDevsWrap');if(wrap)wrap.innerHTML=devBtns;
arcState.slot=firstSlot||'g1';arcState.almPage=0;
arcRenderChartTabs();arcLoadChart();arcLoadAlarms();arcLoadDisk();
}
function arcGetDeviceId(slot){
const sk=arcState.siteKey;if(!sk||!S[sk])return null;
return S[sk][slot]?._deviceId||null;
}
function arcRange(btn,hours){
btn.parentElement.querySelectorAll('.arc-tb').forEach(b=>b.classList.remove('on'));
btn.classList.add('on');arcState.hours=hours;arcState.almPage=0;
dpState.arcFrom=null;dpState.arcTo=null;
const fb=$('arcFromBtn'),tb=$('arcToBtn');
if(fb){fb.textContent='üìÖ –û—Ç';fb.classList.remove('has-val')}
if(tb){tb.textContent='üìÖ –î–æ';tb.classList.remove('has-val')}
_updateZoomLabel('arcZoomLabel',hours);
arcLoadChart();arcLoadAlarms();
}
function arcCustomRange(){
if(!dpState.arcFrom||!dpState.arcTo)return;
document.querySelectorAll('.arc-time .arc-tb').forEach(b=>b.classList.remove('on'));
arcState.hours=null;arcState.customFrom=dpState.arcFrom;arcState.customTo=dpState.arcTo;arcState.almPage=0;
arcLoadChart();arcLoadAlarms();
}

// ---- Date Picker ----
const dpState={arcFrom:null,arcTo:null,_view:{},_open:null};
const DP_MONTHS=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
const DP_DAYS=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];

function dpToggle(id){
const drop=$(id+'Drop');if(!drop)return;
const isOpen=drop.classList.contains('open');
document.querySelectorAll('.dp-drop.open').forEach(d=>d.classList.remove('open'));
if(!isOpen){
const now=dpState[id]?new Date(dpState[id]):new Date();
dpState._view[id]={year:now.getFullYear(),month:now.getMonth(),hour:now.getHours(),minute:now.getMinutes()};
if(dpState[id]){const d=new Date(dpState[id]);dpState._view[id].selDay=d.getDate();dpState._view[id].selMonth=d.getMonth();dpState._view[id].selYear=d.getFullYear()}
dpRender(id);drop.classList.add('open');dpState._open=id;
}else{dpState._open=null}
}

function dpRender(id){
const drop=$(id+'Drop'),v=dpState._view[id];if(!drop||!v)return;
const year=v.year,month=v.month;
const firstDay=new Date(year,month,1).getDay();
const shift=firstDay===0?6:firstDay-1;
const daysInMonth=new Date(year,month+1,0).getDate();
const daysInPrev=new Date(year,month,0).getDate();
const today=new Date(),ty=today.getFullYear(),tm=today.getMonth(),td=today.getDate();

let html=`<div class="dp-hdr"><button class="dp-nav" onclick="dpNav('${id}',-1)">‚óÄ</button><span>${DP_MONTHS[month]} ${year}</span><button class="dp-nav" onclick="dpNav('${id}',1)">‚ñ∂</button></div>`;
html+='<div class="dp-wk">'+DP_DAYS.map(d=>`<span>${d}</span>`).join('')+'</div>';
html+='<div class="dp-days">';
for(let i=0;i<shift;i++){const d=daysInPrev-shift+1+i;html+=`<div class="dp-d other" onclick="dpPickDay('${id}',${year},${month-1},${d})">${d}</div>`}
for(let d=1;d<=daysInMonth;d++){
let cls='dp-d';
if(d===td&&month===tm&&year===ty)cls+=' today';
if(v.selDay===d&&v.selMonth===month&&v.selYear===year)cls+=' sel';
html+=`<div class="${cls}" onclick="dpPickDay('${id}',${year},${month},${d})">${d}</div>`}
const remaining=7-((shift+daysInMonth)%7);
if(remaining<7)for(let d=1;d<=remaining;d++){html+=`<div class="dp-d other" onclick="dpPickDay('${id}',${year},${month+1},${d})">${d}</div>`}
html+='</div>';
html+=`<div class="dp-time"><label>–í—Ä–µ–º—è:</label><input type="number" min="0" max="23" value="${String(v.hour).padStart(2,'0')}" id="${id}H" onchange="dpTimeChange('${id}')">
<span style="color:var(--t3)">:</span>
<input type="number" min="0" max="59" value="${String(v.minute).padStart(2,'0')}" id="${id}M" onchange="dpTimeChange('${id}')"></div>`;
html+=`<button class="dp-apply" onclick="dpApply('${id}')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>`;
drop.innerHTML=html;
}

function dpNav(id,dir){
const v=dpState._view[id];v.month+=dir;
if(v.month>11){v.month=0;v.year++}if(v.month<0){v.month=11;v.year--}
dpRender(id);
}

function dpPickDay(id,y,m,d){
if(m>11){m=0;y++}if(m<0){m=11;y--}
const v=dpState._view[id];v.selDay=d;v.selMonth=m;v.selYear=y;v.year=y;v.month=m;
dpRender(id);
}

function dpTimeChange(id){
const v=dpState._view[id];
const h=$(id+'H'),m=$(id+'M');
if(h)v.hour=Math.max(0,Math.min(23,parseInt(h.value)||0));
if(m)v.minute=Math.max(0,Math.min(59,parseInt(m.value)||0));
}

function dpApply(id){
const v=dpState._view[id];
if(v.selDay==null)return;
const dt=new Date(v.selYear,v.selMonth,v.selDay,v.hour,v.minute);
dpState[id]=dt.toISOString();
const btn=$(id+'Btn');
if(btn){btn.textContent=dt.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});btn.classList.add('has-val')}
const drop=$(id+'Drop');if(drop)drop.classList.remove('open');dpState._open=null;
arcCustomRange();
}

document.addEventListener('click',function(e){
if(dpState._open&&!e.target.closest('.dp-wrap')){
document.querySelectorAll('.dp-drop.open').forEach(d=>d.classList.remove('open'));dpState._open=null}
});
function arcTab(btn,panelId){
const tabs=$('arcMainTabs');if(tabs)tabs.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));
btn.classList.add('on');
['arcCharts','arcAlarms','arcDisk'].forEach(id=>{const el=$(id);if(el)el.style.display='none'});
const target=$(panelId);if(target)target.style.display='block';
if(panelId==='arcDisk')arcLoadDisk();
}
function arcChGroup(btn,group){
btn.closest('.tbs').querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));
btn.classList.add('on');arcState.group=group;arcLoadChart();
}
function arcRenderChartTabs(){
const wrap=$('arcChartTabs');if(!wrap)return;
const tabs=arcGetTabs();const groups=arcGetGroups();
// Reset group if current group doesn't exist for this device type
if(!groups[arcState.group])arcState.group=tabs[0]?.key||'power';
wrap.innerHTML=tabs.map(t=>`<button class="tb${t.key===arcState.group?' on':''}" onclick="arcChGroup(this,'${t.key}')">${t.label}</button>`).join('');
}

function arcBucket(hours){
if(hours<=1)return 0;if(hours<=6)return 60;if(hours<=24)return 300;if(hours<=168)return 1800;return 3600;
}

async function arcLoadChart(){
const devId=arcGetDeviceId(arcState.slot);
if(!devId){arcRenderNoData('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ');return}
const grp=arcGetGroups()[arcState.group],hours=arcState.hours;
if(!grp){arcRenderNoData('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏');return}
const bucket=hours?arcBucket(hours):0;
let url;
if(hours){
if(bucket>0)url=`/api/history/metrics/${devId}/downsampled?last_hours=${hours}&bucket_seconds=${bucket}&fields=${grp.fields}`;
else url=`/api/history/metrics/${devId}?last_hours=${hours}&fields=${grp.fields}&limit=5000`;
}else{
const from=new Date(arcState.customFrom).toISOString(),to=new Date(arcState.customTo).toISOString();
const rangeH=(new Date(arcState.customTo)-new Date(arcState.customFrom))/3600000;
const cb=arcBucket(rangeH);
if(cb>0)url=`/api/history/metrics/${devId}/downsampled?start=${from}&end=${to}&bucket_seconds=${cb}&fields=${grp.fields}`;
else url=`/api/history/metrics/${devId}?start=${from}&end=${to}&fields=${grp.fields}&limit=5000`;
}
try{
const data=await api.get(url);arcRenderChart(data,grp);
arcRenderFieldStats(data,grp);
const stats=await api.get(`/api/history/metrics/${devId}/stats`);arcRenderStats(stats);
}catch(e){console.warn('Archive chart error:',e);arcRenderNoData('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message)}
}

async function arcLoadAlarms(){
const devId=arcGetDeviceId(arcState.slot);
if(!devId){const el=$('arcAlarmTable');if(el)el.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:30px">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ</div>';return}
const sev=$('arcSev')?.value||'',activeOnly=$('arcActiveOnly')?.checked,hours=arcState.hours;
let url=`/api/history/alarms?device_id=${devId}&limit=${arcState.almLimit}&offset=${arcState.almPage*arcState.almLimit}`;
if(sev)url+=`&severity=${sev}`;if(activeOnly)url+='&is_active=true';if(hours)url+=`&last_hours=${hours}`;
try{const alarms=await api.get(url);arcRenderAlarms(alarms)}
catch(e){const el=$('arcAlarmTable');if(el)el.innerHTML=`<div style="color:var(--r);font-size:12px;padding:20px;text-align:center">–û—à–∏–±–∫–∞: ${esc(e.message)}</div>`}
}

async function arcLoadDisk(){
try{const d=await api.get('/api/history/disk');arcRenderDisk(d)}
catch(e){const el=$('arcDiskInfo');if(el)el.innerHTML=`<div style="color:var(--r);font-size:12px;padding:20px;text-align:center">–û—à–∏–±–∫–∞: ${esc(e.message)}</div>`}
}

// Crosshair vertical line plugin
const crosshairPlugin={id:'crosshairLine',
afterDraw(chart){
  if(chart.tooltip&&chart.tooltip._active&&chart.tooltip._active.length){
    const x=chart.tooltip._active[0].element.x;
    const yA=chart.scales.y;
    const ctx=chart.ctx;
    ctx.save();ctx.beginPath();ctx.moveTo(x,yA.top);ctx.lineTo(x,yA.bottom);
    ctx.lineWidth=1;ctx.strokeStyle='rgba(100,140,200,.4)';ctx.setLineDash([4,3]);ctx.stroke();ctx.restore();
  }
}};

function arcRenderChart(data,grp){
const canvas=$('arcCanvas');if(!canvas)return;
if(arcChart){arcChart.destroy();arcChart=null}
if(!data||!data.length){arcRenderNoData('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥');return}
if(typeof Chart==='undefined'){arcRenderNoData('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');return}
const fieldNames=grp.fields.split(',');
const timeKey=data[0].bucket!==undefined?'bucket':'timestamp';

// Calculate adaptive point radius based on data density
const totalPts=data.length;
const showPts=totalPts<80;
const ptRadius=totalPts<30?3:totalPts<80?2:0;
const hoverRadius=totalPts<200?4:3;

const datasets=fieldNames.map((f,i)=>{
  const pts=data.map(row=>({x:new Date(row[timeKey]),y:row[f]!=null?Number(row[f]):null}));
  const hasData=pts.some(p=>p.y!=null);
  if(!hasData) return null;
  return {
    label:grp.labels[f]||f,
    data:pts,
    borderColor:grp.colors[i],
    backgroundColor:grp.colors[i]+'18',
    borderWidth:2.2,
    pointRadius:showPts?ptRadius:0,
    pointHoverRadius:hoverRadius,
    pointBackgroundColor:grp.colors[i],
    pointBorderColor:grp.colors[i],
    pointHitRadius:8,
    tension:0.25,
    fill:fieldNames.length<=2,
    spanGaps:true
  };
}).filter(Boolean);

// Append computed datasets (e.g. P load = busbar_p + mains_total_p)
if(grp._computed){
grp._computed.forEach(c=>{
  const pts=data.map(row=>({x:new Date(row[timeKey]),y:c.calc(row)}));
  const hasData=pts.some(p=>p.y!=null&&p.y!==0);
  if(hasData)datasets.push({
    label:c.label,data:pts,borderColor:c.color,backgroundColor:c.color+'18',
    borderWidth:2.2,pointRadius:showPts?ptRadius:0,pointHoverRadius:hoverRadius,
    pointBackgroundColor:c.color,pointBorderColor:c.color,pointHitRadius:8,
    tension:0.25,fill:false,spanGaps:true
  });
});
}

// Compute Y-axis bounds with padding
let yMin=Infinity,yMax=-Infinity;
for(const ds of datasets){
  for(const pt of ds.data){if(pt.y!=null){if(pt.y<yMin)yMin=pt.y;if(pt.y>yMax)yMax=pt.y}}
}
if(!isFinite(yMin)){yMin=0;yMax=100}
const yRange=yMax-yMin||1;
const yPad=yRange*0.08;
const sugMin=Math.max(0,yMin-yPad);
const sugMax=yMax+yPad;

arcChart=new Chart(canvas,{type:'line',data:{datasets},
plugins:[crosshairPlugin],
options:{
  ...CHART_DEFAULTS,
  plugins:{...CHART_DEFAULTS.plugins},
  scales:(function(){const c=getChartColors();return{
    x:{...CHART_DEFAULTS.scales.x, grid:{...CHART_DEFAULTS.scales.x.grid,color:c.grid},border:{color:c.border},ticks:{...CHART_DEFAULTS.scales.x.ticks,color:c.tick}},
    y:{...CHART_DEFAULTS.scales.y, grid:{...CHART_DEFAULTS.scales.y.grid,color:c.grid},border:{color:c.border},ticks:{...CHART_DEFAULTS.scales.y.ticks,color:c.tick},
      suggestedMin:sugMin,suggestedMax:sugMax,
      title:{display:!!grp.unit,text:grp.unit,color:c.tick,font:{family:'Outfit',size:11,weight:'500'},padding:{bottom:6}}
    }
  }})()

}});
// Update legend with latest values after render
arcChart.update();
// Show chart description
const descEl=$('arcDesc');
if(descEl)descEl.innerHTML=grp.desc?`<b>‚ÑπÔ∏è –ü–æ—è—Å–Ω–µ–Ω–∏–µ:</b> ${grp.desc}`:'';
}


// === POWER CHART (clickable flow diagram labels) ===
let pwChart=null,pwHours=1;
let pwMetrics={bus:true,mains:false,load:false};
const PW_COLORS={bus:'#00e09a',mains:'#4090ff',load:'#ffb020'};
const PW_TITLES={bus:'P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤',mains:'P —Å–µ—Ç–∏',load:'P –Ω–∞–≥—Ä—É–∑–∫–∏'};

function showPwChart(initial){
pwMetrics={bus:initial==='bus',mains:initial==='mains',load:initial==='load'};
pwHours=1;
$('pwChkBus').checked=pwMetrics.bus;
$('pwChkMains').checked=pwMetrics.mains;
$('pwChkLoad').checked=pwMetrics.load;
document.querySelectorAll('#m-pwchart .arc-tb').forEach((b,i)=>b.classList.toggle('on',i===0));
const t=$('pwChartTitle');if(t)t.textContent='üìä '+PW_TITLES[initial]+' ‚Äî –ì—Ä–∞—Ñ–∏–∫';
showM('pwchart');
pwLoadChart();
}

function pwToggleMetric(){
pwMetrics.bus=$('pwChkBus').checked;
pwMetrics.mains=$('pwChkMains').checked;
pwMetrics.load=$('pwChkLoad').checked;
if(!pwMetrics.bus&&!pwMetrics.mains&&!pwMetrics.load){
pwMetrics={bus:true,mains:true,load:true};
$('pwChkBus').checked=true;$('pwChkMains').checked=true;$('pwChkLoad').checked=true;
}
pwLoadChart();
}

function pwRange(btn,hours){
btn.parentElement.querySelectorAll('.arc-tb').forEach(b=>b.classList.remove('on'));
btn.classList.add('on');pwHours=hours;
_updateZoomLabel('pwZoomLabel',hours);
pwLoadChart();
}


async function pwLoadChart(){
if(!cur||!S[cur])return;
const sprId=S[cur].spr?._deviceId;
if(!sprId){pwRenderNoData('–®–ü–† –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');return}
const fields=[];
if(pwMetrics.bus)fields.push('busbar_p');
if(pwMetrics.mains)fields.push('mains_total_p');
if(pwMetrics.load){
if(!fields.includes('busbar_p'))fields.push('busbar_p');
if(!fields.includes('mains_total_p'))fields.push('mains_total_p');
}
const bucket=arcBucket(pwHours);
let url;
if(bucket>0)url=`/api/history/metrics/${sprId}/downsampled?last_hours=${pwHours}&bucket_seconds=${bucket}&fields=${fields.join(',')}`;
else url=`/api/history/metrics/${sprId}?last_hours=${pwHours}&fields=${fields.join(',')}&limit=5000`;
try{
const data=await api.get(url);
if(!data||!data.length){pwRenderNoData('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥');return}
pwRenderChart(data);
}catch(e){pwRenderNoData('–û—à–∏–±–∫–∞: '+e.message)}
}

function pwRenderNoData(msg){
const canvas=$('pwCanvas');
if(pwChart){pwChart.destroy();pwChart=null}
if(canvas){const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.fillStyle='#5a6a80';ctx.font='13px Outfit';ctx.textAlign='center';
ctx.fillText(msg,canvas.width/2,canvas.height/2)}
}

function pwRenderChart(data){
const canvas=$('pwCanvas');if(!canvas)return;
if(pwChart){pwChart.destroy();pwChart=null}
if(typeof Chart==='undefined'){pwRenderNoData('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');return}
const timeKey=data[0].bucket!==undefined?'bucket':'timestamp';
const totalPts=data.length;
const showPts=totalPts<80;
const ptRadius=totalPts<30?3:totalPts<80?2:0;
const hoverRadius=totalPts<200?4:3;
const datasets=[];
if(pwMetrics.bus){
datasets.push({label:'P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤',data:data.map(r=>({x:new Date(r[timeKey]),y:r.busbar_p!=null?Number(r.busbar_p):null})),
borderColor:PW_COLORS.bus,backgroundColor:PW_COLORS.bus+'18',borderWidth:2.2,
pointRadius:showPts?ptRadius:0,pointHoverRadius:hoverRadius,pointBackgroundColor:PW_COLORS.bus,
pointBorderColor:PW_COLORS.bus,pointHitRadius:8,tension:0.25,fill:false,spanGaps:true});
}
if(pwMetrics.mains){
datasets.push({label:'P —Å–µ—Ç–∏',data:data.map(r=>({x:new Date(r[timeKey]),y:r.mains_total_p!=null?Number(r.mains_total_p):null})),
borderColor:PW_COLORS.mains,backgroundColor:PW_COLORS.mains+'18',borderWidth:2.2,
pointRadius:showPts?ptRadius:0,pointHoverRadius:hoverRadius,pointBackgroundColor:PW_COLORS.mains,
pointBorderColor:PW_COLORS.mains,pointHitRadius:8,tension:0.25,fill:false,spanGaps:true});
}
if(pwMetrics.load){
datasets.push({label:'P –Ω–∞–≥—Ä—É–∑–∫–∏',data:data.map(r=>{
const b=r.busbar_p!=null?Number(r.busbar_p):0;
const m=r.mains_total_p!=null?Number(r.mains_total_p):0;
return{x:new Date(r[timeKey]),y:b+m};
}),borderColor:PW_COLORS.load,backgroundColor:PW_COLORS.load+'18',borderWidth:2.2,
pointRadius:showPts?ptRadius:0,pointHoverRadius:hoverRadius,pointBackgroundColor:PW_COLORS.load,
pointBorderColor:PW_COLORS.load,pointHitRadius:8,tension:0.25,fill:false,spanGaps:true});
}
if(!datasets.length){pwRenderNoData('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –º–µ—Ç—Ä–∏–∫—É');return}
const c=getChartColors();
pwChart=new Chart(canvas,{type:'line',data:{datasets},
plugins:[crosshairPlugin],
options:{...CHART_DEFAULTS,
plugins:{...CHART_DEFAULTS.plugins,
legend:{...CHART_DEFAULTS.plugins.legend,labels:{...CHART_DEFAULTS.plugins.legend.labels,generateLabels:null}}},
scales:{
x:{...CHART_DEFAULTS.scales.x,grid:{...CHART_DEFAULTS.scales.x.grid,color:c.grid},border:{color:c.border},ticks:{...CHART_DEFAULTS.scales.x.ticks,color:c.tick}},
y:{...CHART_DEFAULTS.scales.y,grid:{...CHART_DEFAULTS.scales.y.grid,color:c.grid},border:{color:c.border},ticks:{...CHART_DEFAULTS.scales.y.ticks,color:c.tick},
title:{display:true,text:'–∫–í—Ç',color:c.tick,font:{family:'Outfit',size:11,weight:'500'},padding:{bottom:6}}}
}}});
pwChart.update();
}
// === END POWER CHART ===

// === SMOOTH WHEEL ZOOM ‚Äî continuous multiplicative zoom with DB reload ===
var _zoomPresets=[1,6,24,168,720];
var _zoomLabels={1:'1—á',6:'6—á',24:'24—á',168:'7–¥',720:'30–¥'};
var _zoomMin=0.1,_zoomMax=720,_zoomFactor=0.85;
var _wheelDebounceArc=null,_wheelDebouncePw=null;

function _formatZoomLabel(h){
  if(h<1){return Math.round(h*60)+'–º'}
  if(h<24){return (h%1<0.05||h%1>0.95)?Math.round(h)+'—á':h.toFixed(1)+'—á'}
  var d=h/24;
  return (d%1<0.05||d%1>0.95)?Math.round(d)+'–¥':d.toFixed(1)+'–¥';
}

function _updateZoomLabel(id,h){
  var el=document.getElementById(id);if(!el)return;
  var isPreset=_zoomPresets.some(function(p){return Math.abs(h-p)/p<0.01});
  if(isPreset){el.classList.remove('vis')}
  else{el.textContent='~'+_formatZoomLabel(h);el.classList.add('vis')}
}

function _highlightRangeBtn(container,hours){
  var btns=document.querySelectorAll(container+' .arc-tb');
  var matchLabel='';
  for(var i=0;i<_zoomPresets.length;i++){
    if(Math.abs(hours-_zoomPresets[i])/_zoomPresets[i]<0.01){matchLabel=_zoomLabels[_zoomPresets[i]];break}
  }
  btns.forEach(function(b){b.classList.toggle('on',b.textContent.trim()===matchLabel)});
}

function _smoothZoom(curH,deltaY){
  var dir=deltaY<0?_zoomFactor:(1/_zoomFactor);
  var newH=curH*dir;
  newH=Math.max(_zoomMin,Math.min(_zoomMax,newH));
  // Snap to preset if within 3%
  for(var i=0;i<_zoomPresets.length;i++){
    if(Math.abs(newH-_zoomPresets[i])/_zoomPresets[i]<0.03){newH=_zoomPresets[i];break}
  }
  return newH;
}

document.addEventListener('wheel',function(e){
  var t=e.target;
  if(!t||!t.closest)return;
  // --- Power chart ---
  if(t.id==='pwCanvas'||t.closest('#pwChartWrap')){
    e.preventDefault();e.stopPropagation();
    var newH=_smoothZoom(pwHours,e.deltaY);
    if(newH===pwHours)return;
    pwHours=newH;
    _highlightRangeBtn('#m-pwchart',pwHours);
    _updateZoomLabel('pwZoomLabel',pwHours);
    // Instant visual feedback ‚Äî adjust X-axis
    if(pwChart&&pwChart.options&&pwChart.options.scales&&pwChart.options.scales.x){
      var now=Date.now();
      pwChart.options.scales.x.min=now-pwHours*3600000;
      pwChart.options.scales.x.max=now;
      pwChart.update('none');
    }
    clearTimeout(_wheelDebouncePw);
    _wheelDebouncePw=setTimeout(function(){pwLoadChart()},400);
    return;
  }
  // --- Archive chart ---
  if(t.id==='arcCanvas'||t.closest('.arc-chart-wrap')){
    e.preventDefault();e.stopPropagation();
    if(!arcState.hours)arcState.hours=1; // fallback from custom range
    var newH=_smoothZoom(arcState.hours,e.deltaY);
    if(newH===arcState.hours)return;
    arcState.hours=newH;
    arcState.almPage=0;
    dpState.arcFrom=null;dpState.arcTo=null;
    var fb=$('arcFromBtn'),tb=$('arcToBtn');
    if(fb){fb.textContent='üìÖ –û—Ç';fb.classList.remove('has-val')}
    if(tb){tb.textContent='üìÖ –î–æ';tb.classList.remove('has-val')}
    _highlightRangeBtn('.arc-time',arcState.hours);
    _updateZoomLabel('arcZoomLabel',arcState.hours);
    // Instant visual feedback ‚Äî adjust X-axis
    if(arcChart&&arcChart.options&&arcChart.options.scales&&arcChart.options.scales.x){
      var now=Date.now();
      arcChart.options.scales.x.min=now-arcState.hours*3600000;
      arcChart.options.scales.x.max=now;
      arcChart.update('none');
    }
    clearTimeout(_wheelDebounceArc);
    _wheelDebounceArc=setTimeout(function(){arcLoadChart();arcLoadAlarms()},400);
    return;
  }
},{passive:false,capture:true});

function arcRenderFieldStats(data,grp){
const wrap=$('arcFieldStats');if(!wrap)return;
if(!data||!data.length){wrap.innerHTML='';return}
const fieldNames=grp.fields.split(',');
let html='';
for(let i=0;i<fieldNames.length;i++){
  const f=fieldNames[i];
  const vals=data.map(r=>r[f]).filter(v=>v!=null&&isFinite(v));
  if(!vals.length)continue;
  const mn=Math.min(...vals),mx=Math.max(...vals),avg=vals.reduce((a,b)=>a+b,0)/vals.length;
  const last=vals[vals.length-1];
  const lbl=grp.labels[f]||f;
  const shortLbl=lbl.split(' (')[0]; // remove unit from label
  const u=grp.unit?' '+grp.unit:'';
  html+=`<div class="arc-fs" style="border-left-color:${grp.colors[i]}">
<div class="arc-fs-name" style="color:${grp.colors[i]}">${shortLbl}</div>
<div class="arc-fs-row"><span class="arc-fs-lbl">–ú–∏–Ω</span><span class="arc-fs-val">${mn.toFixed(1)}${u}</span></div>
<div class="arc-fs-row"><span class="arc-fs-lbl">–°—Ä–µ–¥–Ω</span><span class="arc-fs-val">${avg.toFixed(1)}${u}</span></div>
<div class="arc-fs-row"><span class="arc-fs-lbl">–ú–∞–∫—Å</span><span class="arc-fs-val">${mx.toFixed(1)}${u}</span></div>
<div class="arc-fs-row"><span class="arc-fs-lbl">–¢–µ–∫—É—â</span><span class="arc-fs-val" style="color:${grp.colors[i]}">${last.toFixed(1)}${u}</span></div>
</div>`;
}
if(grp._computed){
grp._computed.forEach(c=>{
  const vals=data.map(r=>c.calc(r)).filter(v=>v!=null&&isFinite(v));
  if(!vals.length)return;
  const mn=Math.min(...vals),mx=Math.max(...vals),avg=vals.reduce((a,b)=>a+b,0)/vals.length;
  const last=vals[vals.length-1];
  const shortLbl=c.label.split(' (')[0];
  const u=grp.unit?' '+grp.unit:'';
  html+=`<div class="arc-fs" style="border-left-color:${c.color}">
<div class="arc-fs-name" style="color:${c.color}">${shortLbl}</div>
<div class="arc-fs-row"><span class="arc-fs-lbl">–ú–∏–Ω</span><span class="arc-fs-val">${mn.toFixed(1)}${u}</span></div>
<div class="arc-fs-row"><span class="arc-fs-lbl">–°—Ä–µ–¥–Ω</span><span class="arc-fs-val">${avg.toFixed(1)}${u}</span></div>
<div class="arc-fs-row"><span class="arc-fs-lbl">–ú–∞–∫—Å</span><span class="arc-fs-val">${mx.toFixed(1)}${u}</span></div>
<div class="arc-fs-row"><span class="arc-fs-lbl">–¢–µ–∫—É—â</span><span class="arc-fs-val" style="color:${c.color}">${last.toFixed(1)}${u}</span></div>
</div>`;
});
}
wrap.innerHTML=html;
}

function arcRenderNoData(msg){
if(arcChart){arcChart.destroy();arcChart=null}
const descEl=$('arcDesc');if(descEl)descEl.innerHTML='';
const fsEl=$('arcFieldStats');if(fsEl)fsEl.innerHTML='';
const el=$('arcStats');if(el)el.innerHTML=`<div style="color:var(--t3);font-size:12px;text-align:center;padding:30px">${msg}</div>`;
}

function arcRenderStats(stats){
const el=$('arcStats');if(!el)return;
el.innerHTML=`<div style="display:flex;gap:16px;flex-wrap:wrap">
<span>üìä –ó–∞–ø–∏—Å–µ–π: <b>${stats.total_rows?.toLocaleString()||0}</b></span>
<span>üìÖ –ü–µ—Ä–∏–æ–¥: <b>${stats.days_stored||0}</b> –¥–Ω–µ–π</span>
<span>üïê –û—Ç: <b>${stats.oldest?new Date(stats.oldest).toLocaleString('ru-RU'):'‚Äî'}</b></span>
<span>üïê –î–æ: <b>${stats.newest?new Date(stats.newest).toLocaleString('ru-RU'):'‚Äî'}</b></span></div>`;
}

function arcRenderAlarms(alarms){
const el=$('arcAlarmTable');if(!el)return;
if(!alarms||!alarms.length){el.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:30px">–ù–µ—Ç –∞–≤–∞—Ä–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ ‚úì</div>';const p=$('arcPag');if(p)p.innerHTML='';return}
const sevI={error:'üî¥',warning:'üü°',mains:'üîµ'},sevL={error:'–û—à–∏–±–∫–∞',warning:'–ü—Ä–µ–¥—É–ø—Ä.',mains:'–°–µ—Ç—å'};
const rows=alarms.map(a=>{
const occ=new Date(a.occurred_at),clr=a.cleared_at?new Date(a.cleared_at):null;
const dur=clr?Math.round((clr-occ)/60000):'‚Äî';
return`<tr>
<td style="white-space:nowrap">${occ.toLocaleString('ru-RU')}</td>
<td style="font-family:var(--m)">${esc(a.alarm_code)}</td>
<td>${sevI[a.severity]||'‚ö™'} ${sevL[a.severity]||a.severity}</td>
<td>${esc(a.message)}</td>
<td>${typeof dur==='number'?dur+' –º–∏–Ω':dur}</td>
<td>${a.is_active?'<span style="color:var(--r);font-weight:600">‚óè –ê–∫—Ç–∏–≤–Ω–∞</span>':'<span style="color:var(--t3)">‚úì –°–Ω—è—Ç–∞</span>'}</td></tr>`}).join('');
el.innerHTML=`<table class="pt"><thead><tr><th>–í—Ä–µ–º—è</th><th>–ö–æ–¥</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th><th>–î–ª–∏—Ç.</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>${rows}</tbody></table>`;
const pag=$('arcPag'),hasMore=alarms.length===arcState.almLimit;
if(pag)pag.innerHTML=`<div style="display:flex;gap:8px;align-items:center;margin-top:8px">
<button class="sb-btn" style="padding:5px 12px;font-size:11px;width:auto" onclick="arcState.almPage=Math.max(0,arcState.almPage-1);arcLoadAlarms()" ${arcState.almPage===0?'disabled style="opacity:.4;pointer-events:none;padding:5px 12px;font-size:11px;width:auto"':''}>‚Üê –ù–∞–∑–∞–¥</button>
<span style="font-size:11px;color:var(--t3);font-family:var(--m)">–°—Ç—Ä. ${arcState.almPage+1}</span>
<button class="sb-btn" style="padding:5px 12px;font-size:11px;width:auto" onclick="arcState.almPage++;arcLoadAlarms()" ${!hasMore?'disabled style="opacity:.4;pointer-events:none;padding:5px 12px;font-size:11px;width:auto"':''}>–í–ø–µ—Ä—ë–¥ ‚Üí</button></div>`;
}

function arcRenderDisk(d){
const el=$('arcDiskInfo');if(!el)return;
const pct=d.usage_pct||0;
const barColor=pct>85?'var(--r)':pct>65?'var(--y)':'var(--g)';
el.innerHTML=`<div style="max-width:500px">
<div style="font-size:13px;font-weight:600;margin-bottom:12px">üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</div>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--t2);margin-bottom:4px">
<span>PostgreSQL</span><span style="font-family:var(--m)">${d.db_size_mb} –ú–ë / ${d.max_db_size_mb} –ú–ë (${pct}%)</span></div>
<div style="height:8px;background:var(--bg);border-radius:4px;overflow:hidden">
<div style="height:100%;width:${Math.min(pct,100)}%;background:${barColor};border-radius:4px;transition:width .5s"></div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="arc-stat-card">
<div style="font-size:10px;color:var(--t3);margin-bottom:4px">–¢–∞–±–ª–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫</div>
<div style="font-family:var(--m);font-size:16px;font-weight:600;color:var(--g)">${d.metrics_table_size_mb} –ú–ë</div>
<div style="font-size:10px;color:var(--t3);font-family:var(--m)">${(d.metrics_row_count>=0?d.metrics_row_count:0).toLocaleString()} –∑–∞–ø–∏—Å–µ–π</div></div>
<div class="arc-stat-card">
<div style="font-size:10px;color:var(--t3);margin-bottom:4px">–¢–∞–±–ª–∏—Ü–∞ –∞–≤–∞—Ä–∏–π</div>
<div style="font-family:var(--m);font-size:16px;font-weight:600;color:var(--r)">${(d.alarms_row_count>=0?d.alarms_row_count:0).toLocaleString()}</div>
<div style="font-size:10px;color:var(--t3)">–∑–∞–ø–∏—Å–µ–π</div></div></div></div>`;
}
// ===================== END ARCHIVE PAGE =====================

// ===================== ALARMS PAGE =====================
let alarmsPageState={sevFilter:'',activeOnly:false,hours:24,page:0,limit:30};
let alarmsMode=false;

function resolveDeviceName(deviceId){
const info=deviceSlotIndex[deviceId];
if(!info)return'–£—Å—Ç—Ä. #'+deviceId;
const slotNames={g1:'–ì1',g2:'–ì2',spr:'–®–ü–†'};
const name=slotNames[info.slot]||info.slot;
const siteName=S[info.siteKey]?.name||info.siteKey;
return name+' ¬∑ '+siteName;
}

function showAlarms(){stopB24Poll();curView='alarms';
alarmsMode=true;archiveMode=false;
const mn=$('mainArea');
mn.innerHTML=`
<div class="dh"><div class="dt"><h1>üö® –ê–≤–∞—Ä–∏–∏</h1></div>
<div class="da"><button onclick="alarmsMode=false;if(cur&&S[cur])renderDash()">‚Üê –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
<button onclick="almRefresh()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button></div></div>
<div style="margin-bottom:12px">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<h2 style="font-size:14px;font-weight:600;color:var(--r)">‚óè –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≤–∞—Ä–∏–∏</h2>
<span id="almActiveCount" style="font-size:11px;color:var(--t3);font-family:var(--m)"></span></div>
<div id="almActiveList"></div></div>
<div>
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<h2 style="font-size:14px;font-weight:600;color:var(--t2)">üìã –ñ—É—Ä–Ω–∞–ª –∞–≤–∞—Ä–∏–π</h2></div>
<div class="arc-flt" style="margin-bottom:8px">
<select class="fi" id="almSev" style="width:140px;padding:6px 8px;font-size:11px" onchange="alarmsPageState.page=0;almLoadHistory()">
<option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option><option value="error">üî¥ –û—à–∏–±–∫–∞</option><option value="warning">üü° –ü—Ä–µ–¥—É–ø—Ä.</option></select>
<label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--t2)"><input type="checkbox" id="almActiveOnly" style="accent-color:var(--g)" onchange="alarmsPageState.page=0;almLoadHistory()"> –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</label>
<div style="display:flex;gap:2px">
<button class="arc-tb" onclick="almPeriod(this,1)">1—á</button>
<button class="arc-tb" onclick="almPeriod(this,6)">6—á</button>
<button class="arc-tb on" onclick="almPeriod(this,24)">24—á</button>
<button class="arc-tb" onclick="almPeriod(this,168)">7–¥</button>
<button class="arc-tb" onclick="almPeriod(this,720)">30–¥</button>
<button class="arc-tb" onclick="almPeriod(this,0)">–í—Å—ë</button></div></div>
<div id="almHistoryTable"></div>
<div id="almHistoryPag"></div></div>`;
almRefresh();
}

function almPeriod(btn,hours){
btn.parentElement.querySelectorAll('.arc-tb').forEach(b=>b.classList.remove('on'));
btn.classList.add('on');alarmsPageState.hours=hours;alarmsPageState.page=0;almLoadHistory();
}

async function almLoadActive(){
const el=$('almActiveList'),cnt=$('almActiveCount');
if(!el)return;
el.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
try{
const alarms=await api.get('/api/history/alarms/active');
if(cnt)cnt.textContent=alarms.length+' —à—Ç.';
if(!alarms.length){el.innerHTML='<div style="padding:16px 20px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:var(--rad);color:var(--g);font-size:13px;text-align:center">‚úì –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤–∞—Ä–∏–π</div>';return}
const sevI={error:'üî¥',warning:'‚ö†'},sevC={error:'var(--r)',warning:'var(--y)'};
const cards=alarms.map(a=>{
const occ=new Date(a.occurred_at);
const durMin=Math.round((Date.now()-occ.getTime())/60000);
const durStr=durMin<60?durMin+' –º–∏–Ω':(durMin/60|0)+' —á '+(durMin%60)+' –º–∏–Ω';
const ic=sevI[a.severity]||'üî¥';
const col=sevC[a.severity]||'var(--r)';
const bg=a.severity==='warning'?'var(--yd)':'var(--rd)';
const border=a.severity==='warning'?'rgba(255,176,32,.2)':'rgba(255,64,96,.2)';
const dev=resolveDeviceName(a.device_id);
return`<div class="ai" data-device-id="${a.device_id}" style="cursor:pointer;padding:10px 14px;background:${bg};border:1px solid ${border};border-radius:var(--rs);margin-bottom:4px;display:flex;align-items:center;gap:10px">
<span style="font-size:16px">${ic}</span>
<div style="flex:1;min-width:0">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:2px">
<b style="color:${col};font-family:var(--m);font-size:12px">${esc(a.alarm_code)}</b>
<span style="font-size:12px;color:var(--t)">${esc(a.message)}</span></div>
<div style="font-size:10px;color:var(--t3);font-family:var(--m)">${dev} ¬∑ ${occ.toLocaleString('ru-RU')} ¬∑ ${durStr}</div></div></div>`}).join('');
el.innerHTML=cards;
}catch(e){el.innerHTML=`<div style="color:var(--r);font-size:12px;padding:20px;text-align:center">–û—à–∏–±–∫–∞: ${esc(e.message)}</div>`}}

async function almLoadHistory(){
const el=$('almHistoryTable'),pag=$('almHistoryPag');
if(!el)return;
el.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
const st=alarmsPageState;
st.sevFilter=$('almSev')?.value||'';
st.activeOnly=$('almActiveOnly')?.checked||false;
let url=`/api/history/alarms?limit=${st.limit}&offset=${st.page*st.limit}`;
if(st.sevFilter)url+=`&severity=${st.sevFilter}`;
if(st.activeOnly)url+='&is_active=true';
if(st.hours)url+=`&last_hours=${st.hours}`;
try{
const alarms=await api.get(url);
if(!alarms||!alarms.length){el.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:30px">–ù–µ—Ç –∞–≤–∞—Ä–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ ‚úì</div>';if(pag)pag.innerHTML='';return}
const sevI={error:'üî¥',warning:'üü°'},sevL={error:'–û—à–∏–±–∫–∞',warning:'–ü—Ä–µ–¥—É–ø—Ä.'};
const rows=alarms.map(a=>{
const occ=new Date(a.occurred_at),clr=a.cleared_at?new Date(a.cleared_at):null;
const dur=clr?Math.round((clr-occ)/60000):'‚Äî';
const dev=resolveDeviceName(a.device_id);
return`<tr class="ai" data-device-id="${a.device_id}" style="cursor:pointer">
<td style="white-space:nowrap">${occ.toLocaleString('ru-RU')}</td>
<td>${esc(dev)}</td>
<td style="font-family:var(--m)"><b>${esc(a.alarm_code)}</b></td>
<td>${sevI[a.severity]||'‚ö™'} ${sevL[a.severity]||a.severity}</td>
<td>${esc(a.message)}</td>
<td>${typeof dur==='number'?dur+' –º–∏–Ω':dur}</td>
<td>${a.is_active?'<span style="color:var(--r);font-weight:600">‚óè –ê–∫—Ç–∏–≤–Ω–∞</span>':'<span style="color:var(--t3)">‚úì –°–Ω—è—Ç–∞</span>'}</td></tr>`}).join('');
el.innerHTML=`<table class="pt"><thead><tr><th>–í—Ä–µ–º—è</th><th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th><th>–ö–æ–¥</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th><th>–î–ª–∏—Ç.</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>${rows}</tbody></table>`;
const hasMore=alarms.length===st.limit;
if(pag)pag.innerHTML=`<div style="display:flex;gap:8px;align-items:center;margin-top:8px">
<button class="sb-btn" style="padding:5px 12px;font-size:11px;width:auto" onclick="alarmsPageState.page=Math.max(0,alarmsPageState.page-1);almLoadHistory()" ${st.page===0?'disabled style="opacity:.4;pointer-events:none;padding:5px 12px;font-size:11px;width:auto"':''}>‚Üê –ù–∞–∑–∞–¥</button>
<span style="font-size:11px;color:var(--t3);font-family:var(--m)">–°—Ç—Ä. ${st.page+1}</span>
<button class="sb-btn" style="padding:5px 12px;font-size:11px;width:auto" onclick="alarmsPageState.page++;almLoadHistory()" ${!hasMore?'disabled style="opacity:.4;pointer-events:none;padding:5px 12px;font-size:11px;width:auto"':''}>–í–ø–µ—Ä—ë–¥ ‚Üí</button></div>`;
}catch(e){el.innerHTML=`<div style="color:var(--r);font-size:12px;padding:20px;text-align:center">–û—à–∏–±–∫–∞: ${esc(e.message)}</div>`}}

function almRefresh(){almLoadActive();almLoadHistory()}
// ===================== END ALARMS PAGE =====================

// ===================== POWER LIMIT =====================
var _plSlot=null,_plDeviceId=null,_plDeviceType=null;
function openPowerLimitModal(slot){
_plSlot=slot;_plDeviceId=getDeviceIdForSlot(slot);_plDeviceType=null;
if(!_plDeviceId){ae('‚ö† –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');return}
const m=$('plModal');if(!m)return;m.classList.add('sh');
const nm=slot==='g1'?'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1':slot==='g2'?'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2':'–®–ü–†';
$('plTitle').textContent='‚ö° –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏ ‚Äî '+nm;
$('plLiveP').textContent='‚Äî';$('plLiveQ').textContent='‚Äî';
$('plSliderP').value=75;$('plNumP').textContent='75.0%';
$('plSliderQ').value=50;$('plNumQ').textContent='50.0%';
$('plLoadModeWrap').style.display='none';
$('plStatus').innerHTML='';
// Load current values from API
if(apiAvailable){
fetch(API_BASE+'/api/devices/'+_plDeviceId+'/power-limit').then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.json()}).then(d=>{
if(d.success){
_plDeviceType=d.device_type;
if(d.current_p_pct!=null)$('plLiveP').textContent=d.current_p_pct.toFixed(1)+'%';
if(d.current_q_pct!=null)$('plLiveQ').textContent=d.current_q_pct.toFixed(1)+'%';
if(d.config_p_raw!=null){$('plSliderP').value=Math.round(d.config_p_raw/10);$('plNumP').textContent=(d.config_p_raw/10).toFixed(1)+'%'}
if(d.config_q_raw!=null){$('plSliderQ').value=Math.round(d.config_q_raw/10);$('plNumQ').textContent=(d.config_q_raw/10).toFixed(1)+'%'}
if(d.device_type==='ats'){$('plLoadModeWrap').style.display='';document.querySelectorAll('input[name=plMode]').forEach(r=>{r.checked=d.load_mode!=null&&+r.value===d.load_mode})}
}}).catch(e=>{console.warn('PL read error:',e);$('plStatus').innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y)">‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —Å—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥: '+e.message+'</div>'})}
else{
// Use WS data as fallback
const mx=latestMetrics[_plDeviceId];
if(mx){
if(mx.current_p_pct!=null)$('plLiveP').textContent=mx.current_p_pct.toFixed(1)+'%';
if(mx.current_q_pct!=null)$('plLiveQ').textContent=mx.current_q_pct.toFixed(1)+'%';
if(mx.target_p_pct!=null){$('plSliderP').value=Math.round(mx.target_p_pct);$('plNumP').textContent=mx.target_p_pct.toFixed(1)+'%'}
if(mx.target_q_pct!=null){$('plSliderQ').value=Math.round(mx.target_q_pct);$('plNumQ').textContent=mx.target_q_pct.toFixed(1)+'%'}
}}}
function closePowerLimitModal(){const m=$('plModal');if(m)m.classList.remove('sh');_plSlot=null}
function plSliderUpdate(which){
const sl=$('plSlider'+which),num=$('plNum'+which);
if(sl&&num)num.textContent=parseFloat(sl.value).toFixed(1)+'%'}
function plQuickP(p,q){$('plSliderP').value=p;$('plNumP').textContent=p.toFixed(1)+'%';$('plSliderQ').value=q;$('plNumQ').textContent=q.toFixed(1)+'%'}
async function savePowerLimit(){
if(!_plDeviceId){ae('‚ö† –ù–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');return}
const pVal=parseInt($('plSliderP').value),qVal=parseInt($('plSliderQ').value);
const pRaw=pVal*10,qRaw=qVal*10;
const st=$('plStatus');
if(!confirm('–ó–∞–ø–∏—Å–∞—Ç—å P='+pVal+'%, Q='+qVal+'% –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä?\n\n‚ö† –≠—Ç–æ –∏–∑–º–µ–Ω–∏—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏!')){return}
const body={p_raw:pRaw,q_raw:qRaw};
const modeEl=document.querySelector('input[name=plMode]:checked');
if(modeEl)body.load_mode=parseInt(modeEl.value);
st.innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y);font-family:var(--m)">‚è≥ –ó–∞–ø–∏—Å—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä...</div>';
if(!apiAvailable){st.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';return}
try{
const r=await fetch(API_BASE+'/api/devices/'+_plDeviceId+'/power-limit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
const d=await r.json();
if(d.success&&d.verified){st.innerHTML='<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m)">‚úÖ '+d.message+'</div>';ae('‚ö° P='+pVal+'% Q='+qVal+'% –∑–∞–ø–∏—Å–∞–Ω–æ')}
else if(d.success){st.innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y);font-family:var(--m)">‚ö† '+d.message+'</div>';ae('‚ö† PL –∑–∞–ø–∏—Å–∞–Ω–æ, –Ω–æ –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ')}
else{st.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+(d.detail||d.message||'–û—à–∏–±–∫–∞')+'</div>'}
}catch(e){st.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+e.message+'</div>'}}
// ===================== END POWER LIMIT =====================

// === INIT ===
(async function init() {
    // Try loading from API first
    const loaded = await loadFromAPI();
    if (!loaded) {
        // Fallback to localStorage (original v5 behavior)
        if (!Object.keys(S).length) {
            S['mkz'] = {name:'–ú–ö–ó', desc:'–ö–∏—Ä–ø–∏—á–Ω—ã–π –∑–∞–≤–æ–¥', responsible:'',
                g1:{ip:'192.168.97.10',port:502,slaveId:1,runHours:1227},
                g2:{ip:'192.168.97.11',port:502,slaveId:1,runHours:489},
                spr:{ip:'10.11.0.2',port:26,slaveId:1}};
            cur = 'mkz';
            sv();
            ae('üè≠ –ú–ö–ó —Å–æ–∑–¥–∞–Ω (localStorage)');
        }
    }
    renderSB();
    if (cur && S[cur]) renderDash();
    else { cur = Object.keys(S)[0] || null; renderDash(); }
    // Connect WebSocket for live data
    connectWebSocket();
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ë24 Dashboard ‚Äî unified Bitrix24 page (tasks + equipment + mapping + settings)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let b24PollTimer=null;
function stopB24Poll(){if(b24PollTimer){clearInterval(b24PollTimer);b24PollTimer=null}}
function showB24Dashboard(){
alarmsMode=false;archiveMode=false;stopB24Poll();
const mn=$('mainArea');
mn.innerHTML=`<div class="dh"><div class="dt"><h1 style="font-size:16px;font-weight:700;color:var(--t)">üîó –ë–∏—Ç—Ä–∏–∫—Å24</h1></div>
<div class="da"><button class="bs2" style="padding:6px 14px" onclick="stopB24Poll();if(cur&&S[cur])renderDash()">‚Üê –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
<button class="bs2" style="padding:6px 14px" onclick="b24ForceSync()">‚ö° –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
<button class="bs2" style="padding:6px 14px" onclick="b24TestTask()">üß™ –¢–µ—Å—Ç</button>
<button class="bs2" style="padding:6px 14px" onclick="initBxModal();showM('bitrix')">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button></div></div>
<div id="b24Status" style="margin-bottom:10px"></div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:12px">
<div id="b24StatOpen" class="cc" style="padding:14px;text-align:center"></div>
<div id="b24StatClosed" class="cc" style="padding:14px;text-align:center"></div>
<div id="b24StatMaint" class="cc" style="padding:14px;text-align:center"></div>
<div id="b24StatAlarm" class="cc" style="padding:14px;text-align:center"></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div><h3 style="font-size:13px;color:var(--t2);margin-bottom:8px">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3><div id="b24Tasks"></div></div>
<div><h3 style="font-size:13px;color:var(--t2);margin-bottom:8px">üë• –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ —Ä–æ–ª–∏</h3><div id="b24Equip"></div></div></div>
<div><h3 style="font-size:13px;color:var(--t2);margin-bottom:8px">üîß –ü—Ä–∏–≤—è–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é –ë24</h3><div id="b24Mapping"></div></div>`;
b24Refresh();
b24LoadMapping();
b24PollTimer=setInterval(b24Refresh,15000);
}
async function b24Refresh(){await Promise.all([b24LoadStatus(),b24LoadStats(),b24LoadTasks(),b24LoadEquip()])}
async function b24LoadStatus(){
const el=$('b24Status');if(!el)return;
try{const s=await api.get('/api/bitrix24/status');
const c=s.connected;const domain=s.webhook_url?new URL(s.webhook_url).origin:'';
el.innerHTML=`<div style="padding:10px 14px;background:${c?'var(--gd)':'var(--rd)'};border:1px solid var(--bd);border-radius:var(--rad);display:flex;align-items:center;gap:10px;cursor:pointer" onclick="b24ForceSync()" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏">
<span style="font-size:14px">${c?'üü¢':'üî¥'}</span>
<b style="font-size:12px;color:${c?'var(--g)':'var(--r)'}">${c?'–ü–æ–¥–∫–ª—é—á–µ–Ω–æ':'–ù–µ—Ç —Å–≤—è–∑–∏'}</b>
<span style="font-size:10px;color:var(--t3);font-family:var(--m)">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: ${s.equipment_count||0} –µ–¥.</span>
${domain?`<a href="${domain}" target="_blank" onclick="event.stopPropagation()" style="font-size:10px;color:var(--b);text-decoration:underline;margin-left:4px">${domain.replace('https://','')}</a>`:''}
<span style="font-size:10px;color:var(--t4);margin-left:auto">${s.last_sync?'–°–∏–Ω—Ö—Ä: '+new Date(s.last_sync).toLocaleTimeString():''} üîÑ</span></div>`;
}catch(e){el.innerHTML=`<div style="padding:10px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);font-size:11px;color:var(--t3)">–ú–æ–¥—É–ª—å –ë24 –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω (BITRIX24_ENABLED=false)</div>`}}
async function b24LoadStats(){
try{const s=await api.get('/api/bitrix24/stats');
const mk=(id,val,lbl,clr,flt)=>{const el=$(id);if(el){const act=JSON.stringify(b24Filter)===JSON.stringify(flt);el.innerHTML=`<div style="font-size:22px;font-weight:700;color:var(--${clr})">${val}</div><div style="font-size:10px;color:var(--t3);margin-top:2px">${lbl}</div>`;el.style.cursor='pointer';el.style.border=act?'2px solid var(--'+clr+')':'';el.onclick=()=>{b24Filter=act?{status:null,source_type:null}:flt;b24LoadTasks();b24LoadStats()}}};
mk('b24StatOpen',s.open,'–û—Ç–∫—Ä—ã—Ç—ã—Ö','y',{status:'open',source_type:null});
mk('b24StatClosed',s.closed,'–ó–∞–∫—Ä—ã—Ç—ã—Ö','g',{status:'closed',source_type:null});
mk('b24StatMaint',s.by_type?.maintenance||0,'–¢–û','b',{status:null,source_type:'maintenance'});
mk('b24StatAlarm',s.by_type?.alarm||0,'–ê–≤–∞—Ä–∏–π','r',{status:null,source_type:'alarm'});
}catch(e){}}
let b24Filter={status:null,source_type:null};
function b24TaskUrl(taskId){const cfg=getBxConfig();if(!cfg.url)return'';try{const u=new URL(cfg.url);return u.origin+'/company/personal/user/102/tasks/task/view/'+taskId+'/'}catch(e){return''}}
async function b24LoadTasks(){
const el=$('b24Tasks');if(!el)return;
try{let q='/api/bitrix24/tasks?limit=20';if(b24Filter.status)q+='&status='+b24Filter.status;if(b24Filter.source_type)q+='&source_type='+b24Filter.source_type;
const r=await api.get(q);
if(!r.tasks||!r.tasks.length){el.innerHTML='<div style="padding:16px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);font-size:11px;color:var(--t3);text-align:center">–ù–µ—Ç –∑–∞–¥–∞—á'+(b24Filter.status||b24Filter.source_type?' –ø–æ —Ñ–∏–ª—å—Ç—Ä—É ¬∑ <a href="#" onclick="b24Filter={status:null,source_type:null};b24LoadTasks();b24LoadStats();return false" style="color:var(--g)">—Å–±—Ä–æ—Å–∏—Ç—å</a>':'')+'</div>';return}
const fBadge=(b24Filter.status||b24Filter.source_type)?`<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:10px;color:var(--t3)"><span>–§–∏–ª—å—Ç—Ä: ${b24Filter.status||''} ${b24Filter.source_type||''}</span><a href="#" onclick="b24Filter={status:null,source_type:null};b24LoadTasks();b24LoadStats();return false" style="color:var(--g);text-decoration:none">‚úï —Å–±—Ä–æ—Å–∏—Ç—å</a></div>`:'';
el.innerHTML=fBadge+r.tasks.map(t=>{
const isAlarm=t.source_type==='alarm';
const ico=isAlarm?'üî¥':'üü°';
const cls=t.status==='closed'?'opacity:.5':'';
const pr=t.priority>=2?'<span style="color:var(--r);font-size:9px;font-weight:700"> HIGH</span>':'';
const href=b24TaskUrl(t.bitrix_task_id);
return`<div class="cc b24-task" style="padding:10px 12px;margin-bottom:6px;${cls};cursor:pointer" onclick="${href?`window.open('${href}','_blank')`:''}" title="${href?'–û—Ç–∫—Ä—ã—Ç—å –≤ –ë–∏—Ç—Ä–∏–∫—Å24':''}">
<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
<span style="font-size:12px">${ico}</span>
<span style="font-size:11px;font-weight:600;color:var(--t)">${esc(t.task_title)}</span>${pr}
<span style="margin-left:auto;font-size:9px;padding:2px 6px;border-radius:10px;background:${t.status==='open'?'var(--yd)':'var(--gd)'};color:${t.status==='open'?'var(--y)':'var(--g)'}">${t.status}</span></div>
<div style="font-size:10px;color:var(--t3)">
‚Üí ${esc(t.responsible_name||'‚Äî')} ¬∑ <span style="color:var(--b);text-decoration:underline">#${t.bitrix_task_id}</span> ¬∑ ${t.created_at?new Date(t.created_at).toLocaleDateString():''}</div></div>`}).join('')}
catch(e){el.innerHTML=`<div style="padding:10px;font-size:11px;color:var(--r)">–û—à–∏–±–∫–∞: ${esc(e.message)}</div>`}}
async function b24LoadEquip(){
const el=$('b24Equip');if(!el)return;
try{const r=await api.get('/api/bitrix24/equipment');
if(!r.items||!r.items.length){el.innerHTML='<div style="padding:16px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);font-size:11px;color:var(--t3);text-align:center">–ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>';return}
el.innerHTML=r.items.map((eq,i)=>`<div class="cc b24-eq" style="padding:10px 12px;margin-bottom:6px;cursor:pointer" onclick="b24ToggleEq(this,'${esc(eq.system_code)}')">
<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
<span class="b24-eq-arrow" style="font-size:9px;color:var(--t3);width:12px">‚ñ∂</span>
<span style="font-size:12px;font-weight:600;color:var(--t)">${esc(eq.name)}</span>
<span style="font-size:9px;color:var(--t4);font-family:var(--m)">(${esc(eq.system_code)})</span>
<span style="margin-left:auto;font-size:9px;padding:2px 6px;border-radius:10px;background:var(--gd);color:var(--g)">ID: ${eq.responsible_id||'‚Äî'}</span></div>
<div style="font-size:10px;color:var(--t3);line-height:1.6">
<div>üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <b style="color:var(--t2)">${esc(eq.responsible_name||'‚Äî')}</b></div>
${eq.accomplice_names?.length?`<div>üë• –°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${eq.accomplice_names.map(n=>esc(n)).join(', ')}</div>`:''}
${eq.auditor_names?.length?`<div>üëÅ –ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏: ${eq.auditor_names.map(n=>esc(n)).join(', ')}</div>`:''}
</div>
<div class="b24-eq-detail" style="display:none;margin-top:8px;padding-top:8px;border-top:1px solid var(--bd)">
<div style="font-size:10px;color:var(--t4)">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div></div>
</div>`).join('')}
catch(e){el.innerHTML=`<div style="padding:10px;font-size:11px;color:var(--r)">–û—à–∏–±–∫–∞: ${esc(e.message)}</div>`}}
async function b24ToggleEq(card,sysCode){
const det=card.querySelector('.b24-eq-detail');const arr=card.querySelector('.b24-eq-arrow');
if(det.style.display!=='none'){det.style.display='none';arr.textContent='‚ñ∂';return}
det.style.display='block';arr.textContent='‚ñº';
try{const r=await api.get('/api/bitrix24/tasks?limit=10');
const tasks=(r.tasks||[]).filter(t=>t.system_code===sysCode);
if(!tasks.length){det.innerHTML='<div style="font-size:10px;color:var(--t4)">–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è —ç—Ç–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>';return}
det.innerHTML='<div style="font-size:10px;font-weight:600;color:var(--t2);margin-bottom:4px">–ó–∞–¥–∞—á–∏ ('+tasks.length+'):</div>'+tasks.map(t=>{
const href=b24TaskUrl(t.bitrix_task_id);
return`<div style="padding:4px 8px;background:var(--ov);border-radius:4px;margin-bottom:3px;font-size:10px;cursor:pointer" onclick="event.stopPropagation();${href?`window.open('${href}','_blank')`:''}">
<span style="color:${t.status==='open'?'var(--y)':'var(--g)'}">${t.status==='open'?'üü°':'üü¢'}</span>
${esc(t.task_title)} <span style="color:var(--b)">#${t.bitrix_task_id}</span></div>`}).join('')}
catch(e){det.innerHTML='<div style="font-size:10px;color:var(--r)">'+e.message+'</div>'}}
async function b24LoadMapping(){
const el=$('b24Mapping');if(!el)return;
try{const r=await api.get('/api/bitrix24/device-mapping');
const devs=r.devices||[];const eqs=r.equipment||[];
if(!devs.length){el.innerHTML='<div style="padding:10px;font-size:11px;color:var(--t3)">–ù–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div>';return}
el.innerHTML=`<div class="cc" style="padding:12px"><table style="width:100%;border-collapse:collapse;font-size:11px">
<tr style="border-bottom:1px solid var(--bd)"><th style="text-align:left;padding:6px;color:var(--t2)">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th><th style="text-align:left;padding:6px;color:var(--t2)">–¢–∏–ø</th><th style="text-align:left;padding:6px;color:var(--t2)">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ë24</th><th style="padding:6px"></th></tr>
${devs.map(d=>{
const opts=eqs.map(eq=>`<option value="${esc(eq.system_code)}"${d.system_code===eq.system_code?' selected':''}>${esc(eq.name)} (${esc(eq.system_code)})</option>`).join('');
const linked=d.system_code?true:false;
return`<tr style="border-bottom:1px solid var(--bd)">
<td style="padding:6px;color:var(--t)">${esc(d.name)}</td>
<td style="padding:6px;color:var(--t3)">${esc(d.device_type)}</td>
<td style="padding:6px"><select id="b24map_${d.id}" style="padding:4px 8px;font-size:11px;border:1px solid var(--bd);border-radius:4px;background:var(--bg);color:var(--t)">
<option value="">‚Äî –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω ‚Äî</option>${opts}</select></td>
<td style="padding:6px"><button class="bs2" style="padding:4px 10px;font-size:10px" onclick="b24SaveMapping(${d.id})">${linked?'‚úÖ':'üíæ'}</button></td></tr>`}).join('')}
</table></div>`;
}catch(e){el.innerHTML=`<div style="padding:10px;font-size:11px;color:var(--r)">–û—à–∏–±–∫–∞: ${esc(e.message)}</div>`}}
async function b24SaveMapping(deviceId){
const sel=$('b24map_'+deviceId);if(!sel)return;
const sc=sel.value||null;
try{await api.put('/api/bitrix24/device-mapping',{device_id:deviceId,system_code:sc});
ae(sc?'‚úÖ –ü—Ä–∏–≤—è–∑–∞–Ω–æ: '+sc:'‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ —Å–Ω—è—Ç–∞');b24LoadMapping()}
catch(e){ae('‚ùå '+e.message)}}
async function b24ForceSync(){
try{const r=await api.post('/api/bitrix24/equipment/sync');ae('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: '+r.cached+' –µ–¥.');b24Refresh();b24LoadMapping()}
catch(e){ae('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: '+e.message)}}
async function b24TestTask(){
try{const r=await api.post('/api/bitrix24/tasks/test');
if(r.success){ae('‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: #'+r.task_id);b24Refresh()}
else ae('‚ùå –û—à–∏–±–∫–∞: '+(r.error||'unknown'))}
catch(e){ae('‚ùå '+e.message)}}

// ===================== SANEK CHAT + AVATAR =====================
var _snOpen=false,_snSid=null,_snSending=false,_snMsgCount=0,_snHistOpen=false;

// === SANEK AVATAR ENGINE (from sanek_v4) ===
var _sn={
  state:'idle',time:0,
  eyeX:0,eyeY:0,targetEyeX:0,targetEyeY:0,
  bounceY:0,squishX:1,squishY:1,tSquishX:1,tSquishY:1,
  blinkTimer:0,blinkOpen:1,mouthOpen:0,tMouthOpen:0,
  emotionT:0,keystrokeImpact:0,readingNod:0,
  color:{r:93,g:228,b:255},
  tColor:{r:93,g:228,b:255}
};

var _snColorsDark={
  idle:{r:93,g:228,b:255},reading:{r:251,g:146,b:60},listening:{r:255,g:190,b:74},
  thinking:{r:167,g:139,b:250},alert:{r:255,g:107,b:129},success:{r:74,g:222,b:128},sleeping:{r:100,g:116,b:139}
};
var _snColorsLight={
  idle:{r:167,g:139,b:250},reading:{r:251,g:146,b:60},listening:{r:255,g:190,b:74},
  thinking:{r:129,g:140,b:248},alert:{r:255,g:107,b:129},success:{r:74,g:222,b:128},sleeping:{r:140,g:156,b:179}
};
var _snGlowsDark={
  idle:'rgba(93,228,255,.15)',reading:'rgba(251,146,60,.18)',listening:'rgba(255,190,74,.2)',
  thinking:'rgba(167,139,250,.15)',alert:'rgba(255,107,129,.15)',success:'rgba(74,222,128,.2)',sleeping:'rgba(100,116,139,.06)'
};
var _snGlowsLight={
  idle:'rgba(109,40,217,.15)',reading:'rgba(217,119,6,.18)',listening:'rgba(180,83,9,.2)',
  thinking:'rgba(79,70,229,.15)',alert:'rgba(220,38,38,.15)',success:'rgba(5,150,105,.2)',sleeping:'rgba(100,116,139,.06)'
};
var _snTagColorsDark={idle:'#5de4ff',reading:'#fb923c',listening:'#ffbe4a',thinking:'#a78bfa',alert:'#ff6b81',success:'#4ade80',sleeping:'#64748b'};
var _snTagColorsLight={idle:'#6d28d9',reading:'#d97706',listening:'#b45309',thinking:'#4f46e5',alert:'#dc2626',success:'#059669',sleeping:'#64748b'};
var _snColors=_snColorsDark,_snGlows=_snGlowsDark,_snTagColors=_snTagColorsDark;
var _snLabels={
  idle:'–≥–æ—Ç–æ–≤ ‚Äî –∂–¥—É –∫–æ–º–∞–Ω–¥—ã',reading:'—á–∏—Ç–∞—é ‚Äî –≤–∏–∂—É —á—Ç–æ –ø–∏—à–µ—à—å...',listening:'—Å–ª—É—à–∞—é ‚Äî –≥–æ–≤–æ—Ä–∏...',
  thinking:'–¥—É–º–∞—é ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é...',alert:'–æ—à–∏–±–∫–∞ ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ',success:'–≥–æ—Ç–æ–≤–æ ‚Äî –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!',sleeping:'—Å–æ–Ω ‚Äî –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'
};
var _snIsLightTheme=false;
function _snUpdateThemeColors(){
  var lt=document.documentElement.getAttribute('data-theme')==='light';
  _snIsLightTheme=lt;
  _snColors=lt?_snColorsLight:_snColorsDark;
  _snGlows=lt?_snGlowsLight:_snGlowsDark;
  _snTagColors=lt?_snTagColorsLight:_snTagColorsDark;
  var tc={..._snColors[_sn.state]};
  _sn.tColor=tc;
  _sn.color={r:tc.r,g:tc.g,b:tc.b};
  // Update status UI colors
  var st=$('snStatusText');if(st)st.style.color=_snTagColors[_sn.state];
  var dot=$('snStatusDot');if(dot){dot.style.background=_snTagColors[_sn.state];dot.style.boxShadow='0 0 6px '+_snTagColors[_sn.state]}
  var hds=document.querySelector('.sn-hd-status');if(hds)hds.style.color=_snTagColors[_sn.state];
}

function _snLerp(a,b,t){return a+(b-a)*t}
function _snLerpC(c,t,s){c.r=_snLerp(c.r,t.r,s);c.g=_snLerp(c.g,t.g,s);c.b=_snLerp(c.b,t.b,s)}
function _snRgb(c,a){return a!==undefined?`rgba(${Math.round(c.r)},${Math.round(c.g)},${Math.round(c.b)},${a})`:`rgb(${Math.round(c.r)},${Math.round(c.g)},${Math.round(c.b)})`}

function snSetState(state){
  _sn.state=state;_sn.tColor={..._snColors[state]};_sn.emotionT=0;
  var st=$('snStatusText');if(st){st.textContent=_snLabels[state];st.style.color=_snTagColors[state]}
  var dot=$('snStatusDot');if(dot){dot.style.background=_snTagColors[state];dot.style.boxShadow='0 0 6px '+_snTagColors[state]}
  var hds=document.querySelector('.sn-hd-status');if(hds)hds.style.color=_snTagColors[state];
  _sn.tSquishX=1.12;_sn.tSquishY=.9;
  setTimeout(()=>{_sn.tSquishX=.94;_sn.tSquishY=1.08},120);
  setTimeout(()=>{_sn.tSquishX=1;_sn.tSquishY=1},280);
  if(state==='success')_sn.bounceY=-20;
}

function _snDrawBody(c,ox,oy,s){
  var S=_sn,t=S.time,col=S.color,headR=150;
  var lt=_snIsLightTheme;
  // Shadow
  c.save();c.translate(ox,oy+20);c.scale(1,.25);
  var shG=c.createRadialGradient(0,0,0,0,0,headR*.8);shG.addColorStop(0,lt?'rgba(0,0,0,.2)':'rgba(0,0,0,.25)');shG.addColorStop(1,'rgba(0,0,0,0)');
  c.fillStyle=shG;c.beginPath();c.arc(0,0,headR*.8,0,Math.PI*2);c.fill();c.restore();
  // Antenna
  var aw=Math.sin(t*2.5)*4+S.keystrokeImpact*Math.sin(t*20)*6;
  c.save();c.strokeStyle=_snRgb(col,lt?.7:.5);c.lineWidth=4;c.lineCap='round';
  c.beginPath();c.moveTo(ox,oy-headR+10);c.quadraticCurveTo(ox+aw,oy-headR-25,ox+aw*.5,oy-headR-45);c.stroke();
  var tx=ox+aw*.5,ty=oy-headR-45,tr=7+Math.sin(t*3)*2;
  var tG=c.createRadialGradient(tx,ty,0,tx,ty,tr*3);tG.addColorStop(0,_snRgb(col,.8));tG.addColorStop(.5,_snRgb(col,.2));tG.addColorStop(1,_snRgb(col,0));
  c.fillStyle=tG;c.beginPath();c.arc(tx,ty,tr*3,0,Math.PI*2);c.fill();
  c.fillStyle=_snRgb(col);c.beginPath();c.arc(tx,ty,tr,0,Math.PI*2);c.fill();c.restore();
  // Head
  var hG=c.createRadialGradient(ox-30,oy-40,0,ox,oy,headR);
  if(lt){hG.addColorStop(0,'#2a3660');hG.addColorStop(1,'#171e38')}
  else{hG.addColorStop(0,'#2e3a5c');hG.addColorStop(1,'#1a2240')}
  c.fillStyle=hG;c.beginPath();c.ellipse(ox,oy,headR,headR*.95,0,0,Math.PI*2);c.fill();
  // Highlight (specular)
  var hlG=c.createRadialGradient(ox-40,oy-50,0,ox-40,oy-50,headR*.8);hlG.addColorStop(0,'rgba(255,255,255,.1)');hlG.addColorStop(1,'rgba(255,255,255,0)');
  c.fillStyle=hlG;c.beginPath();c.ellipse(ox,oy,headR,headR*.95,0,0,Math.PI*2);c.fill();
  // Head outline ‚Äî bright accent border
  c.strokeStyle=_snRgb(col,.5);c.lineWidth=3;c.beginPath();c.ellipse(ox,oy,headR,headR*.95,0,0,Math.PI*2);c.stroke();
  // Panel lines (robot detail)
  c.save();c.strokeStyle=lt?'rgba(255,255,255,.06)':'rgba(255,255,255,.05)';c.lineWidth=1.5;
  c.beginPath();c.moveTo(ox-headR*.6,oy-headR*.55);c.quadraticCurveTo(ox,oy-headR*.7,ox+headR*.6,oy-headR*.55);c.stroke();
  c.beginPath();c.moveTo(ox,oy-headR*.65);c.lineTo(ox,oy-headR*.95);c.stroke();
  // Side vents
  [-1,1].forEach(function(side){
    for(var i=0;i<3;i++){
      c.beginPath();c.moveTo(ox+side*(headR*.7),oy+30+i*10);c.lineTo(ox+side*(headR*.85),oy+30+i*10);c.stroke();
    }
  });
  c.restore();
  // Inner edge shading (rim)
  var rimG=c.createRadialGradient(ox,oy,headR*.75,ox,oy,headR);
  rimG.addColorStop(0,'rgba(0,0,0,0)');rimG.addColorStop(1,lt?'rgba(0,0,0,.12)':'rgba(0,0,0,.15)');
  c.fillStyle=rimG;c.beginPath();c.ellipse(ox,oy,headR,headR*.95,0,0,Math.PI*2);c.fill();
  // Brightness multiplier: both themes have dark heads, features must be bright
  var B=1.6;
  function _a(v){return Math.min(v*B,1)}
  // Cheeks
  var cA=S.state==='success'?.25:S.state==='listening'?.2:S.state==='reading'?.15:.08;
  [-1,1].forEach(function(side){
    var cG=c.createRadialGradient(ox+side*105,oy+35,0,ox+side*105,oy+35,30);cG.addColorStop(0,_snRgb(col,_a(cA)));cG.addColorStop(1,_snRgb(col,0));
    c.fillStyle=cG;c.beginPath();c.ellipse(ox+side*105,oy+35,30,22,0,0,Math.PI*2);c.fill();
  });
  // Eyes
  var eS=55,eY=oy-15;
  [-1,1].forEach(function(side){
    var ex=ox+side*eS+S.eyeX,ey=eY+S.eyeY;
    var sW=S.state==='listening'?52:S.state==='reading'?48:46;
    var sH=S.state==='listening'?52:S.state==='reading'?44:46;
    c.fillStyle='rgba(0,8,24,.45)';c.beginPath();c.ellipse(ex,ey,sW,sH*S.blinkOpen,0,0,Math.PI*2);c.fill();
    if(S.blinkOpen>.15){
      var iR=S.state==='listening'?28:S.state==='alert'?22:S.state==='reading'?22:24;
      var iG=c.createRadialGradient(ex,ey,0,ex,ey,iR*2.2);iG.addColorStop(0,_snRgb(col,_a(.5)));iG.addColorStop(1,_snRgb(col,0));
      c.fillStyle=iG;c.beginPath();c.arc(ex,ey,iR*2.2,0,Math.PI*2);c.fill();
      c.fillStyle=_snRgb(col);c.beginPath();c.arc(ex,ey,iR,0,Math.PI*2);c.fill();
      var inG=c.createRadialGradient(ex,ey,iR*.2,ex,ey,iR);inG.addColorStop(0,'rgba('+Math.round(col.r*.3)+','+Math.round(col.g*.3)+','+Math.round(col.b*.3)+',.5)');inG.addColorStop(1,'rgba(0,0,0,0)');
      c.fillStyle=inG;c.beginPath();c.arc(ex,ey,iR,0,Math.PI*2);c.fill();
      var pR=S.state==='alert'?7:S.state==='reading'?6:S.state==='listening'?10:8;
      c.fillStyle='#050810';c.beginPath();c.arc(ex+S.eyeX*.3,ey+S.eyeY*.3,pR,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(255,255,255,.9)';c.beginPath();c.arc(ex+8,ey-8,6,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(255,255,255,.6)';c.beginPath();c.arc(ex-5,ey+6,3,0,Math.PI*2);c.fill();
    }
    if(S.blinkOpen<.3){
      c.strokeStyle=_snRgb(col,_a(.6));c.lineWidth=4;c.lineCap='round';c.beginPath();
      if(S.state==='success')c.arc(ex,ey+5,22,Math.PI,0);else{c.moveTo(ex-22,ey);c.lineTo(ex+22,ey)}c.stroke();
    }
  });
  // Eyebrows
  if(S.state==='alert'){c.strokeStyle=_snRgb(col,_a(.8));c.lineWidth=5;c.lineCap='round';[-1,1].forEach(function(side){var bx=ox+side*eS,by=eY-48;c.beginPath();c.moveTo(bx-side*22,by+6);c.lineTo(bx+side*22,by-4);c.stroke()})}
  if(S.state==='thinking'){c.strokeStyle=_snRgb(col,_a(.5));c.lineWidth=4;c.lineCap='round';var lbx=ox-eS,rbx=ox+eS,by=eY-48;c.beginPath();c.moveTo(lbx-22,by+4);c.lineTo(lbx+22,by-8);c.stroke();c.beginPath();c.moveTo(rbx-22,by-2);c.lineTo(rbx+22,by+2);c.stroke()}
  if(S.state==='reading'){c.strokeStyle=_snRgb(col,_a(.5));c.lineWidth=4;c.lineCap='round';[-1,1].forEach(function(side){var bx=ox+side*eS,by=eY-46;c.beginPath();c.moveTo(bx-20,by+2);c.quadraticCurveTo(bx,by-5,bx+20,by+1);c.stroke()})}
  // Mouth
  var mY=oy+55;
  if(S.state==='success'){c.strokeStyle=_snRgb(col,_a(.9));c.lineWidth=4;c.lineCap='round';c.beginPath();c.arc(ox,mY-10,35,.15,Math.PI-.15);c.stroke();if(S.mouthOpen>.4){c.fillStyle='#ff8ba7';c.beginPath();c.ellipse(ox,mY+4,14,8*S.mouthOpen,0,0,Math.PI);c.fill()}}
  else if(S.state==='alert'){c.strokeStyle=_snRgb(col,_a(.7));c.lineWidth=3.5;c.lineCap='round';c.beginPath();c.moveTo(ox-18,mY);c.lineTo(ox+18,mY);c.stroke()}
  else if(S.state==='listening'){c.fillStyle='rgba(0,8,24,.35)';c.beginPath();c.ellipse(ox,mY,16,12+S.mouthOpen*14,0,0,Math.PI*2);c.fill();c.strokeStyle=_snRgb(col,_a(.5));c.lineWidth=2;c.beginPath();c.ellipse(ox,mY,16,12+S.mouthOpen*14,0,0,Math.PI*2);c.stroke()}
  else if(S.state==='thinking'){c.strokeStyle=_snRgb(col,_a(.6));c.lineWidth=3.5;c.lineCap='round';var mW=Math.sin(t*1.5)*3;c.beginPath();c.moveTo(ox-15,mY+mW);c.quadraticCurveTo(ox,mY-8+mW,ox+20,mY+2+mW);c.stroke()}
  else if(S.state==='reading'){c.strokeStyle=_snRgb(col,_a(.6));c.lineWidth=3;c.lineCap='round';var mP=S.keystrokeImpact*2;c.beginPath();c.moveTo(ox-14,mY-1);c.quadraticCurveTo(ox,mY+5+mP,ox+14,mY-1);c.stroke()}
  else if(S.state==='sleeping'){c.strokeStyle=_snRgb(col,_a(.3));c.lineWidth=2.5;c.lineCap='round';c.beginPath();c.arc(ox,mY+4,12,.3,Math.PI-.3);c.stroke()}
  else{c.strokeStyle=_snRgb(col,_a(.7));c.lineWidth=3.5;c.lineCap='round';c.beginPath();c.arc(ox,mY-6,26,.25,Math.PI-.25);c.stroke()}
  // Reading text lines
  if(S.state==='reading'){var lY=oy+100,lW=[50,65,40,55,35],cur=Math.floor((Math.sin(t*1.8)+1)/2*4.99);lW.forEach(function(w,i){c.fillStyle=_snRgb(col,_a(i===cur?.4:.1));c.beginPath();c.roundRect?c.roundRect(ox-35,lY+i*10,w,4,2):(c.rect(ox-35,lY+i*10,w,4));c.fill()});if(Math.sin(t*6)>0){c.fillStyle=_snRgb(col,_a(.7));c.fillRect(ox-35+lW[cur]+3,lY+cur*10-1,2,6)}}
  // Thinking bubbles
  if(S.state==='thinking'){[{x:95,y:-80,r:6+Math.sin(t*2)*1},{x:115,y:-105,r:9+Math.sin(t*2+1)*1.5},{x:130,y:-135,r:13+Math.sin(t*2+2)*2}].forEach(function(b,i){c.fillStyle=_snRgb(col,_a(.15+i*.1+Math.sin(t*1.5+i)*.05));c.beginPath();c.arc(ox+b.x,oy+b.y+Math.sin(t+i)*4,b.r,0,Math.PI*2);c.fill()})}
  // Alert ring
  if(S.state==='alert'){var ap=(Math.sin(t*4)+1)/2;c.strokeStyle=_snRgb(col,_a(.1+ap*.15));c.lineWidth=3;c.setLineDash([8,8]);c.lineDashOffset=-t*40;c.beginPath();c.ellipse(ox,oy,headR+15,headR*.95+15,0,0,Math.PI*2);c.stroke();c.setLineDash([]);var bdX=ox+110,bdY=oy-100;c.fillStyle=_snRgb(col,_a(.9));c.beginPath();c.arc(bdX,bdY,18,0,Math.PI*2);c.fill();c.fillStyle='#fff';c.font='bold 22px sans-serif';c.textAlign='center';c.textBaseline='middle';c.fillText('!',bdX,bdY+1)}
  // Listening waves
  if(S.state==='listening'){for(var i=0;i<12;i++){var h=8+Math.abs(Math.sin(t*5+i*.8))*22,a=_a(.4+Math.abs(Math.sin(t*5+i*.8))*.5);c.fillStyle=_snRgb(col,a);var bx=ox-60+i*10;c.beginPath();c.roundRect?c.roundRect(bx,oy+105-h/2,6,h,3):(c.fillRect(bx,oy+105-h/2,6,h));c.fill()}}
  // Sleeping Zzz
  if(S.state==='sleeping'){c.textAlign='center';[{x:85,y:-60,s:18,d:0},{x:105,y:-90,s:24,d:.6},{x:120,y:-125,s:30,d:1.2}].forEach(function(z,i){var t2=(t*.7+z.d)%3,a=_a(t2<2?Math.sin(t2/2*Math.PI)*.5:0),dr=Math.sin(t*.5+i)*5;c.fillStyle=_snRgb(col,a);c.font='800 '+z.s+'px sans-serif';c.fillText('z',ox+z.x+dr,oy+z.y-t2*8)})}
  // Success sparkles
  if(S.state==='success'){for(var i=0;i<6;i++){var ang=(Math.PI*2/6)*i+t*.5,dist=headR+25+Math.sin(t*2+i)*10,sx=ox+Math.cos(ang)*dist,sy=oy+Math.sin(ang)*dist*.85,sa2=_a(.3+Math.sin(t*3+i*1.5)*.3),sr=3+Math.sin(t*4+i)*2;c.fillStyle=_snRgb(col,sa2);c.beginPath();for(var j=0;j<4;j++){var sa=(Math.PI/2)*j+t*2,sr2=j%2===0?sr*2.5:sr*.5,px=sx+Math.cos(sa)*sr2,py=sy+Math.sin(sa)*sr2;j===0?c.moveTo(px,py):c.lineTo(px,py)}c.closePath();c.fill()}}
}

// Animation tick
function _snTick(){
  var S=_sn;S.time+=.016;S.emotionT=Math.min(S.emotionT+.016,10);
  _snLerpC(S.color,S.tColor,.06);
  // Eye behavior per state
  if(S.state==='reading'){var rs=1.8+Math.sin(S.time*.3)*.3;S.eyeX=_snLerp(S.eyeX,Math.sin(S.time*rs)*16,.12);S.eyeY=_snLerp(S.eyeY,10+Math.sin(S.time*.6)*2,.08);S.readingNod=Math.sin(S.time*1.2)*.03}
  else if(S.state==='thinking'){S.eyeX=_snLerp(S.eyeX,Math.sin(S.time*.7)*14,.04);S.eyeY=_snLerp(S.eyeY,-10+Math.cos(S.time*.5)*4,.04);S.readingNod=_snLerp(S.readingNod,0,.05)}
  else if(S.state==='idle'||S.state==='alert'||S.state==='success'){S.eyeX=_snLerp(S.eyeX,S.targetEyeX*12,.08);S.eyeY=_snLerp(S.eyeY,S.targetEyeY*8,.08);S.readingNod=_snLerp(S.readingNod,0,.05)}
  else{S.eyeX=_snLerp(S.eyeX,0,.05);S.eyeY=_snLerp(S.eyeY,0,.05);S.readingNod=_snLerp(S.readingNod,0,.05)}
  S.keystrokeImpact=_snLerp(S.keystrokeImpact,0,.15);
  S.squishX=_snLerp(S.squishX,S.tSquishX,.12);S.squishY=_snLerp(S.squishY,S.tSquishY,.12);
  S.bounceY=_snLerp(S.bounceY,0,.08);
  // Blink
  S.blinkTimer+=.016;
  if(S.state==='sleeping')S.blinkOpen=_snLerp(S.blinkOpen,0,.1);
  else if(S.state==='success')S.blinkOpen=_snLerp(S.blinkOpen,.35,.1);
  else if(S.state==='reading'){if(S.blinkTimer>6+Math.random()*3){S.blinkTimer=0;S.blinkOpen=0}if(S.blinkOpen<.5)S.blinkOpen=_snLerp(S.blinkOpen,1,.3)}
  else{if(S.blinkTimer>3+Math.random()*2){S.blinkTimer=0;S.blinkOpen=0}if(S.blinkOpen<.5)S.blinkOpen=_snLerp(S.blinkOpen,1,.25)}
  // Mouth
  if(S.state==='listening')S.tMouthOpen=.3+Math.abs(Math.sin(S.time*6))*.5;
  else if(S.state==='success')S.tMouthOpen=.7;
  else if(S.state==='alert')S.tMouthOpen=.15;
  else if(S.state==='reading')S.tMouthOpen=.05+S.keystrokeImpact*.15;
  else S.tMouthOpen=0;
  S.mouthOpen=_snLerp(S.mouthOpen,S.tMouthOpen,.1);
}

// Draw on multiple canvases
function _snDraw(){
  _snTick();
  var S=_sn,fY=Math.sin(S.time*.8)*6;
  // Header mini canvas ‚Äî full Sanek with antenna
  var mc=$('snMiniCanvas');
  if(mc&&mc.offsetParent!==null){var ctx2=mc.getContext('2d');ctx2.clearRect(0,0,320,320);ctx2.save();ctx2.translate(160,172);ctx2.scale(.45,.45);_snDrawBody(ctx2,0,0,.45);ctx2.restore()}
  // Button canvas ‚Äî clean, no glow bleed
  var bc=$('snBtnCanvas');
  if(bc){var ctx3=bc.getContext('2d');ctx3.clearRect(0,0,192,192);ctx3.save();ctx3.beginPath();ctx3.arc(96,96,95,0,Math.PI*2);ctx3.clip();ctx3.translate(96,104+fY*.3);ctx3.scale(.32,.32);_snDrawBody(ctx3,0,0,.32);ctx3.restore()}
  requestAnimationFrame(_snDraw);
}

// Mouse tracking for eyes
document.addEventListener('mousemove',function(e){
  var btn=$('sanekBtn');if(!btn)return;
  var r=btn.getBoundingClientRect(),cx=r.left+r.width/2,cy=r.top+r.height/2;
  _sn.targetEyeX=Math.max(-1,Math.min(1,(e.clientX-cx)/300*2));
  _sn.targetEyeY=Math.max(-1,Math.min(1,(e.clientY-cy)/300*2));
});

// Start avatar loop
_snUpdateThemeColors();
_snDraw();

// === CHAT LOGIC ===
function toggleSanek(){
  _snOpen=!_snOpen;
  $('sanekPanel').classList.toggle('open',_snOpen);
  $('sanekBtn').style.display=_snOpen?'none':'';
  if(_snOpen){$('sanekInput').focus();_snUpdateCtxBadge()}
  if(!_snOpen&&_snHistOpen)_snToggleHistory();
}

function sanekNewSession(){
  _snSid=null;_snMsgCount=0;_snUpdateCounter();snSetState('idle');
  if(_snHistOpen)_snToggleHistory();
  $('sanekMessages').innerHTML='<div class="sn-welcome"><div class="sn-welcome-line"></div><h3>–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</h3><p>–°–ø—Ä–æ—Å–∏ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∞–≤–∞—Ä–∏—è—Ö,<br>–¢–û –∏–ª–∏ –¥–∞–π –∫–æ–º–∞–Ω–¥—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</p><div class="sn-hints"><button class="sn-hint" onclick="sanekHint(this)">üìä –ö–∞–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –µ—Å—Ç—å?</button><button class="sn-hint" onclick="sanekHint(this)">‚ö° –ü–æ–∫–∞–∂–∏ —Ç–µ–∫—É—â—É—é –º–æ—â–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤</button><button class="sn-hint" onclick="sanekHint(this)">üö® –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≤–∞—Ä–∏–∏?</button><button class="sn-hint" onclick="sanekHint(this)">üìã –î–∞–π –æ–±—â—É—é —Å–≤–æ–¥–∫—É –ø–æ —Å–∏—Å—Ç–µ–º–µ</button></div></div>';
  _snUpdateCtxBadge();
}

function sanekHint(el){
  $('sanekInput').value=el.textContent.trim();
  sendToSanek();
}

// Typing detection ‚Äî switches avatar to reading state
// NOTE: attached via setTimeout(0) because sanekInput is below this script in DOM
var _snTypingTimeout=null;
function _snInitTypingDetection(){
  var inp=$('sanekInput');
  if(!inp)return;
  inp.addEventListener('input',function(){
    _sn.keystrokeImpact=1;
    if(inp.value.length>0&&_sn.state!=='thinking'){snSetState('reading')}
    clearTimeout(_snTypingTimeout);
    _snTypingTimeout=setTimeout(function(){if(_sn.state==='reading'&&!inp.value.length)snSetState('idle')},2000);
  });
  inp.addEventListener('focus',function(){if(inp.value.length>0&&_sn.state==='idle')snSetState('reading')});
  inp.addEventListener('blur',function(){if(_sn.state==='reading')setTimeout(function(){if(_sn.state==='reading')snSetState('idle')},500)});
}
// _snInitTypingDetection() called from <script> after sanekInput in DOM

function _snAddMsg(role,text){
  var msgs=$('sanekMessages');
  var welcome=msgs.querySelector('.sn-welcome');
  if(welcome)welcome.remove();
  var div=document.createElement('div');
  div.className='sn-msg '+role;
  if(role==='error'){
    div.innerHTML='<div class="sn-bname">–°–∞–Ω—ë–∫</div>'+_snFormatText(text);
  } else if(role==='assistant'){
    div.innerHTML='<div class="sn-bname">–°–∞–Ω—ë–∫</div>'+_snFormatText(text);
  } else {
    div.textContent=text;
  }
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
  return div;
}

function _snFormatText(text){
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
    .replace(/`(.+?)`/g,'<code style="background:rgba(0,0,0,.3);padding:1px 5px;border-radius:4px;font-size:12px;font-family:Space Mono,monospace">$1</code>')
    .replace(/\n/g,'<br>');
}

function _snShowTyping(){
  var msgs=$('sanekMessages');
  var div=document.createElement('div');
  div.className='sn-typing';div.id='snTyping';
  div.innerHTML='<span></span><span></span><span></span>';
  msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;
}
function _snHideTyping(){var t=$('snTyping');if(t)t.remove()}

function _snShowActions(actions){
  if(!actions||!actions.length)return;
  var msgs=$('sanekMessages'),wrap=document.createElement('div');
  wrap.style.cssText='display:flex;flex-wrap:wrap;gap:4px;padding:0 4px;align-self:flex-start';
  actions.forEach(function(a){var badge=document.createElement('span');badge.className='sn-action';badge.textContent='‚úÖ '+a.tool;wrap.appendChild(badge)});
  msgs.appendChild(wrap);msgs.scrollTop=msgs.scrollHeight;
}

function _snShowPending(pending){
  if(!pending)return;
  var msgs=$('sanekMessages'),div=document.createElement('div');
  div.className='sn-pending';
  div.innerHTML='<div style="font-size:13px;line-height:1.5">'+_snFormatText(pending.description)+'</div><div class="sn-pending-btns"><button class="sn-yes" onclick="sanekConfirm(true)">‚úÖ –î–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç—å</button><button class="sn-no" onclick="sanekConfirm(false)">‚ùå –û—Ç–º–µ–Ω–∞</button></div>';
  msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;
  snSetState('alert');
}

async function sanekConfirm(yes){
  document.querySelectorAll('.sn-pending').forEach(function(el){el.querySelectorAll('button').forEach(function(b){b.disabled=true})});
  var text=yes?'–î–∞':'–ù–µ—Ç';
  _snAddMsg('user',text);
  await _snSendMessage(text);
}

async function sendToSanek(){
  var input=$('sanekInput'),text=input.value.trim();
  if(!text||_snSending)return;
  input.value='';
  _snAddMsg('user',text);
  await _snSendMessage(text);
}

function _snIsErrorMsg(msg){
  if(!msg)return false;
  var prefixes=['‚ö†','üîë','‚è±','üåê','‚ö°','‚ùå','üîß','üìã'];
  return prefixes.some(function(p){return msg.startsWith(p)});
}

async function _snSendMessage(text){
  if(!_snHealthOk){
    _snAddMsg('error','‚ö† '+_snHealthError+'\n\n–û—Ç–∫—Ä–æ–π—Ç–µ ¬´ü§ñ AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä¬ª –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.');
    snSetState('alert');
    return;
  }
  _snSending=true;$('sanekSendBtn').disabled=true;
  snSetState('thinking');
  _snShowTyping();

  try{
    var body={message:text};
    if(_snSid)body.session_id=_snSid;
    var ctx=_snGetContext();
    if(ctx.site)body.context={site:ctx.site,site_name:ctx.siteName,view:ctx.view};
    _snMsgCount++;_snUpdateCounter();
    var r=await api.post('/api/ai/chat',body);
    _snHideTyping();
    if(r.session_id)_snSid=r.session_id;
    _snMsgCount++;_snUpdateCounter();
    if(r.actions&&r.actions.length)_snShowActions(r.actions);
    if(r.message){
      // Detect error messages from backend by their emoji prefixes
      if(_snIsErrorMsg(r.message)){
        _snAddMsg('error',r.message);
        snSetState('alert');setTimeout(function(){if(_sn.state==='alert')snSetState('idle')},5000);
      } else {
        _snAddMsg('assistant',r.message);
        if(r.pending_action){_snShowPending(r.pending_action)}
        else{snSetState('success');setTimeout(function(){if(_sn.state==='success')snSetState('idle')},2500)}
      }
    } else if(r.pending_action){
      _snShowPending(r.pending_action);
    } else {
      _snAddMsg('error','‚ùå –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.\n\n–í–æ–∑–º–æ–∂–Ω–æ, AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –±—ç–∫–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ—à–∏–±–∫–∞–º–∏.');
      snSetState('alert');setTimeout(function(){if(_sn.state==='alert')snSetState('idle')},5000);
    }
  }catch(e){
    _snHideTyping();
    var em=e.message||'';
    var msg;
    if(em.includes('404'))
      msg='‚ùå –≠–Ω–¥–ø–æ–∏–Ω—Ç —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω (404).\n\n–ë—ç–∫–µ–Ω–¥ –°–ö–ê–î–ê —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.';
    else if(em.includes('Failed to fetch')||em.includes(': 0'))
      msg='‚ùå –°–µ—Ä–≤–µ—Ä –°–ö–ê–î–ê –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å–µ—Ç–∏.';
    else if(em.includes('500'))
      msg='‚ùå –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞: docker logs scada-backend';
    else if(em.includes('502')||em.includes('503'))
      msg='‚ùå –°–µ—Ä–≤–µ—Ä –°–ö–ê–î–ê –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è).\n\n–ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.';
    else
      msg='‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.\n\n'+(em?'–î–µ—Ç–∞–ª–∏: '+em:'–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±—ç–∫–µ–Ω–¥–∞.');
    _snAddMsg('error',msg);
    snSetState('alert');setTimeout(function(){if(_sn.state==='alert')snSetState('idle')},5000);
  }finally{
    _snSending=false;$('sanekSendBtn').disabled=false;
  }
}

// === MESSAGE COUNTER ===
function _snUpdateCounter(){
  var el=$('snMsgCounter');if(!el)return;
  if(_snMsgCount<1){el.classList.remove('vis','warn','crit');return}
  el.textContent=_snMsgCount+' —Å–±—â';
  el.classList.add('vis');
  el.classList.toggle('warn',_snMsgCount>=30&&_snMsgCount<45);
  el.classList.toggle('crit',_snMsgCount>=45);
}

// === PAGE CONTEXT BADGE ===
function _snGetContext(){
  var ctx={site:null,siteName:null,view:null};
  if(typeof cur!=='undefined'&&cur&&typeof S!=='undefined'&&S[cur]){
    ctx.site=cur;ctx.siteName=S[cur].name;
  }
  if(typeof curView!=='undefined'&&curView){ctx.view=curView}
  return ctx;
}

function _snUpdateCtxBadge(){
  var el=$('snCtxBadge');if(!el)return;
  var ctx=_snGetContext();
  if(!ctx.siteName){el.style.display='none';return}
  var viewLabel={'monitoring':'–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥','alarms':'–ê–≤–∞—Ä–∏–∏','archive':'–ê—Ä—Ö–∏–≤','to':'–¢–û'}[ctx.view]||'';
  el.textContent=ctx.siteName+(viewLabel?' ¬∑ '+viewLabel:'');
  el.style.display='inline-block';
}

// === HISTORY PANEL ===
function _snToggleHistory(){
  _snHistOpen=!_snHistOpen;
  var panel=$('snHistPanel'),btn=$('snHistBtn');
  if(panel)panel.classList.toggle('open',_snHistOpen);
  if(btn)btn.classList.toggle('active',_snHistOpen);
  if(_snHistOpen)_snLoadSessions();
}

async function _snLoadSessions(){
  var list=$('snHistList');if(!list)return;
  list.innerHTML='<div class="sn-hist-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{
    var r=await api.get('/api/ai/chat/sessions?limit=30');
    if(!r.sessions||!r.sessions.length){
      list.innerHTML='<div class="sn-hist-empty">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤</div>';
      return;
    }
    var html='';
    for(var i=0;i<r.sessions.length;i++){
      var s=r.sessions[i];
      var isActive=_snSid&&s.session_id===_snSid;
      var dt=s.last_at?_snFmtDate(s.last_at):'';
      var preview=s.first_message||('–°–µ—Å—Å–∏—è '+s.session_id);
      html+='<div class="sn-hist-item'+(isActive?' active':'')+'" onclick="_snLoadSession(\''+s.session_id+'\')">'
        +'<div class="sn-hi-icon">'+(isActive?'üí¨':'üó®')+'</div>'
        +'<div class="sn-hi-body">'
        +'<div class="sn-hi-title">'+_snEsc(preview)+'</div>'
        +'<div class="sn-hi-meta"><span>'+dt+'</span><span>'+s.message_count+' —Å–±—â</span></div>'
        +'</div>'
        +'<button class="sn-hi-del" onclick="event.stopPropagation();_snDeleteSession(\''+s.session_id+'\')" title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">üóë</button>'
        +'</div>';
    }
    list.innerHTML=html;
  }catch(e){
    list.innerHTML='<div class="sn-hist-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+(e.message||'')+'</div>';
  }
}

function _snFmtDate(iso){
  try{
    var d=new Date(iso);
    var now=new Date();
    var hh=String(d.getHours()).padStart(2,'0');
    var mm=String(d.getMinutes()).padStart(2,'0');
    var isToday=d.toDateString()===now.toDateString();
    if(isToday)return '–°–µ–≥–æ–¥–Ω—è '+hh+':'+mm;
    var yesterday=new Date(now);yesterday.setDate(yesterday.getDate()-1);
    if(d.toDateString()===yesterday.toDateString())return '–í—á–µ—Ä–∞ '+hh+':'+mm;
    var dd=String(d.getDate()).padStart(2,'0');
    var mo=String(d.getMonth()+1).padStart(2,'0');
    return dd+'.'+mo+' '+hh+':'+mm;
  }catch(e){return iso}
}

function _snEsc(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

async function _snLoadSession(sid){
  if(sid===_snSid){_snToggleHistory();return}
  _snSid=sid;_snMsgCount=0;
  if(_snHistOpen)_snToggleHistory();
  var msgs=$('sanekMessages');
  var welcome=msgs.querySelector('.sn-welcome');if(welcome)welcome.remove();
  msgs.innerHTML='<div class="sn-hist-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';
  snSetState('thinking');
  try{
    var r=await api.get('/api/ai/chat/history?session_id='+sid+'&limit=100');
    msgs.innerHTML='';
    if(r.messages&&r.messages.length){
      for(var i=0;i<r.messages.length;i++){
        var m=r.messages[i];
        if(m.role==='user'||m.role==='assistant'||m.role==='error'){
          _snAddMsg(m.role==='error'?'error':m.role,m.content);
          _snMsgCount++;
        }
      }
    }else{
      msgs.innerHTML='<div class="sn-hist-empty">–ü—É—Å—Ç–∞—è —Å–µ—Å—Å–∏—è</div>';
    }
    _snUpdateCounter();
    snSetState('idle');
  }catch(e){
    msgs.innerHTML='';
    _snAddMsg('error','–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: '+(e.message||''));
    snSetState('alert');
  }
}

async function _snDeleteSession(sid){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?'))return;
  try{
    await api.del('/api/ai/chat/sessions/'+sid);
    // If deleted session is current ‚Äî reset to new chat
    if(_snSid===sid)sanekNewSession();
    _snLoadSessions();
  }catch(e){
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+(e.message||''));
  }
}

// === HEALTH CHECK ‚Äî –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ ===
var _snHealthOk=true,_snHealthError='',_snHealthTipOpen=false;

function _snShowHealthDetail(){
  var row=$('snStatusRow');if(!row)return;
  // –ó–∞–∫—Ä—ã—Ç—å –µ—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç
  var existing=row.querySelector('.sn-health-tip');
  if(existing){existing.remove();_snHealthTipOpen=false;return}
  if(_snHealthOk)return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –µ—Å–ª–∏ –≤—Å—ë –æ–∫
  var tip=document.createElement('div');
  tip.className='sn-health-tip';
  tip.innerHTML='<button class="sn-tip-close" onclick="event.stopPropagation();this.parentElement.remove()">&times;</button>'
    +'<b>‚ö† –ü—Ä–æ–±–ª–µ–º–∞:</b> '+(_snHealthError||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
    +'<br><br>–û—Ç–∫—Ä–æ–π—Ç–µ <b>¬´ü§ñ AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä¬ª</b> –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é, –¥–æ–±–∞–≤—å—Ç–µ API-–∫–ª—é—á –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.';
  row.appendChild(tip);
  _snHealthTipOpen=true;
  // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫
  setTimeout(function(){if(tip.parentElement)tip.remove();_snHealthTipOpen=false},10000);
}

async function _snHealthCheck(){
  if(_snSending)return;
  try{
    var r=await api.get('/api/ai/health');
    if(r.available){
      _snHealthOk=true;_snHealthError='';
      if(_sn.state==='alert'||_sn.state==='sleeping')snSetState('idle');
    }else{
      _snHealthOk=false;
      _snHealthError=r.error||'AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
      if(_sn.state==='idle'||_sn.state==='sleeping')snSetState('alert');
    }
  }catch(e){
    _snHealthOk=false;
    _snHealthError='–°–µ—Ä–≤–µ—Ä –°–ö–ê–î–ê –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    if(_sn.state==='idle'||_sn.state==='sleeping')snSetState('alert');
  }
}

setTimeout(_snHealthCheck,2000);
setInterval(_snHealthCheck,30000);
setTimeout(_snUpdateCtxBadge,500);
</script>
<script src="/alarm_modal.js"></script>
<!-- Power Limit Modal -->
<div class="mbg" id="plModal" onclick="if(event.target===this)closePowerLimitModal()">
<div class="mod" style="max-width:460px">
<div class="mhd"><h3 id="plTitle">‚ö° –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏</h3><button class="mx" onclick="closePowerLimitModal()">&times;</button></div>
<div class="mbd">
<div style="display:flex;gap:12px;margin-bottom:12px">
<div style="flex:1;padding:8px 10px;background:var(--bg);border:1px solid var(--bd);border-radius:6px;text-align:center"><div style="font-size:9px;color:var(--t3);margin-bottom:2px">–¢–µ–∫—É—â–∞—è P</div><div style="font-family:var(--m);font-size:16px;font-weight:600;color:var(--g)" id="plLiveP">‚Äî</div></div>
<div style="flex:1;padding:8px 10px;background:var(--bg);border:1px solid var(--bd);border-radius:6px;text-align:center"><div style="font-size:9px;color:var(--t3);margin-bottom:2px">–¢–µ–∫—É—â–∞—è Q</div><div style="font-family:var(--m);font-size:16px;font-weight:600;color:var(--b)" id="plLiveQ">‚Äî</div></div>
</div>
<div class="slider-group">
<div class="slider-row"><span class="slider-label">P%</span><input type="range" id="plSliderP" min="0" max="100" step="1" value="75" oninput="plSliderUpdate('P')"><span class="slider-val" id="plNumP">75.0%</span></div>
<div class="slider-row"><span class="slider-label">Q%</span><input type="range" id="plSliderQ" min="0" max="100" step="1" value="50" oninput="plSliderUpdate('Q')"><span class="slider-val" id="plNumQ">50.0%</span></div>
</div>
<div id="plLoadModeWrap" style="display:none;margin-bottom:10px;padding:8px 10px;background:var(--ov);border:1px solid var(--bd);border-radius:6px">
<div style="font-size:10px;color:var(--t3);margin-bottom:6px;font-weight:600">Load Mode (–®–ü–†)</div>
<div style="display:flex;gap:6px">
<label style="flex:1;display:flex;align-items:center;gap:4px;font-size:11px;color:var(--t2);cursor:pointer"><input type="radio" name="plMode" value="0" style="accent-color:var(--g)"> Gen Control</label>
<label style="flex:1;display:flex;align-items:center;gap:4px;font-size:11px;color:var(--t2);cursor:pointer"><input type="radio" name="plMode" value="1" style="accent-color:var(--b)"> Mains Control</label>
<label style="flex:1;display:flex;align-items:center;gap:4px;font-size:11px;color:var(--t2);cursor:pointer"><input type="radio" name="plMode" value="2" style="accent-color:var(--y)"> Load Reception</label>
</div>
</div>
<div style="font-size:10px;color:var(--t3);margin-bottom:6px;font-weight:600">–ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã</div>
<div class="preset-grid" style="margin-bottom:10px">
<button class="preset-btn" onclick="plQuickP(100,100)"><div class="preset-name">–ú–∞–∫—Å–∏–º—É–º</div><div class="preset-desc">P:100 Q:100</div></button>
<button class="preset-btn" onclick="plQuickP(75,50)"><div class="preset-name">75% –Ω–∞–≥—Ä.</div><div class="preset-desc">P:75 Q:50</div></button>
<button class="preset-btn" onclick="plQuickP(50,50)"><div class="preset-name">50/50</div><div class="preset-desc">P:50 Q:50</div></button>
<button class="preset-btn" onclick="plQuickP(10,10)"><div class="preset-name">–ú–∏–Ω–∏–º—É–º</div><div class="preset-desc">P:10 Q:10</div></button>
</div>
<div style="padding:8px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;margin-bottom:12px;font-size:10px;color:var(--y)">‚ö† –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏!</div>
<div id="plStatus"></div>
<div style="display:flex;gap:8px;margin-top:10px">
<button class="bs2" style="flex:1;padding:10px" onclick="closePowerLimitModal()">–û—Ç–º–µ–Ω–∞</button>
<button class="bp" style="flex:2" onclick="savePowerLimit()">‚ö° –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</div>
</div>
</div>
</div>
<!-- Power Chart Modal -->
<div class="mbg" id="m-pwchart" onclick="if(event.target===this)hideM('pwchart')">
<div class="mod" style="max-width:800px;width:90vw">
<div class="mhd"><h3 id="pwChartTitle">üìä –ú–æ—â–Ω–æ—Å—Ç—å ‚Äî –ì—Ä–∞—Ñ–∏–∫</h3><button class="mx" onclick="hideM('pwchart')">‚úï</button></div>
<div class="mbd">
<div style="display:flex;gap:16px;margin-bottom:12px;flex-wrap:wrap;align-items:center" id="pwChkWrap">
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="pwChkBus" onchange="pwToggleMetric()" style="accent-color:#00e09a"><span style="color:#00e09a;font-size:12px;font-weight:600">P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–∫–í—Ç)</span></label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="pwChkMains" onchange="pwToggleMetric()" style="accent-color:#4090ff"><span style="color:#4090ff;font-size:12px;font-weight:600">P —Å–µ—Ç–∏ (–∫–í—Ç)</span></label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="pwChkLoad" onchange="pwToggleMetric()" style="accent-color:#ffb020"><span style="color:#ffb020;font-size:12px;font-weight:600">P –Ω–∞–≥—Ä—É–∑–∫–∏ (–∫–í—Ç)</span></label>
</div>
<div style="display:flex;gap:6px;margin-bottom:12px">
<button class="arc-tb on" onclick="pwRange(this,1)">1—á</button>
<button class="arc-tb" onclick="pwRange(this,6)">6—á</button>
<button class="arc-tb" onclick="pwRange(this,24)">24—á</button>
<button class="arc-tb" onclick="pwRange(this,168)">7–¥</button>
<button class="arc-tb" onclick="pwRange(this,720)">30–¥</button>
<span id="pwZoomLabel" class="zoom-lbl"></span>
</div>
<div style="position:relative;height:350px" id="pwChartWrap"><canvas id="pwCanvas"></canvas></div>
</div>
</div>
</div>
<!-- Sanek Chat Button -->
<button id="sanekBtn" onclick="toggleSanek()"><canvas id="snBtnCanvas" width="192" height="192"></canvas></button>
<!-- Sanek Chat Panel -->
<div id="sanekPanel">
<div class="sn-hd">
<canvas id="snMiniCanvas" width="320" height="320"></canvas>
<div style="flex:1">
<div class="sn-hd-info"><h3>–°–∞–Ω—ë–∫</h3> <span class="sn-counter" id="snMsgCounter"></span> <span class="sn-ctx-badge" id="snCtxBadge" style="display:none"></span></div>
<div class="sn-hd-status" id="snStatusRow" onclick="_snShowHealthDetail()" style="cursor:pointer" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π"><div class="sn-hd-dot" id="snStatusDot"></div> <span id="snStatusText">–≥–æ—Ç–æ–≤ ‚Äî –∂–¥—É –∫–æ–º–∞–Ω–¥—ã</span></div>
</div>
<button class="sn-hist-btn" id="snHistBtn" onclick="_snToggleHistory()" title="–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤">üìã</button>
<button onclick="sanekNewSession()" style="background:none;border:1.5px solid #232d4a;border-radius:10px;padding:5px 10px;color:#6b7a9e;cursor:pointer;font-size:11px;transition:all .2s" title="–ù–æ–≤—ã–π —á–∞—Ç">‚ú®</button>
<button onclick="toggleSanek()" style="background:none;border:none;color:#6b7a9e;cursor:pointer;font-size:20px;padding:4px 8px;transition:color .2s" onmouseover="this.style.color='#ff6b81'" onmouseout="this.style.color='#6b7a9e'">&times;</button>
</div>
<div class="sn-hist" id="snHistPanel">
<div class="sn-hist-hd"><span>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</span><button onclick="_snToggleHistory()">‚úï –∑–∞–∫—Ä—ã—Ç—å</button></div>
<div class="sn-hist-list" id="snHistList"><div class="sn-hist-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
</div>
<div class="sn-msgs" id="sanekMessages">
<div class="sn-welcome">
<div class="sn-welcome-line"></div>
<h3>–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</h3>
<p>–°–ø—Ä–æ—Å–∏ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∞–≤–∞—Ä–∏—è—Ö,<br>–¢–û –∏–ª–∏ –¥–∞–π –∫–æ–º–∞–Ω–¥—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</p>
<div class="sn-hints">
<button class="sn-hint" onclick="sanekHint(this)">üìä –ö–∞–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –µ—Å—Ç—å?</button>
<button class="sn-hint" onclick="sanekHint(this)">‚ö° –ü–æ–∫–∞–∂–∏ —Ç–µ–∫—É—â—É—é –º–æ—â–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤</button>
<button class="sn-hint" onclick="sanekHint(this)">üö® –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≤–∞—Ä–∏–∏?</button>
<button class="sn-hint" onclick="sanekHint(this)">üìã –î–∞–π –æ–±—â—É—é —Å–≤–æ–¥–∫—É –ø–æ —Å–∏—Å—Ç–µ–º–µ</button>
</div>
</div>
</div>
<div class="sn-input-row">
<input id="sanekInput" placeholder="–°–ø—Ä–æ—Å–∏ –°–∞–Ω—å–∫–∞..." onkeydown="if(event.key==='Enter'&&!event.shiftKey)sendToSanek()">
<button class="sn-send-btn" id="sanekSendBtn" onclick="sendToSanek()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
</div>
</div>
<script>_snInitTypingDetection();</script>
</body></html>
