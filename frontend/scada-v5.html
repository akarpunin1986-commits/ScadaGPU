<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>SCADA GPU v5.0</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23080c14'/%3E%3Cpath d='M17 4L8 18h6l-3 10 10-14h-6l3-10z' fill='%2300e09a' filter='url(%23g)'/%3E%3Cdefs%3E%3Cfilter id='g'%3E%3CfeDropShadow dx='0' dy='0' stdDeviation='1.5' flood-color='%2300e09a' flood-opacity='.6'/%3E%3C/filter%3E%3C/defs%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
--bg:#06090f;--bg2:#0a0f1a;--bg3:#0f1525;--bg4:#152035;--bg5:#1a2840;
--bd:#1a2640;--bd2:#2a4068;--bdh:#3a5888;
--t:#e8edf5;--t2:#94a3b8;--t3:#5a6a80;--t4:#384860;
--g:#00e09a;--gd:rgba(0,224,154,.08);--gb:rgba(0,224,154,.15);
--y:#ffb020;--yd:rgba(255,176,32,.08);
--r:#ff4060;--rd:rgba(255,64,96,.08);
--b:#4090ff;--bb:rgba(64,144,255,.1);
--p:#a070ff;--pd:rgba(160,112,255,.08);
--m:'JetBrains Mono',monospace;--u:'Outfit',sans-serif;
--rs:8px;--rad:12px
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--t);font-family:var(--u);height:100vh;overflow:hidden}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
.app{display:flex;height:100vh}
.sb{width:220px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0}
.sb-hd{padding:16px 14px 12px;border-bottom:1px solid var(--bd)}
.logo{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.logo svg{color:var(--g);filter:drop-shadow(0 0 6px rgba(0,224,154,.4))}.logo b{font-size:14px;letter-spacing:1px;font-weight:700}.logo span{font-size:10px;color:var(--t3);font-family:var(--m);margin-left:auto}
.sb-btn{display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--bg3);color:var(--t2);cursor:pointer;font-size:12px;font-family:var(--u);width:100%;text-align:left;transition:all .15s;margin-bottom:4px}
.sb-btn:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}
.sb-btn.primary{background:var(--g);color:#080c14;border-color:var(--g);font-weight:600}.sb-btn.primary:hover{background:#00c888}
.sb-sites{flex:1;overflow-y:auto;padding:8px}
.si{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:var(--rs);cursor:pointer;margin-bottom:2px;border:1px solid transparent;transition:all .15s}
.si:hover{background:var(--bg4)}.si.on{background:var(--gd);border-color:rgba(0,224,154,.25)}
.si-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.si-name{font-size:13px;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.si-acts{display:none;gap:2px}.si:hover .si-acts{display:flex}
.si-btn{background:none;border:none;cursor:pointer;font-size:11px;padding:2px 5px;border-radius:4px;color:var(--t3);transition:all .15s}.si-btn:hover{color:var(--t)}.si-btn.del:hover{color:var(--r)}
.mn{flex:1;overflow-y:auto;padding:12px 20px}
.dh{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:6px}
.dt{display:flex;align-items:center;gap:12px}.dt h1{font-size:18px;font-weight:600}
.ld{width:10px;height:10px;border-radius:50%;background:var(--g);box-shadow:0 0 10px var(--g);animation:pulse 2s ease-in-out infinite}@keyframes pulse{50%{opacity:.4}}
.da{display:flex;gap:6px;align-items:center}
.da button{padding:7px 14px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--bg3);color:var(--t2);cursor:pointer;font-size:12px;font-family:var(--u);display:flex;align-items:center;gap:6px;white-space:nowrap;transition:all .15s}
.da button:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.da .demo-on{background:var(--gd);border-color:var(--g);color:var(--g)}
.ck{font-size:12px;color:var(--t3);font-family:var(--m)}
.ss{display:grid;grid-template-columns:repeat(6,1fr);gap:5px;margin-bottom:8px}
.sc{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);padding:7px 10px;transition:border-color .2s}.sc:hover{border-color:var(--bd2)}
.sl2{font-size:9px;color:var(--t3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.8px;font-weight:500}
.sv{font-family:var(--m);font-size:20px;font-weight:700}.su{font-size:11px;color:var(--t3);margin-left:2px;font-weight:400}
.bdg{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;font-family:var(--m)}
.bdg-ok{background:var(--gd);color:var(--g);border:1px solid rgba(0,224,154,.2)}.bdg-w{background:var(--yd);color:var(--y);border:1px solid rgba(255,176,32,.2);cursor:pointer}.bdg-a{background:var(--rd);color:var(--r);border:1px solid rgba(255,64,96,.2);cursor:pointer;animation:bk 1.5s infinite}.bdg-off{background:var(--bg3);color:var(--t3);border:1px solid var(--bd)}.bdg-run{background:var(--gd);color:var(--g);border:1px solid rgba(0,224,154,.2)}
.gg{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}.sr2{display:flex;justify-content:center;margin-bottom:10px}.sr2 .cc{max-width:640px;width:100%}
.cc{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);overflow:hidden;transition:all .25s}.cc:hover{border-color:var(--bd2)}
.cc.s-run{border-left:3px solid var(--g)}.cc.s-stb{border-left:3px solid var(--t4)}.cc.s-wrn{border-left:3px solid var(--y)}.cc.s-alm{border-left:3px solid var(--r)}
.ch{padding:8px 12px 6px;cursor:pointer;transition:background .15s}.ch:hover{background:rgba(255,255,255,.015)}
.cr1{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}.cid{display:flex;align-items:center;gap:8px}
.cdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:all .3s}
.cd-g{background:var(--g);box-shadow:0 0 8px var(--g)}.cd-x{background:var(--t4)}.cd-r{background:var(--r);box-shadow:0 0 8px var(--r);animation:bk 1s infinite}.cd-y{background:var(--y);box-shadow:0 0 8px var(--y)}
@keyframes bk{50%{opacity:.15}}
.cn{font-size:13px;font-weight:600}.csb{font-size:10px;color:var(--t3);font-family:var(--m);margin-top:1px}
.kr{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}.kr5{grid-template-columns:repeat(5,1fr)}
.kp{text-align:center;padding:4px 2px;background:rgba(255,255,255,.02);border-radius:var(--rs)}.kl{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px;font-weight:500}
.kv{font-family:var(--m);font-size:14px;font-weight:600}.ku{font-size:8px;color:var(--t3)}
.vg{color:var(--g)}.vn{color:var(--t)}.vm{color:var(--t4)}.vw{color:var(--y)}.va{color:var(--r)}.vb{color:var(--b)}.vp{color:var(--p)}
/* Quick Controls - ALWAYS VISIBLE on card */
.qc{display:flex;gap:3px;margin-top:3px;padding-top:3px;border-top:1px solid rgba(255,255,255,.04)}
.qb{flex:1;display:flex;align-items:center;justify-content:center;gap:2px;padding:4px 2px;border-radius:6px;border:1px solid var(--bd);background:rgba(255,255,255,.02);color:var(--t3);cursor:pointer;font-family:var(--u);font-size:9px;font-weight:500;transition:all .15s;white-space:nowrap}
.qb:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.qb:active{transform:scale(.96)}
.qb.q-start:hover{border-color:var(--g);color:var(--g);background:var(--gd)}
.qb.q-stop:hover{border-color:var(--r);color:var(--r);background:var(--rd)}
.qb.q-auto:hover{border-color:var(--b);color:var(--b);background:var(--bb)}
.qb.q-manual:hover{border-color:var(--y);color:var(--y);background:var(--yd)}
.qb.q-danger{border-color:rgba(255,64,96,.3);color:var(--r);background:var(--rd)}.qb.q-danger:hover{background:rgba(255,64,96,.2);border-color:var(--r)}
.cmd-st{margin-top:6px;padding:5px 10px;border-radius:6px;font-size:10px;font-family:var(--m);background:var(--gd);color:var(--g);display:none;text-align:center}.cmd-st.sh{display:block}
.to-block{margin-top:3px;padding:4px 7px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:var(--rs);cursor:pointer;transition:all .2s}.to-block:hover{border-color:var(--bd2)}
.to-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}.to-name{font-size:10px;font-weight:600;font-family:var(--m)}.to-g{color:var(--g)}.to-y{color:var(--y)}.to-r{color:var(--r)}.to-remain{font-size:9px;font-family:var(--m);color:var(--t3)}
.to-bar{height:3px;background:var(--bg);border-radius:2px;overflow:hidden;margin-bottom:2px}.to-fill{height:100%;border-radius:2px;transition:width .5s}
.to-tasks{font-size:10px;color:var(--t3);line-height:1.4;max-height:0;overflow:hidden;transition:max-height .3s}.to-block.exp .to-tasks{max-height:140px}.to-hint{font-size:9px;color:var(--t4);text-align:right}
.mds{display:flex;gap:2px;margin-top:3px}.mdt{font-size:8px;font-family:var(--m);font-weight:600;padding:2px 6px;border-radius:3px;border:1px solid var(--bd);color:var(--t4);transition:all .2s}.mdt.on{border-color:var(--g);color:var(--g);background:var(--gd)}
.cv{display:flex;justify-content:center;padding:3px;color:var(--t4);transition:transform .3s}.cc.op .cv{transform:rotate(180deg)}
.ce{max-height:0;overflow:hidden;transition:max-height .4s ease}.cc.op .ce{max-height:2500px}.ei{padding:0 10px 8px}
.tbs{display:flex;gap:0;border-bottom:1px solid var(--bd);margin-bottom:8px;overflow-x:auto}
.tb{padding:7px 12px;font-size:12px;font-weight:500;color:var(--t3);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;font-family:var(--u);white-space:nowrap;flex-shrink:0;transition:all .15s}.tb:hover{color:var(--t)}.tb.on{color:var(--g);border-bottom-color:var(--g)}
.tp{display:none}.tp.on{display:block}
.mg{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.mg4{grid-template-columns:repeat(4,1fr)}.mg2{grid-template-columns:repeat(2,1fr)}
.mc{background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:8px;padding:10px}.ml{font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;font-weight:500}.mv{font-family:var(--m);font-size:17px;font-weight:600}.ms2{font-size:10px;color:var(--t3);font-family:var(--m);margin-top:2px}.mu{font-size:11px;color:var(--t3);margin-left:2px}
.pt{width:100%;font-size:12px;font-family:var(--m);border-collapse:collapse;margin-top:10px}.pt th{text-align:left;font-weight:500;color:var(--t3);padding:7px 8px;border-bottom:1px solid var(--bd);font-size:10px;text-transform:uppercase}.pt td{padding:7px 8px;border-bottom:1px solid rgba(255,255,255,.02)}.pt .ph{color:var(--t3)}
.cg{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.cb2{display:flex;flex-direction:column;align-items:center;gap:5px;padding:12px 4px;border-radius:8px;border:1px solid var(--bd);background:rgba(255,255,255,.02);color:var(--t3);cursor:pointer;font-family:var(--u);font-size:10px;transition:all .15s;font-weight:500}
.cb2:active{transform:scale(.95)}.cb2:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.cb2.cgo:hover{border-color:var(--g);color:var(--g);background:var(--gd)}.cb2.cst:hover{border-color:var(--r);color:var(--r);background:var(--rd)}.ci2{font-size:18px}
.ai{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:var(--rs);margin-bottom:4px;font-size:12px;font-family:var(--m)}.ai.aw{background:var(--yd);border:1px solid rgba(255,176,32,.2)}.ai.aa{background:var(--rd);border:1px solid rgba(255,64,96,.2)}
.cf{display:flex;align-items:center;justify-content:space-between;padding:3px 10px;border-top:1px solid var(--bd);font-size:9px;font-family:var(--m);color:var(--t4)}.li{display:flex;align-items:center;gap:5px}.lo{width:6px;height:6px;border-radius:50%}.lo-g{background:var(--g);animation:pulse 1.5s ease-in-out infinite}.lo-r{background:var(--r)}
.pflow{margin:0 0 6px;padding:2px 8px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad)}
.pflow svg{width:100%;height:auto}
.pline{stroke:var(--t4);stroke-width:2.5;fill:none;transition:stroke .3s}
.pline.on{stroke:var(--g);filter:drop-shadow(0 0 4px rgba(0,224,154,.5));stroke-dasharray:8 4;animation:flowA .8s linear infinite}
.pline.mon{stroke:var(--b);filter:drop-shadow(0 0 4px rgba(64,144,255,.4));stroke-dasharray:8 4;animation:flowA .8s linear infinite}
.pline.bus{stroke-width:4}
@keyframes flowA{to{stroke-dashoffset:-12}}
@keyframes flowR{to{stroke-dashoffset:12}}
.pline.onR{stroke:var(--g);filter:drop-shadow(0 0 4px rgba(0,224,154,.5));stroke-dasharray:8 4;animation:flowR .8s linear infinite}
.pline.monR{stroke:var(--b);filter:drop-shadow(0 0 4px rgba(64,144,255,.4));stroke-dasharray:8 4;animation:flowR .8s linear infinite}
.bk-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:6px;margin-bottom:4px;font-size:11px;font-family:var(--m)}
.bk-item:hover{border-color:var(--bd2)}
.bk-acts{display:flex;gap:4px}
.bk-btn{padding:3px 8px;border-radius:4px;border:1px solid var(--bd);background:var(--bg3);color:var(--t3);cursor:pointer;font-size:10px;font-family:var(--u);transition:all .15s}
.bk-btn:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}
.bk-btn.del:hover{color:var(--r);border-color:rgba(255,64,96,.3)}
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(6px)}.mbg.sh{display:flex}
.mod{background:var(--bg2);border:1px solid var(--bd);border-radius:14px;width:100%;max-width:520px;max-height:85vh;overflow-y:auto;box-shadow:0 2px 20px rgba(0,0,0,.4)}
.mhd{padding:16px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}.mhd h3{font-size:15px;font-weight:600}
.mx{background:none;border:none;color:var(--t3);cursor:pointer;font-size:20px;padding:4px 8px;border-radius:6px;transition:all .15s}.mx:hover{background:var(--bg4);color:var(--t)}
.mbd{padding:18px}
.fg{margin-bottom:14px}.fl{font-size:12px;color:var(--t2);margin-bottom:5px;display:block;font-weight:500}.req{color:var(--r)}
.fi{width:100%;padding:9px 12px;background:var(--bg);border:1px solid var(--bd);border-radius:var(--rs);color:var(--t);font-size:13px;font-family:var(--u);outline:none;transition:all .15s}.fi:focus{border-color:var(--g);box-shadow:0 0 0 3px rgba(0,224,154,.1)}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.bp{padding:10px;background:var(--g);color:#080c14;border:none;border-radius:var(--rs);font-weight:600;cursor:pointer;font-family:var(--u);font-size:13px;width:100%;transition:all .15s}.bp:hover{background:#00c888}
.bs2{padding:8px 14px;background:var(--bg3);border:1px solid var(--bd);color:var(--t2);border-radius:var(--rs);cursor:pointer;font-family:var(--u);font-size:12px;transition:all .15s}.bs2:hover{background:var(--bg4);color:var(--t)}
.bdn{background:var(--rd);color:var(--r);border:1px solid rgba(255,64,96,.3);border-radius:var(--rs);cursor:pointer;font-family:var(--u);font-weight:600;font-size:13px;padding:10px;transition:all .15s}.bdn:hover{background:rgba(255,64,96,.15)}
.bpp{padding:8px 12px;background:var(--pd);border:1px solid rgba(160,112,255,.3);color:var(--p);border-radius:var(--rs);cursor:pointer;font-family:var(--u);font-size:12px;font-weight:600;width:100%;transition:all .15s}.bpp:hover{background:rgba(160,112,255,.15)}
.cfs{border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:12px;transition:border-color .2s}.cfs:hover{border-color:var(--bd2)}
.cft{font-size:12px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.cft .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.cft .dot-g{background:var(--g)}.cft .dot-p{background:var(--p)}
.conn-test{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:4px;font-size:10px;font-family:var(--m);margin-left:auto;cursor:pointer;background:var(--bg4);border:1px solid var(--bd);color:var(--t3);transition:all .15s}.conn-test:hover{color:var(--t);border-color:var(--bd2)}
.spr-cg{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px}
.spr-b{padding:10px 4px;border-radius:8px;border:1px solid var(--bd);background:rgba(255,255,255,.02);color:var(--t3);cursor:pointer;font-family:var(--u);font-size:10px;text-align:center;transition:all .15s;font-weight:500}.spr-b:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.spr-b:active{transform:scale(.96)}.spr-b .si2{font-size:16px;display:block;margin-bottom:3px}
.preset-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px}
.preset-btn{padding:10px 6px;border-radius:8px;border:1px solid var(--bd);background:rgba(255,255,255,.02);color:var(--t2);cursor:pointer;font-family:var(--u);font-size:11px;text-align:center;transition:all .15s}
.preset-btn:hover{background:var(--bg4);color:var(--t);border-color:var(--bd2)}.preset-btn:active{transform:scale(.96)}
.preset-btn .preset-name{font-weight:600;margin-bottom:2px}.preset-btn .preset-desc{font-size:9px;color:var(--t3);font-family:var(--m)}.preset-btn.active{border-color:var(--p);background:var(--pd);color:var(--p)}
.slider-group{padding:10px 12px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:8px;margin-bottom:8px}
.slider-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}.slider-row:last-child{margin-bottom:0}
.slider-label{font-size:11px;font-family:var(--m);color:var(--t3);width:20px;flex-shrink:0}.slider-val{font-size:12px;font-family:var(--m);color:var(--t);width:44px;text-align:right;flex-shrink:0;font-weight:600}
input[type=range]{flex:1;-webkit-appearance:none;height:4px;background:var(--bd);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--p);border-radius:50%;cursor:pointer;box-shadow:0 0 6px rgba(160,112,255,.4)}
.ev{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rad);padding:14px 16px}.ev-t{font-size:11px;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.8px;font-weight:500}
.er{font-size:11px;font-family:var(--m);padding:4px 0;color:var(--t2);display:flex;gap:8px}.et{color:var(--t4);flex-shrink:0}
.to-iv{padding:12px;background:var(--bg4);border:1px solid var(--bd);border-radius:8px;margin-bottom:8px}.to-iv-bar{height:3px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:6px}.to-iv-fill{height:100%;border-radius:2px}
.chk-item{display:flex;align-items:flex-start;gap:8px;padding:7px 8px;border-radius:var(--rs);cursor:pointer;font-size:12px;transition:background .15s}.chk-item:hover{background:var(--bg4)}.chk-item.crit{background:rgba(255,64,96,.03)}.chk-item input{margin-top:2px;accent-color:var(--g)}
.ta{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--bd);border-radius:var(--rs);color:var(--t2);font-size:11px;font-family:var(--u);resize:vertical;min-height:60px;outline:none}.ta:focus{border-color:var(--g)}
.empty-dash{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;color:var(--t3);text-align:center}
.set-tabs{display:flex;gap:0;margin-bottom:16px;border-bottom:1px solid var(--bd)}
.set-tab{padding:10px 16px;font-size:12px;font-weight:500;color:var(--t3);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;font-family:var(--u);transition:all .15s}.set-tab:hover{color:var(--t)}.set-tab.on{color:var(--g);border-bottom-color:var(--g)}
.set-panel{display:none}.set-panel.on{display:block}
</style></head><body>
<div class="app">
<div class="sb"><div class="sb-hd">
<div class="logo"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg><b>SCADA</b><span>v5</span></div>
<button class="sb-btn primary" onclick="openAddSite()">+ –û–±—ä–µ–∫—Ç</button>
<button class="sb-btn" onclick="openTOTemplates()">üìã –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã –¢–û</button>
<button class="sb-btn" onclick="initBxModal();showM('bitrix')">üîó –ë–∏—Ç—Ä–∏–∫—Å24</button>
<button class="sb-btn" onclick="initAIModal();showM('aiconf')">ü§ñ AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä</button>
</div><div class="sb-sites" id="sbSites"></div></div>
<div class="mn" id="mainArea"></div></div>
<!-- MODALS -->
<!-- AI Provider Config -->
<div class="mbg" id="m-aiconf"><div class="mod" style="max-width:520px"><div class="mhd"><h3>ü§ñ AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä</h3><button class="mx" onclick="hideM('aiconf')">‚úï</button></div><div class="mbd">
<div style="font-size:12px;color:var(--t2);margin-bottom:12px">–í—ã–±–µ—Ä–∏—Ç–µ LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è AI-–∏–º–ø–æ—Ä—Ç–∞ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ –¢–û –∏–∑ –º–∞–Ω—É–∞–ª–æ–≤</div>
<div id="aiProviderCards" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px"></div>
<div id="aiKeySection" style="display:none">
<div class="fg"><label class="fl" id="aiKeyLabel">API Key</label><div style="display:flex;gap:6px"><input class="fi" id="aiKeyInput" type="password" placeholder="sk-..." style="flex:1"><button class="bs2" style="padding:8px 12px;font-size:11px;flex-shrink:0" onclick="toggleAIKeyVis()">üëÅ</button></div></div>
<div class="fg"><label class="fl">–ú–æ–¥–µ–ª—å</label><select class="fi" id="aiModelSelect" style="padding:8px 10px"></select></div>
<div style="display:flex;gap:8px;margin-bottom:10px"><button class="bp" style="flex:1" onclick="saveAIConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="bs2" style="padding:10px" onclick="testAIProvider()">üîå –¢–µ—Å—Ç</button></div>
<div id="aiTestResult" style="margin-top:4px"></div>
</div>
<div id="aiStatus" style="padding:8px 10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:6px;margin-top:8px;font-size:10px;color:var(--t3);line-height:1.5"></div>
</div></div></div>
<div class="mbg" id="m-site"><div class="mod" style="max-width:440px"><div class="mhd"><h3 id="smT">–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç</h3><button class="mx" onclick="hideM('site')">‚úï</button></div><div class="mbd">
<div class="fg"><label class="fl">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="req">*</span></label><input class="fi" id="fN" placeholder="–ú–ö–ó"></div>
<div class="fg"><label class="fl">–ö–æ–¥ (–ª–∞—Ç–∏–Ω–∏—Ü–∞) <span class="req">*</span></label><input class="fi" id="fC" placeholder="mkz"></div>
<div class="fg"><label class="fl">–û–ø–∏—Å–∞–Ω–∏–µ</label><input class="fi" id="fD" placeholder="–ö–∏—Ä–ø–∏—á–Ω—ã–π –∑–∞–≤–æ–¥"></div>
<div class="fg"><label class="fl">üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¢–û</label><select class="fi" id="fResp" style="padding:8px 10px"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option></select><div style="font-size:9px;color:var(--t4);margin-top:3px">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –ë–∏—Ç—Ä–∏–∫—Å24 ‚Üí –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div></div>
<div id="smA"></div></div></div></div>
<div class="mbg" id="m-del"><div class="mod" style="max-width:380px"><div class="mhd"><h3>–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?</h3><button class="mx" onclick="hideM('del')">‚úï</button></div><div class="mbd"><p style="font-size:13px;color:var(--t2);margin-bottom:16px">–£–¥–∞–ª–∏—Ç—å <b id="delN"></b> –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?</p><div style="display:flex;gap:8px"><button class="bdn" style="flex:1" onclick="doDel()">–£–¥–∞–ª–∏—Ç—å</button><button class="bs2" style="flex:1;padding:10px" onclick="hideM('del')">–û—Ç–º–µ–Ω–∞</button></div></div></div></div>
<div class="mbg" id="m-settings"><div class="mod" style="max-width:560px"><div class="mhd"><h3 id="setTitle">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button class="mx" onclick="hideM('settings')">‚úï</button></div><div class="mbd" id="setBody"></div></div></div>
<div class="mbg" id="m-cmd"><div class="mod" style="max-width:400px"><div class="mhd"><h3 id="cmdT">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3><button class="mx" onclick="hideM('cmd')">‚úï</button></div><div class="mbd">
<div style="padding:12px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:8px;margin-bottom:12px"><div style="font-size:12px;color:var(--y);font-weight:600;margin-bottom:4px">‚ö† –í–Ω–∏–º–∞–Ω–∏–µ</div><p id="cmdTxt" style="font-size:13px;color:var(--t2)"></p></div>
<div id="cmdInfo" style="padding:8px 10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:6px;font-size:10px;color:var(--t3);font-family:var(--m);margin-bottom:14px"></div>
<div style="display:flex;gap:8px"><button class="bp" style="flex:1" id="cmdOk">‚ö° –í—ã–ø–æ–ª–Ω–∏—Ç—å</button><button class="bs2" style="flex:1;padding:10px" onclick="hideM('cmd')">–û—Ç–º–µ–Ω–∞</button></div></div></div></div>
<div class="mbg" id="m-to"><div class="mod"><div class="mhd"><h3 id="toT">–¢–û</h3><button class="mx" onclick="hideM('to')">‚úï</button></div><div class="mbd" id="toBody"></div></div></div>
<div class="mbg" id="m-tpl"><div class="mod"><div class="mhd"><h3 id="tplT">–†–µ–≥–ª–∞–º–µ–Ω—Ç—ã</h3><button class="mx" onclick="hideM('tpl')">‚úï</button></div><div class="mbd" id="tplBody"></div></div></div>
<div class="mbg" id="m-bitrix"><div class="mod" style="max-width:560px"><div class="mhd"><h3>üîó –ë–∏—Ç—Ä–∏–∫—Å24 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</h3><button class="mx" onclick="hideM('bitrix')">‚úï</button></div><div class="mbd">
<div class="set-tabs"><button class="set-tab on" onclick="bxTab(this,0)">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button><button class="set-tab" onclick="bxTab(this,1)">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button><button class="set-tab" onclick="bxTab(this,2)">–ò–º–ø–æ—Ä—Ç –¢–û</button><button class="set-tab" onclick="bxTab(this,3)">–ê–≤—Ç–æ–∑–∞–¥–∞—á–∏</button></div>
<div class="set-panel on" id="bxp0">
<div class="fg"><label class="fl">Webhook URL <span class="req">*</span></label><input class="fi" id="bxUrl" placeholder="https://your.bitrix24.ru/rest/1/abc123xyz/" value=""></div>
<div style="padding:8px 10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:6px;margin-bottom:10px;font-size:10px;color:var(--t3);line-height:1.5">
<b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å:</b> –ë–∏—Ç—Ä–∏–∫—Å24 ‚Üí –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º ‚Üí –î—Ä—É–≥–æ–µ ‚Üí –í—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫ ‚Üí –°–æ–∑–¥–∞—Ç—å.<br>
<b>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞:</b><br>
‚Ä¢ <b style="color:var(--g)">task</b> ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ/—á—Ç–µ–Ω–∏–µ –∑–∞–¥–∞—á (tasks.task.add, task.checklistitem.add)<br>
‚Ä¢ <b style="color:var(--g)">user</b> ‚Äî —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (user.get)<br>
‚Ä¢ <b style="color:var(--y)">disk</b> ‚Äî —Ñ–∞–π–ª—ã –î–∏—Å–∫–∞ (disk.folder.getchildren, disk.file.get) ‚Äî –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¢–û<br>
‚Ä¢ <b style="color:var(--t3)">crm</b> ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∑–∞–¥–∞—á –∫ CRM (UF_CRM_TASK)<br>
<b>–§–æ—Ä–º–∞—Ç URL:</b> https://–≤–∞—à-–¥–æ–º–µ–Ω.bitrix24.ru/rest/USER_ID/SECRET/<br>
<b>USER_ID</b> ‚Äî –æ—Ç –∏–º–µ–Ω–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∑–∞–¥–∞—á–∏ (CREATED_BY)
</div>
<div style="display:flex;gap:8px"><button class="bp" style="flex:1" onclick="saveBxConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="bs2" style="padding:10px" onclick="testBxConnection()">üîå –¢–µ—Å—Ç</button></div>
<div id="bxConnResult" style="margin-top:8px"></div>
</div>
<div class="set-panel" id="bxp1">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-size:12px;color:var(--t2)">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24</span><button class="bs2" style="padding:6px 12px;font-size:11px" onclick="loadBxUsers()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button></div>
<div id="bxUserList" style="max-height:300px;overflow-y:auto"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div></div>
<div style="padding:8px 10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:6px;margin-top:10px;font-size:10px;color:var(--t3);line-height:1.5">–°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö (RESPONSIBLE_ID) –∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π (AUDITORS) –≤ –∑–∞–¥–∞—á–∞—Ö –¢–û.<br><b>API:</b> user.get ‚Üí –ø–æ–ª—è: ID, NAME, LAST_NAME, WORK_POSITION, UF_DEPARTMENT</div>
</div>
<div class="set-panel" id="bxp2">
<div style="font-size:12px;color:var(--t2);margin-bottom:10px">–ò–º–ø–æ—Ä—Ç —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞ –¢–û –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24 –î–∏—Å–∫</div>
<div class="fg"><label class="fl">ID –ø–∞–ø–∫–∏ –Ω–∞ –î–∏—Å–∫–µ –ë24</label><input class="fi" id="bxFolderId" placeholder="12345" type="number"></div>
<div style="display:flex;gap:8px;margin-bottom:10px"><button class="bp" style="flex:1" onclick="scanBxFolder()">üìÇ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ø–∫—É</button></div>
<div id="bxFileList" style="margin-bottom:10px"></div>
<div style="padding:10px;background:rgba(160,112,255,.04);border:1px solid rgba(160,112,255,.15);border-radius:8px;font-size:10px;color:var(--t2);line-height:1.5">
<b style="color:var(--p)">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b><br>
1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç –¢–û (PDF/DOCX) –Ω–∞ –î–∏—Å–∫ –ë–∏—Ç—Ä–∏–∫—Å24<br>
2. –£–∫–∞–∂–∏—Ç–µ ID –ø–∞–ø–∫–∏ ‚Üí SCADA —Å–∫–∞–Ω–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã<br>
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª ‚Üí AI-–∞–≥–µ–Ω—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç<br>
4. –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ —á–µ–∫–ª–∏—Å—Ç—ã –¢–û<br>
<b>API:</b> disk.folder.getchildren ‚Üí disk.file.get ‚Üí AI parse
</div>
</div>
<div class="set-panel" id="bxp3">
<div style="font-size:12px;color:var(--t2);margin-bottom:10px">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –¢–û</div>
<div class="fg"><label class="fl">–ì—Ä—É–ø–ø–∞/–ø—Ä–æ–µ–∫—Ç –≤ –ë24 (GROUP_ID)</label><input class="fi" id="bxGroupId" placeholder="42" type="number"></div>
<div class="fg"><label class="fl">–®–∞–±–ª–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏ (TITLE)</label><input class="fi" id="bxTaskTitle" placeholder="{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}" value="{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}"></div>
<div style="display:flex;gap:8px"><div class="fg" style="flex:1"><label class="fl">–°—Ä–æ–∫ (–¥–Ω–µ–π –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è)</label><input class="fi" id="bxDeadlineDays" placeholder="3" value="3" type="number"></div><div class="fg" style="flex:1"><label class="fl">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (PRIORITY)</label><select class="fi" id="bxPriority" style="padding:8px 10px"><option value="0">–ù–∏–∑–∫–∏–π (0)</option><option value="1" selected>–°—Ä–µ–¥–Ω–∏–π (1)</option><option value="2">–í—ã—Å–æ–∫–∏–π (2)</option></select></div></div>
<div class="fg"><label class="fl">üë§ –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (AUDITORS)</label><select class="fi" id="bxAuditor" style="padding:8px 10px"><option value="">‚Äî –Ω–µ—Ç ‚Äî</option></select></div>
<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;padding:8px 10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:6px">
<div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bxAutoCreate" style="accent-color:var(--g)"><label for="bxAutoCreate" style="font-size:12px;color:var(--t2)">–ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –¢–û</label></div>
<div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bxAddChecklist" style="accent-color:var(--g)" checked><label for="bxAddChecklist" style="font-size:12px;color:var(--t2)">–î–æ–±–∞–≤–∏—Ç—å —á–µ–∫–ª–∏—Å—Ç —Ä–∞–±–æ—Ç (task.checklistitem.add)</label></div>
<div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bxDescBBCode" style="accent-color:var(--g)" checked><label for="bxDescBBCode" style="font-size:12px;color:var(--t2)">–û–ø–∏—Å–∞–Ω–∏–µ –≤ BBCode (DESCRIPTION_IN_BBCODE=Y)</label></div>
</div>
<button class="bp" onclick="saveBxConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
<div style="padding:10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:8px;margin-top:10px;font-size:10px;color:var(--t3);line-height:1.6">
<b style="color:var(--t2)">–ü–æ–ª—è –∑–∞–¥–∞—á–∏ tasks.task.add:</b><br>
‚Ä¢ TITLE ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —à–∞–±–ª–æ–Ω—É<br>
‚Ä¢ DESCRIPTION ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ —Å —Ä–∞–±–æ—Ç–∞–º–∏ –¢–û (BBCode)<br>
‚Ä¢ RESPONSIBLE_ID ‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–±—ä–µ–∫—Ç–∞)<br>
‚Ä¢ CREATED_BY ‚Äî –ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫ (USER_ID –∏–∑ webhook URL)<br>
‚Ä¢ AUDITORS ‚Äî –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ (–º–∞—Å—Å–∏–≤ ID)<br>
‚Ä¢ GROUP_ID ‚Äî –ø—Ä–æ–µ–∫—Ç/–≥—Ä—É–ø–ø–∞<br>
‚Ä¢ DEADLINE ‚Äî —Å—Ä–æ–∫ –≤ ISO-8601: 2025-01-15T19:00:00+03:00<br>
‚Ä¢ PRIORITY ‚Äî 0/1/2 (–Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π)<br>
‚Ä¢ ALLOW_CHANGE_DEADLINE ‚Äî N (–∑–∞–ø—Ä–µ—Ç —Å–¥–≤–∏–≥–∞ —Å—Ä–æ–∫–∞)<br>
<b style="color:var(--t2);margin-top:4px;display:block">–ß–µ–∫–ª–∏—Å—Ç task.checklistitem.add:</b><br>
‚Ä¢ –í—ã–∑–æ–≤: [TASK_ID, {TITLE: "—Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç—ã"}] –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–∞–±–æ—Ç—ã<br>
‚Ä¢ [!] –∫—Ä–∏—Ç–∏—á–Ω—ã–µ ‚Üí {TITLE: "‚ö† —Ä–∞–±–æ—Ç–∞", IS_IMPORTANT: "Y"}<br>
<b style="color:var(--t2);margin-top:4px;display:block">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞:</b><br>
{TO_NAME}, {SITE_NAME}, {GEN_NAME}, {HOURS}, {RESPONSIBLE}<br>
<b style="color:var(--y);margin-top:4px;display:block">–ò—Å—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å):</b><br>
–ë24 ‚Üí SCADA: –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–¥–∞—á–∏ ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –¢–û.<br>
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –ë24 ‚Üí –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º ‚Üí –ò—Å—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫ ‚Üí –°–æ–±—ã—Ç–∏–µ: ONTASKCOMPLETE
</div>
</div>
</div></div></div>

<script>
const $=id=>document.getElementById(id);
let S,cur,editId=null,delId=null,evts=[];try{S=JSON.parse(localStorage.getItem('s5s'))||{}}catch(e){S={}}cur=localStorage.getItem('s5c')||null;
let demo=false,demoIv=null,dStep=0;

// ===================== API / WS INTEGRATION LAYER =====================
const API_BASE = (window.location.port === '8011')
    ? '' // nginx proxy ‚Äî same origin
    : 'http://' + window.location.hostname + ':8010';
const WS_BASE = API_BASE
    ? API_BASE.replace(/^http/, 'ws')
    : 'ws://' + window.location.host;

const api = {
    async get(path) {
        const r = await fetch(API_BASE + path);
        if (!r.ok) throw new Error(`GET ${path}: ${r.status}`);
        return r.json();
    },
    async post(path, body) {
        const r = await fetch(API_BASE + path, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(`POST ${path}: ${r.status}`);
        return r.json();
    },
    async patch(path, body) {
        const r = await fetch(API_BASE + path, {
            method: 'PATCH', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(`PATCH ${path}: ${r.status}`);
        return r.json();
    },
    async del(path) {
        const r = await fetch(API_BASE + path, {method: 'DELETE'});
        if (!r.ok) throw new Error(`DELETE ${path}: ${r.status}`);
    },
};

// Maps device_id ‚Üí {siteKey, slot, deviceType}
let deviceSlotIndex = {};
// Cache latest WS metrics per device
let latestMetrics = {};
// Maps siteKey ‚Üí apiSiteId
let siteApiIds = {};
// Whether backend API is available
let apiAvailable = false;
let ws = null, wsReconnectTimer = null;
const WS_RECONNECT_DELAY = 3000;

async function loadFromAPI() {
    try {
        const apiSites = await api.get('/api/sites');
        S = {};
        deviceSlotIndex = {};
        siteApiIds = {};
        for (const s of apiSites) {
            const key = (s.code || ('site_' + s.id)).toLowerCase();
            siteApiIds[key] = s.id;
            S[key] = {
                _apiId: s.id,
                name: s.name,
                code: s.code,
                desc: s.description || '',
                responsible: '',
                g1: {}, g2: {}, spr: {},
            };
        }
        // Load devices for each site
        for (const s of apiSites) {
            const key = (s.code || ('site_' + s.id)).toLowerCase();
            try {
                const devices = await api.get('/api/devices?site_id=' + s.id);
                const gens = devices.filter(d => d.device_type === 'generator').sort((a, b) => a.id - b.id);
                const ats = devices.filter(d => d.device_type === 'ats');

                if (gens[0]) {
                    S[key].g1 = {
                        _deviceId: gens[0].id,
                        ip: gens[0].ip_address,
                        port: gens[0].port,
                        slaveId: gens[0].slave_id,
                        runHours: 0,
                    };
                    deviceSlotIndex[gens[0].id] = {siteKey: key, slot: 'g1'};
                }
                if (gens[1]) {
                    S[key].g2 = {
                        _deviceId: gens[1].id,
                        ip: gens[1].ip_address,
                        port: gens[1].port,
                        slaveId: gens[1].slave_id,
                        runHours: 0,
                    };
                    deviceSlotIndex[gens[1].id] = {siteKey: key, slot: 'g2'};
                }
                if (ats[0]) {
                    S[key].spr = {
                        _deviceId: ats[0].id,
                        ip: ats[0].ip_address,
                        port: ats[0].port,
                        slaveId: ats[0].slave_id,
                    };
                    deviceSlotIndex[ats[0].id] = {siteKey: key, slot: 'spr'};
                }
            } catch (e) {
                console.warn('Failed to load devices for site', s.id, e);
            }
        }
        if (!cur || !S[cur]) cur = Object.keys(S)[0] || null;
        apiAvailable = true;
        sv();
        ae('üåê –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ API');
        return true;
    } catch (e) {
        console.warn('API unavailable, using localStorage', e);
        return false;
    }
}

function connectWebSocket() {
    if (ws) { try { ws.close(); } catch(e){} }
    const url = WS_BASE + '/ws/metrics';
    try {
        ws = new WebSocket(url);
    } catch (e) {
        console.warn('WS connect error:', e);
        scheduleWsReconnect();
        return;
    }
    ws.onopen = () => {
        ae('üîå WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω');
        console.log('WS connected:', url);
    };
    ws.onclose = () => {
        console.log('WS closed');
        scheduleWsReconnect();
    };
    ws.onerror = (e) => {
        console.warn('WS error:', e);
    };
    ws.onmessage = (ev) => {
        try {
            const msg = JSON.parse(ev.data);
            if (msg.type === 'snapshot' && Array.isArray(msg.data)) {
                for (const m of msg.data) handleMetricsUpdate(m);
            } else if (msg.type === 'maintenance_alert') {
                // Maintenance alert from backend ‚Äî ignore for now (v5 handles TO locally)
            } else if (msg.device_id !== undefined) {
                handleMetricsUpdate(msg);
            }
        } catch(e) {}
    };
}

function scheduleWsReconnect() {
    if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
    wsReconnectTimer = setTimeout(connectWebSocket, WS_RECONNECT_DELAY);
}

function handleMetricsUpdate(m) {
    if (!m || !m.device_id) return;
    latestMetrics[m.device_id] = m;

    const info = deviceSlotIndex[m.device_id];
    if (!info) return;
    const {siteKey, slot} = info;

    // Only update if this site is currently displayed
    if (siteKey !== cur) return;

    if (slot === 'g1' || slot === 'g2') {
        // Update runHours in S from WS data
        if (m.run_hours != null && S[siteKey]?.[slot]) {
            S[siteKey][slot].runHours = m.run_hours + (m.run_minutes ? m.run_minutes / 60 : 0);
        }
        // Determine status
        let status = 'standby';
        if (m.alarm_common || m.alarm_shutdown) status = 'alarm';
        else if (m.alarm_warning) status = 'warning';
        else if (m.gen_status === 9 || m.gen_status_text === 'running') status = 'running';
        else if (m.gen_status >= 1 && m.gen_status <= 8) status = 'running'; // starting sequence
        else if (m.gen_status >= 10 && m.gen_status <= 14) status = 'standby'; // stopping sequence

        const rh = S[siteKey]?.[slot]?.runHours || 0;
        const basePower = m.power_total != null ? m.power_total : 0;

        applyGen(slot, status, rh, basePower, m.online !== false);
        // applyGenDetailed not needed ‚Äî applyGen now uses latestMetrics directly

        // Update summary cards
        updateSummary();
        // Update flow SVG
        updateFlowFromMetrics();
    }
    else if (slot === 'spr') {
        const gOn = (m.genset_status === 9);
        const mN = (m.mains_status === 0); // 0 = normal
        const bC = (m.busbar_switch === 3); // 3 = closed
        const mC = (m.mains_switch === 3);  // 3 = closed

        applySpr(gOn, mN, bC, mC, m.online !== false);
        applySprDetailed(m);

        updateSummary();
        updateFlowFromMetrics();
    }
}

function applyGenDetailed(sl, m) {
    if (!m) return;
    const on = m.gen_status === 9 || (m.gen_status >= 1 && m.gen_status <= 8);
    const eT = $(sl + 'e');
    if (eT && on) {
        const p = m.power_total != null ? m.power_total : 0;
        const q = m.reactive_total != null ? m.reactive_total : 0;
        const pf = m.pf_avg != null ? m.pf_avg : 0;
        const uab = m.gen_uab != null ? m.gen_uab : 0;
        const ubc = m.gen_ubc != null ? m.gen_ubc : 0;
        const uca = m.gen_uca != null ? m.gen_uca : 0;
        const ia = m.current_a != null ? m.current_a : 0;
        const ib = m.current_b != null ? m.current_b : 0;
        const ic = m.current_c != null ? m.current_c : 0;
        const freq = m.gen_freq != null ? m.gen_freq : 0;
        const rh = S[cur]?.[sl]?.runHours || 0;
        const load = m.load_pct != null ? m.load_pct : 0;
        const ekwh = m.energy_kwh != null ? m.energy_kwh : 0;
        const starts = m.start_count != null ? m.start_count : 0;
        const pa = m.power_a != null ? m.power_a : 0;
        const pb = m.power_b != null ? m.power_b : 0;
        const pc = m.power_c != null ? m.power_c : 0;

        eT.innerHTML = `<div class="mg"><div class="mc"><div class="ml">P</div><div class="mv vg">${p.toFixed(1)}<span class="mu">–∫–í—Ç</span></div></div><div class="mc"><div class="ml">Q</div><div class="mv vn">${q.toFixed(1)}<span class="mu">–∫–≤–∞—Ä</span></div></div><div class="mc"><div class="ml">Cos œÜ</div><div class="mv vn">${pf.toFixed(3)}</div></div></div><table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U</th><th>I</th><th>P</th></tr></thead><tbody><tr><td class="ph">A-B</td><td>${uab.toFixed(0)}</td><td>${ia.toFixed(1)}</td><td>${pa.toFixed(1)}</td></tr><tr><td class="ph">B-C</td><td>${ubc.toFixed(0)}</td><td>${ib.toFixed(1)}</td><td>${pb.toFixed(1)}</td></tr><tr><td class="ph">C-A</td><td>${uca.toFixed(0)}</td><td>${ic.toFixed(1)}</td><td>${pc.toFixed(1)}</td></tr></tbody></table><div class="mg mg4" style="margin-top:10px"><div class="mc"><div class="ml">–ù–∞–≥—Ä—É–∑–∫–∞</div><div class="mv vn">${load}%</div></div><div class="mc"><div class="ml">–≠–Ω–µ—Ä–≥–∏—è</div><div class="mv vn">${ekwh}<span class="mu">–∫–í—Ç¬∑—á</span></div></div><div class="mc"><div class="ml">–ú–æ—Ç–æ—á–∞—Å—ã</div><div class="mv vn">${rh.toFixed(0)}<span class="mu">—á</span></div></div><div class="mc"><div class="ml">–ü—É—Å–∫–æ–≤</div><div class="mv vn">${starts}</div></div></div>`;
    }
    const mT = $(sl + 'm');
    if (mT && on) {
        const ct = m.coolant_temp != null ? m.coolant_temp : '‚Äî';
        const op = m.oil_pressure != null ? m.oil_pressure : '‚Äî';
        const rpm = m.engine_speed != null ? m.engine_speed : '‚Äî';
        const oilT = m.oil_temp != null ? m.oil_temp : '‚Äî';
        const fuel = m.fuel_level != null ? m.fuel_level : '‚Äî';
        const fc = m.fuel_consumption != null ? m.fuel_consumption : '‚Äî';
        const turbo = m.turbo_pressure != null ? m.turbo_pressure : '‚Äî';
        const batt = m.battery_volt != null ? m.battery_volt : '‚Äî';
        const ctC = (typeof ct === 'number' && ct > 95) ? 'va' : (typeof ct === 'number' && ct > 88) ? 'vw' : 'vn';
        const opC = (typeof op === 'number' && op < 300) ? 'va' : 'vn';
        const fuelC = (typeof fuel === 'number' && fuel < 50) ? 'vw' : 'vn';
        mT.innerHTML = `<div class="mg"><div class="mc"><div class="ml">–û–±–æ—Ä–æ—Ç—ã</div><div class="mv vn">${rpm}</div></div><div class="mc"><div class="ml">–¢–µ–º–ø.–û–ñ</div><div class="mv ${ctC}">${ct}¬∞C</div></div><div class="mc"><div class="ml">–î–∞–≤–ª.–º–∞—Å–ª–∞</div><div class="mv ${opC}">${op} –∫–ü–∞</div></div><div class="mc"><div class="ml">–¢–µ–º–ø.–º–∞—Å–ª–∞</div><div class="mv vn">${oilT}¬∞C</div></div><div class="mc"><div class="ml">–¢–æ–ø–ª–∏–≤–æ</div><div class="mv ${fuelC}">${fuel}%</div></div><div class="mc"><div class="ml">–†–∞—Å—Ö–æ–¥</div><div class="mv vn">${fc} –ª/—á</div></div><div class="mc"><div class="ml">–¢—É—Ä–±–æ</div><div class="mv vn">${turbo} –∫–ü–∞</div></div><div class="mc"><div class="ml">–ë–∞—Ç–∞—Ä–µ—è</div><div class="mv vn">${typeof batt === 'number' ? batt.toFixed(1) : batt}–í</div></div></div>`;
    }
}

function applySprDetailed(m) {
    if (!m) return;
    const active = (m.genset_status === 9) || (m.mains_status === 0);
    const mN = (m.mains_status === 0);
    const bC = (m.busbar_switch === 3);
    const mC = (m.mains_switch === 3);
    const gOn = (m.genset_status === 9);

    const sprb = $('sprb');
    if (sprb && active) {
        const bp = m.busbar_p != null ? m.busbar_p : 0;
        const bq = m.busbar_q != null ? m.busbar_q : 0;
        const bi = m.busbar_current != null ? m.busbar_current : 0;
        const buab = m.busbar_uab != null ? m.busbar_uab : 0;
        const bubc = m.busbar_ubc != null ? m.busbar_ubc : 0;
        const buca = m.busbar_uca != null ? m.busbar_uca : 0;
        const bua = m.busbar_ua != null ? m.busbar_ua : 0;
        const bub = m.busbar_ub != null ? m.busbar_ub : 0;
        const buc = m.busbar_uc != null ? m.busbar_uc : 0;
        sprb.innerHTML = `<div class="mg"><div class="mc"><div class="ml">P —à–∏–Ω—ã</div><div class="mv vg">${bp.toFixed(1)}<span class="mu">–∫–í—Ç</span></div></div><div class="mc"><div class="ml">Q</div><div class="mv vn">${bq.toFixed(1)}<span class="mu">–∫–≤–∞—Ä</span></div></div><div class="mc"><div class="ml">I</div><div class="mv vn">${bi.toFixed(0)}<span class="mu">–ê</span></div></div></div><table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U –ª–∏–Ω</th><th>U —Ñ–∞–∑</th></tr></thead><tbody><tr><td class="ph">A-B</td><td>${buab}</td><td>${bua}</td></tr><tr><td class="ph">B-C</td><td>${bubc}</td><td>${bub}</td></tr><tr><td class="ph">C-A</td><td>${buca}</td><td>${buc}</td></tr></tbody></table>`;
    }

    const sprm = $('sprm');
    if (sprm) {
        if (mN) {
            const mu = m.mains_uab != null ? m.mains_uab : '‚Äî';
            const mf = m.mains_freq != null ? m.mains_freq : '‚Äî';
            sprm.innerHTML = `<div class="mg"><div class="mc"><div class="ml">U —Å–µ—Ç–∏</div><div class="mv vn">${mu}<span class="mu">–í</span></div></div><div class="mc"><div class="ml">f —Å–µ—Ç–∏</div><div class="mv vn">${typeof mf === 'number' ? mf.toFixed(2) : mf}<span class="mu">–ì—Ü</span></div></div><div class="mc"><div class="ml">–°—Ç–∞—Ç—É—Å</div><div class="mv vg">–ù–û–†–ú–ê</div></div></div>`;
        } else {
            sprm.innerHTML = `<div class="mg"><div class="mc"><div class="ml">–°–µ—Ç—å</div><div class="mv va">–ê–í–ê–†–ò–Ø</div></div></div>`;
        }
    }

    const sprs = $('sprs');
    if (sprs) {
        sprs.innerHTML = `<div class="mg mg2"><div class="mc"><div class="ml">–ê–≤—Ç.—à–∏–Ω—ã</div><div class="mv ${bC?'vg':'vm'}">${bC?'–ó–ê–ú–ö–ù–£–¢':'–†–ê–ó–û–ú–ö–ù'}</div></div><div class="mc"><div class="ml">–ê–≤—Ç.—Å–µ—Ç–∏</div><div class="mv ${mC?'vb':'vm'}">${mC?'–ó–ê–ú–ö–ù–£–¢':'–†–ê–ó–û–ú–ö–ù'}</div></div><div class="mc"><div class="ml">–°–µ—Ç—å</div><div class="mv ${mN?'vg':'va'}">${mN?'–ù–û–†–ú–ê':'–ê–í–ê–†–ò–Ø'}</div></div><div class="mc"><div class="ml">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã</div><div class="mv ${gOn?'vg':'vm'}">${gOn?'–†–ê–ë–û–¢–ê':'–°–¢–û–ü'}</div></div></div>`;
    }
}

function updateSummary() {
    const s = S[cur];
    if (!s) return;

    // Collect powers from latestMetrics for all devices of current site
    let totalP = 0, genP = 0, mainsU = null, hasAlarm = false, hasWarning = false, running = 0;

    for (const [devId, m] of Object.entries(latestMetrics)) {
        const info = deviceSlotIndex[devId];
        if (!info || info.siteKey !== cur) continue;
        if (info.slot === 'g1' || info.slot === 'g2') {
            const p = m.power_total || 0;
            if (m.gen_status === 9) { genP += p; running++; }
            if (m.alarm_common || m.alarm_shutdown) hasAlarm = true;
            if (m.alarm_warning) hasWarning = true;
        }
        if (info.slot === 'spr') {
            totalP = m.busbar_p || 0;
            mainsU = m.mains_uab;
            if (m.alarm_common) hasAlarm = true;
        }
    }
    if (!totalP) totalP = genP;

    const el = n => document.getElementById(n);
    if (el('sP')) el('sP').innerHTML = `${totalP.toFixed(1)}<span class="su">–∫–í—Ç</span>`;
    if (el('sPg')) el('sPg').innerHTML = `${genP.toFixed(1)}<span class="su">–∫–í—Ç</span>`;
    if (el('sU')) el('sU').innerHTML = mainsU != null ? `${mainsU.toFixed(0)}<span class="su">–í</span>` : '‚Äî<span class="su">–í</span>';
    if (el('sG')) el('sG').innerHTML = `${running}<span class="su">/2</span>`;
    if (el('sSt')) {
        if (hasAlarm) el('sSt').innerHTML = '<span class="bdg bdg-a" onclick="scrollToAlarm()" style="cursor:pointer">‚óè –ê–≤–∞—Ä–∏—è</span>';
        else if (hasWarning) el('sSt').innerHTML = '<span class="bdg bdg-w" onclick="scrollToAlarm()" style="cursor:pointer">‚óè –ü—Ä–µ–¥—É–ø—Ä.</span>';
        else if (running > 0 || totalP > 0) el('sSt').innerHTML = '<span class="bdg bdg-ok">‚óè –ù–æ—Ä–º–∞</span>';
    }
}

function updateFlowFromMetrics() {
    const pf = $('pflow');
    if (!pf || !cur || !S[cur]) return;

    let g1on = false, g2on = false, mN = false, bC = false, mC = false, p1 = 0, p2 = 0;

    for (const [devId, m] of Object.entries(latestMetrics)) {
        const info = deviceSlotIndex[devId];
        if (!info || info.siteKey !== cur) continue;
        if (info.slot === 'g1') { g1on = m.gen_status === 9; p1 = m.power_total || 0; }
        if (info.slot === 'g2') { g2on = m.gen_status === 9; p2 = m.power_total || 0; }
        if (info.slot === 'spr') {
            mN = (m.mains_status === 0);
            bC = (m.busbar_switch === 3);
            mC = (m.mains_switch === 3);
        }
    }

    pf.innerHTML = flowSvg(g1on, g2on, mN, bC, mC, p1, p2);
}

function getDeviceIdForSlot(slot) {
    if (!cur || !S[cur]) return null;
    return S[cur][slot]?._deviceId || null;
}

// ===================== END API / WS LAYER =====================
const DEF_TPL={name:'–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π',intervals:[
{id:'to1',name:'–¢–û-1',hours:250,tasks:[{id:1,text:'–ó–∞–º–µ–Ω–∞ –º–æ—Ç–æ—Ä–Ω–æ–≥–æ –º–∞—Å–ª–∞',c:1},{id:2,text:'–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª—è–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞',c:1},{id:3,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –û–ñ',c:1},{id:4,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ç—è–∂–µ–Ω–∏—è —Ä–µ–º–Ω–µ–π',c:0},{id:5,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞',c:0},{id:6,text:'–û—Å–º–æ—Ç—Ä –Ω–∞ —É—Ç–µ—á–∫–∏',c:0},{id:7,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π –ø—Ä–∏–±–æ—Ä–æ–≤',c:0}]},
{id:'to2',name:'–¢–û-2',hours:500,tasks:[{id:1,text:'–ó–∞–º–µ–Ω–∞ –º–æ—Ç–æ—Ä–Ω–æ–≥–æ –º–∞—Å–ª–∞',c:1},{id:2,text:'–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª—è–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞',c:1},{id:3,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –û–ñ',c:1},{id:4,text:'–ó–∞–º–µ–Ω–∞ –≤–æ–∑–¥—É—à–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞',c:1},{id:5,text:'–ó–∞–º–µ–Ω–∞ —Ç–æ–ø–ª–∏–≤–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞',c:1},{id:6,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä—Å—É–Ω–æ–∫',c:0},{id:7,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è –º–∞—Å–ª–∞',c:0},{id:8,text:'–°–ª–∏–≤ –æ—Ç—Å—Ç–æ—è –∏–∑ –±–∞–∫–∞',c:0}]},
{id:'to3',name:'–¢–û-3',hours:1000,tasks:[{id:1,text:'–ó–∞–º–µ–Ω–∞ –º–æ—Ç–æ—Ä–Ω–æ–≥–æ –º–∞—Å–ª–∞',c:1},{id:2,text:'–ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤',c:1},{id:3,text:'–ó–∞–º–µ–Ω–∞ –û–ñ –ø–æ–ª–Ω–æ—Å—Ç—å—é',c:1},{id:4,text:'–ü—Ä–æ–º—ã–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è',c:1},{id:5,text:'–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –∫–ª–∞–ø–∞–Ω–Ω—ã—Ö –∑–∞–∑–æ—Ä–æ–≤',c:1},{id:6,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏',c:1},{id:7,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—É—Ä–±–æ–∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞',c:0},{id:8,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —Å—Ç–∞—Ä—Ç–µ—Ä–∞',c:0},{id:9,text:'–û—á–∏—Å—Ç–∫–∞ —Ä–∞–¥–∏–∞—Ç–æ—Ä–∞',c:0}]},
{id:'to4',name:'–¢–û-4',hours:2000,tasks:[{id:1,text:'–í—Å–µ —Ä–∞–±–æ—Ç—ã –¢–û-3',c:1},{id:2,text:'–ó–∞–º–µ–Ω–∞ —Ä–µ–º–Ω—è –ì–†–ú',c:1},{id:3,text:'–ó–∞–º–µ–Ω–∞ –≤–æ–¥—è–Ω–æ–≥–æ –Ω–∞—Å–æ—Å–∞',c:1},{id:4,text:'–ó–∞–º–µ–Ω–∞ –ø—Ä–∏–≤–æ–¥–Ω—ã—Ö —Ä–µ–º–Ω–µ–π',c:1},{id:5,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–æ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è',c:0},{id:6,text:'–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≠–ë–£',c:0},{id:7,text:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤',c:0},{id:8,text:'–ü–æ–ª–Ω—ã–π –æ—Å–º–æ—Ç—Ä',c:1}]}
]};
function getTpl(){try{const raw=localStorage.getItem('s5tpl');return raw?JSON.parse(raw):JSON.parse(JSON.stringify(DEF_TPL))}catch(e){return JSON.parse(JSON.stringify(DEF_TPL))}}
function saveTpl(t){localStorage.setItem('s5tpl',JSON.stringify(t))}
function getTOData(site,dev){try{return JSON.parse(localStorage.getItem('s5to_'+site+'_'+dev))||{hoursAtLastTO:0,lastTOId:null,history:[]}}catch(e){return{hoursAtLastTO:0,lastTOId:null,history:[]}}}
function saveTOData(site,dev,d){localStorage.setItem('s5to_'+site+'_'+dev,JSON.stringify(d))}
function getNextTO(rh,site,dev){
const tpl=getTpl(),td=getTOData(site||'',dev||''),lastH=td.hoursAtLastTO||0;
// –ï—Å–ª–∏ –º–æ—Ç–æ—á–∞—Å—ã 0 –∏ –Ω–∏—á–µ–≥–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –ø–µ—Ä–≤–æ–µ –¢–û
if(rh<=0&&lastH<=0)return{name:tpl.intervals[0]?.name||'–¢–û-1',hours:tpl.intervals[0]?.hours||250,remain:tpl.intervals[0]?.hours||250,pct:0,tasks:tpl.intervals[0]?.tasks||[],since:0,dueAt:tpl.intervals[0]?.hours||250,unknown:false};
// –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∞ –º–æ—Ç–æ—á–∞—Å—ã —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
if(!td.lastTOId&&rh>0)return{name:'–¢–û-?',hours:0,remain:0,pct:0,tasks:[],since:rh,dueAt:0,unknown:true};
const sorted=[...tpl.intervals].sort((a,b)=>a.hours-b.hours);
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¢–û –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ (–∫–∞–∫–æ–π —Å–∞–º—ã–π —Å—Ç–∞—Ä—à–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–µ–ª–∏—Ç —Ç–æ—á–∫—É)
function toTypeAtPoint(pt){for(let i=sorted.length-1;i>=0;i--){if(pt>0&&pt%sorted[i].hours===0)return sorted[i]}return sorted[0]}
// –ë–ª–∏–∂–∞–π—à–∞—è —Å–ª–µ–¥—É—é—â–∞—è —Ç–æ—á–∫–∞ –¢–û (–ª—é–±–æ–≥–æ —Ç–∏–ø–∞) > lastH
const minH=sorted[0]?.hours||250;
// –°—á–∏—Ç–∞–µ–º –æ—Ç lastH ‚Äî –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ –ø–æ—Å–ª–µ lastH
let nextPoint=minH>0?Math.ceil(Math.max(lastH+1,1)/minH)*minH:250;
// –ï—Å–ª–∏ nextPoint —É–∂–µ –ø–æ–∑–∞–¥–∏ rh ‚Äî –ø—Ä–æ—Å—Ä–æ—á–∫–∞
if(nextPoint<rh){
// –ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ ‚Äî –Ω–∞–π–¥—ë–º —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –Ω–µ–ø—Ä–æ–π–¥–µ–Ω–Ω—É—é
const overdueIv=toTypeAtPoint(nextPoint);
const overdueH=rh-nextPoint;
return{...overdueIv,remain:-overdueH,pct:100,since:rh-lastH,_prevP:nextPoint,dueAt:nextPoint,unknown:false}
}
const nextIv=toTypeAtPoint(nextPoint);
const remain=nextPoint-rh;
const totalSpan=nextPoint-lastH;
const progress=totalSpan>0?Math.min(100,Math.max(0,Math.round((rh-lastH)/totalSpan*100))):0;
return{...nextIv,remain,pct:progress,since:rh-lastH,_nextP:nextPoint,dueAt:nextPoint,unknown:false}
}
function sv(){localStorage.setItem('s5s',JSON.stringify(S));localStorage.setItem('s5c',cur||'')}
function esc(s){const d=document.createElement('div');d.textContent=s==null?'':String(s);return d.innerHTML}
function ae(m){evts.unshift({t:now(),m});if(evts.length>40)evts.pop()}
function showM(n){$('m-'+n).classList.add('sh')}function hideM(n){$('m-'+n).classList.remove('sh')}
document.querySelectorAll('.mbg').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('sh')}));
function R(a,b){return+(a+Math.random()*(b-a)).toFixed(1)}function RI(a,b){return Math.floor(a+Math.random()*(b-a))}
function now(){return new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}
function renderSB(){const k=Object.keys(S);$('sbSites').innerHTML=k.length?k.map(id=>`<div class="si ${id===cur?'on':''}" onclick="sel('${id}')"><div class="si-dot" style="background:${id===cur?'var(--g)':'var(--t4)'}"></div><span class="si-name">${esc(S[id].name)}</span><div class="si-acts"><button class="si-btn" onclick="event.stopPropagation();openEdit('${id}')">‚úè</button><button class="si-btn del" onclick="event.stopPropagation();openDel('${id}')">‚úï</button></div></div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--t3);font-size:12px">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤</div>'}
function sel(id){cur=id;sv();renderSB();renderDash()}
function openAddSite(){editId=null;$('smT').textContent='–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç';$('fN').value='';$('fC').value='';$('fC').disabled=false;$('fD').value='';populateRespSelect('');$('smA').innerHTML='<button class="bp" onclick="saveSite()">–°–æ–∑–¥–∞—Ç—å</button>';showM('site')}
function openEdit(id){editId=id;const s=S[id];$('smT').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: '+s.name;$('fN').value=s.name;$('fC').value=id;$('fC').disabled=true;$('fD').value=s.desc||'';populateRespSelect(s.responsible||'');$('smA').innerHTML=`<div style="display:flex;gap:8px"><button class="bp" style="flex:1" onclick="saveSite()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="bdn" style="flex:0;padding:10px 16px" onclick="hideM('site');openDel('${id}')">üóë</button></div>`;showM('site')}
async function saveSite(){const n=$('fN').value.trim(),c=$('fC').value.trim().toLowerCase().replace(/[^a-z0-9_-]/g,''),d=$('fD').value.trim(),resp=$('fResp').value;if(!n||!c){ae('‚ö† –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥');return}if(!editId&&S[c]){ae('‚ö† –û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ¬´'+c+'¬ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');return}if(editId){S[editId].name=n;S[editId].desc=d;S[editId].responsible=resp;ae('‚úè '+n);
// API: update site
if(apiAvailable&&siteApiIds[editId]){try{await api.patch('/api/sites/'+siteApiIds[editId],{name:n,description:d})}catch(e){console.warn('API update site error:',e)}}
}else{S[c]={name:n,desc:d,responsible:resp,g1:{},g2:{},spr:{}};cur=c;ae('‚úÖ '+n+' —Å–æ–∑–¥–∞–Ω');
// API: create site
if(apiAvailable){try{const s=await api.post('/api/sites',{name:n,code:c,network:'modbus',description:d});siteApiIds[c]=s.id;S[c]._apiId=s.id}catch(e){console.warn('API create site error:',e)}}
}$('fC').disabled=false;sv();hideM('site');renderSB();renderDash()}
function populateRespSelect(selectedId){populateRespSelectById('fResp',selectedId)}
function populateRespSelectById(selId,selectedId){const sel=$(selId);if(!sel)return;const users=getBxUsers();sel.innerHTML='<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>';for(var i=0;i<users.length;i++){var u=users[i];sel.innerHTML+='<option value="'+u.id+'"'+(u.id===selectedId?' selected':'')+'>'+esc(u.name)+(u.dept?' ('+esc(u.dept)+')':'')+'</option>'}if(!users.length)sel.innerHTML+='<option disabled>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –ë24 –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</option>'}
function openDel(id){delId=id;$('delN').textContent=S[id]?.name||id;showM('del')}
async function doDel(){if(!delId)return;const dName=S[delId]?.name||delId;
// API: delete site (cascade deletes devices)
if(apiAvailable&&siteApiIds[delId]){try{await api.del('/api/sites/'+siteApiIds[delId]);delete siteApiIds[delId]}catch(e){console.warn('API delete site error:',e)}}
delete S[delId];if(cur===delId)cur=Object.keys(S)[0]||null;
localStorage.removeItem('s5to_'+delId+'_g1');localStorage.removeItem('s5to_'+delId+'_g2');
localStorage.removeItem('s5alm_'+delId+'_g1');localStorage.removeItem('s5alm_'+delId+'_g2');localStorage.removeItem('s5alm_'+delId+'_spr');
localStorage.removeItem('s5_spr_backups_'+delId);
ae('üóë '+dName+' —É–¥–∞–ª—ë–Ω');sv();hideM('del');renderSB();renderDash();delId=null}
// === TABBED SETTINGS ===
function openSet(){if(!cur||!S[cur])return;const s=S[cur];
$('setTitle').textContent='‚öô '+s.name+' ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
$('setBody').innerHTML=`<div class="set-tabs"><button class="set-tab on" onclick="setTab(this,0)">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1</button><button class="set-tab" onclick="setTab(this,1)">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2</button><button class="set-tab" onclick="setTab(this,2)">–®–ü–†</button><button class="set-tab" onclick="setTab(this,3)">–û–±—ä–µ–∫—Ç</button></div>
<div class="set-panel on" id="sp0"><div class="cfs"><div class="cft"><span class="dot dot-g"></span>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1 ‚Äî HGM9520N<span class="conn-test" onclick="testConn('g1')">üîå –¢–µ—Å—Ç</span></div>
<div class="fr2"><div class="fg"><label class="fl">IP-–∞–¥—Ä–µ—Å <span class="req">*</span></label><input class="fi" id="cg1i" value="${esc(s.g1?.ip||'')}" placeholder="192.168.97.10"></div><div class="fg"><label class="fl">–ü–æ—Ä—Ç Modbus TCP</label><input class="fi" id="cg1p" value="${s.g1?.port||502}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">Slave ID</label><input class="fi" id="cg1s" value="${s.g1?.slaveId||1}" type="number"></div><div class="fg"><label class="fl">–ú–æ—Ç–æ—á–∞—Å—ã</label><input class="fi" id="cg1h" value="${s.g1?.runHours||0}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û</label><select class="fi" id="cg1lt"><option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>${getTpl().intervals.map(iv=>`<option value="${iv.id}"${(getTOData(cur,'g1').lastTOId===iv.id)?' selected':''}>${iv.name}</option>`).join('')}</select></div><div class="fg"><label class="fl">–ü—Ä–∏ –º–æ—Ç–æ—á–∞—Å–∞—Ö</label><input class="fi" id="cg1lth" value="${getTOData(cur,'g1').hoursAtLastTO||0}" type="number" placeholder="0"></div></div>
<button class="bp" style="margin-top:8px;width:100%;background:var(--bg4);border:1px solid var(--bd);color:var(--t2);font-size:12px;padding:8px 0" onclick="testConn('g1')">üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º</button><div id="g1test"></div></div></div>
<div class="set-panel" id="sp1"><div class="cfs"><div class="cft"><span class="dot dot-g"></span>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2 ‚Äî HGM9520N<span class="conn-test" onclick="testConn('g2')">üîå –¢–µ—Å—Ç</span></div>
<div class="fr2"><div class="fg"><label class="fl">IP-–∞–¥—Ä–µ—Å <span class="req">*</span></label><input class="fi" id="cg2i" value="${esc(s.g2?.ip||'')}" placeholder="192.168.97.11"></div><div class="fg"><label class="fl">–ü–æ—Ä—Ç Modbus TCP</label><input class="fi" id="cg2p" value="${s.g2?.port||502}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">Slave ID</label><input class="fi" id="cg2s" value="${s.g2?.slaveId||1}" type="number"></div><div class="fg"><label class="fl">–ú–æ—Ç–æ—á–∞—Å—ã</label><input class="fi" id="cg2h" value="${s.g2?.runHours||0}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û</label><select class="fi" id="cg2lt"><option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>${getTpl().intervals.map(iv=>`<option value="${iv.id}"${(getTOData(cur,'g2').lastTOId===iv.id)?' selected':''}>${iv.name}</option>`).join('')}</select></div><div class="fg"><label class="fl">–ü—Ä–∏ –º–æ—Ç–æ—á–∞—Å–∞—Ö</label><input class="fi" id="cg2lth" value="${getTOData(cur,'g2').hoursAtLastTO||0}" type="number" placeholder="0"></div></div>
<button class="bp" style="margin-top:8px;width:100%;background:var(--bg4);border:1px solid var(--bd);color:var(--t2);font-size:12px;padding:8px 0" onclick="testConn('g2')">üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º</button><div id="g2test"></div></div></div>
<div class="set-panel" id="sp2"><div class="cfs"><div class="cft"><span class="dot dot-p"></span>–®–ü–† ‚Äî HGM9560 (RS-485‚ÜíEthernet)<span class="conn-test" onclick="testConn('spr')">üîå –¢–µ—Å—Ç</span></div>
<div class="fr2"><div class="fg"><label class="fl">IP –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞ <span class="req">*</span></label><input class="fi" id="csi" value="${esc(s.spr?.ip||'')}" placeholder="10.11.0.2"></div><div class="fg"><label class="fl">–ü–æ—Ä—Ç</label><input class="fi" id="csp" value="${s.spr?.port||26}" type="number"></div></div>
<div class="fr2"><div class="fg"><label class="fl">Slave ID</label><input class="fi" id="css" value="${s.spr?.slaveId||1}" type="number"></div><div class="fg"><label class="fl">–ü—Ä–æ—Ç–æ–∫–æ–ª</label><div style="padding:9px 12px;background:var(--bg);border:1px solid var(--bd);border-radius:var(--rs);font-size:13px;color:var(--t3)">RTU 9600/8N2</div></div></div><button class="bp" style="margin-top:8px;width:100%;background:var(--bg4);border:1px solid var(--bd);color:var(--t2);font-size:12px;padding:8px 0" onclick="testConn('spr')">üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º</button><div id="sprtest"></div></div></div>
<div class="set-panel" id="sp3"><div class="cfs"><div class="cft"><span class="dot dot-g"></span>–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div class="fg"><label class="fl">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="fi" id="csn" value="${esc(s.name)}"></div>
<div class="fg"><label class="fl">–û–ø–∏—Å–∞–Ω–∏–µ</label><input class="fi" id="csd" value="${esc(s.desc||'')}"></div>
<div class="fg"><label class="fl">–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ (–º—Å)</label><input class="fi" id="csi2" value="${s.pollInterval||2000}" type="number"></div>
<div class="fg"><label class="fl">üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¢–û</label><select class="fi" id="csResp" style="padding:8px 10px"></select></div></div></div>
<button class="bp" style="margin-top:4px" onclick="saveSet()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;showM('settings');populateRespSelectById('csResp',s.responsible||'')}
function setTab(btn,idx){btn.closest('.mbd').querySelectorAll('.set-tab').forEach(b=>b.classList.remove('on'));btn.closest('.mbd').querySelectorAll('.set-panel').forEach(p=>p.classList.remove('on'));btn.classList.add('on');$('sp'+idx)?.classList.add('on')}
async function testConn(dev){const el=$(dev+'test');el.innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y);font-family:var(--m);margin-top:6px">‚è≥ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>';
const s=S[cur];if(!s)return;
let ip='',port=502,slaveId=1,proto='tcp';
if(dev==='g1'){ip=$('cg1i')?.value||s.g1?.ip||'';port=+($('cg1p')?.value)||502;slaveId=+($('cg1s')?.value)||1;proto='tcp'}
else if(dev==='g2'){ip=$('cg2i')?.value||s.g2?.ip||'';port=+($('cg2p')?.value)||502;slaveId=+($('cg2s')?.value)||1;proto='tcp'}
else if(dev==='spr'){ip=$('csi')?.value||s.spr?.ip||'';port=+($('csp')?.value)||26;slaveId=+($('css')?.value)||1;proto='rtu_over_tcp'}
if(!ip){el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r);font-family:var(--m);margin-top:6px">–£–∫–∞–∂–∏—Ç–µ IP-–∞–¥—Ä–µ—Å</div>';return}
try{const r=await api.post('/api/devices/test-connection',{ip_address:ip,port:port,slave_id:slaveId,protocol:proto});
if(r.success){el.innerHTML=`<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m);margin-top:6px">‚úÖ ${r.message}</div>`}
else{el.innerHTML=`<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r);font-family:var(--m);margin-top:6px">‚ùå ${r.message}</div>`}
}catch(e){el.innerHTML=`<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r);font-family:var(--m);margin-top:6px">‚ùå ${e.message}</div>`}}
async function saveSet(){const s=S[cur];s.g1={...s.g1,ip:$('cg1i').value.trim(),port:+$('cg1p').value||502,slaveId:+$('cg1s').value||1,runHours:+$('cg1h').value||0};s.g2={...s.g2,ip:$('cg2i').value.trim(),port:+$('cg2p').value||502,slaveId:+$('cg2s').value||1,runHours:+$('cg2h').value||0};s.spr={...s.spr,ip:$('csi').value.trim(),port:+$('csp').value||26,slaveId:+$('css').value||1};s.name=$('csn')?.value.trim()||s.name;s.desc=$('csd')?.value.trim()||'';s.responsible=$('csResp')?.value||s.responsible||'';s.pollInterval=+$('csi2')?.value||2000;
// Save last TO data for G1/G2
for(const sl of['g1','g2']){const ltSel=$('c'+sl+'lt'),lthInp=$('c'+sl+'lth');if(ltSel){const td=getTOData(cur,sl);const newId=ltSel.value||null;const newH=+(lthInp?.value)||0;if(newId!==td.lastTOId||newH!==td.hoursAtLastTO){td.lastTOId=newId;td.hoursAtLastTO=newH;saveTOData(cur,sl,td)}}}
sv();
// API: sync devices
if(apiAvailable&&siteApiIds[cur]){const siteId=siteApiIds[cur];try{
// Update site name/desc
await api.patch('/api/sites/'+siteId,{name:s.name,description:s.desc});
// Sync each device slot
for(const [slot,dtype,proto] of [['g1','generator','tcp'],['g2','generator','tcp'],['spr','ats','rtu_over_tcp']]){
const d=s[slot];if(!d?.ip)continue;
if(d._deviceId){await api.patch('/api/devices/'+d._deviceId,{ip_address:d.ip,port:d.port,slave_id:d.slaveId||1,name:slot==='spr'?'–®–ü–†':('–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä '+(slot==='g1'?'1':'2'))})}
else{const created=await api.post('/api/devices',{site_id:siteId,name:slot==='spr'?'–®–ü–†':('–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä '+(slot==='g1'?'1':'2')),device_type:dtype,ip_address:d.ip,port:d.port,slave_id:d.slaveId||1,protocol:proto});
d._deviceId=created.id;deviceSlotIndex[created.id]={siteKey:cur,slot}}
}}catch(e){console.warn('API sync devices error:',e)}}
ae('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');hideM('settings');renderSB();renderDash()}
function cmdConfirm(target,cmd,label,info){$('cmdT').textContent='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: '+label;$('cmdTxt').innerHTML=`–ö–æ–º–∞–Ω–¥–∞ <b>${label}</b> ‚Üí <b>${target}</b>`;$('cmdInfo').textContent=info||'Modbus FC05';$('cmdOk').onclick=async()=>{hideM('cmd');
const cs=$('cs-'+target.replace(/[\s\/]/g,''));
// Resolve device_id and command params
let deviceId=null,fc=5,addr=0,val=1;
if(target.includes('–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1'))deviceId=getDeviceIdForSlot('g1');
else if(target.includes('–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2'))deviceId=getDeviceIdForSlot('g2');
else if(target==='–®–ü–†')deviceId=getDeviceIdForSlot('spr');
// Parse FC and address from info string
const fcMatch=info?.match(/FC0?(\d)/);if(fcMatch)fc=parseInt(fcMatch[1]);
const addrMatch=info?.match(/0x([0-9A-Fa-f]+)/);if(addrMatch)addr=parseInt(addrMatch[1],16);
const regMatch=info?.match(/reg\s+(\d+)/);if(regMatch)addr=parseInt(regMatch[1]);
// For FC06, parse value from cmd or info
if(fc===6){
const valMatch=info?.match(/‚Üê\s*(\d+)/);if(valMatch)val=parseInt(valMatch[1]);
else if(cmd.includes('LoadMode=')){val=parseInt(cmd.split('=')[1])||0}
else if(cmd==='SetPQ'){
// Send P and Q as separate commands
const pv=+($('sprPslider')?.value||500),qv=+($('sprQslider')?.value||500);
if(apiAvailable&&deviceId){try{
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4352,value:pv});
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4354,value:qv});
if(cs){cs.textContent='‚úÖ P/Q –∑–∞–ø–∏—Å–∞–Ω—ã';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}
ae(`‚ö° FC06 P=${pv/10}% Q=${qv/10}% ‚Üí ${target}`);return}catch(e){ae(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`);if(cs){cs.textContent='‚ùå –û—à–∏–±–∫–∞';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}return}}}
}
if(cmd.startsWith('Preset:')){
// Preset: send 3 commands (LoadMode, P, Q)
const P={island:{m:0,p:1000,q:500},genres:{m:0,p:800,q:500},peak:{m:1,p:300,q:500},parallel:{m:2,p:500,q:500},export:{m:0,p:800,q:300},mains:{m:1,p:0,q:0},test:{m:0,p:200,q:200}};
const pn=cmd.split(':')[1],pr=P[pn];
if(apiAvailable&&deviceId&&pr){try{
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4351,value:pr.m});
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4352,value:pr.p});
await api.post('/api/commands',{device_id:deviceId,function_code:6,address:4354,value:pr.q});
if(cs){cs.textContent='‚úÖ –ü—Ä–µ—Å–µ—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}
ae(`‚ö° –ü—Ä–µ—Å–µ—Ç ${pn} ‚Üí ${target}`);return}catch(e){ae(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`)}}
}
// Standard FC05 or FC06 command
if(apiAvailable&&deviceId){try{
const resp=await api.post('/api/commands',{device_id:deviceId,function_code:fc,address:addr,value:fc===5?1:val});
ae(`‚ö° ${cmd} ‚Üí ${target}`);if(cs){cs.textContent='‚úÖ '+label+' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}
}catch(e){ae(`‚ùå ${cmd} ‚Üí ${target}: ${e.message}`);if(cs){cs.textContent='‚ùå –û—à–∏–±–∫–∞';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}}}
else{ae(`‚ö° ${cmd} ‚Üí ${target}`);if(cs){cs.textContent='‚úÖ '+label+' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';cs.classList.add('sh');setTimeout(()=>cs.classList.remove('sh'),3000)}}
};showM('cmd')}
// TO
function openTO(dev){if(!cur)return;const s=S[cur],c=dev==='g1'?s.g1:s.g2,rh=c?.runHours||0;const tpl=getTpl(),td=getTOData(cur,dev);
const to=getNextTO(rh,cur,dev);
const lastName=td.lastTOId?tpl.intervals.find(iv=>iv.id===td.lastTOId)?.name||td.lastTOId:'–Ω–µ —É–∫–∞–∑–∞–Ω–æ';
const lastH=td.hoursAtLastTO||0;
const isOverdue=to.remain<0;
const col=isOverdue?'var(--r)':to.remain<=20?'var(--y)':'var(--g)';
const bgd=isOverdue?'var(--rd)':'var(--bg4)';
const brd=isOverdue?'rgba(255,64,96,.2)':'transparent';
// –í—Å–µ —Ç–æ—á–∫–∏ –¢–û –≤ —Ü–∏–∫–ª–µ
const sorted=[...tpl.intervals].sort((a,b)=>a.hours-b.hours);
const minH=sorted[0]?.hours||250;
const maxH=sorted[sorted.length-1]?.hours||2000;
let schedule=[];
for(let h=minH;h<=maxH;h+=minH){let best=sorted[0];for(let i=sorted.length-1;i>=0;i--){if(h%sorted[i].hours===0){best=sorted[i];break}}
schedule.push({name:best.name,hours:h})}
let histH=td.history?.length?td.history.slice(0,8).map(h=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--bd);font-size:11px"><span>${h.type} ¬∑ ${h.hours}—á ${h.done?'<span style="color:var(--g)">‚úì'+h.done+'/'+h.total+'</span>':''}</span><span style="color:var(--t4)">${h.date}</span></div>`).join(''):'<div style="color:var(--t4);font-size:11px;padding:10px;text-align:center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
$('toT').textContent=(dev==='g1'?'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1':'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2')+' ‚Äî –¢–û';
$('toBody').innerHTML=`<div style="text-align:center;padding:18px;background:var(--bg4);border-radius:10px;margin-bottom:14px"><div style="font-size:11px;color:var(--t3)">–ú–æ—Ç–æ—á–∞—Å—ã</div><div style="font-size:30px;font-weight:700;font-family:var(--m)">${rh} <span style="font-size:14px;color:var(--t3)">—á</span></div><div style="font-size:10px;color:var(--t4)">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û: ${lastName}${lastH?' –ø—Ä–∏ '+lastH+'—á':''}</div></div>
${to.unknown?`<div style="padding:14px;background:var(--yd);border:1px solid rgba(255,186,0,.2);border-radius:8px;margin-bottom:10px;text-align:center"><div style="font-size:13px;color:var(--y);font-weight:600;margin-bottom:6px">‚ö† –£–∫–∞–∂–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û</div><div style="font-size:11px;color:var(--t3);margin-bottom:10px">–ß—Ç–æ–±—ã —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ –¢–û, –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–∞–∫–æ–µ –¢–û –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –º–æ—Ç–æ—á–∞—Å–∞—Ö.</div><button class="bp" style="padding:8px 24px" onclick="hideM('to');openSet()">‚öô –û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button></div>`:`${isOverdue?`<div style="padding:10px 12px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:8px;margin-bottom:10px"><div style="font-size:12px;color:var(--r);font-weight:600">‚ö† ${to.name} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(to.remain)}—á</div><div style="font-size:10px;color:var(--t3);margin-top:2px">–ë—ã–ª–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∏ ${to.dueAt||'?'}—á ¬∑ –¢–µ–∫—É—â–∏–µ: ${rh}—á</div></div>`:''}
<div style="padding:10px 12px;background:${bgd};border:1px solid ${brd};border-radius:8px;margin-bottom:10px">
<div style="display:flex;justify-content:space-between;margin-bottom:6px"><b style="font-size:12px;color:${col}">${isOverdue?'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+to.name:'–°–ª–µ–¥—É—é—â–µ–µ: '+to.name}</b><span style="font-size:11px;color:${col};font-family:var(--m)">${isOverdue?'‚Äî':to.remain+'—á –æ—Å—Ç.'}</span></div>
<div class="to-iv-bar"><div class="to-iv-fill" style="width:${to.pct}%;background:${col}"></div></div>
<div style="font-size:10px;color:var(--t3);margin-top:4px">${to.tasks?.slice(0,5).map(t=>'‚Ä¢ '+(t.c?'<b>':'')+t.text+(t.c?'</b>':'')).join('<br>')||''}</div>
</div>`}
<div style="font-size:11px;color:var(--t3);margin-bottom:6px">–¶–∏–∫–ª –¢–û (–∫–∞–∂–¥—ã–µ ${maxH}—á)</div>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">${schedule.map(s=>`<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:var(--bg4);color:var(--t3);font-family:var(--m)">${s.name} ${s.hours}—á</span>`).join('')}</div>
<div style="padding:12px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:10px"><div style="font-size:12px;color:var(--g);font-weight:600;margin-bottom:8px">–ü—Ä–æ–≤–µ—Å—Ç–∏ –¢–û</div><div style="display:flex;gap:6px"><select class="fi" id="toSel" style="flex:1;padding:7px 8px">${tpl.intervals.map((iv,i)=>`<option value="${i}"${iv.id===to.id?' selected':''}>${iv.name} (${iv.hours}—á)</option>`).join('')}</select><button class="bp" style="width:auto;padding:8px 20px" onclick="openChecklist('${dev}')">–ù–∞—á–∞—Ç—å</button></div><button class="bs2" style="width:100%;margin-top:6px;padding:7px;font-size:11px;color:var(--b)" onclick="createBxTaskFromTO('${dev}')">üìã –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ –ë–∏—Ç—Ä–∏–∫—Å24</button></div>
<div style="font-size:11px;color:var(--t3);margin-top:14px;margin-bottom:6px">–ò—Å—Ç–æ—Ä–∏—è</div>${histH}`;showM('to')}
function openChecklist(dev){const tpl=getTpl(),idx=+$('toSel').value,iv=tpl.intervals[idx],rh=S[cur]?.[dev]?.runHours||0;$('toT').textContent=iv.name+' ‚Äî –ß–µ–∫–ª–∏—Å—Ç';
$('toBody').innerHTML=`<div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg4);border-radius:8px;font-size:12px;margin-bottom:12px"><span>–ú–æ—Ç–æ—á–∞—Å—ã:</span><b style="font-family:var(--m)">${rh} —á</b></div>
<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:11px;color:var(--t3)">–†–∞–±–æ—Ç—ã</span><button onclick="document.querySelectorAll('.chk-cb').forEach(c=>c.checked=true)" style="font-size:10px;color:var(--g);background:none;border:none;cursor:pointer">–í—Å–µ</button></div>
<div style="max-height:300px;overflow-y:auto">${iv.tasks.map((t,i)=>`<label class="chk-item ${t.c?'crit':''}"><input type="checkbox" class="chk-cb" id="chk${i}"><span>${t.text}${t.c?'<span style="color:var(--r);font-size:9px;margin-left:4px">–æ–±—è–∑–∞—Ç.</span>':''}</span></label>`).join('')}</div>
<div style="padding:8px;background:var(--yd);border-radius:6px;font-size:10px;color:var(--y);margin-top:8px">‚ö† –°—á—ë—Ç—á–∏–∫ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω</div>
<div style="display:flex;gap:8px;margin-top:12px"><button class="bp" style="flex:1" onclick="completeTO('${dev}',${idx})">‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button><button class="bs2" style="flex:1;padding:10px" onclick="openTO('${dev}')">–ù–∞–∑–∞–¥</button></div>`}
function completeTO(dev,idx){const tpl=getTpl(),iv=tpl.intervals[idx],rh=S[cur]?.[dev]?.runHours||0;const cbs=document.querySelectorAll('.chk-cb');let done=0;cbs.forEach(c=>{if(c.checked)done++});const td=getTOData(cur,dev);td.hoursAtLastTO=rh;td.lastTOId=iv.id;td.history=td.history||[];td.history.unshift({type:iv.name,hours:rh,done,total:cbs.length,date:new Date().toLocaleDateString('ru-RU')});saveTOData(cur,dev,td);ae(`‚úÖ ${iv.name} ${dev==='g1'?'G1':'G2'}: ${done}/${cbs.length}`);hideM('to');renderDash()}
async function openTOTemplates(){const tpl=getTpl();const bxCfg=getBxConfig();const bxOk=!!bxCfg.url;
let aiOk=false;let aiProv='';let aiModel='';if(apiAvailable){try{const ah=await api.get('/api/ai/health');aiOk=ah&&ah.available;aiProv=ah?.provider||'';aiModel=ah?.model||''}catch(e){}}
var localAi=getAIConfig();var localProv=localAi.provider||'';var localHasKey=!!(localAi.keys&&localAi.keys[localProv]);
var provName=localProv?((AI_PROVIDERS[localProv]||{}).name||localProv):'';var provIcon=localProv?((AI_PROVIDERS[localProv]||{}).icon||'ü§ñ'):'ü§ñ';
$('tplT').textContent='üìã –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã –¢–û';$('tplBody').innerHTML=`
<div style="padding:10px;background:${bxOk?'rgba(0,224,154,.04)':'rgba(255,176,32,.04)'};border:1px solid ${bxOk?'rgba(0,224,154,.15)':'rgba(255,176,32,.15)'};border-radius:8px;margin-bottom:12px">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
<span style="font-size:12px;font-weight:600;color:${bxOk?'var(--g)':'var(--y)'}">${bxOk?'üîó –ë–∏—Ç—Ä–∏–∫—Å24 –ø–æ–¥–∫–ª—é—á—ë–Ω':'‚ö† –ë–∏—Ç—Ä–∏–∫—Å24 –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω'}</span>
<button class="bs2" style="padding:4px 10px;font-size:10px" onclick="hideM('tpl');initBxModal();showM('bitrix')">${bxOk?'‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏':'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å'}</button>
</div>
<div style="font-size:10px;color:var(--t3);line-height:1.5">
${bxOk&&(aiOk||localHasKey)?`<b style="color:var(--p)">${provIcon} AI-–∏–º–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (${aiProv?provName+' ¬∑ '+aiModel:provName})</b> ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–∞–Ω—É–∞–ª –î–ì–£ –Ω–∞ –î–∏—Å–∫ –ë24, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ò–º–ø–æ—Ä—Ç –∏–∑ –º–∞–Ω—É–∞–ª–∞¬ª.<br>–ò–ò-–∞–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á—ë—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¢–û, —á–µ–∫–ª–∏—Å—Ç—ã —Ä–∞–±–æ—Ç –∏ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å.`:bxOk&&!aiOk?`<b style="color:var(--y)">‚ö† AI-–∞–≥–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</b> ‚Äî <a href="#" onclick="event.preventDefault();hideM('tpl');initAIModal();showM('aiconf')" style="color:var(--p);text-decoration:underline">–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</a> (OpenAI, Claude, Gemini, Grok).`:'–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ë–∏—Ç—Ä–∏–∫—Å24 –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ –¢–û –∏–∑ –º–∞–Ω—É–∞–ª–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ò–ò-–∞–≥–µ–Ω—Ç.'}
</div>
${bxOk?`<div style="display:flex;gap:6px;margin-top:8px"><button class="bpp" style="flex:1;padding:7px 10px;font-size:11px" onclick="hideM('tpl');initBxModal();showM('bitrix');setTimeout(()=>bxTab(document.querySelectorAll('.set-tab')[2],2),100)">ü§ñ –ò–º–ø–æ—Ä—Ç –∏–∑ –º–∞–Ω—É–∞–ª–∞</button></div>`:''}
</div>
<div style="font-size:11px;color:var(--t3);margin-bottom:6px;font-weight:500">–¢–µ–∫—É—â–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (${tpl.intervals.length})</div>
<div style="margin-bottom:10px">${tpl.intervals.map((iv,i)=>`<div class="to-iv" style="display:flex;align-items:center;gap:8px"><div style="flex:1"><div style="display:flex;justify-content:space-between"><b>${iv.name}</b><span style="font-size:11px;color:var(--t3);font-family:var(--m)">${iv.hours}—á ¬∑ ${iv.tasks.length} —Ä–∞–±–æ—Ç</span></div></div><button class="bk-btn del" onclick="delTOInterval(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button></div>`).join('')}</div>
<div style="display:flex;gap:8px;margin-bottom:8px"><button class="bp" style="flex:1" onclick="editTemplates()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="bs2" style="flex:0;padding:10px 16px" onclick="addTOInterval()">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
<button class="bs2" style="width:100%" onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º?')){localStorage.removeItem('s5tpl');openTOTemplates()}">–°–±—Ä–æ—Å–∏—Ç—å</button>`;showM('tpl')}
function addTOInterval(){const tpl=getTpl();const num=tpl.intervals.length+1;tpl.intervals.push({id:'to_'+Date.now(),name:'–¢–û-'+num,hours:num*500,tasks:[{id:1,text:'–û—Å–º–æ—Ç—Ä',c:0}]});saveTpl(tpl);ae('+ –¢–û-'+num+' –¥–æ–±–∞–≤–ª–µ–Ω');editTemplates()}
function delTOInterval(idx){const tpl=getTpl();if(tpl.intervals.length<=1)return;const name=tpl.intervals[idx].name;if(!confirm('–£–¥–∞–ª–∏—Ç—å '+name+'?'))return;tpl.intervals.splice(idx,1);saveTpl(tpl);ae('üóë '+name+' —É–¥–∞–ª—ë–Ω');openTOTemplates()}
function editTemplates(){const tpl=getTpl();$('tplT').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';$('tplBody').innerHTML=tpl.intervals.map((iv,i)=>`<div class="cfs"><div class="cft"><span class="dot dot-g"></span><input class="fi" style="width:80px;padding:4px 6px;font-size:12px;font-weight:600" id="tin${i}" value="${iv.name}"><span class="conn-test del" onclick="delTOInterval(${i})">‚úï –£–¥–∞–ª–∏—Ç—å</span></div><div class="fg"><label class="fl">–ò–Ω—Ç–µ—Ä–≤–∞–ª (—á)</label><input class="fi" id="tih${i}" value="${iv.hours}" type="number"></div><div class="fg"><label class="fl">–†–∞–±–æ—Ç—ã ([!] = –∫—Ä–∏—Ç–∏—á–Ω–∞—è)</label><textarea class="ta" id="tit${i}" rows="4">${iv.tasks.map(t=>(t.c?'[!] ':'')+t.text).join('\n')}</textarea></div></div>`).join('')+`<div style="display:flex;gap:8px;margin-top:4px"><button class="bp" style="flex:1" onclick="saveTemplates()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="bs2" style="padding:10px" onclick="addTOInterval()">+ –î–æ–±–∞–≤–∏—Ç—å</button><button class="bs2" style="flex:1;padding:10px" onclick="openTOTemplates()">–ù–∞–∑–∞–¥</button></div>`}
function saveTemplates(){const tpl=getTpl();tpl.intervals.forEach((iv,i)=>{iv.name=$('tin'+i)?.value||iv.name;iv.hours=parseInt($('tih'+i).value)||iv.hours;const lines=$('tit'+i).value.split('\n').filter(l=>l.trim());if(lines.length===0)lines.push('–û—Å–º–æ—Ç—Ä');iv.tasks=lines.map((l,j)=>{const c=l.startsWith('[!]');return{id:j+1,text:l.replace('[!] ','').replace('[!]','').trim(),c:c?1:0}})});saveTpl(tpl);ae('‚úÖ –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');openTOTemplates()}
// === POWER FLOW SVG ===
function flowSvg(g1on,g2on,mN,bC,mC,p1,p2){
p1=p1||0;p2=p2||0;
const gAct=(g1on||g2on)&&bC,mAct=mN&&mC,busAct=gAct||mAct;
const g1act=g1on&&bC,g2act=g2on&&bC;
// Line thickness proportional to power (2-5px range)
const g1w=g1act?Math.max(2,Math.min(5,p1/100)):2.5;
const g2w=g2act?Math.max(2,Math.min(5,p2/100)):2.5;
return`<svg viewBox="0 0 740 92" style="width:100%">
<!-- G1 (source, top-left) -->
<circle cx="46" cy="14" r="12" fill="${g1on?'rgba(0,224,154,.08)':'rgba(255,255,255,.02)'}" stroke="${g1on?'var(--g)':'var(--t4)'}" stroke-width="1.5"/>
<text x="46" y="12" fill="${g1on?'var(--g)':'var(--t3)'}" font-size="8" text-anchor="middle" font-family="var(--m)" font-weight="700">G1</text>
<text x="46" y="20" fill="${g1on?'rgba(0,224,154,.6)':'var(--t4)'}" font-size="5.5" text-anchor="middle" font-family="var(--m)">${g1on?(p1>0?p1.toFixed(0)+'–∫–í—Ç':'–†–ê–ë'):'–°–¢–û–ü'}</text>
<!-- G1 ‚Üí Y-join -->
<line x1="58" y1="14" x2="100" y2="14" class="pline ${g1act?'on':''}" stroke-width="${g1w}"/>
<line x1="100" y1="14" x2="100" y2="36" class="pline ${g1act?'on':''}" stroke-width="${g1w}"/>
<!-- G2 (source, bottom-left) -->
<circle cx="46" cy="58" r="12" fill="${g2on?'rgba(0,224,154,.08)':'rgba(255,255,255,.02)'}" stroke="${g2on?'var(--g)':'var(--t4)'}" stroke-width="1.5"/>
<text x="46" y="56" fill="${g2on?'var(--g)':'var(--t3)'}" font-size="8" text-anchor="middle" font-family="var(--m)" font-weight="700">G2</text>
<text x="46" y="64" fill="${g2on?'rgba(0,224,154,.6)':'var(--t4)'}" font-size="5.5" text-anchor="middle" font-family="var(--m)">${g2on?(p2>0?p2.toFixed(0)+'–∫–í—Ç':'–†–ê–ë'):'–°–¢–û–ü'}</text>
<!-- G2 ‚Üí Y-join -->
<line x1="58" y1="58" x2="100" y2="58" class="pline ${g2act?'on':''}" stroke-width="${g2w}"/>
<line x1="100" y1="58" x2="100" y2="36" class="pline ${g2act?'on':''}" stroke-width="${g2w}"/>
<!-- Y-join ‚Üí Busbar Switch -->
<line x1="100" y1="36" x2="150" y2="36" class="pline ${gAct?'on':''}"/>
<!-- Busbar Switch -->
<rect x="150" y="26" width="48" height="20" rx="4" fill="${bC?'rgba(0,224,154,.08)':'rgba(255,255,255,.02)'}" stroke="${bC?'var(--g)':'var(--t4)'}" stroke-width="1.5"/>
<text x="174" y="39" fill="${bC?'var(--g)':'var(--t3)'}" font-size="6.5" text-anchor="middle" font-family="var(--m)" font-weight="600">${bC?'–ó–ê–ú–ö–ù':'–†–ê–ó–û–ú–ö'}</text>
<text x="174" y="21" fill="var(--t3)" font-size="5.5" text-anchor="middle" font-family="var(--m)">–ê–≤—Ç. —à–∏–Ω—ã</text>
<!-- Busbar Switch ‚Üí BUS LEFT -->
<line x1="198" y1="36" x2="340" y2="36" class="pline bus ${gAct?'on':(busAct?'on':'')}" stroke-width="4"/>
<!-- BUS CENTER LABEL -->
<rect x="340" y="27" width="64" height="18" rx="4" fill="var(--bg3)" stroke="${busAct?'var(--g)':'var(--t4)'}" stroke-width="1"/>
<text x="372" y="39" fill="${busAct?'var(--g)':'var(--t3)'}" font-size="8" text-anchor="middle" font-family="var(--m)" font-weight="700">–®–ò–ù–ê</text>
<text x="372" y="22" fill="var(--p)" font-size="5.5" text-anchor="middle" font-family="var(--m)" font-weight="600">–®–ü–†</text>
<!-- BUS RIGHT ‚Üí Mains Switch -->
<line x1="404" y1="36" x2="520" y2="36" class="pline bus ${mAct?'monR':(busAct?'on':'')}" stroke-width="4"/>
<!-- Mains Switch -->
<rect x="520" y="26" width="48" height="20" rx="4" fill="${mC?'rgba(64,144,255,.1)':'rgba(255,255,255,.02)'}" stroke="${mC?'#4090ff':'var(--t4)'}" stroke-width="1.5"/>
<text x="544" y="39" fill="${mC?'#4090ff':'var(--t3)'}" font-size="6.5" text-anchor="middle" font-family="var(--m)" font-weight="600">${mC?'–ó–ê–ú–ö–ù':'–†–ê–ó–û–ú–ö'}</text>
<text x="544" y="21" fill="var(--t3)" font-size="5.5" text-anchor="middle" font-family="var(--m)">–ê–≤—Ç. —Å–µ—Ç–∏</text>
<!-- Mains Switch ‚Üí MAINS -->
<line x1="568" y1="36" x2="630" y2="36" class="pline ${mAct?'monR':''}"/>
<!-- MAINS (source, right) -->
<rect x="630" y="24" width="56" height="24" rx="5" fill="${mN?'rgba(64,144,255,.1)':'rgba(255,64,96,.06)'}" stroke="${mN?'#4090ff':'#ff4060'}" stroke-width="1.5"/>
<text x="658" y="40" fill="${mN?'#4090ff':'#ff4060'}" font-size="8.5" text-anchor="middle" font-family="var(--m)" font-weight="600">–°–ï–¢–¨</text>
<text x="658" y="18" fill="${mN?'rgba(64,144,255,.6)':'rgba(255,64,96,.5)'}" font-size="5.5" text-anchor="middle" font-family="var(--m)">${mN?'–ù–û–†–ú–ê':'–ê–í–ê–†–ò–Ø'}</text>
<!-- BUS ‚Üí LOAD -->
<line x1="372" y1="45" x2="372" y2="66" class="pline ${busAct?'on':''}"/>
<rect x="342" y="66" width="60" height="20" rx="5" fill="${busAct?'rgba(0,224,154,.06)':'rgba(255,255,255,.02)'}" stroke="${busAct?'var(--g)':'var(--t4)'}" stroke-width="1.5"/>
<text x="372" y="79" fill="${busAct?'var(--t)':'var(--t3)'}" font-size="7.5" text-anchor="middle" font-family="var(--m)" font-weight="600">–ù–ê–ì–†–£–ó–ö–ê</text>
</svg>`}
// === RENDER ===
function renderDash(){const mn=$('mainArea');
if(!cur||!S[cur]){mn.innerHTML='<div class="empty-dash" style="height:100%"><div style="font-size:48px;margin-bottom:16px;opacity:.4">üè≠</div><p style="font-size:14px">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –∏–ª–∏ <span style="color:var(--g);cursor:pointer" onclick="openAddSite()">—Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</span></p></div>';return}
const s=S[cur],hg1=!!s.g1?.ip,hg2=!!s.g2?.ip,hs=!!s.spr?.ip,cfg=[hg1,hg2,hs].filter(Boolean).length;
mn.innerHTML=`<div class="dh"><div class="dt"><div class="ld"></div><h1>${esc(s.name)}${s.desc?' ‚Äî '+esc(s.desc):''}</h1></div><div style="display:flex;align-items:center;gap:16px"><div class="da"><button onclick="openSet()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button><button id="demoBtn" class="${demo?'demo-on':''}" onclick="togDemo()">${demo?'‚èπ –°—Ç–æ–ø':'‚ñ∂ –î–µ–º–æ'}</button></div><span class="ck" id="ck"></span></div></div>
<div class="ss"><div class="sc"><div class="sl2">P —à–∏–Ω—ã</div><div class="sv" style="color:var(--g)" id="sP">‚Äî<span class="su">–∫–í—Ç</span></div></div><div class="sc"><div class="sl2">P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤</div><div class="sv" style="color:var(--p)" id="sPg">‚Äî<span class="su">–∫–í—Ç</span></div></div><div class="sc"><div class="sl2">U —Å–µ—Ç–∏</div><div class="sv" id="sU">‚Äî<span class="su">–í</span></div></div><div class="sc"><div class="sl2">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div><div class="sv" id="sG">${cfg}<span class="su">/3</span></div></div><div class="sc"><div class="sl2">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div><div id="sSt"><span class="bdg bdg-off">${cfg?'–û–∂–∏–¥–∞–Ω–∏–µ':'‚Äî'}</span></div></div><div class="sc"><div class="sl2">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div><div class="sv" id="sResp" style="font-size:12px">‚Äî</div></div></div>
${cfg===0?'<div class="empty-dash" style="padding:40px"><div style="font-size:32px;margin-bottom:10px;opacity:.4">‚öô</div><p>–ù–∞–∂–º–∏—Ç–µ <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b></p></div>':`
<div class="gg">${genCard('g1','–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1',s.g1)}${genCard('g2','–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2',s.g2)}</div>
<div class="pflow" id="pflow">${flowSvg(false,false,false,false,false)}</div>
${hs?sprCard(s.spr):''}
`}<div class="ev"><div class="ev-t">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</div><div id="evL">${evts.length?evts.slice(0,10).map(e=>`<div class="er"><span class="et">${e.t}</span>${esc(e.m)}</div>`).join(''):'<div style="color:var(--t4);font-size:11px">‚Äî</div>'}</div></div>`;uCk();if(demo)demoTick()}
function genCard(sl,nm,c){
if(!c?.ip)return`<div class="cc s-stb"><div style="padding:24px;text-align:center;color:var(--t3);font-size:12px">${nm} ‚Äî –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω<br><span style="color:var(--g);cursor:pointer" onclick="openSet()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å ‚Üí</span></div></div>`;
const rh=c.runHours||0,to=getNextTO(rh,cur,sl),tc=to.remain<0?'to-r':to.pct>85?'to-r':to.pct>65?'to-y':'to-g',bc=to.remain<0?'var(--r)':to.pct>85?'var(--r)':to.pct>65?'var(--y)':'var(--g)';
return`<div class="cc s-stb" id="c${sl}"><div class="ch" onclick="tog('c${sl}')">
<div class="cr1"><div class="cid"><div class="cdot cd-x"></div><div><div class="cn">${nm}</div><div class="csb">HGM9520N ¬∑ ${esc(c.ip)}:${c.port||502} <span id="${sl}-rh" style="color:var(--t);font-weight:600;margin-left:6px">‚è± ${rh} —á</span></div></div></div><span class="bdg bdg-off" onclick="event.stopPropagation();openAlarms('c${sl}','${sl}a')" title="–ù–∞–∂–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–≤–∞—Ä–∏–π">–û–ñ–ò–î–ê–ù–ò–ï</span></div>
<div class="kr"><div class="kp"><div class="kl">P</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">U</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">I</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">f</div><div class="kv vm">‚Äî</div></div></div>
<div class="to-block" id="${sl}-to" onclick="event.stopPropagation();${to.unknown?'openSet()':'this.classList.toggle(&quot;exp&quot;)'}"><div class="to-head"><span class="to-name ${to.unknown?'to-y':tc}">${to.unknown?'‚ö† –£–∫–∞–∂–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û':to.name+' ‚Üí '+to.dueAt+'—á'}</span><span class="to-remain">${to.unknown?'<span style=&quot;color:var(--y);cursor:pointer&quot;>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí</span>':(to.remain>0?to.remain+'—á –æ—Å—Ç.':(to.remain<0?'–ø—Ä–æ—Å—Ä–æ—á. '+Math.abs(to.remain)+'—á':'—Å–µ–π—á–∞—Å'))+' ¬∑ '+rh+'—á'}</span></div>${to.unknown?'':`<div class="to-bar"><div class="to-fill" style="width:${to.pct}%;background:${bc}"></div></div><div class="to-tasks">${to.tasks?.slice(0,5).map(t=>'‚Ä¢ '+(t.c?'<b>':'')+t.text+(t.c?'</b>':'')).join('<br>')||''}</div><div class="to-hint">‚ñº —Ä–∞–±–æ—Ç—ã ¬∑ <span style="color:var(--g);cursor:pointer" onclick="event.stopPropagation();openTO('${sl}')">–¢–û</span></div>`}</div>
<div class="mds"><span class="mdt">AUTO</span><span class="mdt">MAN</span><span class="mdt">TEST</span><span class="mdt">STOP</span></div></div>
<!-- QUICK CONTROLS always visible -->
<div style="padding:0 10px 5px"><div class="qc">
<button class="qb q-start" onclick="event.stopPropagation();cmdConfirm('${nm}','Start','‚ñ∂ –ü—É—Å–∫','FC05 coil 0x0000: Remote Start')">‚ñ∂ –ü—É—Å–∫</button>
<button class="qb q-stop" onclick="event.stopPropagation();cmdConfirm('${nm}','Stop','‚èπ –°—Ç–æ–ø','FC05 coil 0x0001: Remote Stop')">‚èπ –°—Ç–æ–ø</button>
<button class="qb q-auto" onclick="event.stopPropagation();cmdConfirm('${nm}','Auto','üÖ∞ –ê–≤—Ç–æ','FC05 coil 0x0003: Remote Auto')">üÖ∞ –ê–≤—Ç–æ</button>
<button class="qb q-manual" onclick="event.stopPropagation();cmdConfirm('${nm}','Manual','üîß –†—É—á–Ω–æ–π','FC05 coil 0x0004: Remote Manual')">üîß –†—É—á.</button>
</div><div class="cmd-st" id="cs-${nm.replace(/[\s\/]/g,'')}"></div></div>
<div class="cv" onclick="tog('c${sl}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
<div class="ce"><div class="ei">
<div class="tbs"><button class="tb on" onclick="stab(this,'${sl}e')">–≠–ª–µ–∫—Ç—Ä–∏–∫–∞</button><button class="tb" onclick="stab(this,'${sl}m')">–î–≤–∏–≥–∞—Ç–µ–ª—å</button><button class="tb" onclick="stab(this,'${sl}a')">–ê–≤–∞—Ä–∏–∏</button><button class="tb" onclick="stab(this,'${sl}c')">–í—Å–µ –∫–æ–º–∞–Ω–¥—ã</button></div>
<div class="tp on" id="${sl}e"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div></div>
<div class="tp" id="${sl}m"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="${sl}a">
<div style="display:flex;gap:4px;margin-bottom:8px"><button class="spr-b" style="flex:1;font-weight:600;color:var(--r)" id="${sl}a-act-btn" onclick="showAlarmSub('${sl}','act')">üî¥ –ê–∫—Ç–∏–≤–Ω—ã–µ</button><button class="spr-b" style="flex:1" id="${sl}a-arc-btn" onclick="showAlarmSub('${sl}','arc')">üìã –ê—Ä—Ö–∏–≤</button><button class="spr-b" onclick="clearAlarmArchive('${sl}')">üóë</button></div>
<div id="${sl}a-act"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–ù–µ—Ç –∞–≤–∞—Ä–∏–π ‚úì</div></div>
<div id="${sl}a-arc" style="display:none"><div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div></div>
</div>
<div class="tp" id="${sl}c"><div style="font-size:11px;color:var(--t3);margin-bottom:8px">–í—Å–µ –∫–æ–º–∞–Ω–¥—ã HGM9520N (FC05)</div>
<div class="cg">
<button class="cb2 cgo" onclick="event.stopPropagation();cmdConfirm('${nm}','Start','‚ñ∂ –ü—É—Å–∫','FC05 0x0000')"><span class="ci2">‚ñ∂</span>–ü—É—Å–∫</button>
<button class="cb2 cst" onclick="event.stopPropagation();cmdConfirm('${nm}','Stop','‚èπ –°—Ç–æ–ø','FC05 0x0001')"><span class="ci2">‚èπ</span>–°—Ç–æ–ø</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','Auto','üÖ∞ –ê–≤—Ç–æ','FC05 0x0003')"><span class="ci2">üÖ∞</span>–ê–≤—Ç–æ</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','Manual','üîß –†—É—á–Ω–æ–π','FC05 0x0004')"><span class="ci2">üîß</span>–†—É—á–Ω–æ–π</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','GenClose','‚ö° –í–ö–õ –≥–µ–Ω.','FC05 0x0006: Remote Gen Close')"><span class="ci2">‚ö°</span>–í–ö–õ –≥–µ–Ω.</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','GenOpen','‚ö° –û–¢–ö–õ –≥–µ–Ω.','FC05 0x0007: Remote Gen Open')"><span class="ci2">‚ö°</span>–û–¢–ö–õ –≥–µ–Ω.</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','MainsClose','üîå –ê–≤—Ç.—Å–µ—Ç–∏','FC05 0x0005: Mains Close/Open')"><span class="ci2">üîå</span>–ê–≤—Ç.—Å–µ—Ç–∏</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','Mute','üîá –¢–∏—à–∏–Ω–∞','FC05 addr 0x000C (12): Remote Mute Key')"><span class="ci2">üîá</span>–¢–∏—à–∏–Ω–∞</button>
<button class="cb2" onclick="event.stopPropagation();cmdConfirm('${nm}','Reset','üîÑ –°–±—Ä–æ—Å','FC05 addr 0x0011 (17): Remote Alarm Reset')"><span class="ci2">üîÑ</span>–°–±—Ä–æ—Å</button>
</div><div style="margin-top:8px"><button class="cb2 q-danger" style="width:100%;flex-direction:row;justify-content:center;gap:8px;padding:10px" onclick="event.stopPropagation();cmdConfirm('${nm}','FastStop','üõë –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å—Ç–æ–ø','FC05 addr 0x000F (15): Remote Diesel Engine Fast Stop')"><span>üõë</span>–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å—Ç–æ–ø</button></div>
</div></div></div>
<div class="cf"><div class="li"><span class="lo lo-r"></span><span>–æ–∂–∏–¥–∞–Ω–∏–µ</span></div><span>tcp:${c.port||502} ¬∑ id:${c.slaveId||1}</span></div></div>`}
function sprCard(c){return`<div class="sr2"><div class="cc s-stb" id="cspr"><div class="ch" onclick="tog('cspr')">
<div class="cr1"><div class="cid"><div class="cdot cd-x"></div><div><div class="cn" style="color:var(--p)">–®–ü–†</div><div class="csb">HGM9560 ¬∑ ${esc(c.ip)}:${c.port||26} ¬∑ RTU</div></div></div><span class="bdg bdg-off" onclick="event.stopPropagation();openAlarms('cspr','spra')" title="–ù–∞–∂–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–≤–∞—Ä–∏–π">–û–ñ–ò–î–ê–ù–ò–ï</span></div>
<div class="kr kr5"><div class="kp"><div class="kl">P —à–∏–Ω—ã</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">U</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">f</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">–°–µ—Ç—å</div><div class="kv vm">‚Äî</div></div><div class="kp"><div class="kl">–†–µ–∂–∏–º</div><div class="kv vm">‚Äî</div></div></div></div>
<!-- SPR QUICK CONTROLS -->
<div style="padding:0 10px 5px"><div class="qc">
<button class="qb q-start" onclick="event.stopPropagation();cmdConfirm('–®–ü–†','Start','‚ñ∂ –ü—É—Å–∫','FC05 0x0000')">‚ñ∂ –ü—É—Å–∫</button>
<button class="qb q-stop" onclick="event.stopPropagation();cmdConfirm('–®–ü–†','Stop','‚èπ –°—Ç–æ–ø','FC05 0x0001')">‚èπ –°—Ç–æ–ø</button>
<button class="qb q-auto" onclick="event.stopPropagation();cmdConfirm('–®–ü–†','Auto','üÖ∞ –ê–≤—Ç–æ','FC05 0x0003')">üÖ∞ –ê–≤—Ç–æ</button>
<button class="qb q-manual" onclick="event.stopPropagation();cmdConfirm('–®–ü–†','Manual','üîß –†—É—á–Ω–æ–π','FC05 0x0004')">üîß –†—É—á.</button>
</div><div class="cmd-st" id="cs-–®–ü–†"></div></div>
<div class="cv" onclick="tog('cspr')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
<div class="ce"><div class="ei">
<div class="tbs"><button class="tb on" onclick="stab(this,'sprb')">–®–∏–Ω–∞</button><button class="tb" onclick="stab(this,'sprm')">–°–µ—Ç—å</button><button class="tb" onclick="stab(this,'sprs')">–ö–æ–º–º—É—Ç–∞—Ü–∏—è</button><button class="tb" onclick="stab(this,'spra')">–ê–≤–∞—Ä–∏–∏</button><button class="tb" onclick="stab(this,'sprc');onSprControlTabOpen()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button><button class="tb" onclick="stab(this,'sprp')">–ü—Ä–µ—Å–µ—Ç—ã</button></div>
<div class="tp on" id="sprb"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="sprm"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="sprs"><div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
<div class="tp" id="spra">
<div style="display:flex;gap:4px;margin-bottom:8px"><button class="spr-b" style="flex:1;font-weight:600;color:var(--r)" id="spra-act-btn" onclick="showAlarmSub('spr','act')">üî¥ –ê–∫—Ç–∏–≤–Ω—ã–µ</button><button class="spr-b" style="flex:1" id="spra-arc-btn" onclick="showAlarmSub('spr','arc')">üìã –ê—Ä—Ö–∏–≤</button><button class="spr-b" onclick="clearAlarmArchive('spr')">üóë</button></div>
<div id="spra-act"><div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –®–ü–†...</div></div>
<div id="spra-arc" style="display:none"><div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div></div>
</div>
<div class="tp" id="sprc">
<div id="sprCfgBanner" style="padding:8px 10px;background:var(--bg3);border:1px solid var(--bd);border-radius:6px;margin-bottom:10px;font-size:11px;color:var(--t3);font-family:var(--m);text-align:center">–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç —Å—á–∏—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
<div style="font-size:11px;color:var(--t3);margin-bottom:8px">–ö–æ–º–∞–Ω–¥—ã HGM9560 (FC05)</div>
<div class="spr-cg">
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','Start','‚ñ∂ –ü—É—Å–∫','FC05 0x0000')"><span class="si2">‚ñ∂</span>–ü—É—Å–∫</button>
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','Stop','‚èπ –°—Ç–æ–ø','FC05 0x0001')"><span class="si2">‚èπ</span>–°—Ç–æ–ø</button>
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','Auto','üÖ∞ –ê–≤—Ç–æ','FC05 0x0003')"><span class="si2">üÖ∞</span>–ê–≤—Ç–æ</button>
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','Manual','üîß –†—É—á–Ω.','FC05 0x0004')"><span class="si2">üîß</span>–†—É—á–Ω.</button>
</div><div class="spr-cg">
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','MainsSwitch','üîå –ê–≤—Ç.—Å–µ—Ç–∏','FC05 0x0005: Mains Close/Open')"><span class="si2">üîå</span>–ê–≤—Ç.—Å–µ—Ç–∏</button>
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','BusbarSwitch','‚ö° –ê–≤—Ç.—à–∏–Ω—ã','FC05 0x0006: Busbar Close/Open')"><span class="si2">‚ö°</span>–ê–≤—Ç.—à–∏–Ω—ã</button>
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','Mute','üîá –¢–∏—à–∏–Ω–∞','FC05 0x000C: Mute')"><span class="si2">üîá</span>–¢–∏—à–∏–Ω–∞</button>
<button class="spr-b" onclick="cmdConfirm('–®–ü–†','Confirm','‚úì –ü–æ–¥—Ç–≤.','FC05 0x000B: Confirm')"><span class="si2">‚úì</span>–ü–æ–¥—Ç–≤.</button>
</div>
<div style="font-size:11px;color:var(--t3);margin-top:12px;margin-bottom:6px">–†–µ–∂–∏–º –Ω–∞–≥—Ä—É–∑–∫–∏ (FC06 reg 4351) <span id="sprLmCurrent" style="font-size:10px;color:var(--t4)"></span></div>
<div style="padding:8px 10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:6px;margin-bottom:8px;font-size:10px;color:var(--t2);line-height:1.5;font-family:var(--m)">
<b style="color:var(--g)">Gen Control (0)</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —É–ø—Ä–∞–≤–ª—è—é—Ç –º–æ—â–Ω–æ—Å—Ç—å—é. P% –∑–∞–¥–∞—ë—Ç, —Å–∫–æ–ª—å–∫–æ –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞ –≤—ã–¥–∞—ë—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –°–µ—Ç—å –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫.<br>
<b style="color:var(--b)">Mains Control (1)</b> ‚Äî —Å–µ—Ç—å –æ—Å–Ω–æ–≤–Ω–∞—è. P% –∑–∞–¥–∞—ë—Ç –ø–æ—Ä–æ–≥ ¬´—Å—Ä–µ–∑–∞–Ω–∏—è –ø–∏–∫–æ–≤¬ª (peak clipping). –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –≤–∫–ª—é—á–∞—é—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ç–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —ç—Ç–æ—Ç %.<br>
<b style="color:var(--p)">Load Reception (2)</b> ‚Äî –ø—Ä–∏—ë–º –Ω–∞–≥—Ä—É–∑–∫–∏. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –ø–ª–∞–≤–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –Ω–∞ —Å–µ–±—è –Ω–∞–≥—Ä—É–∑–∫—É –æ—Ç —Å–µ—Ç–∏.
</div>
<div style="display:flex;gap:6px;margin-bottom:10px">
<button class="spr-b" id="sprLm0" style="flex:1" onclick="setSprLoadMode(0)">Gen Ctrl</button>
<button class="spr-b" id="sprLm1" style="flex:1" onclick="setSprLoadMode(1)">Mains Ctrl</button>
<button class="spr-b" id="sprLm2" style="flex:1" onclick="setSprLoadMode(2)">Load Rec.</button>
</div>
<div class="slider-group">
<div style="font-size:10px;color:var(--t3);margin-bottom:6px;line-height:1.4">P% –∏ Q% ‚Äî —É—Å—Ç–∞–≤–∫–∏ –¥–ª—è –®–ü–†. –í —Ä–µ–∂–∏–º–µ <b style="color:var(--g)">Gen Ctrl</b>: P% = –≤—ã—Ö–æ–¥–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞. –í —Ä–µ–∂–∏–º–µ <b style="color:var(--b)">Mains Ctrl</b>: P% = –ø–æ—Ä–æ–≥ –ø–∏–∫-—à–µ–π–≤–∏–Ω–≥–∞ —Å–µ—Ç–∏.</div>
<div class="slider-row"><span class="slider-label">P%</span><input type="range" id="sprPslider" min="0" max="1000" value="500" oninput="sprCfgDirty=true;$('sprPval').textContent=((+this.value)/10).toFixed(1)+'%'"><span class="slider-val" id="sprPval">50.0%</span></div>
<div class="slider-row"><span class="slider-label">Q%</span><input type="range" id="sprQslider" min="0" max="1000" value="500" oninput="sprCfgDirty=true;$('sprQval').textContent=((+this.value)/10).toFixed(1)+'%'"><span class="slider-val" id="sprQval">50.0%</span></div>
<button class="bp" id="sprSaveBtn" style="margin-top:6px;padding:7px;font-size:11px" onclick="saveSprConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä</button>
<div style="font-size:9px;color:var(--t4);margin-top:4px">FC06: LoadMode ‚Üí reg 4351, P% ‚Üí reg 4352, Q% ‚Üí reg 4354. –ó–Ω–∞—á–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.</div></div>
<div style="font-size:11px;color:var(--t3);margin-top:14px;margin-bottom:6px">–ë—ç–∫–∞–ø / –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
<div style="display:flex;gap:6px;margin-bottom:8px">
<button class="spr-b" style="flex:1" onclick="readSprConfig()"><span class="si2">üîÑ</span>–ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å</button>
<button class="spr-b" style="flex:1" onclick="backupSprConfig()"><span class="si2">üíæ</span>–ë—ç–∫–∞–ø</button>
<button class="spr-b" style="flex:1" onclick="openRestoreBackup()"><span class="si2">üìÇ</span>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
</div>
<div id="sprConfigStatus"></div>
<div id="sprBackupList"></div>
</div>
<!-- PRESETS TAB -->
<div class="tp" id="sprp">
<div style="font-size:11px;color:var(--t3);margin-bottom:10px">–ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã —Ä–µ–∂–∏–º–æ–≤ –®–ü–† (HGM9560)</div>
<div style="padding:10px;background:rgba(160,112,255,.04);border:1px solid rgba(160,112,255,.15);border-radius:8px;margin-bottom:12px;font-size:11px;color:var(--t2);line-height:1.5">
<b style="color:var(--p)">–ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–µ—Å–µ—Ç—ã?</b><br>
–ü—Ä–µ—Å–µ—Ç ‚Äî —ç—Ç–æ –≥–æ—Ç–æ–≤–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –∏–∑ —Ç—Ä—ë—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: <b>—Ä–µ–∂–∏–º –Ω–∞–≥—Ä—É–∑–∫–∏</b> (LoadMode), <b>% –∞–∫—Ç–∏–≤–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏</b> (P) –∏ <b>% —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏</b> (Q), –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –®–ü–† —á–µ—Ä–µ–∑ FC06.<br>
–í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ‚Äî –æ–¥–∏–Ω –∫–ª–∏–∫.
</div>
<div class="preset-grid">
<button class="preset-btn" onclick="applyPreset(this,'island')"><div class="preset-name">üèù –û—Å—Ç—Ä–æ–≤–Ω–æ–π</div><div class="preset-desc">Gen Ctrl ¬∑ P100% Q50%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'genres')"><div class="preset-name">üîã –ì–µ–Ω+–†–µ–∑–µ—Ä–≤</div><div class="preset-desc">Gen Ctrl ¬∑ P80% Q50%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'peak')"><div class="preset-name">‚ö° –ü–∏–∫-—à–µ–π–≤–∏–Ω–≥</div><div class="preset-desc">Mains Ctrl ¬∑ P30% Q50%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'parallel')"><div class="preset-name">üîÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å</div><div class="preset-desc">Load Rec ¬∑ P50% Q50%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'export')"><div class="preset-name">üì§ –≠–∫—Å–ø–æ—Ä—Ç</div><div class="preset-desc">Gen Ctrl ¬∑ P80% Q30%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'mains')"><div class="preset-name">üîå –¢–æ–ª—å–∫–æ —Å–µ—Ç—å</div><div class="preset-desc">Mains Ctrl ¬∑ P0% Q0%</div></button>
<button class="preset-btn" onclick="applyPreset(this,'test')"><div class="preset-name">üîß –¢–µ—Å—Ç</div><div class="preset-desc">Gen Ctrl ¬∑ P20% Q20%</div></button>
</div>
<div id="presetExplain" style="padding:10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:8px;margin-top:6px">
<div style="font-size:10px;color:var(--t3);margin-bottom:6px">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤:</div>
<div style="font-size:10px;color:var(--t2);line-height:1.6;font-family:var(--m)">
<b style="color:var(--g)">üèù –û—Å—Ç—Ä–æ–≤–Ω–æ–π</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫, —Å–µ—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∞. P=100%<br>
<b style="color:#00c8ff">üîã –ì–µ–Ω+–†–µ–∑–µ—Ä–≤</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π (80%), —Å–µ—Ç—å –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫. –ü—Ä–∏ –ø—Ä–æ–ø–∞–¥–∞–Ω–∏–∏ —Å–µ—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–∏—Ç–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏<br>
<b style="color:var(--y)">‚ö° –ü–∏–∫-—à–µ–π–≤–∏–Ω–≥</b> ‚Äî —Å–µ—Ç—å –æ—Å–Ω–æ–≤–Ω–∞—è, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —Å—Ä–µ–∑–∞—é—Ç –ø–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏. P=30%<br>
<b style="color:var(--p)">üîÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å</b> ‚Äî –ø—Ä–∏—ë–º –Ω–∞–≥—Ä—É–∑–∫–∏, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –∏ —Å–µ—Ç—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ<br>
<b style="color:var(--b)">üì§ –≠–∫—Å–ø–æ—Ä—Ç</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –≤—ã–¥–∞—é—Ç 80% –≤ —Å–µ—Ç—å (–æ–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞)<br>
<b style="color:var(--t)">üîå –¢–æ–ª—å–∫–æ —Å–µ—Ç—å</b> ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã, –ø–∏—Ç–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ—Ç —Å–µ—Ç–∏<br>
<b style="color:var(--t3)">üîß –¢–µ—Å—Ç</b> ‚Äî 20% –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤
</div>
</div>
<div style="padding:10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:8px;margin-top:8px"><div style="font-size:10px;color:var(--t3);margin-bottom:4px">–¢–µ–∫—É—â–∏–π:</div><div id="currentPreset" style="font-family:var(--m);font-size:12px;color:var(--t2)">–ù–µ –≤—ã–±—Ä–∞–Ω</div></div>
</div></div></div>
<div class="cf"><div class="li"><span class="lo lo-r"></span><span>–æ–∂–∏–¥–∞–Ω–∏–µ</span></div><span>rtu:9600/8N2 ¬∑ id:${c.slaveId||1}</span></div></div></div>`}
function applyPreset(btn,name){
const P={island:{m:0,p:1000,q:500,l:'üèù –û—Å—Ç—Ä–æ–≤–Ω–æ–π'},genres:{m:0,p:800,q:500,l:'üîã –ì–µ–Ω+–†–µ–∑–µ—Ä–≤ —Å–µ—Ç–∏'},peak:{m:1,p:300,q:500,l:'‚ö° –ü–∏–∫-—à–µ–π–≤–∏–Ω–≥'},parallel:{m:2,p:500,q:500,l:'üîÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å'},export:{m:0,p:800,q:300,l:'üì§ –≠–∫—Å–ø–æ—Ä—Ç'},mains:{m:1,p:0,q:0,l:'üîå –¢–æ–ª—å–∫–æ —Å–µ—Ç—å'},test:{m:0,p:200,q:200,l:'üîß –¢–µ—Å—Ç'}};
const pr=P[name];if(!pr)return;
// Apply preset to control tab UI
sprSelectedLoadMode=pr.m;sprCfgDirty=true;
applySprConfigToUI(pr.m, pr.p, pr.q);
const cp=$('currentPreset');if(cp)cp.innerHTML=`<b>${pr.l}</b> ¬∑ Mode=${pr.m} P=${(pr.p/10).toFixed(1)}% Q=${(pr.q/10).toFixed(1)}%`;
document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
ae(`üéõ –ü—Ä–µ—Å–µ—Ç: ${pr.l}`);
// Prompt to save to controller
if(confirm('–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–µ—Å–µ—Ç ¬´'+pr.l+'¬ª –∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä?\n\nLoadMode='+pr.m+' P='+(pr.p/10).toFixed(1)+'% Q='+(pr.q/10).toFixed(1)+'%')){saveSprConfig()}
else{const banner=$('sprCfgBanner');if(banner)banner.innerHTML='<span style="color:var(--y)">‚ö† –ü—Ä–µ—Å–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –ù–ï –∑–∞–ø–∏—Å–∞–Ω –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä. –ù–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.</span>'}}
function tog(id){$(id)?.classList.toggle('op')}
function openAlarms(cardId,alarmTabId){const card=$(cardId);if(!card)return;if(!card.classList.contains('op'))card.classList.add('op');const tabs=card.querySelectorAll('.tb');const panels=card.querySelectorAll('.tp');tabs.forEach(t=>t.classList.remove('on'));panels.forEach(p=>p.classList.remove('on'));tabs.forEach(t=>{if(t.textContent==='–ê–≤–∞—Ä–∏–∏')t.classList.add('on')});const ap=$(alarmTabId);if(ap)ap.classList.add('on');card.scrollIntoView({behavior:'smooth',block:'nearest'})}
function scrollToAlarm(){const cards=['cg1','cg2','cspr'];for(const id of cards){const c=$(id);if(c&&(c.classList.contains('s-wrn')||c.classList.contains('s-alm'))){const sl=id.replace('c','');const aTab=id==='cspr'?'spra':sl+'a';openAlarms(id,aTab);return}}}
function stab(btn,pid){const c=btn.closest('.cc');if(!c)return;c.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));c.querySelectorAll('.tp').forEach(p=>p.classList.remove('on'));btn.classList.add('on');$(pid)?.classList.add('on')}
function uCk(){const el=$('ck');if(el)el.textContent=now()}
setInterval(uCk,1000);
// === DEMO ===
function togDemo(){demo=!demo;
if(demo){if(cur&&S[cur]){const s=S[cur];if(!s.g1?.ip){s.g1={ip:'192.168.97.10',port:502,slaveId:1,runHours:1227};s.g2={ip:'192.168.97.11',port:502,slaveId:1,runHours:489};s.spr={ip:'10.11.0.2',port:26,slaveId:1};sv();renderDash()}}dStep=0;ae('‚ñ∂ –î–µ–º–æ');demoTick();demoIv=setInterval(demoTick,2500)}
else{clearInterval(demoIv);demoIv=null;ae('‚èπ –°—Ç–æ–ø');renderDash()}
const b=$('demoBtn');if(b){b.textContent=demo?'‚èπ –°—Ç–æ–ø':'‚ñ∂ –î–µ–º–æ';b.classList.toggle('demo-on',demo)}}
// Demo scenario: [g1state, g2state, mainsNormal, busbarClosed, mainsClosed, g1power, g2power]
// Shows realistic ATS: mains fail ‚Üí generators start ‚Üí parallel ‚Üí mains return ‚Üí transfer back
const SC=[
['standby','standby',true,false,true, 0,0],       // 1: –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —Å–µ—Ç—å –ø–∏—Ç–∞–µ—Ç, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —Å—Ç–æ—è—Ç
['standby','standby',true,false,true, 0,0],       // 2: –Ω–æ—Ä–º–∞–ª—å–Ω–æ
['standby','standby',false,false,true, 0,0],      // 3: –ê–í–ê–†–ò–Ø –°–ï–¢–ò! mains fail
['running','standby',false,false,false, 180,0],   // 4: G1 –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, G2 –µ—â—ë —Å—Ç–æ–∏—Ç
['running','running',false,false,false, 280,200],  // 5: –æ–±–∞ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å, –Ω–∞–±–∏—Ä–∞—é—Ç –æ–±–æ—Ä–æ—Ç—ã
['running','running',false,true,false, 320,240],   // 6: –∞–≤—Ç.—à–∏–Ω—ã –∑–∞–º–∫–Ω—É—Ç, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
['running','running',false,true,false, 340,220],   // 7: —Ä–∞–±–æ—Ç–∞—é—Ç, G1 –±–æ–ª—å—à–µ –º–æ—â–Ω–æ—Å—Ç–∏ —á–µ–º G2
['warning','running',false,true,false, 350,260],   // 8: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ G1 (—Ç–µ–º–ø.–û–ñ)
['running','running',false,true,false, 300,280],   // 9: G1 —Å–Ω–∏–∑–∏–ª –Ω–∞–≥—Ä—É–∑–∫—É, G2 –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç
['running','running',true,true,false, 280,260],    // 10: —Å–µ—Ç—å –≤–µ—Ä–Ω—É–ª–∞—Å—å! –Ω–æ –µ—â—ë –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞—Ö
['running','running',true,true,true, 200,180],     // 11: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Å–µ—Ç—å—é, –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
['standby','standby',true,false,true, 0,0]         // 12: –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –≤–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ —Å–µ—Ç—å
];
const ST={running:{dot:'cd-g',bdg:'bdg-run',txt:'–†–ê–ë–û–¢–ê',cls:'s-run'},warning:{dot:'cd-y',bdg:'bdg-w',txt:'–ü–†–ï–î–£–ü–†.',cls:'s-wrn'},alarm:{dot:'cd-r',bdg:'bdg-a',txt:'–ê–í–ê–†–ò–Ø',cls:'s-alm'},standby:{dot:'cd-x',bdg:'bdg-off',txt:'–°–¢–û–ü',cls:'s-stb'}};
function demoTick(){if(!cur||!S[cur])return;dStep++;const sc=SC[(dStep-1)%SC.length],s1=sc[0],s2=sc[1],mN=sc[2],bC=sc[3],mC=sc[4],p1base=sc[5],p2base=sc[6];
const on1=s1!=='standby',on2=s2!=='standby';
// Pass actual power values to applyGen for display
applyGen('g1',s1,S[cur].g1?.runHours||1227,p1base,true);applyGen('g2',s2,S[cur].g2?.runHours||489,p2base,true);applySpr(on1||on2,mN,bC,mC,true);
const p1=on1?p1base+R(-10,10):0,p2=on2?p2base+R(-10,10):0,mP=mN&&mC?R(100,200):0;const el=n=>document.getElementById(n);
const pf=$('pflow');if(pf)pf.innerHTML=flowSvg(on1,on2,mN,bC,mC,p1,p2);
if(el('sP'))el('sP').innerHTML=`${(p1+p2+mP).toFixed(1)}<span class="su">–∫–í—Ç</span>`;
if(el('sPg'))el('sPg').innerHTML=`${(p1+p2).toFixed(1)}<span class="su">–∫–í—Ç</span>`;
if(el('sU')){if(mN)el('sU').innerHTML=`${RI(398,406)}<span class="su">–í</span>`;else el('sU').innerHTML='<span style="color:var(--r)">–ê–í–ê–†</span>'}
if(el('sG'))el('sG').innerHTML=`${(on1?1:0)+(on2?1:0)}<span class="su">/2</span>`;
const w=s1==='alarm'||s2==='alarm'?'a':s1==='warning'||s2==='warning'?'w':(!mN&&!on1&&!on2)?'a':'ok';
if(el('sSt'))el('sSt').innerHTML=w==='a'?'<span class="bdg bdg-a" onclick="scrollToAlarm()" style="cursor:pointer">‚óè –ê–≤–∞—Ä–∏—è</span>':w==='w'?'<span class="bdg bdg-w" onclick="scrollToAlarm()" style="cursor:pointer">‚óè –ü—Ä–µ–¥—É–ø—Ä.</span>':'<span class="bdg bdg-ok">‚óè –ù–æ—Ä–º–∞</span>';
if(el('sResp')){var rid=S[cur]?.responsible||'';var users=getBxUsers();var rn='‚Äî';for(var ui=0;ui<users.length;ui++){if(users[ui].id===rid)rn=users[ui].name}el('sResp').textContent=rn}
if(el('evL'))el('evL').innerHTML=evts.slice(0,10).map(e=>`<div class="er"><span class="et">${e.t}</span>${esc(e.m)}</div>`).join('')}
function applyGen(sl,status,rh,basePower,isOnline){const card=$('c'+sl);if(!card)return;const st=ST[status],on=status!=='standby',isO=card.classList.contains('op');
card.className='cc '+st.cls+(isO?' op':'');card.querySelector('.cdot').className='cdot '+st.dot;
const bdg=card.querySelector('.bdg');bdg.className='bdg '+st.bdg;bdg.textContent=st.txt;
// Use real WS metrics if available, else random (demo)
const devId=getDeviceIdForSlot(sl),mx=devId?latestMetrics[devId]:null;
const p=mx?.power_total!=null?mx.power_total:(basePower?basePower+R(-8,8):R(220,340));
const u=mx?.gen_uab!=null?mx.gen_uab:R(398,406);
const I=mx?.current_a!=null?(mx.current_a+mx.current_b+mx.current_c):(basePower?Math.round(basePower*2.5+R(-20,20)):RI(1100,1350));
const f=mx?.gen_freq!=null?mx.gen_freq:R(49.96,50.04);
const kvs=card.querySelectorAll('.kv');
if(on){kvs[0].className='kv vg';kvs[0].innerHTML=p.toFixed(1)+'<span class="ku">–∫–í—Ç</span>';kvs[1].className='kv vn';kvs[1].innerHTML=u.toFixed(0)+'<span class="ku">–í</span>';kvs[2].className='kv vn';kvs[2].innerHTML=Math.round(I)+'<span class="ku">–ê</span>';kvs[3].className='kv vn';kvs[3].innerHTML=f.toFixed(2)+'<span class="ku">–ì—Ü</span>'}else kvs.forEach(k=>{k.className='kv vm';k.textContent='‚Äî'});
const modes=card.querySelectorAll('.mdt');modes.forEach(m=>m.classList.remove('on'));
if(mx){if(mx.mode_auto)modes[0]?.classList.add('on');if(mx.mode_manual)modes[1]?.classList.add('on');if(mx.mode_test)modes[2]?.classList.add('on');if(mx.mode_stop)modes[3]?.classList.add('on')}else{if(on)modes[0]?.classList.add('on');else modes[3]?.classList.add('on')}
// Update run hours display in header
const rhEl=$(sl+'-rh');if(rhEl){const rhVal=mx?.run_hours!=null?mx.run_hours:rh;rhEl.textContent='‚è± '+(typeof rhVal==='number'?rhVal.toFixed(0):rhVal)+' —á'}
const tob=$(sl+'-to');if(tob){const to=getNextTO(rh,cur,sl);if(to.unknown){tob.querySelector('.to-head').innerHTML=`<span class="to-name to-y">‚ö† –£–∫–∞–∂–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û</span><span class="to-remain" style="color:var(--y);cursor:pointer" onclick="event.stopPropagation();openSet()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí</span>`;tob.onclick=function(e){e.stopPropagation();openSet()};const bar=tob.querySelector('.to-bar');if(bar)bar.style.display='none';const tasks=tob.querySelector('.to-tasks');if(tasks)tasks.style.display='none';const hint=tob.querySelector('.to-hint');if(hint)hint.style.display='none'}else{const tc2=to.remain<0?'to-r':to.pct>85?'to-r':to.pct>65?'to-y':'to-g';const bc2=to.remain<0?'var(--r)':to.pct>85?'var(--r)':to.pct>65?'var(--y)':'var(--g)';tob.querySelector('.to-head').innerHTML=`<span class="to-name ${tc2}">${to.name} ‚Üí ${to.dueAt}—á</span><span class="to-remain">${to.remain>0?to.remain+'—á –æ—Å—Ç.':(to.remain<0?'–ø—Ä–æ—Å—Ä–æ—á. '+Math.abs(to.remain)+'—á':'—Å–µ–π—á–∞—Å')} ¬∑ ${rh}—á</span>`;const fill=tob.querySelector('.to-fill');if(fill){fill.parentElement.style.display='';fill.style.cssText=`width:${to.pct}%;background:${bc2}`}}}
// online/offline indicator: isOnline=true means WS data arrives, separate from gen running
const connOk=isOnline!==undefined?isOnline:(mx?.online===true);
card.querySelector('.lo').className='lo '+(connOk?'lo-g':'lo-r');card.querySelector('.li span:last-child').textContent=connOk?(on?'live':'standby'):'offline';
// Detailed tabs ‚Äî use real WS data if available
const ct=mx?.coolant_temp!=null?mx.coolant_temp:(status==='warning'?RI(93,99):(status==='alarm'?RI(100,108):RI(75,88)));
const op=mx?.oil_pressure!=null?mx.oil_pressure:(status==='alarm'?RI(150,250):RI(350,450));
const eT=$(sl+'e');if(eT&&on){const pp=mx?.power_total!=null?mx.power_total:(basePower||p);
const q=mx?.reactive_total!=null?mx.reactive_total:R(30,55);
const pf=mx?.pf_avg!=null?mx.pf_avg:R(.97,.999);
const uab=mx?.gen_uab!=null?mx.gen_uab:u;
const ubc=mx?.gen_ubc!=null?mx.gen_ubc:R(397,403);
const uca=mx?.gen_uca!=null?mx.gen_uca:R(399,405);
const ia=mx?.current_a!=null?mx.current_a:Math.round(I/3+R(-15,15));
const ib=mx?.current_b!=null?mx.current_b:Math.round(I/3+R(-15,15));
const ic=mx?.current_c!=null?mx.current_c:Math.round(I/3+R(-15,15));
const pa=mx?.power_a!=null?mx.power_a:(pp/3+R(-5,5));
const pb=mx?.power_b!=null?mx.power_b:(pp/3+R(-5,5));
const pc=mx?.power_c!=null?mx.power_c:(pp/3+R(-5,5));
const ld=mx?.load_pct!=null?mx.load_pct:Math.round(pp/5);
const ekwh=mx?.energy_kwh!=null?mx.energy_kwh:RI(400,500);
const starts=mx?.start_count!=null?mx.start_count:RI(300,400);
eT.innerHTML=`<div class="mg"><div class="mc"><div class="ml">P</div><div class="mv vg">${pp.toFixed?pp.toFixed(1):pp}<span class="mu">–∫–í—Ç</span></div></div><div class="mc"><div class="ml">Q</div><div class="mv vn">${typeof q==='number'?q.toFixed(1):q}<span class="mu">–∫–≤–∞—Ä</span></div></div><div class="mc"><div class="ml">Cos œÜ</div><div class="mv vn">${typeof pf==='number'?pf.toFixed(3):pf}</div></div></div><table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U</th><th>I</th><th>P</th></tr></thead><tbody><tr><td class="ph">A-B</td><td>${typeof uab==='number'?uab.toFixed(0):uab}</td><td>${typeof ia==='number'?ia.toFixed(1):ia}</td><td>${typeof pa==='number'?pa.toFixed(1):pa}</td></tr><tr><td class="ph">B-C</td><td>${typeof ubc==='number'?ubc.toFixed(0):ubc}</td><td>${typeof ib==='number'?ib.toFixed(1):ib}</td><td>${typeof pb==='number'?pb.toFixed(1):pb}</td></tr><tr><td class="ph">C-A</td><td>${typeof uca==='number'?uca.toFixed(0):uca}</td><td>${typeof ic==='number'?ic.toFixed(1):ic}</td><td>${typeof pc==='number'?pc.toFixed(1):pc}</td></tr></tbody></table><div class="mg mg4" style="margin-top:10px"><div class="mc"><div class="ml">–ù–∞–≥—Ä—É–∑–∫–∞</div><div class="mv vn">${ld}%</div></div><div class="mc"><div class="ml">–≠–Ω–µ—Ä–≥–∏—è</div><div class="mv vn">${ekwh}<span class="mu">–∫–í—Ç¬∑—á</span></div></div><div class="mc"><div class="ml">–ú–æ—Ç–æ—á–∞—Å—ã</div><div class="mv vn">${typeof rh==='number'?rh.toFixed(0):rh}<span class="mu">—á</span></div></div><div class="mc"><div class="ml">–ü—É—Å–∫–æ–≤</div><div class="mv vn">${starts}</div></div></div>`}
else if(eT&&!on)eT.innerHTML=`<div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">${connOk?'–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω':'–ù–µ—Ç —Å–≤—è–∑–∏'}</div>`;
const mT=$(sl+'m');if(mT&&on){
const rpm=mx?.engine_speed!=null?mx.engine_speed:1500;
const oilT=mx?.oil_temp!=null?mx.oil_temp:RI(70,85);
const fuel=mx?.fuel_level!=null?mx.fuel_level:RI(30,90);
const fc=mx?.fuel_consumption!=null?mx.fuel_consumption:R(30,45);
const turbo=mx?.turbo_pressure!=null?mx.turbo_pressure:RI(160,200);
const batt=mx?.battery_volt!=null?mx.battery_volt:R(27,28.5);
const ctC=(typeof ct==='number'&&ct>95)?'va':(typeof ct==='number'&&ct>88)?'vw':'vn';
const opC=(typeof op==='number'&&op<300)?'va':'vn';
const fuelC=(typeof fuel==='number'&&fuel<50)?'vw':'vn';
mT.innerHTML=`<div class="mg"><div class="mc"><div class="ml">–û–±–æ—Ä–æ—Ç—ã</div><div class="mv vn">${rpm}</div></div><div class="mc"><div class="ml">–¢–µ–º–ø.–û–ñ</div><div class="mv ${ctC}">${ct}¬∞C</div></div><div class="mc"><div class="ml">–î–∞–≤–ª.–º–∞—Å–ª–∞</div><div class="mv ${opC}">${op} –∫–ü–∞</div></div><div class="mc"><div class="ml">–¢–µ–º–ø.–º–∞—Å–ª–∞</div><div class="mv vn">${oilT}¬∞C</div></div><div class="mc"><div class="ml">–¢–æ–ø–ª–∏–≤–æ</div><div class="mv ${fuelC}">${fuel}%</div></div><div class="mc"><div class="ml">–†–∞—Å—Ö–æ–¥</div><div class="mv vn">${typeof fc==='number'?fc.toFixed(1):fc} –ª/—á</div></div><div class="mc"><div class="ml">–¢—É—Ä–±–æ</div><div class="mv vn">${turbo} –∫–ü–∞</div></div><div class="mc"><div class="ml">–ë–∞—Ç–∞—Ä–µ—è</div><div class="mv vn">${typeof batt==='number'?batt.toFixed(1):batt}–í</div></div></div>`}
else if(mT&&!on)mT.innerHTML=`<div style="color:var(--t3);font-size:12px;text-align:center;padding:20px">${connOk?'‚Äî':'–ù–µ—Ç —Å–≤—è–∑–∏'}</div>`;
const aT=$(sl+'a-act');if(aT){if(status==='warning'){aT.innerHTML=`<div class="ai aw">‚ö† <b style="color:var(--y)">W008</b> ${ALARM_CODES['W008']}: ${ct}¬∞C<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;if(Math.random()<0.3)addAlarmToArchive(sl,'W008',ALARM_CODES['W008']+': '+ct+'¬∞C','warning')}else if(status==='alarm'){aT.innerHTML=`<div class="ai aa">üî¥ <b style="color:var(--r)">W012</b> ${ALARM_CODES['W012']}: ${op} –∫–ü–∞<span style="margin-left:auto;color:var(--t4)">${now()}</span></div><div class="ai aa" style="margin-top:2px">üî¥ <b style="color:var(--r)">E014</b> ${ALARM_CODES['E014']}<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;if(Math.random()<0.3){addAlarmToArchive(sl,'W012',ALARM_CODES['W012']+': '+op+' –∫–ü–∞','alarm');addAlarmToArchive(sl,'E014',ALARM_CODES['E014'],'alarm')}}else aT.innerHTML='<div style="color:var(--g);font-size:12px;text-align:center;padding:15px">‚úì –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤–∞—Ä–∏–π</div>'}}
function applySpr(gOn,mN,bC,mC,isOnline){const card=$('cspr');if(!card)return;const isO=card.classList.contains('op'),active=gOn||mN;
// Status: alarm (mains abnormal), running (active), standby (online but idle), offline
let cls='s-stb',dot='cd-x',bcls='bdg-off',btxt='–°–¢–û–ü';
if(!isOnline){cls='s-stb';dot='cd-x';bcls='bdg-off';btxt='OFFLINE'}
else if(!mN&&!active){cls='s-alm';dot='cd-r';bcls='bdg-a';btxt='–ê–í–ê–†–ò–Ø'}
else if(active){cls='s-run';dot='cd-g';bcls='bdg-run';btxt='–†–ê–ë–û–¢–ê'}
else{cls='s-run';dot='cd-g';bcls='bdg-ok';btxt='–ù–û–†–ú–ê'}
card.className='cc '+cls+(isO?' op':'');card.querySelector('.cdot').className='cdot '+dot;
const bdg=card.querySelector('.bdg');bdg.className='bdg '+bcls;bdg.textContent=btxt;
const kvs=card.querySelectorAll('.kv'),bp=R(400,520),bu=RI(398,405),bf=R(49.98,50.04);
if(isOnline){
const m3=latestMetrics[getDeviceIdForSlot('spr')];
const rBp=m3?.busbar_p!=null?m3.busbar_p:0;
const rBu=m3?.busbar_uab!=null?m3.busbar_uab:0;
const rBf=m3?.busbar_freq!=null?m3.busbar_freq:0;
kvs[0].className='kv '+(rBp>0?'vg':'vn');kvs[0].innerHTML=(rBp||0).toFixed(1)+'<span class="ku">–∫–í—Ç</span>';
kvs[1].className='kv vn';kvs[1].innerHTML=(rBu||0)+'<span class="ku">–í</span>';
kvs[2].className='kv vn';kvs[2].innerHTML=(rBf||0).toFixed(2)+'<span class="ku">–ì—Ü</span>';
kvs[3].className=mN?'kv vg':'kv va';kvs[3].textContent=mN?'–ù–û–†–ú':'–ê–í–ê–†';
const mode=gOn&&!mC?'–ì–ï–ù':mC&&!gOn?'–°–ï–¢–¨':gOn&&mC?'–ü–ê–†–ê–õ':'‚Äî';
kvs[4].className='kv '+(gOn&&mC?'vp':gOn?'vg':mN?'vb':'vm');kvs[4].textContent=mN&&!gOn?'–°–ï–¢–¨':mode;
}else kvs.forEach(k=>{k.className='kv vm';k.textContent='‚Äî'});
card.querySelector('.lo').className='lo '+(isOnline?'lo-g':'lo-r');card.querySelector('.li span:last-child').textContent=isOnline?'live':'offline';
const sprb=$('sprb');if(sprb&&isOnline){const m3=latestMetrics[getDeviceIdForSlot('spr')];const rBp=m3?.busbar_p!=null?m3.busbar_p:0;const rBq=m3?.busbar_q!=null?m3.busbar_q:0;const rBi=m3?.busbar_current!=null?m3.busbar_current:0;const rBuab=m3?.busbar_uab||0;const rBubc=m3?.busbar_ubc||0;const rBuca=m3?.busbar_uca||0;const rBua=m3?.busbar_ua||0;const rBub=m3?.busbar_ub||0;const rBuc=m3?.busbar_uc||0;
sprb.innerHTML=`<div class="mg"><div class="mc"><div class="ml">P —à–∏–Ω—ã</div><div class="mv ${rBp>0?'vg':'vn'}">${rBp.toFixed(1)}<span class="mu">–∫–í—Ç</span></div></div><div class="mc"><div class="ml">Q</div><div class="mv vn">${rBq.toFixed(1)}<span class="mu">–∫–≤–∞—Ä</span></div></div><div class="mc"><div class="ml">I</div><div class="mv vn">${rBi.toFixed(0)}<span class="mu">–ê</span></div></div></div><table class="pt"><thead><tr><th>–§–∞–∑–∞</th><th>U –ª–∏–Ω</th><th>U —Ñ–∞–∑</th></tr></thead><tbody><tr><td class="ph">A-B</td><td>${rBuab}</td><td>${rBua}</td></tr><tr><td class="ph">B-C</td><td>${rBubc}</td><td>${rBub}</td></tr><tr><td class="ph">C-A</td><td>${rBuca}</td><td>${rBuc}</td></tr></tbody></table>`}else if(sprb){sprb.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">‚Äî</div>'}
const sprm=$('sprm');if(sprm&&isOnline){const m3=latestMetrics[getDeviceIdForSlot('spr')];const rMu=m3?.mains_uab||0;const rMf=m3?.mains_freq||0;sprm.innerHTML=mN?`<div class="mg"><div class="mc"><div class="ml">U —Å–µ—Ç–∏</div><div class="mv vn">${rMu}<span class="mu">–í</span></div></div><div class="mc"><div class="ml">f —Å–µ—Ç–∏</div><div class="mv vn">${rMf.toFixed(2)}<span class="mu">–ì—Ü</span></div></div><div class="mc"><div class="ml">–°—Ç–∞—Ç—É—Å</div><div class="mv vg">–ù–û–†–ú–ê</div></div></div>`:`<div class="mg"><div class="mc"><div class="ml">–°–µ—Ç—å</div><div class="mv va">–ê–í–ê–†–ò–Ø</div></div><div class="mc"><div class="ml">U</div><div class="mv vm">${rMu}<span class="mu">–í</span></div></div><div class="mc"><div class="ml">f</div><div class="mv vm">${rMf.toFixed(2)}<span class="mu">–ì—Ü</span></div></div></div>`}
const sprs=$('sprs');if(sprs)sprs.innerHTML=`<div class="mg mg2"><div class="mc"><div class="ml">–ê–≤—Ç.—à–∏–Ω—ã</div><div class="mv ${bC?'vg':'vm'}">${bC?'–ó–ê–ú–ö–ù–£–¢':'–†–ê–ó–û–ú–ö–ù'}</div></div><div class="mc"><div class="ml">–ê–≤—Ç.—Å–µ—Ç–∏</div><div class="mv ${mC?'vb':'vm'}">${mC?'–ó–ê–ú–ö–ù–£–¢':'–†–ê–ó–û–ú–ö–ù'}</div></div><div class="mc"><div class="ml">–°–µ—Ç—å</div><div class="mv ${mN?'vg':'va'}">${mN?'–ù–û–†–ú–ê':'–ê–í–ê–†–ò–Ø'}</div></div><div class="mc"><div class="ml">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã</div><div class="mv ${gOn?'vg':'vm'}">${gOn?'–†–ê–ë–û–¢–ê':'–°–¢–û–ü'}</div></div></div>`;
const sprAct=$('spra-act');if(sprAct){if(!mN){sprAct.innerHTML=`<div class="ai aa">üî¥ <b style="color:var(--r)">M001</b> ${ALARM_CODES['M001']}<span style="margin-left:auto;color:var(--t4)">${now()}</span></div>`;if(Math.random()<0.2)addAlarmToArchive('spr','M001',ALARM_CODES['M001'],'alarm')}else if(isOnline){sprAct.innerHTML='<div style="color:var(--g);font-size:12px;text-align:center;padding:15px">‚úì –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤–∞—Ä–∏–π</div>'}else{sprAct.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–ù–µ—Ç —Å–≤—è–∑–∏ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º</div>'}}}
// === BITRIX24 INTEGRATION ===
function getBxConfig(){try{return JSON.parse(localStorage.getItem('s5bx'))||{}}catch(e){return{}}}
function saveBxCfg(c){localStorage.setItem('s5bx',JSON.stringify(c))}
function getBxUsers(){try{return JSON.parse(localStorage.getItem('s5bx_users'))||[]}catch(e){return[]}}
function saveBxUsers(u){localStorage.setItem('s5bx_users',JSON.stringify(u))}
function bxTab(btn,idx){btn.closest('.mbd').querySelectorAll('.set-tab').forEach(b=>b.classList.remove('on'));btn.closest('.mbd').querySelectorAll('.set-panel').forEach(p=>p.classList.remove('on'));btn.classList.add('on');$('bxp'+idx)?.classList.add('on')}
function saveBxConfig(){const cfg=getBxConfig();cfg.url=($('bxUrl')?.value||'').trim();cfg.folderId=$('bxFolderId')?.value||'';cfg.groupId=$('bxGroupId')?.value||'';cfg.taskTitle=$('bxTaskTitle')?.value||'{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}';cfg.deadlineDays=+($('bxDeadlineDays')?.value)||3;cfg.priority=$('bxPriority')?.value||'1';cfg.auditor=$('bxAuditor')?.value||'';cfg.autoCreate=$('bxAutoCreate')?.checked||false;cfg.addChecklist=$('bxAddChecklist')?.checked!==false;cfg.descBBCode=$('bxDescBBCode')?.checked!==false;saveBxCfg(cfg);ae('‚úÖ –ë–∏—Ç—Ä–∏–∫—Å24 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã')}
async function testBxConnection(){const el=$('bxConnResult');const url=($('bxUrl')?.value||'').trim();if(!url){el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">–£–∫–∞–∂–∏—Ç–µ Webhook URL</div>';return}
el.innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y);font-family:var(--m)">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>';
if(apiAvailable){try{const r=await api.post('/api/bitrix/test',{webhook_url:url});
if(r.success){el.innerHTML='<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m)">‚úÖ '+r.message+'</div>';ae('‚úÖ –ë24 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ OK')}
else{el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+r.message+'</div>'}
}catch(e){el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+e.message+'</div>'}}
else{setTimeout(function(){el.innerHTML='<div style="padding:6px 10px;background:var(--bb);border:1px solid rgba(64,144,255,.2);border-radius:6px;font-size:11px;color:var(--b);font-family:var(--m)">‚Ñπ Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. URL: '+esc(url.substring(0,40))+'...</div>'},800)}}
async function loadBxUsers(){const el=$('bxUserList');el.innerHTML='<div style="color:var(--y);font-size:12px;text-align:center;padding:15px">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ user.get...</div>';
const cfg=getBxConfig();
if(apiAvailable&&cfg.url){try{const r=await api.post('/api/bitrix/users/sync',{webhook_url:cfg.url});
if(r.success){saveBxUsers(r.users);var h='';for(var i=0;i<r.users.length;i++){var u=r.users[i];h+='<div class="bk-item"><div><b style="color:var(--t)">'+esc(u.name)+'</b><br><span style="color:var(--t3);font-size:10px">'+esc(u.pos)+' ¬∑ '+esc(u.dept)+'</span></div><span style="font-size:10px;color:var(--t4);font-family:var(--m)">ID: '+u.id+'</span></div>'}
el.innerHTML=h+'<div style="padding:6px;text-align:center;font-size:10px;color:var(--t4)">'+r.users.length+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –ë24</div>';ae('üë• –ó–∞–≥—Ä—É–∂–µ–Ω–æ '+r.users.length+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');return}
}catch(e){console.warn('Bitrix users error:',e)}}
// Fallback: demo data
setTimeout(function(){var users=[{id:'1',name:'–ò–≤–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π',dept:'–≠–Ω–µ—Ä–≥–æ—Å–ª—É–∂–±–∞',pos:'–°—Ç–∞—Ä—à–∏–π –∏–Ω–∂–µ–Ω–µ—Ä'},{id:'2',name:'–ü–µ—Ç—Ä–æ–≤ –°–µ—Ä–≥–µ–π',dept:'–≠–Ω–µ—Ä–≥–æ—Å–ª—É–∂–±–∞',pos:'–ò–Ω–∂–µ–Ω–µ—Ä'},{id:'3',name:'–°–∏–¥–æ—Ä–æ–≤ –î–º–∏—Ç—Ä–∏–π',dept:'–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π —Ü–µ—Ö',pos:'–ú–µ—Ö–∞–Ω–∏–∫'},{id:'5',name:'–ö–æ–∑–ª–æ–≤–∞ –ê–Ω–Ω–∞',dept:'–î–∏—Å–ø–µ—Ç—á–µ—Ä—Å–∫–∞—è',pos:'–î–∏—Å–ø–µ—Ç—á–µ—Ä'},{id:'8',name:'–í–æ–ª–∫–æ–≤ –ù–∏–∫–æ–ª–∞–π',dept:'–≠–Ω–µ—Ä–≥–æ—Å–ª—É–∂–±–∞',pos:'–ù–∞—á–∞–ª—å–Ω–∏–∫'}];saveBxUsers(users);
var h='';for(var i=0;i<users.length;i++){var u=users[i];h+='<div class="bk-item"><div><b style="color:var(--t)">'+esc(u.name)+'</b><br><span style="color:var(--t3);font-size:10px">'+esc(u.pos)+' ¬∑ '+esc(u.dept)+'</span></div><span style="font-size:10px;color:var(--t4);font-family:var(--m)">ID: '+u.id+'</span></div>'}
el.innerHTML=h+'<div style="padding:6px;text-align:center;font-size:10px;color:var(--t4)">'+users.length+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ ¬∑ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</div>';ae('üë• –ó–∞–≥—Ä—É–∂–µ–Ω–æ '+users.length+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–¥–µ–º–æ)')},1000)}
function formatSize(b){if(b<1024)return b+' –ë';if(b<1048576)return(b/1024).toFixed(0)+' –ö–ë';return(b/1048576).toFixed(1)+' –ú–ë'}
async function scanBxFolder(){var el=$('bxFileList');var fid=$('bxFolderId')?.value;if(!fid){el.innerHTML='<div style="padding:6px;background:var(--rd);border-radius:6px;font-size:11px;color:var(--r)">–£–∫–∞–∂–∏—Ç–µ ID –ø–∞–ø–∫–∏</div>';return}
el.innerHTML='<div style="padding:10px;color:var(--y);font-size:12px;text-align:center">‚è≥ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ disk.folder.getchildren...</div>';
var cfg=getBxConfig();
if(apiAvailable&&cfg.url){try{var r=await api.post('/api/bitrix/folder/scan',{webhook_url:cfg.url,folder_id:parseInt(fid)});
if(r.success&&r.files&&r.files.length>0){var h='<div style="font-size:11px;color:var(--t3);margin-bottom:6px">–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: '+r.files.length+'</div>';
for(var i=0;i<r.files.length;i++){var f=r.files[i];var ext=(f.name||'').split('.').pop().toLowerCase();var canParse=(ext==='pdf'||ext==='docx');
h+='<div class="bk-item"><div><b style="color:var(--t)">'+esc(f.name)+'</b><br><span style="color:var(--t3);font-size:10px">'+ext.toUpperCase()+' ¬∑ '+formatSize(f.size||0)+' ¬∑ '+(f.updated||'')+'</span></div>';
if(canParse){h+='<button class="bk-btn" onclick="importBxFile('+f.id+',\''+esc(f.name).replace(/'/g,"\\'")+'\')" style="color:var(--p)">ü§ñ AI Import</button>'}
h+='</div>'}
el.innerHTML=h;ae('üìÇ –ù–∞–π–¥–µ–Ω–æ '+r.files.length+' —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ –ë24')}
else if(r.success){el.innerHTML='<div style="padding:10px;font-size:11px;color:var(--t3);text-align:center">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</div>'}
else{el.innerHTML='<div style="padding:6px;background:var(--rd);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+(r.message||'–û—à–∏–±–∫–∞')+'</div>'}}
catch(e){el.innerHTML='<div style="padding:6px;background:var(--rd);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+e.message+'</div>'}}
else{setTimeout(function(){el.innerHTML='<div style="font-size:11px;color:var(--t3);margin-bottom:6px">–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:</div><div class="bk-item"><div><b style="color:var(--t)">–†–µ–≥–ª–∞–º–µ–Ω—Ç_–¢–û_–î–ì–£_2024.pdf</b><br><span style="color:var(--t3);font-size:10px">PDF ¬∑ 2.4 –ú–ë ¬∑ 15.01.2025</span></div><button class="bk-btn" onclick="importBxFile(1,\'–†–µ–≥–ª–∞–º–µ–Ω—Ç_–¢–û_–î–ì–£_2024.pdf\')" style="color:var(--p)">ü§ñ AI Import</button></div><div class="bk-item"><div><b style="color:var(--t)">–¢–û_Cummins_QSK60.docx</b><br><span style="color:var(--t3);font-size:10px">DOCX ¬∑ 890 –ö–ë ¬∑ 22.12.2024</span></div><button class="bk-btn" onclick="importBxFile(2,\'–¢–û_Cummins_QSK60.docx\')" style="color:var(--p)">ü§ñ AI Import</button></div><div style="padding:6px;font-size:9px;color:var(--t4);text-align:center">–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ ¬∑ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>'},1200)}}
async function importBxFile(fileId,filename){var el=$('bxFileList');var cfg=getBxConfig();
el.innerHTML+='<div id="aiProgress" style="padding:10px;background:var(--pd);border:1px solid rgba(160,112,255,.2);border-radius:8px;margin-top:8px"><div style="font-size:12px;color:var(--p);font-weight:600;margin-bottom:6px">ü§ñ AI-–∞–≥–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</div><div id="aiStep" style="font-size:11px;color:var(--t2)">‚è≥ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24...</div><div style="margin-top:6px;height:3px;background:rgba(160,112,255,.1);border-radius:2px;overflow:hidden"><div id="aiBar" style="width:10%;height:100%;background:var(--p);transition:width .5s"></div></div></div>';
ae('ü§ñ AI-–∏–º–ø–æ—Ä—Ç: '+(filename||'file#'+fileId));
var t1=setTimeout(function(){var b=$('aiBar'),s=$('aiStep');if(b)b.style.width='30%';if(s)s.textContent='‚è≥ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞...'},2000);
var aiCfgName=((AI_PROVIDERS[(getAIConfig().provider||'openai')])||{}).name||'AI';
var t2=setTimeout(function(){var b=$('aiBar'),s=$('aiStep');if(b)b.style.width='50%';if(s)s.textContent='‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ '+aiCfgName+' –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...'},5000);
var t3=setTimeout(function(){var b=$('aiBar'),s=$('aiStep');if(b)b.style.width='80%';if(s)s.textContent='‚è≥ –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¢–û –∏ —Ä–∞–±–æ—Ç...'},15000);
if(apiAvailable&&cfg.url){try{var r=await api.post('/api/ai/parse',{webhook_url:cfg.url,file_id:fileId,filename:filename||''});
clearTimeout(t1);clearTimeout(t2);clearTimeout(t3);
var bar=$('aiBar');if(bar)bar.style.width='100%';
if(r.success&&r.intervals&&r.intervals.length>0){window._aiParsedResult=r;
var prog=$('aiProgress');if(prog)prog.remove();
var h='<div id="aiResult" style="padding:10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:8px;margin-top:8px">';
h+='<div style="font-size:12px;color:var(--g);font-weight:600;margin-bottom:6px">‚úÖ AI-–∞–≥–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª –∞–Ω–∞–ª–∏–∑</div>';
h+='<div style="font-size:11px;color:var(--t2);margin-bottom:8px">'+esc(r.template_name)+' ‚Äî '+r.intervals.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤</div>';
for(var i=0;i<r.intervals.length;i++){var iv=r.intervals[i];h+='<div style="padding:5px 8px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:4px;margin-bottom:3px"><div style="display:flex;justify-content:space-between"><b style="font-size:11px">'+esc(iv.name)+'</b><span style="font-size:10px;color:var(--t3);font-family:var(--m)">'+iv.hours+'—á ¬∑ '+iv.tasks.length+' —Ä–∞–±–æ—Ç</span></div></div>'}
h+='<div style="display:flex;gap:8px;margin-top:10px"><button class="bp" style="flex:1" onclick="applyAIResult()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—É</button><button class="bs2" style="padding:10px" onclick="var e=document.getElementById(\'aiResult\');if(e)e.remove()">‚úï</button></div></div>';
el.innerHTML+=h;ae('‚úÖ AI: –Ω–∞–π–¥–µ–Ω–æ '+r.intervals.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¢–û')}
else{var step=$('aiStep');if(step){step.textContent='‚ùå '+(r.error||'–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ');step.style.color='var(--r)'}ae('‚ùå AI: '+(r.error||'–ø—É—Å—Ç–æ'))}}
catch(e){clearTimeout(t1);clearTimeout(t2);clearTimeout(t3);var step=$('aiStep');if(step){step.textContent='‚ùå –û—à–∏–±–∫–∞: '+e.message;step.style.color='var(--r)'}ae('‚ùå AI –æ—à–∏–±–∫–∞: '+e.message)}}
else{clearTimeout(t1);clearTimeout(t2);clearTimeout(t3);var step=$('aiStep');if(step){step.textContent='‚Ñπ Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî AI-–∏–º–ø–æ—Ä—Ç —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É';step.style.color='var(--b)'}}}
function applyAIResult(){var r=window._aiParsedResult;if(!r||!r.intervals){ae('‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö AI');return}
var tpl=getTpl();var newIvs=[];
for(var i=0;i<r.intervals.length;i++){var iv=r.intervals[i];var tasks=[];
for(var j=0;j<iv.tasks.length;j++){tasks.push({id:j+1,text:iv.tasks[j].text,c:iv.tasks[j].is_critical?1:0})}
newIvs.push({id:iv.code,name:iv.name,hours:iv.hours,tasks:tasks})}
if(confirm('–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–≥–ª–∞–º–µ–Ω—Ç ('+tpl.intervals.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤) –Ω–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ('+newIvs.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤)?')){
tpl.name=r.template_name||tpl.name;tpl.intervals=newIvs;saveTpl(tpl);
ae('‚úÖ –†–µ–≥–ª–∞–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –∏–∑ AI: '+newIvs.length+' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤');hideM('bitrix');openTOTemplates()}}
function createBxTaskFromTO(dev){var tpl=getTpl();var idx=+($('toSel')?.value||0);var iv=tpl.intervals[idx];if(!iv){ae('‚ö† –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¢–û');return}createBxTask(dev,iv.name,iv.tasks)}
function createBxTask(dev,toName,tasks){var cfg=getBxConfig();var s=S[cur];if(!s)return;var users=getBxUsers();var respId=s.responsible||'';var respName='–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';for(var i=0;i<users.length;i++){if(users[i].id===respId)respName=users[i].name}
var genName=dev==='g1'?'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1':'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 2';var title=cfg.taskTitle||'{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}';title=title.replace('{TO_NAME}',toName).replace('{SITE_NAME}',s.name).replace('{GEN_NAME}',genName).replace('{HOURS}',s[dev]?.runHours||0).replace('{RESPONSIBLE}',respName);
var dl=new Date();dl.setDate(dl.getDate()+(+cfg.deadlineDays||3));var dlStr=dl.toISOString().replace('Z','+03:00');
var desc='[B]–û–±—ä–µ–∫—Ç:[/B] '+s.name+'\n[B]–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä:[/B] '+genName+'\n[B]–ú–æ—Ç–æ—á–∞—Å—ã:[/B] '+(s[dev]?.runHours||0)+'\n[B]–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:[/B] '+respName+'\n\n[B]–†–∞–±–æ—Ç—ã –¢–û:[/B]\n';
for(var ti=0;ti<tasks.length;ti++){desc+=(ti+1)+'. '+tasks[ti].text+(tasks[ti].c?' [COLOR=red][!] –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û[/COLOR]':'')+'\n'}
var auditors=cfg.auditor?'['+cfg.auditor+']':'[]';
var payload='{\n  "fields": {\n    "TITLE": "'+title.replace(/"/g,'\\"')+'",\n    "DESCRIPTION": "'+desc.replace(/"/g,'\\"').replace(/\n/g,'\\n')+'",\n    "DESCRIPTION_IN_BBCODE": "Y",\n    "RESPONSIBLE_ID": '+respId+',\n    "GROUP_ID": '+(cfg.groupId||'null')+',\n    "DEADLINE": "'+dlStr+'",\n    "PRIORITY": '+(cfg.priority||1)+',\n    "AUDITORS": '+auditors+',\n    "ALLOW_CHANGE_DEADLINE": "N"\n  }\n}';
var chkPayload='// –î–ª—è –∫–∞–∂–¥–æ–π —Ä–∞–±–æ—Ç—ã:\ntask.checklistitem.add\n[TASK_ID, {"TITLE": "—Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç—ã"}]';
$('toBody').innerHTML+='<div style="padding:10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:8px;margin-top:10px"><div style="font-size:12px;color:var(--g);font-weight:600;margin-bottom:8px">üìã –ó–∞–¥–∞—á–∞ –¥–ª—è –ë–∏—Ç—Ä–∏–∫—Å24</div><div style="font-size:11px;color:var(--t2);line-height:1.5"><b>TITLE:</b> '+esc(title)+'<br><b>RESPONSIBLE_ID:</b> '+respId+' ('+esc(respName)+')<br><b>GROUP_ID:</b> '+(cfg.groupId||'‚Äî')+'<br><b>DEADLINE:</b> '+dlStr+'<br><b>PRIORITY:</b> '+(cfg.priority||1)+'<br><b>AUDITORS:</b> '+auditors+'<br><b>–ß–µ–∫–ª–∏—Å—Ç:</b> '+tasks.length+' –ø—É–Ω–∫—Ç–æ–≤'+(cfg.addChecklist!==false?' (task.checklistitem.add)':' (–æ—Ç–∫–ª—é—á—ë–Ω)')+'</div><details style="margin-top:8px"><summary style="cursor:pointer;font-size:10px;color:var(--t3)">–ü–æ–∫–∞–∑–∞—Ç—å JSON payload</summary><pre style="font-size:9px;color:var(--t3);background:var(--bg);padding:8px;border-radius:4px;margin-top:4px;overflow-x:auto;white-space:pre-wrap">POST {webhook}/tasks.task.add\n'+esc(payload)+'</pre></details><div style="margin-top:8px;font-size:9px;color:var(--t4)">–¢—Ä–µ–±—É–µ—Ç—Å—è backend –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. URL: '+esc((cfg.url||'https://...').substring(0,35))+'...</div></div>';ae('üìã –ë24 –∑–∞–¥–∞—á–∞: '+title)}
function initBxModal(){var cfg=getBxConfig();if($('bxUrl'))$('bxUrl').value=cfg.url||'';if($('bxFolderId'))$('bxFolderId').value=cfg.folderId||'';if($('bxGroupId'))$('bxGroupId').value=cfg.groupId||'';if($('bxTaskTitle'))$('bxTaskTitle').value=cfg.taskTitle||'{TO_NAME} ‚Äî {SITE_NAME} ‚Äî {GEN_NAME}';if($('bxDeadlineDays'))$('bxDeadlineDays').value=cfg.deadlineDays||3;if($('bxPriority'))$('bxPriority').value=cfg.priority||'1';if($('bxAutoCreate'))$('bxAutoCreate').checked=cfg.autoCreate||false;if($('bxAddChecklist'))$('bxAddChecklist').checked=cfg.addChecklist!==false;if($('bxDescBBCode'))$('bxDescBBCode').checked=cfg.descBBCode!==false;var aud=$('bxAuditor');if(aud){var users=getBxUsers();aud.innerHTML='<option value="">‚Äî –Ω–µ—Ç ‚Äî</option>';for(var i=0;i<users.length;i++){var u=users[i];aud.innerHTML+='<option value="'+u.id+'"'+(u.id===(cfg.auditor||'')?'selected':'')+'>'+u.name+'</option>'}}}
// === AI PROVIDER CONFIG ===
const AI_PROVIDERS={
openai:{id:'openai',name:'OpenAI',color:'#10a37f',icon:'üü¢',models:['gpt-4o','gpt-4o-mini','gpt-4-turbo','o3-mini'],keyPrefix:'sk-',keyPlaceholder:'sk-proj-...'},
claude:{id:'claude',name:'Claude',color:'#d97706',icon:'üü†',models:['claude-sonnet-4-20250514','claude-3-5-haiku-20241022','claude-opus-4-20250514'],keyPrefix:'sk-ant-',keyPlaceholder:'sk-ant-api03-...'},
gemini:{id:'gemini',name:'Gemini',color:'#4285f4',icon:'üîµ',models:['gemini-2.5-pro','gemini-2.5-flash','gemini-2.0-flash'],keyPrefix:'AI',keyPlaceholder:'AIza...'},
grok:{id:'grok',name:'Grok',color:'#ef4444',icon:'üî¥',models:['grok-3','grok-3-mini','grok-2'],keyPrefix:'xai-',keyPlaceholder:'xai-...'}
};
function getAIConfig(){try{return JSON.parse(localStorage.getItem('s5ai'))||{}}catch(e){return{}}}
function saveAICfg(c){localStorage.setItem('s5ai',JSON.stringify(c))}
function initAIModal(){var cfg=getAIConfig();var cards=$('aiProviderCards');if(!cards)return;
var h='';for(var k in AI_PROVIDERS){var p=AI_PROVIDERS[k];var sel=cfg.provider===k;
h+='<div onclick="selectAIProvider(\''+k+'\')" style="padding:10px;border:2px solid '+(sel?p.color:'var(--bd)')+';border-radius:var(--rad);cursor:pointer;background:'+(sel?p.color+'15':'rgba(255,255,255,.02)')+';transition:all .2s;text-align:center" id="aip_'+k+'">';
h+='<div style="font-size:22px;margin-bottom:4px">'+p.icon+'</div>';
h+='<div style="font-size:13px;font-weight:600;color:'+(sel?p.color:'var(--t)')+'">'+p.name+'</div>';
h+='<div style="font-size:9px;color:var(--t3);margin-top:2px">'+p.models.length+' –º–æ–¥–µ–ª–µ–π</div>';
h+='</div>'}
cards.innerHTML=h;
if(cfg.provider){showAIKeySection(cfg.provider)}else{$('aiKeySection').style.display='none'}
updateAIStatus()}
function selectAIProvider(pid){var cfg=getAIConfig();cfg.provider=pid;saveAICfg(cfg);
for(var k in AI_PROVIDERS){var el=$('aip_'+k);if(!el)continue;var p=AI_PROVIDERS[k];var sel=k===pid;
el.style.borderColor=sel?p.color:'var(--bd)';el.style.background=sel?p.color+'15':'rgba(255,255,255,.02)';
el.querySelector('div:nth-child(2)').style.color=sel?p.color:'var(--t)'}
showAIKeySection(pid)}
function showAIKeySection(pid){var p=AI_PROVIDERS[pid];if(!p)return;var cfg=getAIConfig();
$('aiKeySection').style.display='block';
$('aiKeyLabel').textContent=p.name+' API Key';$('aiKeyLabel').style.color=p.color;
$('aiKeyInput').placeholder=p.keyPlaceholder;$('aiKeyInput').value=cfg.keys?.[pid]||'';$('aiKeyInput').type='password';
var sel=$('aiModelSelect');sel.innerHTML='';
for(var i=0;i<p.models.length;i++){var o=document.createElement('option');o.value=p.models[i];o.textContent=p.models[i];sel.appendChild(o)}
var savedModel=cfg.models?.[pid];if(savedModel)sel.value=savedModel;
$('aiTestResult').innerHTML=''}
function toggleAIKeyVis(){var inp=$('aiKeyInput');inp.type=inp.type==='password'?'text':'password'}
function saveAIConfig(){var cfg=getAIConfig();var pid=cfg.provider;if(!pid){ae('‚ö† –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞');return}
var key=$('aiKeyInput').value.trim();var model=$('aiModelSelect').value;
if(!key){ae('‚ö† –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á');return}
if(!cfg.keys)cfg.keys={};if(!cfg.models)cfg.models={};
cfg.keys[pid]=key;cfg.models[pid]=model;saveAICfg(cfg);
updateAIStatus();ae('‚úÖ '+AI_PROVIDERS[pid].name+' —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
// Push config to backend
if(apiAvailable){api.post('/api/ai/config',{provider:pid,api_key:key,model:model}).catch(function(e){console.warn('AI config push error:',e)})}}
async function testAIProvider(){var cfg=getAIConfig();var pid=cfg.provider;if(!pid)return;
var key=$('aiKeyInput').value.trim();var model=$('aiModelSelect').value;
if(!key){$('aiTestResult').innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á</div>';return}
var el=$('aiTestResult');el.innerHTML='<div style="padding:6px 10px;background:var(--yd);border:1px solid rgba(255,176,32,.2);border-radius:6px;font-size:11px;color:var(--y);font-family:var(--m)">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ '+AI_PROVIDERS[pid].name+'...</div>';
if(apiAvailable){try{var r=await api.post('/api/ai/test',{provider:pid,api_key:key,model:model});
if(r.success){el.innerHTML='<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m)">‚úÖ '+r.message+'</div>';ae('‚úÖ '+AI_PROVIDERS[pid].name+' OK')}
else{el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+(r.error||'–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è')+'</div>'}}
catch(e){el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r)">‚ùå '+e.message+'</div>'}}
else{setTimeout(function(){el.innerHTML='<div style="padding:6px 10px;background:var(--bb);border:1px solid rgba(64,144,255,.2);border-radius:6px;font-size:11px;color:var(--b);font-family:var(--m)">‚Ñπ Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Ç–µ—Å—Ç —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É</div>'},800)}}
function updateAIStatus(){var cfg=getAIConfig();var el=$('aiStatus');if(!el)return;
if(!cfg.provider){el.innerHTML='<b>–°—Ç–∞—Ç—É—Å:</b> –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω';return}
var p=AI_PROVIDERS[cfg.provider];var hasKey=cfg.keys?.[cfg.provider];var model=cfg.models?.[cfg.provider]||p.models[0];
el.innerHTML='<b>–°—Ç–∞—Ç—É—Å:</b> '+p.icon+' <span style="color:'+p.color+';font-weight:600">'+p.name+'</span>'+(hasKey?' ¬∑ <span style="color:var(--g)">üîë –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω</span>':' ¬∑ <span style="color:var(--y)">‚ö† –Ω–µ—Ç –∫–ª—é—á–∞</span>')+'<br><b>–ú–æ–¥–µ–ª—å:</b> <span style="font-family:var(--m)">'+model+'</span>'}
// === ALARM SYSTEM ===
// HGM9520N alarms from protocol Table 27
const ALARM_CODES={
'E001':'–ê–≤–∞—Ä–∏–π–Ω—ã–π –æ—Å—Ç–∞–Ω–æ–≤','E002':'–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –æ–±–æ—Ä–æ—Ç–æ–≤','E003':'–°–Ω–∏–∂–µ–Ω–∏–µ –æ–±–æ—Ä–æ—Ç–æ–≤','E004':'–ü–æ—Ç–µ—Ä—è —Å–∏–≥–Ω–∞–ª–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏',
'E005':'–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞','E006':'–ü–æ–Ω–∏–∂–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞','E007':'–ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞','E008':'–ü–æ–Ω–∏–∂–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞',
'E009':'–ù–µ—É–¥–∞—á–Ω—ã–π –∑–∞–ø—É—Å–∫','E010':'–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø–æ —Ç–æ–∫—É','E011':'–î–∏—Å–±–∞–ª–∞–Ω—Å —Ç–æ–∫–æ–≤','E012':'–ó–∞–º—ã–∫–∞–Ω–∏–µ –Ω–∞ –∑–µ–º–ª—é',
'E013':'–û–±—Ä–∞—Ç–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å','E014':'–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø–æ –º–æ—â–Ω–æ—Å—Ç–∏','E015':'–ü–æ—Ç–µ—Ä—è –≤–æ–∑–±—É–∂–¥–µ–Ω–∏—è','E016':'–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –≠–ë–£',
'W001':'–ê–≤–∞—Ä–∏—è –≠–ë–£','W002':'–í—Ö–æ–¥ –≤—ã—Å–æ–∫–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã','W003':'–í—Ö–æ–¥ –Ω–∏–∑–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è –º–∞—Å–ª–∞','W004':'–û—à–∏–±–∫–∞ MSC ID',
'W005':'–û—à–∏–±–∫–∞ —à–∏–Ω—ã –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è','W006':'–û—à–∏–±–∫–∞ —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è —Ñ–∞–∑','W007':'–û–±—Ä—ã–≤ –¥–∞—Ç—á–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã',
'W008':'–í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è','W009':'–ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è','W010':'–û–±—Ä—ã–≤ –¥–∞—Ç—á–∏–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è –º–∞—Å–ª–∞',
'W011':'–í—ã—Å–æ–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å–ª–∞','W012':'–ù–∏–∑–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å–ª–∞','W013':'–ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞',
'W014':'–û—à–∏–±–∫–∞ –∑–∞—Ä—è–¥–∫–∏','W015':'–ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë','W016':'–ü–æ–Ω–∏–∂–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë',
'W017':'–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏','W018':'–†–µ–≥—É–ª—è—Ç–æ—Ä –æ–±–æ—Ä–æ—Ç–æ–≤ –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ','W019':'AVR –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ',
'W020':'–û—à–∏–±–∫–∞ –≤–∫–ª. –∞–≤—Ç–æ–º–∞—Ç–∞ —Å–µ—Ç–∏','W021':'–û—à–∏–±–∫–∞ –≤–∫–ª. –∞–≤—Ç–æ–º–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞','W022':'–¢—Ä–µ–±—É–µ—Ç—Å—è –¢–û',
'M001':'–ê–≤–∞—Ä–∏—è —Å–µ—Ç–∏'
};
function getAlarmArchive(site,dev){try{return JSON.parse(localStorage.getItem('s5alm_'+site+'_'+dev))||[]}catch(e){return[]}}
function saveAlarmArchive(site,dev,a){localStorage.setItem('s5alm_'+site+'_'+dev,JSON.stringify(a))}
function addAlarmToArchive(dev,code,msg,severity){if(!cur)return;const arc=getAlarmArchive(cur,dev);arc.unshift({code,msg,severity,time:new Date().toLocaleString('ru-RU'),ts:Date.now()});if(arc.length>100)arc.pop();saveAlarmArchive(cur,dev,arc)}
function showAlarmSub(sl,sub){const act=$(sl+'a-act'),arc=$(sl+'a-arc'),ab=$(sl+'a-act-btn'),bb=$(sl+'a-arc-btn');if(!act||!arc)return;if(sub==='act'){act.style.display='';arc.style.display='none';ab.style.fontWeight='600';ab.style.color='var(--r)';bb.style.fontWeight='';bb.style.color=''}else{act.style.display='none';arc.style.display='';bb.style.fontWeight='600';bb.style.color='var(--p)';ab.style.fontWeight='';ab.style.color='';renderAlarmArchive(sl)}}
function renderAlarmArchive(sl){const el=$(sl+'a-arc');if(!el||!cur)return;const arc=getAlarmArchive(cur,sl);if(!arc.length){el.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:15px">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div>';return}
el.innerHTML='<div style="max-height:200px;overflow-y:auto">'+arc.map(function(a){var isA=a.severity==='alarm';var cls=isA?'aa':'aw';var ico=isA?'üî¥':'‚ö†';var col=isA?'var(--r)':'var(--y)';return'<div class="ai '+cls+'" style="margin-bottom:2px"><span style="font-size:10px">'+ico+'</span><b style="color:'+col+';font-size:10px;margin:0 4px">'+a.code+'</b><span style="font-size:11px;flex:1">'+a.msg+'</span><span style="color:var(--t4);font-size:9px;white-space:nowrap">'+a.time+'</span></div>'}).join('')+'</div>'}
function clearAlarmArchive(sl){if(!cur)return;if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤ –∞–≤–∞—Ä–∏–π?'))return;saveAlarmArchive(cur,sl,[]);renderAlarmArchive(sl);ae('üóë –ê—Ä—Ö–∏–≤ –∞–≤–∞—Ä–∏–π '+sl+' –æ—á–∏—â–µ–Ω')}
// === SPR CONFIG: READ ‚Üí CONFIGURE ‚Üí SAVE ===
let sprCurrentConfig = null; // {loadMode, pRaw, qRaw, readAt} ‚Äî last config read from controller
let sprSelectedLoadMode = null; // user-selected load mode (null = not changed)
let sprCfgDirty = false; // true when user changed sliders or load mode
let sprCfgReading = false;

function getSprBackups(){try{return JSON.parse(localStorage.getItem('s5_spr_backups_'+(cur||'')))||[]}catch(e){return[]}}
function saveSprBackups(list){localStorage.setItem('s5_spr_backups_'+(cur||''),JSON.stringify(list))}

// Called when "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" tab is opened
async function onSprControlTabOpen(){
    if(sprCfgReading)return;
    await readSprConfig();
}

// Read current config from controller via API
async function readSprConfig(){
    const banner=$('sprCfgBanner'),status=$('sprConfigStatus');
    const devId=getDeviceIdForSlot('spr');
    if(!devId||!apiAvailable){
        if(banner)banner.innerHTML='<span style="color:var(--y)">‚ö† –®–ü–† –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ API</span>';
        return;
    }
    sprCfgReading=true;
    if(banner)banner.innerHTML='<span style="color:var(--y)">‚è≥ –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞...</span>';
    if(status)status.innerHTML='';
    try{
        const cfg=await api.get('/api/commands/spr-config/'+devId);
        if(!cfg.success)throw new Error(cfg.message);
        sprCurrentConfig={loadMode:cfg.load_mode,pRaw:cfg.p_raw,qRaw:cfg.q_raw,readAt:Date.now()};
        sprSelectedLoadMode=cfg.load_mode;
        sprCfgDirty=false;
        // Populate UI from real controller values
        applySprConfigToUI(cfg.load_mode, cfg.p_raw, cfg.q_raw);
        if(banner)banner.innerHTML='<span style="color:var(--g)">‚úì –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—á–∏—Ç–∞–Ω–∞ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞</span>'+
            '<span style="color:var(--t4);font-size:10px;margin-left:8px">'+new Date().toLocaleTimeString('ru-RU')+'</span>';
        ae('üìñ –ö–æ–Ω—Ñ–∏–≥ –®–ü–† —Å—á–∏—Ç–∞–Ω: Mode='+cfg.load_mode+' P='+(cfg.p_raw/10).toFixed(1)+'% Q='+(cfg.q_raw/10).toFixed(1)+'%');
    }catch(e){
        console.error('SPR config read error:',e);
        if(banner)banner.innerHTML='<span style="color:var(--r)">‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: '+(e.message||e)+'</span>';
    }finally{sprCfgReading=false}
}

function applySprConfigToUI(loadMode, pRaw, qRaw){
    // LoadMode buttons
    highlightLoadMode(loadMode);
    // P/Q sliders
    const ps=$('sprPslider'),qs=$('sprQslider');
    if(ps){ps.value=pRaw;$('sprPval').textContent=(pRaw/10).toFixed(1)+'%'}
    if(qs){qs.value=qRaw;$('sprQval').textContent=(qRaw/10).toFixed(1)+'%'}
    // Current label
    const lbl=$('sprLmCurrent');
    if(lbl)lbl.textContent='(—Ç–µ–∫—É—â–∏–π: '+(loadMode===0?'Gen Ctrl':loadMode===1?'Mains Ctrl':loadMode===2?'Load Rec.':'?')+')';
}

function highlightLoadMode(mode){
    ['sprLm0','sprLm1','sprLm2'].forEach((id,i)=>{
        const btn=$(id);if(!btn)return;
        if(i===mode){btn.style.background='var(--ac)';btn.style.color='#fff';btn.style.borderColor='var(--ac)'}
        else{btn.style.background='';btn.style.color='';btn.style.borderColor=''}
    });
}

function setSprLoadMode(mode){
    sprSelectedLoadMode=mode;
    sprCfgDirty=true;
    highlightLoadMode(mode);
}

// Save current configuration to controller (LoadMode + P% + Q%)
async function saveSprConfig(){
    const devId=getDeviceIdForSlot('spr');
    if(!devId||!apiAvailable){ae('‚ö† –®–ü–† –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω');return}
    const lm=sprSelectedLoadMode!=null?sprSelectedLoadMode:(sprCurrentConfig?.loadMode??0);
    const pv=+($('sprPslider')?.value||500);
    const qv=+($('sprQslider')?.value||500);
    const desc='LoadMode='+lm+' P='+(pv/10).toFixed(1)+'% Q='+(qv/10).toFixed(1)+'%';
    // Confirm before writing
    if(!confirm('–ó–∞–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –®–ü–†?\n\n'+desc))return;
    const banner=$('sprCfgBanner');
    if(banner)banner.innerHTML='<span style="color:var(--y)">‚è≥ –ó–∞–ø–∏—Å—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (FC06 √ó 3 + verify)...</span>';
    try{
        // Atomic write: 3 config registers ‚Üí verify read-back
        const res=await api.post('/api/commands/spr-config/'+devId,{
            load_mode:lm, p_raw:pv, q_raw:qv
        });
        sprCfgDirty=false;
        if(res.verified){
            sprCurrentConfig={loadMode:lm,pRaw:pv,qRaw:qv,readAt:Date.now()};
            if(banner)banner.innerHTML='<span style="color:var(--g)">‚úì –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–∞–Ω–∞ –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞</span>'+
                '<span style="color:var(--t4);font-size:10px;margin-left:8px">'+new Date().toLocaleTimeString('ru-RU')+'</span>';
            ae('‚ö° –®–ü–† –∫–æ–Ω—Ñ–∏–≥ –∑–∞–ø–∏—Å–∞–Ω (verified): '+desc);
        }else{
            // Echo OK but verify-read returned old values
            if(banner)banner.innerHTML='<span style="color:var(--y)">‚ö† –ö–æ–º–∞–Ω–¥—ã FC06 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (echo OK), –Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–Ω–∏–∏ ‚Äî —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.</span>'+
                '<span style="display:block;font-size:10px;color:var(--t4);margin-top:2px">–ó–∞–ø–∏—Å—å reg 4351-4354 —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—à–∏–≤–∫—É HGM9560 ‚â• V1.1 (2023). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é –ø—Ä–æ—à–∏–≤–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞.</span>';
            ae('‚ö† –®–ü–† –∫–æ–Ω—Ñ–∏–≥: echo OK, verify mismatch (firmware V1.1+ needed?): '+desc);
        }
    }catch(e){
        console.error('SPR config write error:',e);
        const msg=(e.message||e).toString();
        if(banner)banner.innerHTML='<span style="color:var(--r)">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: '+msg+'</span>';
        ae('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∫–æ–Ω—Ñ–∏–≥–∞ –®–ü–†: '+msg);
    }
}

function backupSprConfig(){
    if(!sprCurrentConfig){ae('‚ö† –°–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞');readSprConfig();return}
    const backups=getSprBackups();
    const backup={id:'bk_'+Date.now(),date:new Date().toLocaleString('ru-RU'),site:cur,name:S[cur]?.name||'',
        loadMode:sprCurrentConfig.loadMode,pPercent:sprCurrentConfig.pRaw,qPercent:sprCurrentConfig.qRaw,
        readAt:sprCurrentConfig.readAt,note:''};
    backups.unshift(backup);if(backups.length>20)backups.pop();saveSprBackups(backups);
    ae('üíæ –ë—ç–∫–∞–ø –®–ü–† —Å–æ–∑–¥–∞–Ω (–∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞)');renderBackupList();
    const el=$('sprConfigStatus');if(el)el.innerHTML='<div style="padding:6px 10px;background:var(--gd);border:1px solid rgba(0,224,154,.2);border-radius:6px;font-size:11px;color:var(--g);font-family:var(--m);margin-bottom:6px">‚úì –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω: '+backup.date+' (LoadMode='+backup.loadMode+' P='+(backup.pPercent/10).toFixed(1)+'% Q='+(backup.qPercent/10).toFixed(1)+'%)</div>';
}
function openRestoreBackup(){const backups=getSprBackups();if(!backups.length){const el=$('sprConfigStatus');if(el)el.innerHTML='<div style="padding:6px 10px;background:var(--rd);border:1px solid rgba(255,64,96,.2);border-radius:6px;font-size:11px;color:var(--r);font-family:var(--m);margin-bottom:6px">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤</div>';return}
renderBackupList()}
function renderBackupList(){const backups=getSprBackups();const el=$('sprBackupList');if(!el)return;
const lmNames={0:'GenCtrl',1:'MainsCtrl',2:'LoadRec'};
el.innerHTML='<div style="font-size:10px;color:var(--t3);margin:6px 0 4px">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –±—ç–∫–∞–ø—ã ('+backups.length+'):</div><div style="max-height:160px;overflow-y:auto">'+backups.map((b,i)=>`<div class="bk-item"><div><span style="color:var(--t)">${b.date}</span><br><span style="color:var(--t3);font-size:10px">${lmNames[b.loadMode]||'?'} P=${(b.pPercent/10).toFixed(1)}% Q=${(b.qPercent/10).toFixed(1)}%</span></div><div class="bk-acts"><button class="bk-btn" onclick="restoreBackup(${i})" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä">üìÇ</button><button class="bk-btn" onclick="downloadBackup(${i})" title="–°–∫–∞—á–∞—Ç—å JSON">‚¨á</button><button class="bk-btn del" onclick="deleteBackup(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button></div></div>`).join('')+'</div>'}
function restoreBackup(idx){const backups=getSprBackups();const b=backups[idx];if(!b)return;
// Apply backup values to UI
sprSelectedLoadMode=b.loadMode;sprCfgDirty=true;
applySprConfigToUI(b.loadMode, b.pPercent, b.qPercent);
// Prompt to save to controller
const desc='LoadMode='+b.loadMode+' P='+(b.pPercent/10).toFixed(1)+'% Q='+(b.qPercent/10).toFixed(1)+'%';
if(confirm('–ü—Ä–∏–º–µ–Ω–∏—Ç—å –±—ç–∫–∞–ø –æ—Ç '+b.date+' –∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä?\n\n'+desc)){saveSprConfig()}
else{ae('üìÇ –ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω –≤ UI (–Ω–µ –∑–∞–ø–∏—Å–∞–Ω –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä)')}}
function downloadBackup(idx){const backups=getSprBackups();const b=backups[idx];if(!b)return;
const json=JSON.stringify(b,null,2);const blob=new Blob([json],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='spr_backup_'+b.date.replace(/[\s:.,]/g,'_')+'.json';a.click();URL.revokeObjectURL(url);ae('‚¨á –ë—ç–∫–∞–ø —Å–∫–∞—á–∞–Ω')}
function deleteBackup(idx){const backups=getSprBackups();backups.splice(idx,1);saveSprBackups(backups);renderBackupList();ae('üóë –ë—ç–∫–∞–ø —É–¥–∞–ª—ë–Ω')}
// === INIT ===
(async function init() {
    // Try loading from API first
    const loaded = await loadFromAPI();
    if (!loaded) {
        // Fallback to localStorage (original v5 behavior)
        if (!Object.keys(S).length) {
            S['mkz'] = {name:'–ú–ö–ó', desc:'–ö–∏—Ä–ø–∏—á–Ω—ã–π –∑–∞–≤–æ–¥', responsible:'',
                g1:{ip:'192.168.97.10',port:502,slaveId:1,runHours:1227},
                g2:{ip:'192.168.97.11',port:502,slaveId:1,runHours:489},
                spr:{ip:'10.11.0.2',port:26,slaveId:1}};
            cur = 'mkz';
            sv();
            ae('üè≠ –ú–ö–ó —Å–æ–∑–¥–∞–Ω (localStorage)');
        }
    }
    renderSB();
    if (cur && S[cur]) renderDash();
    else { cur = Object.keys(S)[0] || null; renderDash(); }
    // Connect WebSocket for live data
    connectWebSocket();
})();
</script></body></html>
