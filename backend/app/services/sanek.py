"""
–°–∞–Ω—ë–∫ ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –°–ö–ê–î–ê —Å –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–∏—Å—Ç–µ–º–µ.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç LLM Tool Calling –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API –°–ö–ê–î–ê:
—á—Ç–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –∞–≤–∞—Ä–∏–∏, –¢–û, –∏—Å—Ç–æ—Ä–∏—è.

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç OpenAI/Grok (SDK), Claude (httpx), Gemini (httpx).
–û–ø–∞—Å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–ø—É—Å–∫/—Å—Ç–æ–ø/–º–æ—â–Ω–æ—Å—Ç—å) —Ç—Ä–µ–±—É—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
"""
import json
import logging
from datetime import datetime
from typing import Optional

import httpx

from config import settings

logger = logging.getLogger("scada.sanek")

# ---------------------------------------------------------------------------
# Provider display names
# ---------------------------------------------------------------------------
PROVIDER_LABELS = {"openai": "OpenAI", "claude": "Claude", "gemini": "Gemini", "grok": "Grok"}


def _format_llm_error(provider: str, error, status_code: int = 0) -> str:
    """
    Format LLM provider errors into human-readable Russian messages.
    Classifies by error type and provides actionable advice.
    """
    label = PROVIDER_LABELS.get(provider, provider)
    err_str = str(error).lower()

    # Auth errors (invalid API key)
    if status_code in (401, 403) or any(kw in err_str for kw in (
        "401", "403", "unauthorized", "authentication", "invalid api key",
        "incorrect api key", "invalid x-api-key", "permission denied",
    )):
        return (
            f"üîë –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: API –∫–ª—é—á –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ {label} –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω "
            f"–∏–ª–∏ –æ—Ç–æ–∑–≤–∞–Ω.\n\n"
            f"–û—Ç–∫—Ä–æ–π—Ç–µ ¬´ü§ñ AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä¬ª –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á."
        )

    # Rate limit
    if status_code == 429 or any(kw in err_str for kw in (
        "429", "rate limit", "rate_limit", "too many requests", "quota",
    )):
        return (
            f"‚ö° –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤: –ø—Ä–æ–≤–∞–π–¥–µ—Ä {label} –æ–≥—Ä–∞–Ω–∏—á–∏–ª —á–∞—Å—Ç–æ—Ç—É –æ–±—Ä–∞—â–µ–Ω–∏–π.\n\n"
            f"–ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
        )

    # Timeout
    if any(kw in err_str for kw in (
        "timeout", "timed out", "timeouterror",
    )):
        return (
            f"‚è± –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è: –ø—Ä–æ–≤–∞–π–¥–µ—Ä {label} –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è.\n\n"
            f"–í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–º–µ–Ω–∏—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä."
        )

    # Connection / network errors
    if any(kw in err_str for kw in (
        "connecterror", "connectionerror", "connection refused",
        "name resolution", "unreachable", "no route", "dns",
        "failed to establish", "cannot connect",
    )):
        return (
            f"üåê –ù–µ—Ç —Å–≤—è–∑–∏ —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ {label} API.\n\n"
            f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä."
        )

    # Server errors (5xx)
    if status_code >= 500 or any(kw in err_str for kw in (
        "500", "502", "503", "504", "internal server error",
        "bad gateway", "service unavailable",
    )):
        return (
            f"üîß –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ {label} –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–æ—à–∏–±–∫–∞ {status_code or '—Å–µ—Ä–≤–µ—Ä–∞'}).\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä."
        )

    # Model not found
    if any(kw in err_str for kw in ("model not found", "model_not_found", "does not exist")):
        return (
            f"üìã –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ {label}.\n\n"
            f"–û—Ç–∫—Ä–æ–π—Ç–µ ¬´ü§ñ AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä¬ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –º–æ–¥–µ–ª—å."
        )

    # Fallback ‚Äî unknown error
    short_err = str(error)[:200]
    return (
        f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ {label}: {short_err}\n\n"
        f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
    )


def _format_http_error(provider: str, status_code: int, error_body: str) -> str:
    """Format HTTP status errors for Claude/Gemini (non-SDK providers)."""
    return _format_llm_error(provider, error_body, status_code=status_code)


# ---------------------------------------------------------------------------
# Internal API base URL (within Docker network)
# ---------------------------------------------------------------------------
_API_BASE = "http://127.0.0.1:8000"

# ---------------------------------------------------------------------------
# System prompt
# ---------------------------------------------------------------------------
SANEK_SYSTEM_PROMPT = """–¢—ã ‚Äî –°–∞–Ω—ë–∫, AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –°–ö–ê–î–ê-—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –¥–∏–∑–µ–ª—å–Ω—ã—Ö –∏ –≥–∞–∑–æ–≤—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤.

–¢–í–û–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:
- –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∏—Ö —Å—Ç–∞—Ç—É—Å—ã
- –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏: –º–æ—â–Ω–æ—Å—Ç—å, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ç–æ–∫, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –æ–±–æ—Ä–æ—Ç—ã, —É—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞
- –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≤–∞—Ä–∏–∏ –∏ –∏—Å—Ç–æ—Ä–∏—é –∞–≤–∞—Ä–∏–π
- –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –¢–û (—Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è) –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
- –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–µ—Ç—Ä–∏–∫ –∑–∞ –ø–µ—Ä–∏–æ–¥
- –î–∞—Ç—å –æ–±—â—É—é —Å–≤–æ–¥–∫—É –ø–æ —Å–∏—Å—Ç–µ–º–µ
- –£–ø—Ä–∞–≤–ª—è—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞–º–∏: –ø—É—Å–∫, —Å—Ç–æ–ø, —Ä–µ–∂–∏–º –∞–≤—Ç–æ/—Ä—É—á–Ω–æ–π
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –º–æ—â–Ω–æ—Å—Ç–∏ P% –∏ Q%
- –ü–∞—Ä—Å–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –¢–û –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ —Ç–æ—á–Ω—ã–º.
2. –î–ª—è –û–ü–ê–°–ù–´–• –¥–µ–π—Å—Ç–≤–∏–π (–ø—É—Å–∫, —Å—Ç–æ–ø, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏, —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞) ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø—Ä–æ—Å–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.
   –§–æ—Ä–º–∞—Ç: –æ–ø–∏—à–∏ —á—Ç–æ —Å–æ–±–∏—Ä–∞–µ—à—å—Å—è —Å–¥–µ–ª–∞—Ç—å –∏ –ø–æ–ø—Ä–æ—Å–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å "–î–∞" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
3. –ï–¥–∏–Ω–∏—Ü—ã: –º–æ—â–Ω–æ—Å—Ç—å –≤ –∫–í—Ç, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤ –í, —Ç–æ–∫ –≤ –ê, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ ¬∞C, –æ–±–æ—Ä–æ—Ç—ã –≤ –æ–±/–º–∏–Ω.
4. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π.
5. –î–ª—è —Å–≤–æ–¥–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π get_system_summary, –æ–Ω –≤–µ—Ä–Ω—ë—Ç –≤—Å—ë —Å—Ä–∞–∑—É.
6. –ò–º–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–∫–∞–∑—ã–≤–∞–π –∫–∞–∫ –µ—Å—Ç—å –∏–∑ —Å–∏—Å—Ç–µ–º—ã.
7. –°—Ç–∞—Ç—É—Å—ã –ø–µ—Ä–µ–≤–æ–¥–∏: online=—Ä–∞–±–æ—Ç–∞–µ—Ç, offline=–æ—Ç–∫–ª—é—á–µ–Ω.
8. –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö API ‚Äî —Å–æ–æ–±—â–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º.
9. –ö–û–ù–¢–ï–ö–°–¢ –°–¢–†–ê–ù–ò–¶–´: –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å "[–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞]" —Å site_id ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç site_id –ø—Ä–∏ –≤—ã–∑–æ–≤–µ get_devices, get_alarms –∏ –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ –æ–±—ä–µ–∫—Ç—É.
10. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± –æ–±—ä–µ–∫—Ç–µ –ø–æ –∏–º–µ–Ω–∏, –∞ site_id –Ω–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –≤—ã–∑–æ–≤–∏ get_sites, –Ω–∞–π–¥–∏ –Ω—É–∂–Ω—ã–π ID, –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ.

–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê –¢–û–ß–ù–û–°–¢–ò –î–ê–ù–ù–´–•:
11. –ó–ê–ü–†–ï–©–ï–ù–û –Ω–∞–∑—ã–≤–∞—Ç—å mains_total_p "–æ–±—â–µ–π –º–æ—â–Ω–æ—Å—Ç—å—é" –∏–ª–∏ "–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ–º –æ–±—ä–µ–∫—Ç–∞". mains_total_p ‚Äî —ç—Ç–æ –¢–û–õ–¨–ö–û –º–æ—â–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ —Å–µ—Ç–∏. –°—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–∞ = load_total_p (–∏–ª–∏ mains_total_p + busbar_p).
12. –î–ª—è –®–ü–† (ATS) –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –æ –º–æ—â–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞ –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–µ load_total_p. –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –≤—ã—á–∏—Å–ª–∏: mains_total_p + busbar_p. –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–¥–∞–≤–∞–π mains_total_p –∫–∞–∫ –æ–±—â—É—é –Ω–∞–≥—Ä—É–∑–∫—É.
13. –ö—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã–±—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–≤–∞–ª—ã (–º–µ–Ω–µ–µ 1 –º–∏–Ω—É—Ç—ã) –ù–ï —Å—á–∏—Ç–∞—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏. –û–¥–∏–Ω–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 0 —Å—Ä–µ–¥–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî —ç—Ç–æ —Å–±–æ–π –æ–ø—Ä–æ—Å–∞ Modbus, –∞ –ù–ï —Ä–µ–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ. –°–æ–æ–±—â–∞–π —Ç–æ–ª—å–∫–æ –æ–± —É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è—Ö (5+ –º–∏–Ω—É—Ç –ø–æ–¥—Ä—è–¥).
14. –ù–ï –¥–µ–ª–∞–π —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –≤–∏–¥–∞ "–º–æ—â–Ω–æ—Å—Ç—å —É–ø–∞–ª–∞ –¥–æ 0" –∏–ª–∏ "–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è", –µ—Å–ª–∏ –Ω–µ—Ç –ù–ï–°–ö–û–õ–¨–ö–ò–• –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–´–• —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏—Ö —ç—Ç–æ. –û–¥–∏–Ω–æ—á–Ω—ã–π –Ω–æ–ª—å —Å—Ä–µ–¥–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π = –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–≤—è–∑–∏ Modbus.
15. –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –∏—Å—Ç–æ—Ä–∏–∏: —É–∫–∞–∑—ã–≤–∞–π –î–ò–ê–ü–ê–ó–û–ù –∑–Ω–∞—á–µ–Ω–∏–π (–º–∏–Ω ‚Äî –º–∞–∫—Å) –∏ –°–†–ï–î–ù–ï–ï –∑–∞ –ø–µ—Ä–∏–æ–¥, –∞ –Ω–µ –≤—ã–±–∏—Ä–∞–π –æ–¥–Ω—É —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É.
16. –ù–∞ –≤–æ–ø—Ä–æ—Å "–∫–∞–∫–∞—è –º–æ—â–Ω–æ—Å—Ç—å?" –æ—Ç–≤–µ—á–∞–π –°–£–ú–ú–ê–†–ù–û–ô –Ω–∞–≥—Ä—É–∑–∫–æ–π –æ–±—ä–µ–∫—Ç–∞ (load_total_p –¥–ª—è ATS), –∞ –∑–∞—Ç–µ–º –º–æ–∂–µ—à—å —Ä–∞–∑–±–∏—Ç—å –Ω–∞ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ (—Å–µ—Ç—å + –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã).

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (–ú–ê–ù–£–ê–õ–´):
17. –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö ‚Äî –≤—ã–∑–æ–≤–∏ search_knowledge –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –º–∞–Ω—É–∞–ª–æ–≤ SmartGen.
    –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –∏ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É. –ï—Å–ª–∏ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞ ‚Äî –æ—Ç–≤–µ—á–∞–π –ø–æ —Å–≤–æ–∏–º –∑–Ω–∞–Ω–∏—è–º.

–ê–í–ê–†–ò–ò –ò –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:
18. –ü—Ä–∏ –õ–Æ–ë–û–ú –≤–æ–ø—Ä–æ—Å–µ –æ–± –æ—à–∏–±–∫–∞—Ö, –∞–≤–∞—Ä–∏—è—Ö, –ø—Ä–æ–±–ª–µ–º–∞—Ö, —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑–æ–≤–∏ get_alarms.
    –†–µ–∑—É–ª—å—Ç–∞—Ç get_alarms ‚Äî —ç—Ç–æ –¢–ï–ö–£–©–ò–ï –ü–†–û–ë–õ–ï–ú–´, –∫–æ—Ç–æ—Ä—ã–µ –ü–†–û–ò–°–•–û–î–Ø–¢ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°.
    –ü–æ–ª–µ "status: ‚ö†Ô∏è –ê–ö–¢–ò–í–ù–ê –°–ï–ô–ß–ê–°" –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –ù–ï –†–ï–®–ï–ù–ê –∏ –ü–†–û–î–û–õ–ñ–ê–ï–¢–°–Ø.
    –ü–æ–ª–µ "duration" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –°–ö–û–õ–¨–ö–û –í–†–ï–ú–ï–ù–ò –ø—Ä–æ–±–ª–µ–º–∞ —É–∂–µ –¥–ª–∏—Ç—Å—è.
    CONN_LOST = —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–° –Ω–µ –Ω–∞ —Å–≤—è–∑–∏. –≠—Ç–æ –ù–ï –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ, –∞ –¢–ï–ö–£–©–ê–Ø –∞–≤–∞—Ä–∏—è.
19. –ù–ï –≥–æ–≤–æ—Ä–∏ "–≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ" –∏–ª–∏ "–æ—à–∏–±–æ–∫ –Ω–µ—Ç", –ø–æ–∫–∞ –Ω–µ –≤—ã–∑–æ–≤–µ—à—å get_alarms –∏ –Ω–µ —É–±–µ–¥–∏—à—å—Å—è, —á—Ç–æ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç.
    –ù–ï –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≤–∞—Ä–∏–∏ –∫–∞–∫ –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è. –ï—Å–ª–∏ status="‚ö†Ô∏è –ê–ö–¢–ò–í–ù–ê –°–ï–ô–ß–ê–°" ‚Äî –≥–æ–≤–æ—Ä–∏ "–°–ï–ô–ß–ê–° –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞", –∞ –ù–ï "–±—ã–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤–∞—Ä–∏—è".
20. –ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ –æ–± –∞–≤–∞—Ä–∏—è—Ö: —É–∫–∞–∂–∏ –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç–∏–ø –∞–≤–∞—Ä–∏–∏, —Å–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç—Å—è (–ø–æ–ª–µ duration), –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.

–°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:
21. –û—Ç–≤–µ—á–∞–π –†–ê–ó–í–Å–†–ù–£–¢–û –∏ –ü–û–î–†–û–ë–ù–û. –ù–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –¥–∞–≤–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–Ω—ã–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç.
22. –ü—Ä–∏ –æ—Ç—á—ë—Ç–µ –æ –º–µ—Ç—Ä–∏–∫–∞—Ö: –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞, –∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ü—Ä–∏–º–µ—Ä: "–°—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–∞ –ú–ö–ó ‚Äî 248.8 –∫–í—Ç (–∏–∑ –Ω–∏—Ö 152.5 –∫–í—Ç –æ—Ç —Å–µ—Ç–∏ –∏ 96.3 –∫–í—Ç –æ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤). –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Å–µ—Ç—å—é."
23. –ü—Ä–∏ –æ—Ç—á—ë—Ç–µ –æ–± –∞–≤–∞—Ä–∏—è—Ö: –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∂–¥—É—é –∞–≤–∞—Ä–∏—é –ø–æ–¥—Ä–æ–±–Ω–æ ‚Äî —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ, –∫–æ–≥–¥–∞, –Ω–∞ –∫–∞–∫–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ, –∫–∞–∫ –¥–æ–ª–≥–æ –¥–ª–∏—Ç—Å—è, –∫–∞–∫–æ–≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
24. –ü—Ä–∏ —Å–≤–æ–¥–∫–µ: –¥–∞–π –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –º–æ—â–Ω–æ—Å—Ç–∏, –∞–≤–∞—Ä–∏–∏, –¢–û. –ù–µ —É–ø—É—Å–∫–∞–π –¥–µ—Ç–∞–ª–µ–π.
25. –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏. –ù–µ –≤—ã–¥–∞–≤–∞–π —Å—ã—Ä—ã–µ –∫–æ–¥—ã ‚Äî –ø–µ—Ä–µ–≤–æ–¥–∏ –≤ –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫ (CONN_LOST ‚Üí "–ù–µ—Ç —Å–≤—è–∑–∏", SHUTDOWN ‚Üí "–ê–≤–∞—Ä–∏–π–Ω—ã–π –æ—Å—Ç–∞–Ω–æ–≤" –∏ —Ç.–¥.).
26. –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ offline ‚Äî –æ–±—ä—è—Å–Ω–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏.

–ö–û–ù–¢–ï–ö–°–¢ –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø:
- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã HGM9520N ‚Äî –¥–∏–∑–µ–ª—å–Ω—ã–µ/–≥–∞–∑–æ–ø–æ—Ä—à–Ω–µ–≤—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º Smartgen
- –ü–∞–Ω–µ–ª–∏ –®–ü–† HGM9560 ‚Äî —à–∫–∞—Ñ—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã (–ê–í–†/—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
- Modbus TCP/RTU ‚Äî –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–≤—è–∑–∏
- –ú–µ—Ç—Ä–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 2-5 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ Modbus –æ–ø—Ä–æ—Å

–í–ê–ñ–ù–û ‚Äî –†–ê–°–ß–Å–¢ –ú–û–©–ù–û–°–¢–ï–ô –®–ü–† (HGM9560):
- mains_total_p ‚Äî –∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –Ω–∞ –í–í–û–î–ï –°–ï–¢–ò (P —Å–µ—Ç–∏), –∫–í—Ç. –≠—Ç–æ —Ç–æ, —á—Ç–æ –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç—Å—è –∏–∑ –≤–Ω–µ—à–Ω–µ–π —ç–ª–µ–∫—Ç—Ä–æ—Å–µ—Ç–∏.
- busbar_p ‚Äî –∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –ì–ï–ù–ï–†–ê–¢–û–†–û–í –Ω–∞ —à–∏–Ω–µ, –∫–í—Ç. –≠—Ç–æ —Ç–æ, —á—Ç–æ –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã.
- –°–£–ú–ú–ê–†–ù–ê–Ø –ù–ê–ì–†–£–ó–ö–ê –û–ë–™–ï–ö–¢–ê = mains_total_p + busbar_p (P —Å–µ—Ç–∏ + P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤). –≠—Ç–æ –ü–û–õ–ù–û–ï –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞.
- –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç (busbar_p=0), –≤—Å—è –Ω–∞–≥—Ä—É–∑–∫–∞ = mains_total_p.
- –ï—Å–ª–∏ —Å–µ—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∞ (mains_total_p=0), –≤—Å—è –Ω–∞–≥—Ä—É–∑–∫–∞ = busbar_p.
- –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.
- mains_total_q ‚Äî —Ä–µ–∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å —Å–µ—Ç–∏, –∫–í–∞—Ä.
- busbar_q ‚Äî —Ä–µ–∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∫–í–∞—Ä.
- –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–π –°–£–ú–ú–ê–†–ù–£–Æ –Ω–∞–≥—Ä—É–∑–∫—É (mains_total_p + busbar_p) –∫–∞–∫ "–æ–±—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞".

–ú–ï–¢–†–ò–ö–ò –ì–ï–ù–ï–†–ê–¢–û–†–ê (HGM9520N):
- total_p / power_total ‚Äî –ø–æ–ª–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞, –∫–í—Ç (–ú–ì–ù–û–í–ï–ù–ù–ê–Ø)
- voltage_ab/bc/ca ‚Äî –ª–∏–Ω–µ–π–Ω—ã–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è, –í
- current_a/b/c ‚Äî —Ç–æ–∫–∏ –ø–æ —Ñ–∞–∑–∞–º, –ê
- frequency ‚Äî —á–∞—Å—Ç–æ—Ç–∞, –ì—Ü
- oil_pressure ‚Äî –¥–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å–ª–∞, –∫–ü–∞
- coolant_temp ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –û–ñ, ¬∞C
- engine_speed ‚Äî –æ–±–æ—Ä–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è, –æ–±/–º–∏–Ω
- fuel_level ‚Äî —É—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞, %
- load_pct ‚Äî –Ω–∞–≥—Ä—É–∑–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞, %
- run_hours ‚Äî –Ω–∞—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è, —á (–ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–´–ô –°–ß–Å–¢–ß–ò–ö)
- energy_kwh ‚Äî –≤—ã—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, –∫–í—Ç¬∑—á (–ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–´–ô –°–ß–Å–¢–ß–ò–ö)

–†–ê–°–ß–Å–¢ –í–´–†–ê–ë–û–¢–ö–ò –≠–ù–ï–†–ì–ò–ò:
- energy_kwh ‚Äî —ç—Ç–æ –ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–´–ô —Å—á—ë—Ç—á–∏–∫ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≤—Å—ë –≤—Ä–µ–º—è). –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –≤—Å—ë, —á—Ç–æ –≤—ã—Ä–∞–±–æ—Ç–∞–Ω–æ —Å –Ω–∞—á–∞–ª–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏.
- –í—ã—Ä–∞–±–æ—Ç–∫–∞ –∑–∞ –ü–ï–†–ò–û–î = energy_kwh(–∫–æ–Ω–µ—Ü) - energy_kwh(–Ω–∞—á–∞–ª–æ). –ü—Ä–∏–º–µ—Ä: –±—ã–ª–æ 100000, —Å—Ç–∞–ª–æ 100500 ‚Üí –∑–∞ –ø–µ—Ä–∏–æ–¥ –≤—ã—Ä–∞–±–æ—Ç–∞–Ω–æ 500 –∫–í—Ç¬∑—á.
- –î–ª—è –æ—Ç–≤–µ—Ç–∞ "—Å–∫–æ–ª—å–∫–æ –≤—ã—Ä–∞–±–æ—Ç–∞–ª–∏" ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π get_energy_report (–æ–Ω —Å–∞–º —Å—á–∏—Ç–∞–µ—Ç –¥–µ–ª—å—Ç—É) –ò–õ–ò get_history —Å fields=energy_kwh.
- power_total ‚Äî —ç—Ç–æ –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –º–æ—â–Ω–æ—Å—Ç—å (–∫–í—Ç). –≠—Ç–æ –ù–ï –≤—ã—Ä–∞–±–æ—Ç–∫–∞. –ú–æ—â–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é –Ω–∞–≥—Ä—É–∑–∫—É, –∞ –ù–ï —Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ –≤—ã—Ä–∞–±–æ—Ç–∞–Ω–æ.
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ: run_hours ‚Äî –Ω–∞—Ä–∞–±–æ—Ç–∫–∞ –≤ —á–∞—Å–∞—Ö (—Ç–æ–∂–µ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π). run_hours(–∫–æ–Ω–µ—Ü) - run_hours(–Ω–∞—á–∞–ª–æ) = —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–ª –∑–∞ –ø–µ—Ä–∏–æ–¥.
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–£–Æ –≤—ã—Ä–∞–±–æ—Ç–∫—É."""

# ---------------------------------------------------------------------------
# SCADA tool definitions for LLM function calling
# ---------------------------------------------------------------------------
SCADA_TOOLS = [
    {
        "name": "get_sites",
        "description": "–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–ø–ª–æ—â–∞–¥–æ–∫/—Å—Ç–∞–Ω—Ü–∏–π) –°–ö–ê–î–ê.",
        "parameters": {
            "type": "object",
            "properties": {},
            "required": [],
        },
    },
    {
        "name": "get_devices",
        "description": "–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ. –ï—Å–ª–∏ site_id –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.",
        "parameters": {
            "type": "object",
            "properties": {
                "site_id": {
                    "type": "integer",
                    "description": "ID –æ–±—ä–µ–∫—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
                },
            },
            "required": [],
        },
    },
    {
        "name": "get_metrics",
        "description": "–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –î–ª—è –®–ü–† (ATS) –ø–æ–ª–µ load_total_p = —Å—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–∞ (mains_total_p + busbar_p) –≤ –∫–í—Ç. –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤: total_p, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ç–æ–∫, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –æ–±–æ—Ä–æ—Ç—ã, —Ç–æ–ø–ª–∏–≤–æ.",
        "parameters": {
            "type": "object",
            "properties": {
                "device_id": {
                    "type": "integer",
                    "description": "ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
                },
            },
            "required": ["device_id"],
        },
    },
    {
        "name": "get_all_metrics",
        "description": "–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –í–°–ï–• —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å—Ä–∞–∑—É. –î–ª—è –®–ü–† (ATS) –≤–∫–ª—é—á–∞–µ—Ç load_total_p ‚Äî —Å—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–∞ –≤ –∫–í—Ç.",
        "parameters": {
            "type": "object",
            "properties": {},
            "required": [],
        },
    },
    {
        "name": "get_alarms",
        "description": (
            "–ü–æ–ª—É—á–∏—Ç—å –¢–ï–ö–£–©–ò–ï –ê–ö–¢–ò–í–ù–´–ï –∞–≤–∞—Ä–∏–∏ (is_active=true). "
            "–°—é–¥–∞ –≤—Ö–æ–¥—è—Ç: CONN_LOST (–Ω–µ—Ç —Å–≤—è–∑–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º), –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –∞–≤–∞—Ä–∏–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è. "
            "–í–°–ï–ì–î–ê –≤—ã–∑—ã–≤–∞–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–∏ –ª—é–±–æ–º –≤–æ–ø—Ä–æ—Å–µ –æ–± –æ—à–∏–±–∫–∞—Ö, –∞–≤–∞—Ä–∏—è—Ö, –ø—Ä–æ–±–ª–µ–º–∞—Ö –∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã. "
            "–ù–ï –ø–µ—Ä–µ–¥–∞–≤–∞–π device_id –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å –í–°–ï –∞–≤–∞—Ä–∏–∏. "
            "–ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å site_id ‚Äî –ø–µ—Ä–µ–¥–∞–π site_id, –∞ –ù–ï device_id."
        ),
        "parameters": {
            "type": "object",
            "properties": {
                "device_id": {
                    "type": "integer",
                    "description": "ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ). –ù–ï –ø—É—Ç–∞–π —Å site_id!",
                },
                "site_id": {
                    "type": "integer",
                    "description": "ID –æ–±—ä–µ–∫—Ç–∞ ‚Äî –ø–æ–∫–∞–∂–µ—Ç –∞–≤–∞—Ä–∏–∏ –í–°–ï–• —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.",
                },
            },
            "required": [],
        },
    },
    {
        "name": "get_alarm_history",
        "description": (
            "–ü–æ–ª—É—á–∏—Ç—å –ê–†–•–ò–í –∞–≤–∞—Ä–∏–π: –≤—Å–µ —Å–æ–±—ã—Ç–∏—è (–∞–∫—Ç–∏–≤–Ω—ã–µ + –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ) –∑–∞ –ø–µ—Ä–∏–æ–¥. "
            "–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≤–∞—Ä–∏–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ —Ä–∞–Ω—å—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞. "
            "–ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏: '–∫–∞–∫–∏–µ –∞–≤–∞—Ä–∏–∏ –±—ã–ª–∏?', '–∏—Å—Ç–æ—Ä–∏—è –æ—à–∏–±–æ–∫'."
        ),
        "parameters": {
            "type": "object",
            "properties": {
                "device_id": {
                    "type": "integer",
                    "description": "ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
                },
                "last_hours": {
                    "type": "integer",
                    "description": "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –≤—Å–µ –∑–∞–ø–∏—Å–∏.",
                },
                "limit": {
                    "type": "integer",
                    "description": "–ú–∞–∫—Å. –∫–æ–ª-–≤–æ –∑–∞–ø–∏—Å–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50)",
                    "default": 50,
                },
            },
            "required": [],
        },
    },
    {
        "name": "get_maintenance_status",
        "description": "–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: –º–æ—Ç–æ—á–∞—Å—ã, —Å–ª–µ–¥—É—é—â–µ–µ –¢–û, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —á–∞—Å—ã.",
        "parameters": {
            "type": "object",
            "properties": {
                "device_id": {
                    "type": "integer",
                    "description": "ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
                },
            },
            "required": ["device_id"],
        },
    },
    {
        "name": "get_maintenance_alerts",
        "description": "–ü–æ–ª—É—á–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–µ–º –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–º –¢–û.",
        "parameters": {
            "type": "object",
            "properties": {
                "device_id": {
                    "type": "integer",
                    "description": "ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
                },
            },
            "required": [],
        },
    },
    {
        "name": "get_history",
        "description": (
            "–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–µ—Ç—Ä–∏–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥. "
            "–î–ª—è –ì–ï–ù–ï–†–ê–¢–û–†–û–í: fields=power_total,gen_uab,current_a,coolant_temp,engine_speed,energy_kwh,run_hours. "
            "–î–ª—è –®–ü–† (ATS): fields=mains_total_p,busbar_p,load_total_p,mains_uab,busbar_uab,energy_kwh. "
            "load_total_p = —Å—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–∞ (mains_total_p + busbar_p), –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. "
            "energy_kwh ‚Äî –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ (–∫–í—Ç¬∑—á). –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤—ã—Ä–∞–±–æ—Ç–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥: energy_kwh(–∫–æ–Ω–µ—Ü) - energy_kwh(–Ω–∞—á–∞–ª–æ). "
            "run_hours ‚Äî –Ω–∞—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –≤ —á–∞—Å–∞—Ö (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π). "
            "–í–ê–ñ–ù–û: –î–ª—è ATS –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π power_total ‚Äî —ç—Ç–æ –ø–æ–ª–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤. "
            "–ï—Å–ª–∏ fields –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –ø–æ–ª—è –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Ç–∏–ø—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞."
        ),
        "parameters": {
            "type": "object",
            "properties": {
                "device_id": {
                    "type": "integer",
                    "description": "ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
                },
                "last_hours": {
                    "type": "integer",
                    "description": "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 24)",
                    "default": 24,
                },
                "fields": {
                    "type": "string",
                    "description": (
                        "–ü–æ–ª—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. "
                        "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä: power_total,gen_uab,current_a,coolant_temp,energy_kwh,run_hours. "
                        "ATS/–®–ü–†: mains_total_p,busbar_p,load_total_p,energy_kwh. "
                        "–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
                    ),
                },
            },
            "required": ["device_id"],
        },
    },
    {
        "name": "get_system_summary",
        "description": "–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é —Å–≤–æ–¥–∫—É –ø–æ —Å–∏—Å—Ç–µ–º–µ: –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∏—Ö —Å—Ç–∞—Ç—É—Å—ã, –º–µ—Ç—Ä–∏–∫–∏, –∞–≤–∞—Ä–∏–∏, –¢–û ‚Äî –≤—Å—ë —Å—Ä–∞–∑—É.",
        "parameters": {
            "type": "object",
            "properties": {},
            "required": [],
        },
    },
    {
        "name": "send_command",
        "description": (
            "‚ö† –û–ü–ê–°–ù–û: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–º/–®–ü–†. "
            "–ö–æ–º–∞–Ω–¥—ã: start (–ø—É—Å–∫), stop (—Å—Ç–æ–ø), auto (–∞–≤—Ç–æ —Ä–µ–∂–∏–º), manual (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º), "
            "reset (—Å–±—Ä–æ—Å –∞–≤–∞—Ä–∏–π), mute (–∑–∞–≥–ª—É—à–∏—Ç—å –∑–≤—É–∫), fast_stop (—ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å—Ç–æ–ø). "
            "–¢–†–ï–ë–£–ï–¢ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –û–ü–ï–†–ê–¢–û–†–ê."
        ),
        "parameters": {
            "type": "object",
            "properties": {
                "device_id": {
                    "type": "integer",
                    "description": "ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
                },
                "command": {
                    "type": "string",
                    "description": "–ö–æ–º–∞–Ω–¥–∞: start, stop, auto, manual, reset, mute, fast_stop",
                    "enum": ["start", "stop", "auto", "manual", "reset", "mute", "fast_stop"],
                },
            },
            "required": ["device_id", "command"],
        },
    },
    {
        "name": "set_power_limit",
        "description": "‚ö† –û–ü–ê–°–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏ P% –∏/–∏–ª–∏ Q%. –ó–Ω–∞—á–µ–Ω–∏—è 0-100%. –¢–†–ï–ë–£–ï–¢ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –û–ü–ï–†–ê–¢–û–†–ê.",
        "parameters": {
            "type": "object",
            "properties": {
                "device_id": {
                    "type": "integer",
                    "description": "ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
                },
                "p_percent": {
                    "type": "number",
                    "description": "–ê–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å P –≤ % (0-100)",
                },
                "q_percent": {
                    "type": "number",
                    "description": "–†–µ–∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å Q –≤ % (0-100)",
                },
            },
            "required": ["device_id"],
        },
    },
    {
        "name": "get_energy_report",
        "description": (
            "–û—Ç—á—ë—Ç –ø–æ –≤—ã—Ä–∞–±–æ—Ç–∫–µ/–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—é —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥. "
            "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –∫–∞–∂–¥–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (–∫–í—Ç¬∑—á) –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –æ—Ç —Å–µ—Ç–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –®–ü–†. "
            "–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ —Å—á—ë—Ç—á–∏–∫–æ–≤ energy_kwh –≤ –±–∞–∑–µ. "
            "–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö: '—Å–∫–æ–ª—å–∫–æ –≤—ã—Ä–∞–±–æ—Ç–∞–ª–∏', '—Ä–∞—Å—Ö–æ–¥ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏', 'P –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é' –∏ —Ç.–¥."
        ),
        "parameters": {
            "type": "object",
            "properties": {
                "site_id": {
                    "type": "integer",
                    "description": "ID –æ–±—ä–µ–∫—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã)",
                },
                "last_hours": {
                    "type": "integer",
                    "description": "–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 168 = 1 –Ω–µ–¥–µ–ª—è)",
                    "default": 168,
                },
            },
            "required": [],
        },
    },
    {
        "name": "search_knowledge",
        "description": (
            "–ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π (–º–∞–Ω—É–∞–ª—ã SmartGen HGM9520N, HGM9560 –∏ –¥—Ä.). "
            "–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ–± –æ—à–∏–±–∫–∞—Ö, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞. "
            "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–∞–Ω—É–∞–ª–æ–≤."
        ),
        "parameters": {
            "type": "object",
            "properties": {
                "query": {
                    "type": "string",
                    "description": "–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–∑–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏, –ø–∞—Ä–∞–º–µ—Ç—Ä, –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞)",
                },
                "category": {
                    "type": "string",
                    "description": "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: hgm9520n_manual, hgm9560_manual, general (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
                },
            },
            "required": ["query"],
        },
    },
]

# Commands that are dangerous and require confirmation
DANGEROUS_TOOLS = {"send_command", "set_power_limit"}

# Command descriptions for confirmation messages
COMMAND_LABELS = {
    "start": "–ó–∞–ø—É—Å–∫",
    "stop": "–û—Å—Ç–∞–Ω–æ–≤–∫–∞",
    "auto": "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º",
    "manual": "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º",
    "reset": "–°–±—Ä–æ—Å –∞–≤–∞—Ä–∏–π",
    "mute": "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞",
    "fast_stop": "–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞",
}

# Modbus coil addresses for commands (HGM9520N / HGM9560)
# Addresses per SmartGen protocol: docs/tested-scripts/hgm9560_modbus_gui (3).py
COMMAND_ADDRESSES = {
    "start":     (5, 0x0000, 0xFF00),  # FC05, coil 0:  Remote Start
    "stop":      (5, 0x0001, 0xFF00),  # FC05, coil 1:  Remote Stop
    "auto":      (5, 0x0003, 0xFF00),  # FC05, coil 3:  Remote Auto
    "manual":    (5, 0x0004, 0xFF00),  # FC05, coil 4:  Remote Manual
    "reset":     (5, 0x0011, 0xFF00),  # FC05, coil 17: Remote Alarm Reset (–°–±—Ä–æ—Å)
    "mute":      (5, 0x000C, 0xFF00),  # FC05, coil 12: Remote Mute
    "fast_stop": (5, 0x000F, 0xFF00),  # FC05, coil 15: Emergency Fast Stop
}


# ---------------------------------------------------------------------------
# Tool executor functions (call internal SCADA API via httpx)
# ---------------------------------------------------------------------------
async def _api_get(path: str, params: dict = None) -> dict:
    """GET request to internal SCADA API."""
    async with httpx.AsyncClient(base_url=_API_BASE, timeout=10) as client:
        resp = await client.get(path, params=params)
        resp.raise_for_status()
        return resp.json()


async def _api_post(path: str, data: dict = None) -> dict:
    """POST request to internal SCADA API."""
    async with httpx.AsyncClient(base_url=_API_BASE, timeout=15) as client:
        resp = await client.post(path, json=data or {})
        resp.raise_for_status()
        return resp.json()


async def execute_tool(name: str, args: dict) -> dict:
    """Execute a SCADA tool and return result."""
    try:
        if name == "get_sites":
            return await _api_get("/api/sites")

        elif name == "get_devices":
            params = {}
            if args.get("site_id"):
                params["site_id"] = args["site_id"]
            return await _api_get("/api/devices", params)

        elif name == "get_metrics":
            device_id = args["device_id"]
            data = await _api_get("/api/metrics", {"device_id": device_id})
            result = data[0] if isinstance(data, list) and data else data
            # Add hint for ATS to prevent LLM from confusing fields
            if isinstance(result, dict) and result.get("device_type") == "ats":
                result["_–ø–æ–¥—Å–∫–∞–∑–∫–∞"] = (
                    "load_total_p ‚Äî –°–£–ú–ú–ê–†–ù–ê–Ø –Ω–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–∞ (—Å–µ—Ç—å+–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã). "
                    "mains_total_p ‚Äî —Ç–æ–ª—å–∫–æ –º–æ—â–Ω–æ—Å—Ç—å –æ—Ç —Å–µ—Ç–∏. "
                    "busbar_p ‚Äî —Ç–æ–ª—å–∫–æ –º–æ—â–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞ —à–∏–Ω–µ."
                )
            return result

        elif name == "get_all_metrics":
            return await _api_get("/api/metrics")

        elif name == "get_alarms":
            params = {}
            if args.get("device_id"):
                params["device_id"] = args["device_id"]
            alarms = await _api_get("/api/history/alarms/active", params)
            # If site_id provided, filter alarms to devices of that site
            site_id = args.get("site_id")
            site_device_ids = None
            if site_id:
                try:
                    devices = await _api_get("/api/devices", {"site_id": site_id})
                    site_device_ids = {d["id"] for d in devices} if isinstance(devices, list) else None
                except Exception:
                    site_device_ids = None
                if site_device_ids is not None and isinstance(alarms, list):
                    alarms = [a for a in alarms if a.get("device_id") in site_device_ids]
            # Enrich with device names, status and duration for LLM
            if isinstance(alarms, list) and alarms:
                try:
                    if site_device_ids is None:
                        devices = await _api_get("/api/devices")
                    dev_names = {d["id"]: d["name"] for d in devices} if isinstance(devices, list) else {}
                except Exception:
                    dev_names = {}
                for a in alarms:
                    a["device_name"] = dev_names.get(a.get("device_id"), f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ #{a.get('device_id')}")
                    a["status"] = "‚ö†Ô∏è –ê–ö–¢–ò–í–ù–ê –°–ï–ô–ß–ê–°"
                    a["duration"] = _calc_alarm_duration(a.get("occurred_at"))
            return alarms

        elif name == "get_alarm_history":
            params = {"limit": args.get("limit", 50)}
            if args.get("device_id"):
                params["device_id"] = args["device_id"]
            if args.get("last_hours"):
                params["last_hours"] = args["last_hours"]
            alarms = await _api_get("/api/history/alarms", params)
            # Enrich with device names and duration for active alarms
            if isinstance(alarms, list) and alarms:
                try:
                    devices = await _api_get("/api/devices")
                    dev_names = {d["id"]: d["name"] for d in devices} if isinstance(devices, list) else {}
                except Exception:
                    dev_names = {}
                for a in alarms:
                    a["device_name"] = dev_names.get(a.get("device_id"), f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ #{a.get('device_id')}")
                    if a.get("is_active"):
                        a["status"] = "‚ö†Ô∏è –ê–ö–¢–ò–í–ù–ê –°–ï–ô–ß–ê–°"
                        a["duration"] = _calc_alarm_duration(a.get("occurred_at"))
            return alarms

        elif name == "get_maintenance_status":
            device_id = args["device_id"]
            return await _api_get(f"/api/devices/{device_id}/maintenance")

        elif name == "get_maintenance_alerts":
            params = {}
            if args.get("device_id"):
                params["device_id"] = args["device_id"]
            return await _api_get("/api/alerts", params)

        elif name == "get_history":
            device_id = args["device_id"]
            fields = args.get("fields")
            if not fields:
                # Auto-detect device type to choose correct default fields
                try:
                    devs = await _api_get("/api/metrics", {"device_id": device_id})
                    d = devs[0] if isinstance(devs, list) and devs else {}
                    dt = d.get("device_type", "generator")
                except Exception:
                    dt = "generator"
                fields = "mains_total_p,busbar_p,load_total_p" if dt == "ats" else "power_total"
            params = {
                "last_hours": args.get("last_hours", 24),
                "fields": fields,
                "limit": 100,
            }
            return await _api_get(f"/api/history/metrics/{device_id}", params)

        elif name == "get_system_summary":
            return await _build_system_summary()

        elif name == "send_command":
            return await _execute_command(args["device_id"], args["command"])

        elif name == "set_power_limit":
            return await _execute_power_limit(
                args["device_id"],
                args.get("p_percent"),
                args.get("q_percent"),
            )

        elif name == "get_energy_report":
            return await _build_energy_report(
                args.get("site_id"),
                args.get("last_hours", 168),
            )

        elif name == "search_knowledge":
            return await _search_knowledge_base(
                args["query"],
                args.get("category"),
            )

        else:
            return {"error": f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {name}"}

    except httpx.HTTPStatusError as e:
        logger.error("Tool %s HTTP error: %s", name, e)
        return {"error": f"–û—à–∏–±–∫–∞ API ({e.response.status_code}): {e.response.text[:200]}"}
    except Exception as e:
        logger.error("Tool %s error: %s", name, e, exc_info=True)
        return {"error": f"–û—à–∏–±–∫–∞: {str(e)}"}


def _calc_alarm_duration(occurred_at) -> str:
    """–í—ã—á–∏—Å–ª–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–≤–∞—Ä–∏–∏."""
    if not occurred_at:
        return "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    try:
        if isinstance(occurred_at, str):
            ts = datetime.fromisoformat(occurred_at.replace("Z", "").replace("+00:00", ""))
        else:
            ts = occurred_at
        delta = datetime.utcnow() - ts
        days = delta.days
        hours = delta.seconds // 3600
        mins = (delta.seconds % 3600) // 60
        parts = []
        if days > 0:
            parts.append(f"{days} –¥–Ω.")
        if hours > 0:
            parts.append(f"{hours} —á.")
        if mins > 0 and days == 0:
            parts.append(f"{mins} –º–∏–Ω.")
        return " ".join(parts) if parts else "—Ç–æ–ª—å–∫–æ —á—Ç–æ"
    except Exception:
        return "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"


async def _build_system_summary() -> dict:
    """Build comprehensive system summary."""
    summary = {"sites": [], "total_devices": 0, "active_alarms": 0}

    try:
        sites = await _api_get("/api/sites")
        all_metrics = await _api_get("/api/metrics")
        alarms = await _api_get("/api/history/alarms/active")
        alert_summary = await _api_get("/api/alerts/summary")

        metrics_by_device = {}
        if isinstance(all_metrics, list):
            for m in all_metrics:
                did = m.get("device_id")
                if did:
                    metrics_by_device[did] = m

        for site in (sites if isinstance(sites, list) else []):
            devices = await _api_get("/api/devices", {"site_id": site["id"]})
            device_list = []
            for dev in (devices if isinstance(devices, list) else []):
                m = metrics_by_device.get(dev["id"], {})
                dev_type = dev.get("device_type", "")
                # Choose correct fields based on device type
                if dev_type == "ats":
                    power_kw = m.get("load_total_p")
                    voltage_v = m.get("mains_uab")
                else:
                    power_kw = m.get("power_total")
                    voltage_v = m.get("gen_uab")
                dev_info = {
                    "id": dev["id"],
                    "name": dev["name"],
                    "type": dev_type,
                    "online": m.get("online", False),
                    "power_kw": power_kw,
                    "voltage_v": voltage_v,
                    "coolant_temp": m.get("coolant_temp"),
                    "engine_speed": m.get("engine_speed"),
                    "run_hours": m.get("run_hours"),
                    "fuel_level": m.get("fuel_level"),
                    "gen_status": m.get("gen_status"),
                }
                # ATS-specific breakdown
                if dev_type == "ats":
                    dev_info["mains_p_kw"] = m.get("mains_total_p")
                    dev_info["busbar_p_kw"] = m.get("busbar_p")
                device_list.append(dev_info)
                summary["total_devices"] += 1
            summary["sites"].append({
                "id": site["id"],
                "name": site["name"],
                "code": site.get("code", ""),
                "devices": device_list,
            })

        # Build device name lookup for alarm enrichment
        device_names = {}
        for site_data in summary["sites"]:
            for dev in site_data.get("devices", []):
                device_names[dev["id"]] = dev["name"]

        # Active alarm details with status and duration
        if isinstance(alarms, list) and alarms:
            summary["active_alarms"] = len(alarms)
            summary["active_alarm_details"] = [
                {
                    "device_id": a["device_id"],
                    "device_name": device_names.get(a["device_id"], f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ #{a['device_id']}"),
                    "alarm_code": a["alarm_code"],
                    "severity": a["severity"],
                    "message": a["message"],
                    "status": "‚ö†Ô∏è –ê–ö–¢–ò–í–ù–ê –°–ï–ô–ß–ê–°",
                    "duration": _calc_alarm_duration(a.get("occurred_at")),
                }
                for a in alarms
            ]
        else:
            summary["active_alarms"] = 0
            summary["active_alarm_details"] = []

        summary["maintenance_alerts"] = alert_summary if isinstance(alert_summary, dict) else {}

    except Exception as e:
        logger.error("Error building system summary: %s", e)
        summary["error"] = str(e)

    return summary


async def _build_energy_report(site_id: int | None, last_hours: int) -> dict:
    """Build energy production/consumption report for a period.

    Calculates delta of energy_kwh counters between start and end of period.
    Also reports average power (power_total for generators, load_total_p for ATS).
    """
    report = {"period_hours": last_hours, "devices": [], "totals": {}}

    try:
        # Get all devices (optionally filtered by site)
        params = {}
        if site_id:
            params["site_id"] = site_id
        sites = await _api_get("/api/sites")
        all_devices = []
        for site in (sites if isinstance(sites, list) else []):
            if site_id and site["id"] != site_id:
                continue
            devs = await _api_get("/api/devices", {"site_id": site["id"]})
            for d in (devs if isinstance(devs, list) else []):
                d["_site_name"] = site["name"]
                all_devices.append(d)

        total_gen_kwh = 0
        total_mains_kwh = 0

        for dev in all_devices:
            did = dev["id"]
            dtype = dev.get("device_type", "generator")
            dname = dev.get("name", f"#{did}")
            site_name = dev.get("_site_name", "")

            # Get history with energy_kwh for start and end of period
            hist = await _api_get(f"/api/history/metrics/{did}", {
                "last_hours": last_hours,
                "fields": "energy_kwh,power_total,run_hours" if dtype == "generator"
                    else "energy_kwh,mains_total_p,busbar_p",
                "limit": 2000,
            })

            if not isinstance(hist, list) or len(hist) < 2:
                report["devices"].append({
                    "device_id": did,
                    "name": dname,
                    "site": site_name,
                    "type": dtype,
                    "note": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥",
                })
                continue

            # Find first and last valid energy_kwh readings
            first_kwh = None
            last_kwh = None
            first_run_h = None
            last_run_h = None
            powers = []

            for pt in hist:
                ekwh = pt.get("energy_kwh")
                if ekwh is not None and ekwh > 0:
                    if first_kwh is None:
                        first_kwh = ekwh
                    last_kwh = ekwh
                rh = pt.get("run_hours")
                if rh is not None and rh > 0:
                    if first_run_h is None:
                        first_run_h = rh
                    last_run_h = rh
                # Collect power readings for average
                p = pt.get("power_total") or pt.get("mains_total_p")
                if p is not None and p > 0:
                    powers.append(p)

            energy_delta = None
            if first_kwh is not None and last_kwh is not None and last_kwh >= first_kwh:
                energy_delta = round(last_kwh - first_kwh, 1)

            run_delta = None
            if first_run_h is not None and last_run_h is not None and last_run_h >= first_run_h:
                run_delta = round(last_run_h - first_run_h, 1)

            avg_power = round(sum(powers) / len(powers), 1) if powers else None
            max_power = round(max(powers), 1) if powers else None

            dev_report = {
                "device_id": did,
                "name": dname,
                "site": site_name,
                "type": "–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä" if dtype == "generator" else "–®–ü–†",
                "energy_kwh": energy_delta,
                "avg_power_kw": avg_power,
                "max_power_kw": max_power,
                "data_points": len(hist),
            }
            if run_delta is not None:
                dev_report["run_hours_delta"] = run_delta
            if energy_delta is None and avg_power:
                # Estimate from average power * hours
                estimated = round(avg_power * last_hours, 0)
                dev_report["estimated_kwh"] = estimated
                dev_report["note"] = "–°—á—ë—Ç—á–∏–∫ energy_kwh –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ—Ü–µ–Ω–∫–∞ –ø–æ —Å—Ä–µ–¥–Ω–µ–π –º–æ—â–Ω–æ—Å—Ç–∏"

            if dtype == "generator" and energy_delta is not None:
                total_gen_kwh += energy_delta
            elif dtype == "ats" and energy_delta is not None:
                total_mains_kwh += energy_delta

            report["devices"].append(dev_report)

        report["totals"] = {
            "generators_kwh": round(total_gen_kwh, 1),
            "note": f"–°—É–º–º–∞—Ä–Ω–∞—è –≤—ã—Ä–∞–±–æ—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∑–∞ {last_hours} —á–∞—Å–æ–≤",
        }
        if total_mains_kwh:
            report["totals"]["mains_kwh"] = round(total_mains_kwh, 1)

    except Exception as e:
        logger.error("Error building energy report: %s", e, exc_info=True)
        report["error"] = str(e)

    return report


async def _execute_command(device_id: int, command: str) -> dict:
    """Execute a Modbus command on a device."""
    if command not in COMMAND_ADDRESSES:
        return {"error": f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {command}"}

    fc, address, value = COMMAND_ADDRESSES[command]
    result = await _api_post("/api/commands", {
        "device_id": device_id,
        "function_code": fc,
        "address": address,
        "value": value,
    })
    return result


async def _execute_power_limit(
    device_id: int,
    p_percent: Optional[float] = None,
    q_percent: Optional[float] = None,
) -> dict:
    """Set power limit on a device."""
    # Read current values first
    current = await _api_get(f"/api/devices/{device_id}/power-limit")

    p_raw = int(p_percent * 10) if p_percent is not None else (current.get("config_p_raw") or 1000)
    q_raw = int(q_percent * 10) if q_percent is not None else (current.get("config_q_raw") or 1000)

    result = await _api_post(f"/api/devices/{device_id}/power-limit", {
        "p_raw": p_raw,
        "q_raw": q_raw,
    })
    return result


async def _search_knowledge_base(query: str, category: str = None) -> dict:
    """Search knowledge base via internal API."""
    params = {"q": query, "limit": 5}
    if category:
        params["category"] = category
    try:
        results = await _api_get("/api/ai/knowledge/search", params)
        if isinstance(results, list) and results:
            return {
                "found": len(results),
                "results": [
                    {
                        "title": r.get("title", ""),
                        "content": r.get("content", "")[:800],
                        "source": r.get("source_filename", ""),
                        "category": r.get("category", ""),
                    }
                    for r in results
                ],
            }
        return {"found": 0, "results": [], "hint": "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞."}
    except Exception as e:
        logger.warning("Knowledge base search error: %s", e)
        return {"found": 0, "error": str(e), "hint": "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞."}


# ---------------------------------------------------------------------------
# Format tools for different LLM providers
# ---------------------------------------------------------------------------
def _tools_for_openai() -> list[dict]:
    """Format tools for OpenAI / Grok function calling."""
    return [
        {
            "type": "function",
            "function": {
                "name": t["name"],
                "description": t["description"],
                "parameters": t["parameters"],
            },
        }
        for t in SCADA_TOOLS
    ]


def _tools_for_claude() -> list[dict]:
    """Format tools for Claude (Anthropic) tool use."""
    return [
        {
            "name": t["name"],
            "description": t["description"],
            "input_schema": t["parameters"],
        }
        for t in SCADA_TOOLS
    ]


def _tools_for_gemini() -> list[dict]:
    """Format tools for Gemini function calling."""
    return [
        {
            "name": t["name"],
            "description": t["description"],
            "parameters": t["parameters"],
        }
        for t in SCADA_TOOLS
    ]


# ---------------------------------------------------------------------------
# SanekAssistant ‚Äî main class
# ---------------------------------------------------------------------------
class SanekAssistant:
    """
    AI assistant for SCADA operators.

    Usage:
        assistant = SanekAssistant(provider="openai", api_key="sk-...", model="gpt-4o")
        response = await assistant.chat(messages, pending_action=None)
    """

    def __init__(self, provider: str, api_key: str, model: str = ""):
        self.provider = provider
        self.api_key = api_key
        self.model = model or {
            "openai": "gpt-4o",
            "claude": "claude-sonnet-4-20250514",
            "gemini": "gemini-2.5-flash",
            "grok": "grok-3-mini",
        }.get(provider, "gpt-4o")
        self.timeout = settings.AI_TIMEOUT

    async def chat(
        self,
        messages: list[dict],
        pending_action: Optional[dict] = None,
    ) -> dict:
        """
        Process a chat turn with tool calling.

        Args:
            messages: Conversation history [{role, content}]
            pending_action: If set, user is confirming/declining a previous action.

        Returns:
            {
                "message": str,          # Assistant's text reply
                "actions": [...]          # Executed tool calls
                "pending_action": {...}   # If dangerous command needs confirmation
            }
        """
        # Handle pending action confirmation
        if pending_action:
            last_msg = messages[-1].get("content", "").strip().lower() if messages else ""
            if last_msg in ("–¥–∞", "yes", "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é", "–æ–∫", "ok", "–¥–∞–≤–∞–π"):
                # Execute the confirmed action
                tool_name = pending_action["tool"]
                tool_args = pending_action["args"]
                logger.info("Executing confirmed action: %s(%s)", tool_name, tool_args)
                result = await execute_tool(tool_name, tool_args)
                return {
                    "message": f"‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {pending_action.get('description', tool_name)}\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç: {json.dumps(result, ensure_ascii=False, indent=2)[:500]}",
                    "actions": [{"tool": tool_name, "args": tool_args, "result": result}],
                    "pending_action": None,
                }
            else:
                return {
                    "message": "‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
                    "actions": [],
                    "pending_action": None,
                }

        # Build messages with system prompt
        full_messages = [{"role": "system", "content": SANEK_SYSTEM_PROMPT}] + messages

        # Call LLM with tools
        if self.provider in ("openai", "grok"):
            return await self._chat_openai(full_messages)
        elif self.provider == "claude":
            return await self._chat_claude(full_messages)
        elif self.provider == "gemini":
            return await self._chat_gemini(full_messages)
        else:
            return {"message": f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: {self.provider}", "actions": [], "pending_action": None}

    # ------------------------------------------------------------------
    # OpenAI / Grok
    # ------------------------------------------------------------------
    async def _chat_openai(self, messages: list[dict]) -> dict:
        from openai import AsyncOpenAI

        base_url = "https://api.x.ai/v1" if self.provider == "grok" else None
        client = AsyncOpenAI(
            api_key=self.api_key,
            timeout=self.timeout,
            base_url=base_url,
        )

        tools = _tools_for_openai()
        actions = []

        # Allow up to 5 tool call rounds
        for _ in range(5):
            try:
                response = await client.chat.completions.create(
                    model=self.model,
                    messages=messages,
                    tools=tools,
                    temperature=0.3,
                )
            except Exception as e:
                logger.error("OpenAI/Grok error: %s", e)
                return {"message": _format_llm_error(self.provider, e), "actions": actions, "pending_action": None}

            choice = response.choices[0]

            # If tool calls requested
            if choice.message.tool_calls:
                messages.append(choice.message.model_dump())

                for tc in choice.message.tool_calls:
                    tool_name = tc.function.name
                    tool_args = json.loads(tc.function.arguments) if tc.function.arguments else {}

                    logger.info("Tool call: %s(%s)", tool_name, tool_args)

                    # Check if dangerous ‚Äî return pending action
                    if tool_name in DANGEROUS_TOOLS:
                        pending = self._build_pending_action(tool_name, tool_args)
                        return {
                            "message": pending["description"],
                            "actions": actions,
                            "pending_action": pending,
                        }

                    # Execute safe tool
                    result = await execute_tool(tool_name, tool_args)
                    actions.append({"tool": tool_name, "args": tool_args, "result": result})

                    messages.append({
                        "role": "tool",
                        "tool_call_id": tc.id,
                        "content": json.dumps(result, ensure_ascii=False, default=str),
                    })

                continue  # Next round with tool results

            # No more tool calls ‚Äî return final text
            text = choice.message.content or ""
            return {"message": text, "actions": actions, "pending_action": None}

        # Max rounds reached
        return {"message": "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.", "actions": actions, "pending_action": None}

    # ------------------------------------------------------------------
    # Claude (Anthropic)
    # ------------------------------------------------------------------
    async def _chat_claude(self, messages: list[dict]) -> dict:
        tools = _tools_for_claude()
        actions = []

        # Separate system prompt from messages
        system_text = ""
        chat_msgs = []
        for m in messages:
            if m["role"] == "system":
                system_text += m["content"] + "\n"
            else:
                chat_msgs.append(m)

        for _ in range(5):
            try:
                async with httpx.AsyncClient(timeout=self.timeout) as http:
                    body = {
                        "model": self.model,
                        "max_tokens": 4096,
                        "system": system_text.strip(),
                        "messages": chat_msgs,
                        "tools": tools,
                        "temperature": 0.3,
                    }
                    resp = await http.post(
                        "https://api.anthropic.com/v1/messages",
                        headers={
                            "x-api-key": self.api_key,
                            "anthropic-version": "2023-06-01",
                            "content-type": "application/json",
                        },
                        json=body,
                    )
            except Exception as e:
                logger.error("Claude error: %s", e)
                return {"message": _format_llm_error("claude", e), "actions": actions, "pending_action": None}

            if resp.status_code != 200:
                try:
                    err = resp.json().get("error", {}).get("message", resp.text[:200])
                except Exception:
                    err = resp.text[:200]
                return {"message": _format_http_error("claude", resp.status_code, err), "actions": actions, "pending_action": None}

            data = resp.json()
            stop_reason = data.get("stop_reason", "")
            content_blocks = data.get("content", [])

            # Collect text and tool_use blocks
            text_parts = []
            tool_uses = []
            for block in content_blocks:
                if block["type"] == "text":
                    text_parts.append(block["text"])
                elif block["type"] == "tool_use":
                    tool_uses.append(block)

            if tool_uses:
                # Add assistant message with all content blocks
                chat_msgs.append({"role": "assistant", "content": content_blocks})

                tool_results = []
                for tu in tool_uses:
                    tool_name = tu["name"]
                    tool_args = tu.get("input", {})

                    logger.info("Claude tool call: %s(%s)", tool_name, tool_args)

                    # Check if dangerous
                    if tool_name in DANGEROUS_TOOLS:
                        pending = self._build_pending_action(tool_name, tool_args)
                        text = "\n".join(text_parts) if text_parts else ""
                        return {
                            "message": (text + "\n\n" + pending["description"]).strip(),
                            "actions": actions,
                            "pending_action": pending,
                        }

                    result = await execute_tool(tool_name, tool_args)
                    actions.append({"tool": tool_name, "args": tool_args, "result": result})

                    tool_results.append({
                        "type": "tool_result",
                        "tool_use_id": tu["id"],
                        "content": json.dumps(result, ensure_ascii=False, default=str),
                    })

                chat_msgs.append({"role": "user", "content": tool_results})
                continue

            # No tool calls ‚Äî return text
            text = "\n".join(text_parts)
            return {"message": text, "actions": actions, "pending_action": None}

        return {"message": "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.", "actions": actions, "pending_action": None}

    # ------------------------------------------------------------------
    # Gemini
    # ------------------------------------------------------------------
    async def _chat_gemini(self, messages: list[dict]) -> dict:
        tools = _tools_for_gemini()
        actions = []

        # Convert messages to Gemini format
        gemini_contents = []
        system_text = ""
        for m in messages:
            if m["role"] == "system":
                system_text += m["content"] + "\n"
            elif m["role"] == "user":
                gemini_contents.append({"role": "user", "parts": [{"text": m["content"]}]})
            elif m["role"] == "assistant":
                gemini_contents.append({"role": "model", "parts": [{"text": m.get("content", "")}]})

        # Prepend system as first user message if needed
        if system_text and gemini_contents:
            first = gemini_contents[0]
            if first["role"] == "user":
                first["parts"][0]["text"] = system_text.strip() + "\n\n" + first["parts"][0]["text"]

        url = (
            f"https://generativelanguage.googleapis.com/v1beta/models/"
            f"{self.model}:generateContent?key={self.api_key}"
        )

        for _ in range(5):
            try:
                async with httpx.AsyncClient(timeout=self.timeout) as http:
                    body = {
                        "contents": gemini_contents,
                        "tools": [{"function_declarations": tools}],
                        "generationConfig": {
                            "temperature": 0.3,
                            "maxOutputTokens": 4096,
                        },
                    }
                    resp = await http.post(url, json=body)
            except Exception as e:
                logger.error("Gemini error: %s", e)
                return {"message": _format_llm_error("gemini", e), "actions": actions, "pending_action": None}

            if resp.status_code != 200:
                try:
                    err = resp.json().get("error", {}).get("message", resp.text[:200])
                except Exception:
                    err = resp.text[:200]
                return {"message": _format_http_error("gemini", resp.status_code, err), "actions": actions, "pending_action": None}

            data = resp.json()
            candidate = data.get("candidates", [{}])[0]
            parts = candidate.get("content", {}).get("parts", [])

            text_parts = []
            function_calls = []
            for part in parts:
                if "text" in part:
                    text_parts.append(part["text"])
                if "functionCall" in part:
                    function_calls.append(part["functionCall"])

            if function_calls:
                # Add model response
                gemini_contents.append({"role": "model", "parts": parts})

                func_responses = []
                for fc in function_calls:
                    tool_name = fc["name"]
                    tool_args = fc.get("args", {})

                    logger.info("Gemini tool call: %s(%s)", tool_name, tool_args)

                    if tool_name in DANGEROUS_TOOLS:
                        pending = self._build_pending_action(tool_name, tool_args)
                        text = "\n".join(text_parts) if text_parts else ""
                        return {
                            "message": (text + "\n\n" + pending["description"]).strip(),
                            "actions": actions,
                            "pending_action": pending,
                        }

                    result = await execute_tool(tool_name, tool_args)
                    actions.append({"tool": tool_name, "args": tool_args, "result": result})

                    func_responses.append({
                        "functionResponse": {
                            "name": tool_name,
                            "response": result,
                        }
                    })

                gemini_contents.append({"role": "user", "parts": func_responses})
                continue

            text = "\n".join(text_parts)
            return {"message": text, "actions": actions, "pending_action": None}

        return {"message": "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.", "actions": actions, "pending_action": None}

    # ------------------------------------------------------------------
    # Helpers
    # ------------------------------------------------------------------
    def _build_pending_action(self, tool_name: str, tool_args: dict) -> dict:
        """Build a pending action that requires operator confirmation."""
        if tool_name == "send_command":
            cmd = tool_args.get("command", "")
            dev_id = tool_args.get("device_id", "?")
            label = COMMAND_LABELS.get(cmd, cmd)
            desc = f"‚ö† {label} —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ID={dev_id}?\n\n–û—Ç–≤–µ—Ç—å—Ç–µ ¬´–î–∞¬ª –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ ¬´–ù–µ—Ç¬ª –¥–ª—è –æ—Ç–º–µ–Ω—ã."
        elif tool_name == "set_power_limit":
            dev_id = tool_args.get("device_id", "?")
            p = tool_args.get("p_percent", "‚Äî")
            q = tool_args.get("q_percent", "‚Äî")
            desc = f"‚ö† –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ID={dev_id}: P={p}%, Q={q}%?\n\n–û—Ç–≤–µ—Ç—å—Ç–µ ¬´–î–∞¬ª –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ ¬´–ù–µ—Ç¬ª –¥–ª—è –æ—Ç–º–µ–Ω—ã."
        else:
            desc = f"‚ö† –í—ã–ø–æ–ª–Ω–∏—Ç—å {tool_name}?"

        return {
            "tool": tool_name,
            "args": tool_args,
            "description": desc,
        }
